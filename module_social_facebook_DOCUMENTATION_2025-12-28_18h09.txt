
################################################################################
#                      MODULE_SOCIAL_FACEBOOK                            #
#                   ODOO MODULE DOCUMENTATION GENERATOR                     #
#                           Version 1.3.0 - Enterprise Style                #
################################################################################

================================================================================
                                ğŸ“‚ DIRECTORY TREE
================================================================================
ğŸ“„ __init__.py
ğŸ“„ __manifest__.py
ğŸ“ controllers
â”œâ”€â”€ ğŸ“„ __init__.py
â”œâ”€â”€ ğŸ“„ main.py
â””â”€â”€ ğŸ“„ webhook.py
ğŸ“ data
â”œâ”€â”€ ğŸ“„ chatbot_data.xml
â”œâ”€â”€ ğŸ“„ facebook_post_template_data.xml
â”œâ”€â”€ ğŸ“„ ir_cron_data.xml
â”œâ”€â”€ ğŸ“„ mail_template_data.xml
â””â”€â”€ ğŸ“„ user_groups_data.xml
ğŸ“„ generate_doc_4.py
ğŸ“ lib
â”œâ”€â”€ ğŸ“„ __init__.py
â””â”€â”€ ğŸ“„ facebook_api.py
ğŸ“ models
â”œâ”€â”€ ğŸ“„ __init__.py
â”œâ”€â”€ ğŸ“„ crm_lead.py
â”œâ”€â”€ ğŸ“„ res_company.py
â”œâ”€â”€ ğŸ“„ res_config_settings.py
â”œâ”€â”€ ğŸ“„ social_account.py
â”œâ”€â”€ ğŸ“„ social_analytics.py
â”œâ”€â”€ ğŸ“„ social_chatbot_automation.py
â”œâ”€â”€ ğŸ“„ social_comment.py
â”œâ”€â”€ ğŸ“„ social_conversation.py
â”œâ”€â”€ ğŸ“„ social_message.py
â”œâ”€â”€ ğŸ“„ social_messenger_order.py
â”œâ”€â”€ ğŸ“„ social_messenger_product.py
â”œâ”€â”€ ğŸ“„ social_post.py
â””â”€â”€ ğŸ“„ social_post_template.py
ğŸ“„ ok.py
ğŸ“ security
â”œâ”€â”€ ğŸ“„ ir.model.access.csv
â””â”€â”€ ğŸ“„ social_security.xml
ğŸ“ static
â”œâ”€â”€ ğŸ“ description
â”‚   â””â”€â”€ ğŸ“„ icon.png
â””â”€â”€ ğŸ“ src
    â”œâ”€â”€ ğŸ“ css
    â”‚   â””â”€â”€ ğŸ“„ social_facebook.css
    â”œâ”€â”€ ğŸ“ js
    â”‚   â”œâ”€â”€ ğŸ“„ social_conversation_list.js
    â”‚   â””â”€â”€ ğŸ“„ social_dashboard.js
    â””â”€â”€ ğŸ“ xml
        â””â”€â”€ ğŸ“„ social_conversation_templates.xml
ğŸ“ views
â”œâ”€â”€ ğŸ“„ dashboard_views.xml
â”œâ”€â”€ ğŸ“„ menu_views.xml
â”œâ”€â”€ ğŸ“„ res_config_settings_views.md
â”œâ”€â”€ ğŸ“„ social_account_views.xml
â”œâ”€â”€ ğŸ“„ social_analytics_views.xml
â”œâ”€â”€ ğŸ“„ social_chatbot_automation_views.xml
â”œâ”€â”€ ğŸ“„ social_comment_views.xml
â”œâ”€â”€ ğŸ“„ social_conversation_views.xml
â”œâ”€â”€ ğŸ“„ social_message_views.xml
â”œâ”€â”€ ğŸ“„ social_messenger_order_views.xml
â”œâ”€â”€ ğŸ“„ social_messenger_product_views.xml
â”œâ”€â”€ ğŸ“„ social_post_calendar_views.xml
â”œâ”€â”€ ğŸ“„ social_post_template_views.xml
â””â”€â”€ ğŸ“„ social_post_views.xml
ğŸ“ wizard
â”œâ”€â”€ ğŸ“„ __init__.py
â”œâ”€â”€ ğŸ“„ bulk_schedule_wizard.py
â”œâ”€â”€ ğŸ“„ post_composer_wizard.py
â””â”€â”€ ğŸ“„ wizard_views.xml


================================================================================
                              Cáº¤U TRÃšC THÆ¯ Má»¤C - 53 FILES
================================================================================

  1.  __init__.py
  2.  __manifest__.py
  3.  controllers/__init__.py
  4.  controllers/main.py
  5.  controllers/webhook.py
  6.  data/chatbot_data.xml
  7.  data/facebook_post_template_data.xml
  8.  data/ir_cron_data.xml
  9.  data/mail_template_data.xml
 10.  data/user_groups_data.xml
 11.  generate_doc_4.py
 12.  lib/__init__.py
 13.  lib/facebook_api.py
 14.  models/__init__.py
 15.  models/crm_lead.py
 16.  models/res_company.py
 17.  models/res_config_settings.py
 18.  models/social_account.py
 19.  models/social_analytics.py
 20.  models/social_chatbot_automation.py
 21.  models/social_comment.py
 22.  models/social_conversation.py
 23.  models/social_message.py
 24.  models/social_messenger_order.py
 25.  models/social_messenger_product.py
 26.  models/social_post.py
 27.  models/social_post_template.py
 28.  ok.py
 29.  security/ir.model.access.csv
 30.  security/social_security.xml
 31.  static/description/icon.png
 32.  static/src/css/social_facebook.css
 33.  static/src/js/social_conversation_list.js
 34.  static/src/js/social_dashboard.js
 35.  static/src/xml/social_conversation_templates.xml
 36.  views/dashboard_views.xml
 37.  views/menu_views.xml
 38.  views/res_config_settings_views.md
 39.  views/social_account_views.xml
 40.  views/social_analytics_views.xml
 41.  views/social_chatbot_automation_views.xml
 42.  views/social_comment_views.xml
 43.  views/social_conversation_views.xml
 44.  views/social_message_views.xml
 45.  views/social_messenger_order_views.xml
 46.  views/social_messenger_product_views.xml
 47.  views/social_post_calendar_views.xml
 48.  views/social_post_template_views.xml
 49.  views/social_post_views.xml
 50.  wizard/__init__.py
 51.  wizard/bulk_schedule_wizard.py
 52.  wizard/post_composer_wizard.py
 53.  wizard/wizard_views.xml


================================================================================
                         Báº¢NG Tá»”NG Káº¾T 53 FILES
================================================================================
â”‚  #  â”‚ ÄÆ°á»ng dáº«n file                                     â”‚ Loáº¡i     â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1   â”‚ __init__.py                                        â”‚ Python   â”‚
â”‚ 2   â”‚ __manifest__.py                                    â”‚ Python   â”‚
â”‚ 3   â”‚ controllers/__init__.py                            â”‚ Python   â”‚
â”‚ 4   â”‚ controllers/main.py                                â”‚ Python   â”‚
â”‚ 5   â”‚ controllers/webhook.py                             â”‚ Python   â”‚
â”‚ 6   â”‚ data/chatbot_data.xml                              â”‚ XML      â”‚
â”‚ 7   â”‚ data/facebook_post_template_data.xml               â”‚ XML      â”‚
â”‚ 8   â”‚ data/ir_cron_data.xml                              â”‚ XML      â”‚
â”‚ 9   â”‚ data/mail_template_data.xml                        â”‚ XML      â”‚
â”‚ 10  â”‚ data/user_groups_data.xml                          â”‚ XML      â”‚
â”‚ 11  â”‚ generate_doc_4.py                                  â”‚ Python   â”‚
â”‚ 12  â”‚ lib/__init__.py                                    â”‚ Python   â”‚
â”‚ 13  â”‚ lib/facebook_api.py                                â”‚ Python   â”‚
â”‚ 14  â”‚ models/__init__.py                                 â”‚ Python   â”‚
â”‚ 15  â”‚ models/crm_lead.py                                 â”‚ Python   â”‚
â”‚ 16  â”‚ models/res_company.py                              â”‚ Python   â”‚
â”‚ 17  â”‚ models/res_config_settings.py                      â”‚ Python   â”‚
â”‚ 18  â”‚ models/social_account.py                           â”‚ Python   â”‚
â”‚ 19  â”‚ models/social_analytics.py                         â”‚ Python   â”‚
â”‚ 20  â”‚ models/social_chatbot_automation.py                â”‚ Python   â”‚
â”‚ 21  â”‚ models/social_comment.py                           â”‚ Python   â”‚
â”‚ 22  â”‚ models/social_conversation.py                      â”‚ Python   â”‚
â”‚ 23  â”‚ models/social_message.py                           â”‚ Python   â”‚
â”‚ 24  â”‚ models/social_messenger_order.py                   â”‚ Python   â”‚
â”‚ 25  â”‚ models/social_messenger_product.py                 â”‚ Python   â”‚
â”‚ 26  â”‚ models/social_post.py                              â”‚ Python   â”‚
â”‚ 27  â”‚ models/social_post_template.py                     â”‚ Python   â”‚
â”‚ 28  â”‚ ok.py                                              â”‚ Python   â”‚
â”‚ 29  â”‚ security/ir.model.access.csv                       â”‚ CSV      â”‚
â”‚ 30  â”‚ security/social_security.xml                       â”‚ XML      â”‚
â”‚ 31  â”‚ static/description/icon.png                        â”‚ Image    â”‚
â”‚ 32  â”‚ static/src/css/social_facebook.css                 â”‚ CSS      â”‚
â”‚ 33  â”‚ static/src/js/social_conversation_list.js          â”‚ JS       â”‚
â”‚ 34  â”‚ static/src/js/social_dashboard.js                  â”‚ JS       â”‚
â”‚ 35  â”‚ static/src/xml/social_conversation_templates.xml   â”‚ XML      â”‚
â”‚ 36  â”‚ views/dashboard_views.xml                          â”‚ XML      â”‚
â”‚ 37  â”‚ views/menu_views.xml                               â”‚ XML      â”‚
â”‚ 38  â”‚ views/res_config_settings_views.md                 â”‚ Other    â”‚
â”‚ 39  â”‚ views/social_account_views.xml                     â”‚ XML      â”‚
â”‚ 40  â”‚ views/social_analytics_views.xml                   â”‚ XML      â”‚
â”‚ 41  â”‚ views/social_chatbot_automation_views.xml          â”‚ XML      â”‚
â”‚ 42  â”‚ views/social_comment_views.xml                     â”‚ XML      â”‚
â”‚ 43  â”‚ views/social_conversation_views.xml                â”‚ XML      â”‚
â”‚ 44  â”‚ views/social_message_views.xml                     â”‚ XML      â”‚
â”‚ 45  â”‚ views/social_messenger_order_views.xml             â”‚ XML      â”‚
â”‚ 46  â”‚ views/social_messenger_product_views.xml           â”‚ XML      â”‚
â”‚ 47  â”‚ views/social_post_calendar_views.xml               â”‚ XML      â”‚
â”‚ 48  â”‚ views/social_post_template_views.xml               â”‚ XML      â”‚
â”‚ 49  â”‚ views/social_post_views.xml                        â”‚ XML      â”‚
â”‚ 50  â”‚ wizard/__init__.py                                 â”‚ Python   â”‚
â”‚ 51  â”‚ wizard/bulk_schedule_wizard.py                     â”‚ Python   â”‚
â”‚ 52  â”‚ wizard/post_composer_wizard.py                     â”‚ Python   â”‚
â”‚ 53  â”‚ wizard/wizard_views.xml                            â”‚ XML      â”‚



================================================================================
                              Ná»˜I DUNG CÃC FILES
================================================================================

################################################################################
## FILE 1: __init__.py
## ÄÆ°á»ng dáº«n: __init__.py
################################################################################

# -*- coding: utf-8 -*-

from . import models
from . import controllers
from . import wizard
from . import lib



################################################################################
## FILE 2: __manifest__.py
## ÄÆ°á»ng dáº«n: __manifest__.py
################################################################################

# -*- coding: utf-8 -*-
{
    'name': 'Social Media - Facebook Enhanced',
    'version': '19.0.2.0.0',
    'category': 'Marketing/Social Marketing',
    'summary': 'Facebook Integration with CRM, Messenger Sales & Content Calendar',
    'description': """
Facebook Integration - Enterprise Edition
==========================================

Core Features:
--------------
* Facebook Pages Management
* Posts Publishing & Scheduling
* Comments & Reactions Tracking
* Messenger Conversations
* Analytics & Insights
* Webhook Integration

NEW Features (v2.0):
-------------------
* âœ¨ CRM Lead Auto-creation from Messenger & Lead Ads
* âœ¨ Messenger Sales Bot with Order Creation
* âœ¨ Content Calendar View
* âœ¨ Ngrok Integration for Local Development
* âœ¨ Webhook Configuration UI
* âœ¨ Messenger Product Catalog
* âœ¨ Sale Order Integration
    """,
    'author': 'Your Company',
    'website': 'https://www.yourcompany.com',
    'license': 'LGPL-3',
    'depends': [
        'base',
        'mail',
        'web',
        'crm',
        'sale_management',
        'product',
    ],
    'data': [
        # Security
        'security/social_security.xml',
        'security/ir.model.access.csv',
        
        # Data
        'data/ir_cron_data.xml',
        
        # Views
        'views/social_account_views.xml',
        'views/social_post_views.xml',
        'views/social_comment_views.xml',
        'views/social_conversation_views.xml',
        'views/social_message_views.xml',
        'views/social_messenger_product_views.xml',
        'views/social_messenger_order_views.xml',
        'views/social_analytics_views.xml',        # âœ… THÃŠM
        'views/social_post_template_views.xml',    # âœ… THÃŠM
        'views/social_post_calendar_views.xml',    # âœ… THÃŠM
        'views/social_chatbot_automation_views.xml', # âœ… THÃŠM
        'views/dashboard_views.xml',               # âœ… THÃŠM - QUAN TRá»ŒNG
        'views/menu_views.xml',
    ],
    'installable': True,
    'application': True,
    'auto_install': False,
}



################################################################################
## FILE 3: __init__.py
## ÄÆ°á»ng dáº«n: controllers/__init__.py
################################################################################

from . import main
from . import webhook




################################################################################
## FILE 4: main.py
## ÄÆ°á»ng dáº«n: controllers/main.py
################################################################################

from odoo import http
from odoo.http import request


class SocialFacebookController(http.Controller):
    """
    Controller chÃ­nh cho Facebook integration.
    """

    @http.route('/social/facebook/oauth/callback', type='http', auth='user', website=True)
    def facebook_oauth_callback(self, **kwargs):
        """
        Callback URL sau khi user authorize Facebook app.
        """
        code = kwargs.get('code')
        state = kwargs.get('state')
        
        if not code:
            return request.render('module_social_facebook.oauth_error', {
                'error': 'No authorization code received'
            })
        
        # Process OAuth code and exchange for access token
        # Logic xá»­ lÃ½ á»Ÿ Ä‘Ã¢y
        
        return request.redirect('/web#action=module_social_facebook.action_social_account')




################################################################################
## FILE 5: webhook.py
## ÄÆ°á»ng dáº«n: controllers/webhook.py
################################################################################

import json
import logging
import requests
import re
from datetime import datetime, timedelta
from odoo import http, fields
from odoo.http import request

_logger = logging.getLogger(__name__)


class FacebookWebhookController(http.Controller):
    
    @http.route('/social/facebook/webhook', type='http', auth='public', 
                methods=['GET'], csrf=False)
    def webhook_verify(self, **kwargs):
        """Verify webhook"""
        mode = kwargs.get('hub.mode')
        token = kwargs.get('hub.verify_token')
        challenge = kwargs.get('hub.challenge')
        
        verify_token = request.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.verify_token', '16112005'
        )
        
        if mode == 'subscribe' and token == verify_token:
            _logger.info('âœ… Webhook verified')
            return challenge
        else:
            _logger.warning('âŒ Webhook verify failed')
            return 'Forbidden', 403
    
    @http.route('/social/facebook/webhook', type='http', auth='public', 
                methods=['POST'], csrf=False)
    def webhook_callback(self, **kwargs):
        """Nháº­n events tá»« Facebook"""
        try:
            body = request.httprequest.get_data(as_text=True)
            data = json.loads(body)
            
            if data.get('object') != 'page':
                return 'OK'
            
            for entry in data.get('entry', []):
                self._process_entry(entry)
            
            return 'OK'
            
        except Exception as e:
            _logger.error('âŒ Webhook error: %s', e, exc_info=True)
            return 'OK'
    
    def _process_entry(self, entry):
        if 'messaging' in entry:
            for event in entry['messaging']:
                self._process_messaging_event(event)
    
    def _process_messaging_event(self, event):
        sender_id = event.get('sender', {}).get('id')
        recipient_id = event.get('recipient', {}).get('id')
        
        if not sender_id or not recipient_id:
            return
        
        conversation = self._find_or_create_conversation(sender_id, recipient_id)
        if not conversation:
            return
        
        if 'message' in event:
            message_data = event['message']
            
            if message_data.get('is_echo'):
                return
            
            if 'quick_reply' in message_data:
                payload = message_data['quick_reply'].get('payload', '')
                self._process_chatbot_flow(conversation, payload)
            else:
                text = message_data.get('text', '')
                self._process_chatbot_flow(conversation, text)
    
    # =========================================================================
    # CHATBOT FLOW - UPGRADED
    # =========================================================================
    
    def _process_chatbot_flow(self, conversation, user_message):
        chatbot_enabled = request.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.chatbot_enabled', 'False'
        )
        
        if chatbot_enabled != 'True':
            return
        
        if self._is_in_cooldown(conversation):
            self._send_text(conversation, 
                "Cáº£m Æ¡n báº¡n Ä‘Ã£ Ä‘áº·t hÃ ng! ÄÆ¡n hÃ ng Ä‘ang Ä‘Æ°á»£c xá»­ lÃ½.Äá»£i 15 giÃ¢y Ä‘á»ƒ nháº¯n láº¡i")
            return
        
        current_state = conversation.chatbot_state or 'idle'
        _logger.info('ğŸ¤– State: %s | Message: %s', current_state, user_message)
        
        # âœ… ROUTING Má»šI
        if current_state == 'idle':
            self._state_idle(conversation, user_message)
        elif current_state == 'ask_name':
            self._state_ask_name(conversation, user_message)
        elif current_state == 'ask_phone':
            self._state_ask_phone(conversation, user_message)
        elif current_state == 'ask_address':  # âœ… Má»šI
            self._state_ask_address(conversation, user_message)
        elif current_state == 'show_products':
            self._state_show_products(conversation, user_message)
        elif current_state == 'ask_quantity':  # âœ… Má»šI
            self._state_ask_quantity(conversation, user_message)
        elif current_state == 'confirm_order':
            self._state_confirm_order(conversation, user_message)
        elif current_state == 'completed':
            self._state_completed(conversation, user_message)
    
    def _state_idle(self, conv, msg):
        msg_lower = msg.lower().strip()
        
        if any(kw in msg_lower for kw in ['mua', 'order', 'buy', 'menu']):
            conv.sudo().write({'chatbot_state': 'ask_name'})
            self._send_text(conv, "Xin chÃ o! ğŸ‘‹\n\nBáº¡n vui lÃ²ng cho biáº¿t tÃªn cá»§a báº¡n?")
        else:
            self._send_text(conv, 'ğŸ‘‹ Gá»­i "mua" Ä‘á»ƒ xem sáº£n pháº©m!')
    
    def _state_ask_name(self, conv, msg):
        name = msg.strip()
        
        if len(name) < 2:
            self._send_text(conv, "TÃªn quÃ¡ ngáº¯n. Vui lÃ²ng nháº­p láº¡i.")
            return
        
        name_normalized = ' '.join(word.capitalize() for word in name.split())
        
        conv.sudo().write({
            'customer_name': name_normalized,
            'chatbot_state': 'ask_phone'
        })
        
        welcome_msg = "Xin chÃ o %s! ğŸ˜Š\n\nBáº¡n vui lÃ²ng cung cáº¥p sá»‘ Ä‘iá»‡n thoáº¡i?" % name_normalized
        self._send_text(conv, welcome_msg)
    
    def _state_ask_phone(self, conv, msg):
        phone = msg.strip()
        phone_clean = re.sub(r'[\s\-\(\)]', '', phone)
        
        if phone_clean.startswith('+84'):
            phone_clean = '0' + phone_clean[3:]
        elif phone_clean.startswith('84'):
            phone_clean = '0' + phone_clean[2:]
        
        if not re.match(r'^0\d{9,10}$', phone_clean):
            self._send_text(conv, 
                "ğŸ“± Sá»‘ Ä‘iá»‡n thoáº¡i khÃ´ng há»£p lá»‡!\n\nVui lÃ²ng nháº­p láº¡i (VD: 0912345678)")
            return
        
        conv.sudo().write({
            'customer_phone': phone_clean,
            'chatbot_state': 'ask_address'  # âœ… Äá»”I STATE
        })
        
        # âœ… Há»I Äá»ŠA CHá»ˆ
        self._send_text(conv, "ğŸ“ Báº¡n vui lÃ²ng cung cáº¥p Ä‘á»‹a chá»‰ giao hÃ ng?")
    
    # âœ… STATE Má»šI: ASK_ADDRESS
    def _state_ask_address(self, conv, msg):
        """Há»i Ä‘á»‹a chá»‰ khÃ¡ch hÃ ng"""
        address = msg.strip()
        
        if len(address) < 5:
            self._send_text(conv, "Äá»‹a chá»‰ quÃ¡ ngáº¯n. Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ Ä‘á»‹a chá»‰!")
            return
        
        conv.sudo().write({
            'customer_address': address,
            'chatbot_state': 'show_products'
        })
        
        # Hiá»ƒn thá»‹ sáº£n pháº©m
        self._send_product_list(conv)
    
    def _state_show_products(self, conv, msg):
        if msg.startswith('PRODUCT_'):
            product_id = self._extract_product_id(msg)
            if product_id:
                self._handle_product_selection(conv, product_id)
    
    # âœ… STATE Má»šI: ASK_QUANTITY
    def _state_ask_quantity(self, conv, msg):
        """Há»i sá»‘ lÆ°á»£ng sáº£n pháº©m"""
        try:
            quantity = int(msg.strip())
            
            if quantity < 1:
                self._send_text(conv, "âŒ Sá»‘ lÆ°á»£ng pháº£i >= 1. Vui lÃ²ng nháº­p láº¡i!")
                return
            
            if quantity > 999:
                self._send_text(conv, "âŒ Sá»‘ lÆ°á»£ng quÃ¡ lá»›n (max 999). Vui lÃ²ng nháº­p láº¡i!")
                return
            
            # LÆ°u sá»‘ lÆ°á»£ng
            conv.sudo().write({
                'product_quantity': quantity,
                'chatbot_state': 'confirm_order'
            })
            
            # Hiá»ƒn thá»‹ xÃ¡c nháº­n
            product = conv.selected_product_ids[0]  # Láº¥y sáº£n pháº©m Ä‘Ã£ chá»n
            price_unit = product.price
            total = price_unit * quantity
            
            confirm_msg = """âœ… XÃ¡c nháº­n Ä‘Æ¡n hÃ ng:

ğŸ“¦ Sáº£n pháº©m: %s
ğŸ”¢ Sá»‘ lÆ°á»£ng: %d
ğŸ’° ÄÆ¡n giÃ¡: %s Ä‘
ğŸ’µ Tá»•ng tiá»n: %s Ä‘

ğŸ‘¤ KhÃ¡ch hÃ ng: %s
ğŸ“ SÄT: %s
ğŸ“ Äá»‹a chá»‰: %s

XÃ¡c nháº­n Ä‘áº·t hÃ ng?
ğŸ‘‰ "CÃ³" / "KhÃ´ng" """ % (
                product.product_id.name,
                quantity,
                "{:,.0f}".format(price_unit),
                "{:,.0f}".format(total),
                conv.customer_name,
                conv.customer_phone,
                conv.customer_address or 'ChÆ°a cÃ³'
            )
            
            self._send_text(conv, confirm_msg)
            
        except ValueError:
            self._send_text(conv, "âŒ Vui lÃ²ng nháº­p sá»‘ lÆ°á»£ng há»£p lá»‡ (vÃ­ dá»¥: 1, 2, 5...)")
    
    def _state_confirm_order(self, conv, msg):
        """âœ… XÃC NHáº¬N VÃ€ Táº O ORDER + CRM LEAD"""
        msg_lower = msg.lower().strip()
        
        if any(kw in msg_lower for kw in ['cÃ³', 'yes', 'ok', 'Ä‘á»“ng Ã½']):
            
            try:
                # Validate
                validation = self._validate_order_data(conv)
                if not validation['valid']:
                    self._send_text(conv, "âŒ Dá»¯ liá»‡u khÃ´ng há»£p lá»‡: %s" % validation['errors'])
                    return
                
                # âœ… Táº O PARTNER
                Partner = request.env['res.partner'].with_context(tracking_disable=True).sudo()
                
                partner = Partner.search([
                    ('phone', '=', conv.customer_phone),
                ], limit=1)
                
                if not partner:
                    # Get Facebook tag
                    Tag = request.env['res.partner.category'].sudo()
                    facebook_tag = Tag.search([('name', '=ilike', 'Facebook-Messenger')], limit=1)
                    if not facebook_tag:
                        facebook_tag = Tag.create({'name': 'Facebook-Messenger', 'color': 4})
                    
                    # âœ… CREATE PARTNER Vá»šI Äá»ŠA CHá»ˆ
                    partner = Partner.create({
                        'name': conv.customer_name,
                        'phone': conv.customer_phone,
                        'street': conv.customer_address,  # âœ… Äá»ŠA CHá»ˆ
                        'company_type': 'person',
                        'category_id': [(6, 0, [facebook_tag.id])],
                    })
                else:
                    # âœ… Cáº¬P NHáº¬T Äá»ŠA CHá»ˆ Náº¾U CHÆ¯A CÃ“
                    if not partner.street and conv.customer_address:
                        partner.write({'street': conv.customer_address})
                
                # âœ… Táº O SALE ORDER
                SaleOrder = request.env['sale.order'].with_context(tracking_disable=True).sudo()
                
                order = SaleOrder.create({
                    'partner_id': partner.id,
                    'date_order': fields.Datetime.now(),
                })
                
                # âœ… THÃŠM PRODUCTS Vá»šI Sá» LÆ¯á»¢NG
                OrderLine = request.env['sale.order.line'].with_context(tracking_disable=True).sudo()
                
                quantity = conv.product_quantity or 1
                
                for product in conv.selected_product_ids:
                    OrderLine.create({
                        'order_id': order.id,
                        'product_id': product.product_id.id,
                        'product_uom_qty': quantity,  # âœ… Sá» LÆ¯á»¢NG
                        'price_unit': product.price,
                    })
                
                # âœ…âœ…âœ… Táº O CRM LEAD âœ…âœ…âœ…
                self._create_crm_lead(conv, partner, order)
                
                # âœ… SUCCESS MESSAGE
                success_msg = """ğŸ‰ Äáº·t hÃ ng thÃ nh cÃ´ng!

ğŸ“ MÃ£ Ä‘Æ¡n hÃ ng: %s
ğŸ‘¤ KhÃ¡ch hÃ ng: %s
ğŸ“ SÄT: %s
ğŸ“ Äá»‹a chá»‰: %s
ğŸ’° Tá»•ng tiá»n: %s Ä‘

âœ… ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c ghi nháº­n!
âœ… ThÃ´ng tin Ä‘Ã£ Ä‘Æ°á»£c lÆ°u vÃ o há»‡ thá»‘ng CRM!
Cáº£m Æ¡n báº¡n! ğŸ™""" % (
                    order.name,
                    conv.customer_name,
                    conv.customer_phone,
                    conv.customer_address or 'ChÆ°a cáº­p nháº­t',
                    "{:,.0f}".format(order.amount_total)
                )
                
                self._send_text(conv, success_msg)
                
                conv.sudo().write({'chatbot_state': 'completed'})
                self._set_cooldown(conv)
                
            except Exception as e:
                import traceback
                _logger.error('âŒ ORDER FAILED: %s', str(e))
                _logger.error(traceback.format_exc())
                
                conv.sudo().write({'chatbot_state': 'idle'})
                self._send_text(conv, "âŒ CÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i!")
        
        elif any(kw in msg_lower for kw in ['khÃ´ng', 'no']):
            conv.sudo().write({
                'chatbot_state': 'show_products',
                'selected_product_ids': [(5, 0, 0)],
                'product_quantity': 0,
            })
            self._send_text(conv, "ÄÃ£ há»§y. Chá»n láº¡i!")
            self._send_product_list(conv)
        else:
            self._send_text(conv, 'Vui lÃ²ng gá»­i "CÃ³" hoáº·c "KhÃ´ng"')
    
    def _state_completed(self, conv, msg):
        if self._is_in_cooldown(conv):
            self._send_text(conv, "ÄÆ¡n hÃ ng Ä‘ang xá»­ lÃ½...")
        else:
            conv.sudo().write({'chatbot_state': 'idle'})
            self._state_idle(conv, msg)
    
    # =========================================================================
    # âœ… HELPER: Táº O CRM LEAD
    # =========================================================================
    
    def _create_crm_lead(self, conv, partner, order):
        """
        Táº¡o CRM Lead tá»« order Messenger.
        
        Args:
            conv: Conversation record
            partner: res.partner record
            order: sale.order record
        """
        try:
            Lead = request.env['crm.lead'].with_context(tracking_disable=True).sudo()
            
            # Get Facebook-Messenger tag
            LeadTag = request.env['crm.tag'].sudo()
            fb_tag = LeadTag.search([('name', '=ilike', 'Facebook-Messenger')], limit=1)
            if not fb_tag:
                fb_tag = LeadTag.create({
                    'name': 'Facebook-Messenger',
                    'color': 4,
                })
            
            # âœ… Táº O LEAD
            lead = Lead.create({
                'name': 'FB Lead - %s' % partner.name,
                'type': 'opportunity',
                'partner_id': partner.id,  # âœ… CONTACT
                'contact_name': partner.name,
                'phone': partner.phone,
                'street': partner.street,
                'expected_revenue': order.amount_total,  # âœ… EXPECTED REVENUE
                'tag_ids': [(6, 0, [fb_tag.id])],  # âœ… TAG
                'description': (
                    'Lead táº¡o tá»« Facebook Messenger Chatbot\n'
                    'PSID: %s\n'
                    'ÄÆ¡n hÃ ng: %s\n'
                    'Tá»•ng tiá»n: %s Ä‘'
                ) % (
                    conv.facebook_user_id,
                    order.name,
                    "{:,.0f}".format(order.amount_total)
                ),
            })
            
            _logger.info('âœ… Created CRM Lead: %s (ID: %s)', lead.name, lead.id)
            
            # Gáº¯n lead vÃ o conversation
            conv.sudo().write({'lead_id': lead.id})
            
        except Exception as e:
            _logger.error('âŒ Failed to create CRM Lead: %s', e)
    
    # =========================================================================
    # HELPER METHODS
    # =========================================================================
    
    def _handle_product_selection(self, conv, product_id):
        try:
            product = request.env['social.messenger.product'].sudo().browse(product_id)
            
            if not product.exists():
                self._send_text(conv, "âŒ Sáº£n pháº©m khÃ´ng tá»“n táº¡i!")
                return
            
            conv.sudo().write({
                'selected_product_ids': [(6, 0, [product.id])],
                'chatbot_state': 'ask_quantity'  # âœ… Äá»”I STATE
            })
            
            # âœ… Há»I Sá» LÆ¯á»¢NG
            ask_qty_msg = """âœ… Báº¡n Ä‘Ã£ chá»n: %s

ğŸ”¢ Báº¡n muá»‘n mua bao nhiÃªu?
ğŸ‘‰ Vui lÃ²ng nháº­p sá»‘ lÆ°á»£ng (VD: 1, 2, 5...)""" % product.product_id.name
            
            self._send_text(conv, ask_qty_msg)
            
        except Exception as e:
            _logger.error('âŒ Product selection error: %s', e)
    
    def _send_text(self, conv, text):
        url = 'https://graph.facebook.com/v18.0/me/messages'
        
        payload = {
            'recipient': {'id': conv.facebook_user_id},
            'message': {'text': text},
            'messaging_type': 'RESPONSE'
        }
        
        params = {'access_token': conv.account_id.access_token}
        
        try:
            resp = requests.post(url, json=payload, params=params, timeout=10)
            return resp.status_code == 200
        except:
            return False
    
    def _send_product_list(self, conv):
        products = request.env['social.messenger.product'].sudo().search([
            ('active', '=', True),
            ('company_id', '=', conv.company_id.id)
        ], order='sequence, id')
        
        if not products:
            self._send_text(conv, "Xin lá»—i, chÆ°a cÃ³ sáº£n pháº©m!")
            return
        
        product_list = "ğŸ“¦ Danh sÃ¡ch sáº£n pháº©m:\n\n"
        
        for idx, p in enumerate(products, 1):
            price = "{:,.0f}Ä‘".format(p.price) if p.price > 0 else "LiÃªn há»‡"
            product_list += "%s. %s - %s\n" % (idx, p.product_id.name, price)
        
        product_list += "\nğŸ‘‡ Chá»n sáº£n pháº©m:"
        
        quick_replies = []
        for p in products[:11]:
            quick_replies.append({
                'content_type': 'text',
                'title': p.quick_reply_title or p.product_id.name[:20],
                'payload': 'PRODUCT_%s' % p.id
            })
        
        url = 'https://graph.facebook.com/v18.0/me/messages'
        
        payload = {
            'recipient': {'id': conv.facebook_user_id},
            'message': {
                'text': product_list,
                'quick_replies': quick_replies
            },
            'messaging_type': 'RESPONSE'
        }
        
        params = {'access_token': conv.account_id.access_token}
        
        try:
            requests.post(url, json=payload, params=params, timeout=10)
        except:
            pass
    
    def _validate_order_data(self, conv):
        errors = []
        
        if not conv.customer_name:
            errors.append("Thiáº¿u tÃªn")
        if not conv.customer_phone:
            errors.append("Thiáº¿u SÄT")
        if not conv.customer_address:
            errors.append("Thiáº¿u Ä‘á»‹a chá»‰")
        if not conv.selected_product_ids:
            errors.append("ChÆ°a chá»n SP")
        if not hasattr(conv, 'product_quantity') or not conv.product_quantity:
            errors.append("Thiáº¿u sá»‘ lÆ°á»£ng")
        
        return {
            'valid': len(errors) == 0,
            'errors': ', '.join(errors)
        }
    
    def _set_cooldown(self, conv):
        try:
            cooldown_until = datetime.now() + timedelta(seconds=15)
            conv.sudo().write({'cooldown_until': cooldown_until})
        except:
            pass
    
    def _is_in_cooldown(self, conv):
        if not hasattr(conv, 'cooldown_until'):
            return False
        return conv.cooldown_until and conv.cooldown_until > datetime.now()
    
    def _extract_product_id(self, payload):
        try:
            return int(payload.replace('PRODUCT_', ''))
        except:
            return None
    
    def _find_or_create_conversation(self, sender_id, recipient_id):
        account = request.env['social.account'].sudo().search([
            ('facebook_page_id', '=', recipient_id)
        ], limit=1)
        
        if not account:
            return None
        
        conv = request.env['social.message'].sudo().search([
            ('facebook_user_id', '=', sender_id),
            ('account_id', '=', account.id),
        ], limit=1)
        
        if conv:
            return conv
        
        conv_vals = {
            'facebook_user_id': sender_id,
            'account_id': account.id,
            'company_id': account.company_id.id,
            'chatbot_state': 'idle',
        }
        
        try:
            return request.env['social.message'].sudo().create(conv_vals)
        except:
            return None



################################################################################
## FILE 6: chatbot_data.xml
## ÄÆ°á»ng dáº«n: data/chatbot_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!-- Purchase Intent Rule - Vietnamese -->
        <record id="chatbot_rule_purchase_intent_vietnamese" model="social.chatbot.automation">
            <field name="name">Mua hÃ ng - Tiáº¿ng Viá»‡t</field>
            <field name="trigger_keywords">mua,Ä‘áº·t hÃ ng,muá»‘n mua,Ä‘áº·t mua</field>
            <field name="response_text">Cáº£m Æ¡n báº¡n Ä‘Ã£ quan tÃ¢m Ä‘áº¿n sáº£n pháº©m cá»§a chÃºng tÃ´i! ğŸ‰

TÃ´i Ä‘Ã£ ghi nháº­n nhu cáº§u mua hÃ ng cá»§a báº¡n vÃ  Ä‘á»™i ngÅ© tÆ° váº¥n sáº½ liÃªn há»‡ vá»›i báº¡n trong thá»i gian sá»›m nháº¥t.

Äá»ƒ Ä‘Æ°á»£c há»— trá»£ nhanh hÆ¡n, báº¡n vui lÃ²ng cho tÃ´i biáº¿t:
- Sáº£n pháº©m báº¡n quan tÃ¢m
- Sá»‘ lÆ°á»£ng cáº§n mua
- Thá»i gian dá»± kiáº¿n nháº­n hÃ ng

Xin cáº£m Æ¡n! ğŸ™</field>
            <field name="priority">100</field>
            <field name="active" eval="True"/>
        </record>

        <!-- Purchase Intent Rule - English -->
        <record id="chatbot_rule_purchase_intent_english" model="social.chatbot.automation">
            <field name="name">Purchase - English</field>
            <field name="trigger_keywords">buy,order,purchase,want to buy</field>
            <field name="response_text">Thank you for your interest in our products! ğŸ‰

I've noted your purchase request and our sales team will contact you as soon as possible.

For faster assistance, please provide:
- Product(s) you're interested in
- Quantity needed
- Expected delivery time

Thank you! ğŸ™</field>
            <field name="priority">100</field>
            <field name="active" eval="True"/>
        </record>

        <!-- Greeting Rule -->
        <record id="chatbot_rule_greeting" model="social.chatbot.automation">
            <field name="name">ChÃ o há»i</field>
            <field name="trigger_keywords">xin chÃ o,chÃ o,hello,hi,hey</field>
            <field name="response_text">Xin chÃ o! ğŸ‘‹ Cáº£m Æ¡n báº¡n Ä‘Ã£ nháº¯n tin cho chÃºng tÃ´i.

TÃ´i cÃ³ thá»ƒ giÃºp gÃ¬ cho báº¡n hÃ´m nay?</field>
            <field name="priority">50</field>
            <field name="active" eval="True"/>
        </record>

        <!-- Pricing Rule -->
        <record id="chatbot_rule_pricing" model="social.chatbot.automation">
            <field name="name">Há»i giÃ¡</field>
            <field name="trigger_keywords">giÃ¡,bao nhiÃªu,price,cost,how much</field>
            <field name="response_text">Äá»ƒ tÆ° váº¥n giÃ¡ chÃ­nh xÃ¡c nháº¥t, báº¡n vui lÃ²ng cho tÃ´i biáº¿t:
- Sáº£n pháº©m báº¡n quan tÃ¢m
- Sá»‘ lÆ°á»£ng cáº§n mua

Äá»™i ngÅ© cá»§a chÃºng tÃ´i sáº½ bÃ¡o giÃ¡ chi tiáº¿t trong thá»i gian sá»›m nháº¥t! ğŸ’°</field>
            <field name="priority">70</field>
            <field name="active" eval="True"/>
        </record>

    </data>
</odoo>



################################################################################
## FILE 7: facebook_post_template_data.xml
## ÄÆ°á»ng dáº«n: data/facebook_post_template_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!-- TEMPLATE BÃ€I ÄÄ‚NG MáºªU -->

        <record id="template_new_product_launch" model="social.post.template">
            <field name="name">ğŸš€ Ra Máº¯t Sáº£n Pháº©m Má»›i</field>
            <field name="template_type">product_launch</field>
            <field name="content"><![CDATA[ğŸ‰ EXCITING NEWS! ğŸ‰

We're thrilled to announce our latest product: {{product_name}}!

âœ¨ Key Features:
{{feature_list}}

ğŸ’° Special Launch Price: {{price}}
ğŸ Limited time offer: {{offer_details}}

ğŸ‘‰ Shop now: {{shop_link}}

#NewProduct #Launch #{{company_name}}]]></field>
        </record>

        <record id="template_flash_sale" model="social.post.template">
            <field name="name">âš¡ Flash Sale</field>
            <field name="template_type">promotion</field>
            <field name="content"><![CDATA[âš¡ FLASH SALE ALERT! âš¡

ğŸ”¥ {{discount_percentage}}% OFF on {{product_category}}!

â° Hurry! Only {{hours_left}} hours left!
ğŸ›’ Shop now: {{shop_link}}

Don't miss out on this amazing deal! ğŸ¯

#FlashSale #Discount #LimitedOffer #{{company_name}}]]></field>
        </record>

        <record id="template_customer_testimonial" model="social.post.template">
            <field name="name">ğŸ’¬ ÄÃ¡nh GiÃ¡ KhÃ¡ch HÃ ng</field>
            <field name="template_type">testimonial</field>
            <field name="content"><![CDATA[â­â­â­â­â­

"{{testimonial_text}}"

- {{customer_name}}

Thank you for your amazing feedback! ğŸ’™

We love hearing from our satisfied customers. Your trust means the world to us! ğŸ™

#CustomerLove #Testimonial #{{company_name}}]]></field>
        </record>

        <record id="template_weekly_tips" model="social.post.template">
            <field name="name">ğŸ’¡ Tips HÃ ng Tuáº§n</field>
            <field name="template_type">educational</field>
            <field name="content"><![CDATA[ğŸ’¡ TIP OF THE WEEK ğŸ’¡

{{tip_title}}

{{tip_description}}

ğŸ‘‰ Try it out and let us know your results!

Have questions? Drop them in the comments below! ğŸ‘‡

#Tips #DidYouKnow #{{company_name}}]]></field>
        </record>

        <record id="template_behind_the_scenes" model="social.post.template">
            <field name="name">ğŸ¬ Behind The Scenes</field>
            <field name="template_type">engagement</field>
            <field name="content"><![CDATA[ğŸ¬ BEHIND THE SCENES ğŸ¬

Ever wondered how we {{process_description}}?

Here's a sneak peek into our {{department_name}} team! ğŸ‘€

{{additional_details}}

Drop a â¤ï¸ if you'd like to see more behind-the-scenes content!

#BehindTheScenes #TeamWork #{{company_name}}]]></field>
        </record>

        <record id="template_event_announcement" model="social.post.template">
            <field name="name">ğŸ“… ThÃ´ng BÃ¡o Sá»± Kiá»‡n</field>
            <field name="template_type">event</field>
            <field name="content"><![CDATA[ğŸ“… SAVE THE DATE! ğŸ“…

{{event_name}}

ğŸ“ Location: {{location}}
ğŸ—“ï¸ Date: {{event_date}}
â° Time: {{event_time}}

{{event_description}}

ğŸŸï¸ Register now: {{registration_link}}

Limited seats available! Don't miss out! ğŸ¯

#Event #SaveTheDate #{{company_name}}]]></field>
        </record>

    </data>
</odoo>



################################################################################
## FILE 8: ir_cron_data.xml
## ÄÆ°á»ng dáº«n: data/ir_cron_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- CRON JOBS - Facebook Synchronization -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->

    <!-- Cron: Sync Facebook Posts -->
    <record id="cron_sync_facebook_posts" model="ir.cron">
        <field name="name">Facebook: Sync Posts</field>
        <field name="model_id" ref="model_social_post"/>
        <field name="state">code</field>
        <field name="code">model._cron_sync_posts()</field>
        <field name="interval_number">15</field>
        <field name="interval_type">minutes</field>
        <field name="active">True</field>
    </record>

    <!-- Cron: Sync Facebook Comments -->
    <record id="cron_sync_facebook_comments" model="ir.cron">
        <field name="name">Facebook: Sync Comments</field>
        <field name="model_id" ref="model_social_comment"/>
        <field name="state">code</field>
        <field name="code">model._cron_sync_comments()</field>
        <field name="interval_number">10</field>
        <field name="interval_type">minutes</field>
        <field name="active">True</field>
    </record>

    <!-- Cron: Publish Scheduled Posts -->
    <record id="cron_publish_scheduled_posts" model="ir.cron">
        <field name="name">Facebook: Publish Scheduled Posts</field>
        <field name="model_id" ref="model_social_post"/>
        <field name="state">code</field>
        <field name="code">model._cron_publish_scheduled_posts()</field>
        <field name="interval_number">5</field>
        <field name="interval_type">minutes</field>
        <field name="active">True</field>
    </record>

    <!-- 
    NOTE: Ngrok health check Ä‘Ã£ bá»‹ XÃ“A
    LÃ½ do: Odoo 19 cáº¥m opcode IMPORT_NAME trong cron code
    Náº¿u cáº§n kiá»ƒm tra ngrok, dÃ¹ng external monitoring tool
    -->

</odoo>



################################################################################
## FILE 9: mail_template_data.xml
## ÄÆ°á»ng dáº«n: data/mail_template_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!-- EMAIL NOTIFICATION TEMPLATES -->

        <record id="mail_template_post_published" model="mail.template">
            <field name="name">Social Facebook: Post Published</field>
            <field name="model_id" ref="model_social_post"/>
            <field name="subject">Your Facebook post has been published</field>
            <field name="body_html"><![CDATA[
<div style="font-family: Arial, sans-serif;">
    <h3>Post Published Successfully!</h3>
    <p>Your post has been published to Facebook:</p>
    <blockquote style="border-left: 3px solid #1877f2; padding-left: 10px;">
        ${object.content}
    </blockquote>
    <p>
        <strong>Page:</strong> ${object.account_id.name}<br/>
        <strong>Published:</strong> ${object.published_date}<br/>
    </p>
    <p><a href="${object.facebook_post_url}" style="color: #1877f2;">View on Facebook</a></p>
</div>
            ]]></field>
        </record>

        <record id="mail_template_new_comment" model="mail.template">
            <field name="name">Social Facebook: New Comment</field>
            <field name="model_id" ref="model_social_comment"/>
            <field name="subject">New comment on your Facebook post</field>
            <field name="body_html"><![CDATA[
<div style="font-family: Arial, sans-serif;">
    <h3>New Comment Received!</h3>
    <p><strong>${object.author_name}</strong> commented:</p>
    <blockquote style="border-left: 3px solid #1877f2; padding-left: 10px;">
        ${object.message}
    </blockquote>
    <p>On post: "${object.post_id.content[:100]}..."</p>
    <p><a href="/web#id=${object.id}&model=social.comment" style="color: #1877f2;">Reply in Odoo</a></p>
</div>
            ]]></field>
        </record>

    </data>
</odoo>



################################################################################
## FILE 10: user_groups_data.xml
## ÄÆ°á»ng dáº«n: data/user_groups_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ThÃªm Admin vÃ o groups Social Facebook -->
    <!-- âœ… Sá»¬A: Äá»•i tÃªn group reference cho khá»›p -->
    <record id="base.user_admin" model="res.users">
        <field name="group_ids" eval="[(4, ref('module_social_facebook.group_social_facebook_manager'))]"/>
    </record>

</odoo>



################################################################################
## FILE 11: generate_doc_4.py
## ÄÆ°á»ng dáº«n: generate_doc_4.py
################################################################################

import os
import datetime

# -------------------------------------------------------------
# CONFIG
# -------------------------------------------------------------
OUTPUT_NAME = None  # None -> tá»± Ä‘áº·t tÃªn theo thÆ° má»¥c module

# ğŸš« ThÆ° má»¥c bá»‹ loáº¡i trá»« á»Ÿ má»i cáº¥p
EXCLUDED_DIRS = {
    "__pycache__",
    ".git",          # âœ… NEW: cháº·n thÆ° má»¥c git
}


# -------------------------------------------------------------
# HÃ€M Táº O BANNER
# -------------------------------------------------------------
def make_banner(module_name):
    banner = f"""
################################################################################
#                      {module_name.upper():<50}#
#                   ODOO MODULE DOCUMENTATION GENERATOR                     #
#                           Version 1.3.0 - Enterprise Style                #
################################################################################
"""
    return banner


# -------------------------------------------------------------
# HÃ€M QUÃ‰T FILES (Bá» QUA __pycache__, .git)
# -------------------------------------------------------------
def scan_files(root):
    file_list = []

    for base, dirs, files in os.walk(root):
        # ğŸ”¥ CHáº¶N __pycache__ & .git á» Má»ŒI Cáº¤P
        dirs[:] = [d for d in dirs if d not in EXCLUDED_DIRS]

        dirs.sort()
        files.sort()

        for f in files:
            full_path = os.path.join(base, f)
            rel = os.path.relpath(full_path, root).replace("\\", "/")
            file_list.append(rel)

    return file_list


# -------------------------------------------------------------
# HÃ€M XÃC Äá»ŠNH LOáº I FILE
# -------------------------------------------------------------
def detect_type(file):
    ext = file.lower().split(".")[-1]
    if ext == "py":
        return "Python"
    if ext == "xml":
        return "XML"
    if ext == "csv":
        return "CSV"
    if ext == "js":
        return "JS"
    if ext == "css":
        return "CSS"
    if ext in ["png", "jpg", "jpeg", "svg"]:
        return "Image"
    return "Other"


# -------------------------------------------------------------
# HÃ€M SINH CÃ‚Y THÆ¯ Má»¤C Dáº NG TREE (ASCII)
# -------------------------------------------------------------
def generate_directory_tree(files):
    if not files:
        return ""

    tree = {}
    for path in files:
        parts = path.split("/")
        current = tree
        for part in parts:
            current = current.setdefault(part, {})

    lines = []

    def render(node, prefix="", is_root=True):
        items = list(node.items())
        for i, (name, children) in enumerate(items):
            is_last = (i == len(items) - 1)

            if is_root:
                connector = ""
                new_prefix = ""
            else:
                connector = "â””â”€â”€ " if is_last else "â”œâ”€â”€ "
                new_prefix = prefix + ("    " if is_last else "â”‚   ")

            icon = "ğŸ“" if children else "ğŸ“„"
            lines.append(f"{prefix}{connector}{icon} {name}")

            if children:
                render(children, new_prefix, is_root=False)

    render(tree)

    return "\n".join([
        "================================================================================",
        "                                ğŸ“‚ DIRECTORY TREE",
        "================================================================================",
        "\n".join(lines),
        "\n"
    ])


# -------------------------------------------------------------
# HÃ€M SINH Cáº¤U TRÃšC THÆ¯ Má»¤C Dáº NG STT
# -------------------------------------------------------------
def generate_tree(files, root):
    lines = []
    counter = 1

    lines.append("================================================================================")
    lines.append(f"                              Cáº¤U TRÃšC THÆ¯ Má»¤C - {len(files)} FILES")
    lines.append("================================================================================\n")

    for f in files:
        lines.append(f"{counter:>3}.  {f}")
        counter += 1

    lines.append("\n")
    return "\n".join(lines)


# -------------------------------------------------------------
# HÃ€M SINH Báº¢NG Tá»”NG Káº¾T FILES
# -------------------------------------------------------------
def generate_summary(files):
    lines = []

    lines.append("================================================================================")
    lines.append(f"                         Báº¢NG Tá»”NG Káº¾T {len(files)} FILES")
    lines.append("================================================================================")
    lines.append("â”‚  #  â”‚ ÄÆ°á»ng dáº«n file                                     â”‚ Loáº¡i     â”‚")
    lines.append("â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")

    for idx, f in enumerate(files, 1):
        ftype = detect_type(f)
        lines.append(f"â”‚ {idx:<3} â”‚ {f:<50} â”‚ {ftype:<8} â”‚")

    lines.append("\n")
    return "\n".join(lines)


# -------------------------------------------------------------
# HÃ€M Äá»ŒC Ná»˜I DUNG FILE
# -------------------------------------------------------------
def read_file(fullpath):
    try:
        with open(fullpath, "r", encoding="utf-8") as f:
            return f.read()
    except:
        return "[KhÃ´ng Ä‘á»c Ä‘Æ°á»£c file â€“ cÃ³ thá»ƒ lÃ  binary hoáº·c lá»—i mÃ£ hÃ³a]"


# -------------------------------------------------------------
# HÃ€M SINH Ná»˜I DUNG CÃC FILE
# -------------------------------------------------------------
def generate_file_contents(files, root):
    lines = []

    lines.append("\n================================================================================")
    lines.append("                              Ná»˜I DUNG CÃC FILES")
    lines.append("================================================================================\n")

    for idx, f in enumerate(files, 1):
        fullpath = os.path.join(root, f)

        lines.append("################################################################################")
        lines.append(f"## FILE {idx}: {os.path.basename(f)}")
        lines.append(f"## ÄÆ°á»ng dáº«n: {f}")
        lines.append("################################################################################\n")

        lines.append(read_file(fullpath))
        lines.append("\n\n")

    return "\n".join(lines)


# -------------------------------------------------------------
# MAIN
# -------------------------------------------------------------
def main():
    root = os.path.dirname(os.path.abspath(__file__))
    module_name = os.path.basename(root)

    now = datetime.datetime.now().strftime("%Y-%m-%d_%Hh%M")
    output_file = OUTPUT_NAME or f"{module_name}_DOCUMENTATION_{now}.txt"

    files = sorted(scan_files(root))

    output = [
        make_banner(module_name),
        generate_directory_tree(files),
        generate_tree(files, root),
        generate_summary(files),
        generate_file_contents(files, root),
    ]

    with open(output_file, "w", encoding="utf-8") as f:
        f.write("\n".join(output))

    print(f"\nDONE! File generated: {output_file}")


if __name__ == "__main__":
    main()




################################################################################
## FILE 12: __init__.py
## ÄÆ°á»ng dáº«n: lib/__init__.py
################################################################################

from . import facebook_api



################################################################################
## FILE 13: facebook_api.py
## ÄÆ°á»ng dáº«n: lib/facebook_api.py
################################################################################

# -*- coding: utf-8 -*-

import requests
import logging

_logger = logging.getLogger(__name__)


class FacebookAPI:
    """
    Wrapper for Facebook Graph API.
    Version: v18.0
    """
    
    API_VERSION = 'v18.0'
    BASE_URL = f'https://graph.facebook.com/{API_VERSION}'
    
    def __init__(self, access_token):
        """
        Initialize API wrapper.
        
        Args:
            access_token (str): Page Access Token
        """
        self.access_token = access_token
    
    # -------------------------------------------------------------------------
    # PAGE METHODS
    # -------------------------------------------------------------------------
    
    def get_page_info(self, page_id):
        """Get page information"""
        url = f"{self.BASE_URL}/{page_id}"
        params = {
            'access_token': self.access_token,
            'fields': 'id,name,category,picture,fan_count,link'
        }
        response = requests.get(url, params=params)
        return response.json()
    
    def publish_post(self, page_id, message, **kwargs):
        """Publish a post to page"""
        url = f"{self.BASE_URL}/{page_id}/feed"
        data = {
            'access_token': self.access_token,
            'message': message,
        }
        data.update(kwargs)
        response = requests.post(url, data=data)
        return response.json()
    
    # -------------------------------------------------------------------------
    # âœ… MESSENGER SEND API - FIXED
    # -------------------------------------------------------------------------
    
    def send_message(self, recipient_id, message_text):
        """
        âœ… FIX: Send text message via Messenger Send API.
        
        Args:
            recipient_id (str): PSID of recipient
            message_text (str): Text message to send
        
        Returns:
            dict: API response with message_id
            
        Example:
            >>> api = FacebookAPI('token123')
            >>> api.send_message('user456', 'Hello!')
            {'recipient_id': 'user456', 'message_id': 'mid.xxx'}
        """
        url = f"{self.BASE_URL}/me/messages"
        
        payload = {
            'recipient': {'id': recipient_id},
            'message': {'text': message_text},
            'messaging_type': 'RESPONSE'
        }
        
        params = {'access_token': self.access_token}
        
        try:
            response = requests.post(url, json=payload, params=params, timeout=30)
            response.raise_for_status()
            
            # âœ… FIX: Parse JSON an toÃ n
            try:
                result = response.json()
                
                # âœ… Check result lÃ  dict
                if isinstance(result, dict):
                    message_id = result.get('message_id', 'N/A')
                    _logger.info(f"âœ… Message sent to {recipient_id}: {message_id}")
                else:
                    # Result lÃ  list hoáº·c kiá»ƒu khÃ¡c
                    _logger.info(f"âœ… Message sent to {recipient_id}")
                    result = {'success': True}
                
                return result
                
            except Exception as json_error:
                _logger.warning(f"âš ï¸ JSON parse warning: {json_error}")
                return {'success': True}
            
        except requests.exceptions.HTTPError as e:
            # âœ… FIX: Handle HTTP errors
            try:
                error_data = e.response.json()
                
                # âœ… Check error_data type
                if isinstance(error_data, dict):
                    error_msg = error_data.get('error', {}).get('message', str(e))
                else:
                    error_msg = str(e)
            except:
                error_msg = str(e)
            
            _logger.error(f"âŒ Facebook API Error: {error_msg}")
            raise Exception(f"Facebook API Error: {error_msg}")
            
        except requests.exceptions.RequestException as e:
            _logger.error(f"âŒ Request failed: {e}")
            raise Exception(f"Failed to send message: {str(e)}")
    
    # -------------------------------------------------------------------------
    # CONVERSATION METHODS
    # -------------------------------------------------------------------------
    
    def get_conversation_messages(self, conversation_id, limit=25):
        """Get messages from a conversation"""
        url = f"{self.BASE_URL}/{conversation_id}"
        params = {
            'access_token': self.access_token,
            'fields': f'messages.limit({limit}){{id,created_time,from,to,message}}'
        }
        response = requests.get(url, params=params)
        return response.json()
    
    # -------------------------------------------------------------------------
    # LEADGEN API
    # -------------------------------------------------------------------------
    
    def get_leadgen_data(self, leadgen_id):
        """
        Láº¥y dá»¯ liá»‡u lead form tá»« Facebook.
        
        Endpoint: /{leadgen_id}
        Fields: field_data (contains name, phone, email, etc.)
        
        Args:
            leadgen_id (str): Lead generation ID from webhook
        
        Returns:
            dict: Lead data
                {
                    'id': '123',
                    'created_time': '2025-01-01T10:00:00+0000',
                    'field_data': [
                        {'name': 'full_name', 'values': ['John Doe']},
                        {'name': 'phone_number', 'values': ['+1234567890']},
                        {'name': 'email', 'values': ['john@example.com']},
                    ]
                }
        """
        url = f"{self.BASE_URL}/{leadgen_id}"
        params = {
            'access_token': self.access_token,
            'fields': 'id,created_time,field_data'
        }
        
        try:
            response = requests.get(url, params=params, timeout=10)
            response.raise_for_status()
            data = response.json()
            
            _logger.info(f'Successfully fetched leadgen data for {leadgen_id}')
            return data
            
        except requests.exceptions.RequestException as e:
            _logger.error(f'Failed to fetch leadgen {leadgen_id}: {e}')
            raise
    
    def get_leadgen_forms(self, page_id):
        """
        Láº¥y danh sÃ¡ch lead forms cá»§a page.
        
        Args:
            page_id (str): Facebook Page ID
        
        Returns:
            list: List of lead forms
        """
        url = f"{self.BASE_URL}/{page_id}/leadgen_forms"
        params = {
            'access_token': self.access_token,
            'fields': 'id,name,status,questions'
        }
        
        try:
            response = requests.get(url, params=params, timeout=10)
            response.raise_for_status()
            data = response.json()
            
            return data.get('data', [])
            
        except requests.exceptions.RequestException as e:
            _logger.error(f'Failed to fetch leadgen forms: {e}')
            return []
    
    # -------------------------------------------------------------------------
    # MESSENGER PROFILE API
    # -------------------------------------------------------------------------
    
    def set_get_started_button(self, payload='GET_STARTED'):
        """
        Set Get Started button for Messenger.
        
        Args:
            payload (str): Postback payload when button clicked
        """
        url = f"{self.BASE_URL}/me/messenger_profile"
        data = {
            'access_token': self.access_token,
            'get_started': {'payload': payload}
        }
        response = requests.post(url, json=data)
        return response.json()
    
    def set_greeting_text(self, greeting_text):
        """
        Set greeting text for Messenger.
        
        Args:
            greeting_text (str): Greeting message
        """
        url = f"{self.BASE_URL}/me/messenger_profile"
        data = {
            'access_token': self.access_token,
            'greeting': [
                {
                    'locale': 'default',
                    'text': greeting_text
                }
            ]
        }
        response = requests.post(url, json=data)
        return response.json()



################################################################################
## FILE 14: __init__.py
## ÄÆ°á»ng dáº«n: models/__init__.py
################################################################################

# -*- coding: utf-8 -*-

from . import crm_lead
from . import res_company
from . import res_config_settings
from . import social_account
from . import social_analytics
from . import social_comment
from . import social_conversation
from . import social_message
from . import social_messenger_order
from . import social_messenger_product
from . import social_post
from . import social_post_template
from . import social_chatbot_automation



################################################################################
## FILE 15: crm_lead.py
## ÄÆ°á»ng dáº«n: models/crm_lead.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _


class CrmLead(models.Model):
    """
    Má»Ÿ rá»™ng crm.lead Ä‘á»ƒ link vá»›i Facebook conversations.
    """
    _inherit = 'crm.lead'
    
    # Link to Facebook
    facebook_conversation_id = fields.Many2one(
        'social.message',
        string='Facebook Conversation',
        ondelete='set null',
        help='Conversation Messenger táº¡o ra lead nÃ y',
    )
    facebook_user_id = fields.Char(
        string='Facebook User ID',
        help='PSID cá»§a khÃ¡ch hÃ ng',
    )
    
    # Statistics
    messenger_message_count = fields.Integer(
        string='Messenger Messages',
        compute='_compute_messenger_stats',
        help='Sá»‘ tin nháº¯n trong conversation',
    )
    
    def _compute_messenger_stats(self):
        """TÃ­nh sá»‘ tin nháº¯n Messenger"""
        for lead in self:
            if lead.facebook_conversation_id:
                messages = self.env['social.message'].search_count([
                    ('conversation_id', '=', lead.facebook_conversation_id.id)
                ])
                lead.messenger_message_count = messages
            else:
                lead.messenger_message_count = 0
    
    def action_view_messenger_conversation(self):
        """Xem conversation Messenger"""
        self.ensure_one()
        if not self.facebook_conversation_id:
            return {'type': 'ir.actions.act_window_close'}
        
        return {
            'name': _('Messenger Conversation'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.message',
            'res_id': self.facebook_conversation_id.id,
            'view_mode': 'form',
            'target': 'current',
        }



################################################################################
## FILE 16: res_company.py
## ÄÆ°á»ng dáº«n: models/res_company.py
################################################################################

from odoo import models, fields


class ResCompany(models.Model):
    _inherit = 'res.company'

    facebook_app_id = fields.Char(
        string='Facebook App ID',
        help='Facebook App ID for authentication'
    )
    
    facebook_app_secret = fields.Char(
        string='Facebook App Secret',
        help='Facebook App Secret for authentication'
    )
    
    facebook_webhook_verify_token = fields.Char(
        string='Webhook Verify Token',
        help='Token for Facebook webhook verification'
    )




################################################################################
## FILE 17: res_config_settings.py
## ÄÆ°á»ng dáº«n: models/res_config_settings.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _
from odoo.exceptions import UserError
import subprocess
import requests
import logging
import os

_logger = logging.getLogger(__name__)


class ResConfigSettings(models.TransientModel):
    _inherit = 'res.config.settings'
    
    # -------------------------------------------------------------------------
    # FACEBOOK WEBHOOK CONFIG
    # -------------------------------------------------------------------------
    
    facebook_verify_token = fields.Char(
        string='Webhook Verify Token',
        config_parameter='module_social_facebook.verify_token',
        help='Token Ä‘á»ƒ verify webhook tá»« Facebook (GET request)',
    )
    facebook_webhook_url = fields.Char(
        string='Webhook URL',
        compute='_compute_webhook_url',
        help='URL webhook hiá»‡n táº¡i (localhost hoáº·c ngrok)',
    )
    
    # -------------------------------------------------------------------------
    # NGROK CONFIG
    # -------------------------------------------------------------------------
    
    ngrok_executable_path = fields.Char(
        string='Ngrok Executable Path',
        config_parameter='module_social_facebook.ngrok_path',
        default='C:/ngrok/ngrok.exe',
        help='ÄÆ°á»ng dáº«n Ä‘áº§y Ä‘á»§ tá»›i file ngrok.exe',
    )
    ngrok_tunnel_url = fields.Char(
        string='Ngrok Public URL',
        compute='_compute_ngrok_tunnel_url',
        help='URL cÃ´ng khai tá»« ngrok (https)',
    )
    ngrok_is_running = fields.Boolean(
        string='Ngrok Running',
        compute='_compute_ngrok_is_running',
        help='Tráº¡ng thÃ¡i ngrok',
    )
    
    # -------------------------------------------------------------------------
    # CRM INTEGRATION CONFIG
    # -------------------------------------------------------------------------
    
    auto_create_lead = fields.Boolean(
        string='Auto Create Leads',
        config_parameter='module_social_facebook.auto_create_lead',
        default=True,
        help='Tá»± Ä‘á»™ng táº¡o crm.lead tá»« Messenger conversations',
    )
    lead_default_user_id = fields.Many2one(
        'res.users',
        string='Default Salesperson',
        config_parameter='module_social_facebook.lead_default_user_id',
        help='NgÆ°á»i Ä‘Æ°á»£c assign lead máº·c Ä‘á»‹nh',
    )
    
    # -------------------------------------------------------------------------
    # CHATBOT CONFIG
    # -------------------------------------------------------------------------
    
    chatbot_enabled = fields.Boolean(
        string='Enable Sales Chatbot',
        config_parameter='module_social_facebook.chatbot_enabled',
        default=False,
        help='Báº­t chatbot bÃ¡n hÃ ng tá»± Ä‘á»™ng qua Messenger',
    )
    chatbot_welcome_message = fields.Text(
        string='Welcome Message',
        config_parameter='module_social_facebook.chatbot_welcome_message',
        default='Xin chÃ o! TÃ´i lÃ  trá»£ lÃ½ bÃ¡n hÃ ng tá»± Ä‘á»™ng. ğŸ˜Š\nBáº¡n vui lÃ²ng cho tÃ´i biáº¿t tÃªn cá»§a báº¡n?',
        help='Tin nháº¯n chÃ o má»«ng khi báº¯t Ä‘áº§u flow',
    )
    
    # -------------------------------------------------------------------------
    # COMPUTE METHODS
    # -------------------------------------------------------------------------
    
    @api.depends('ngrok_tunnel_url')
    def _compute_webhook_url(self):
        """TÃ­nh toÃ¡n webhook URL (ngrok hoáº·c localhost)"""
        for record in self:
            base_url = record.ngrok_tunnel_url or self.env['ir.config_parameter'].sudo().get_param('web.base.url', 'http://localhost:8069')
            record.facebook_webhook_url = f"{base_url}/social/facebook/webhook"
    
    def _compute_ngrok_tunnel_url(self):
        """Láº¥y URL ngrok tá»« API"""
        for record in self:
            try:
                # Query ngrok API (default: http://127.0.0.1:4040/api/tunnels)
                response = requests.get('http://127.0.0.1:4040/api/tunnels', timeout=2)
                if response.status_code == 200:
                    data = response.json()
                    tunnels = data.get('tunnels', [])
                    for tunnel in tunnels:
                        if tunnel.get('proto') == 'https':
                            record.ngrok_tunnel_url = tunnel.get('public_url')
                            return
                record.ngrok_tunnel_url = False
            except Exception as e:
                _logger.debug(f'Failed to get ngrok URL: {e}')
                record.ngrok_tunnel_url = False
    
    def _compute_ngrok_is_running(self):
        """Kiá»ƒm tra ngrok cÃ³ Ä‘ang cháº¡y khÃ´ng"""
        for record in self:
            record.ngrok_is_running = bool(record.ngrok_tunnel_url)
    
    # -------------------------------------------------------------------------
    # NGROK ACTIONS
    # -------------------------------------------------------------------------
    
    def action_start_ngrok(self):
        """
        Khá»Ÿi Ä‘á»™ng ngrok subprocess.
        
        Command: ngrok.exe http 8069
        Process cháº¡y background, khÃ´ng block Odoo.
        """
        self.ensure_one()
        
        ngrok_path = self.ngrok_executable_path or 'C:/ngrok/ngrok.exe'
        
        # Check if file exists
        if not os.path.exists(ngrok_path):
            raise UserError(_(
                'Ngrok executable not found at: %s\n'
                'Please update the path in settings!'
            ) % ngrok_path)
        
        # Check if already running
        if self.ngrok_is_running:
            raise UserError(_('Ngrok is already running!'))
        
        try:
            # Start ngrok subprocess
            # Use Popen to run in background
            subprocess.Popen(
                [ngrok_path, 'http', '8069'],
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
                creationflags=subprocess.CREATE_NEW_CONSOLE if os.name == 'nt' else 0
            )
            
            _logger.info('Ngrok started successfully')
            
            return {
                'type': 'ir.actions.client',
                'tag': 'display_notification',
                'params': {
                    'title': _('Success'),
                    'message': _('Ngrok started! Please wait 5 seconds then refresh to see the URL.'),
                    'type': 'success',
                    'sticky': False,
                }
            }
            
        except Exception as e:
            _logger.error(f'Failed to start ngrok: {e}')
            raise UserError(_(
                'Failed to start ngrok: %s\n'
                'Please check the executable path and try again.'
            ) % str(e))
    
    def action_stop_ngrok(self):
        """
        Dá»«ng ngrok process.
        
        Kill táº¥t cáº£ process ngrok Ä‘ang cháº¡y.
        """
        self.ensure_one()
        
        try:
            if os.name == 'nt':  # Windows
                subprocess.run(['taskkill', '/F', '/IM', 'ngrok.exe'], 
                             stdout=subprocess.DEVNULL, 
                             stderr=subprocess.DEVNULL)
            else:  # Linux/Mac
                subprocess.run(['pkill', 'ngrok'], 
                             stdout=subprocess.DEVNULL, 
                             stderr=subprocess.DEVNULL)
            
            _logger.info('Ngrok stopped')
            
            return {
                'type': 'ir.actions.client',
                'tag': 'display_notification',
                'params': {
                    'title': _('Success'),
                    'message': _('Ngrok stopped successfully!'),
                    'type': 'success',
                    'sticky': False,
                }
            }
            
        except Exception as e:
            _logger.error(f'Failed to stop ngrok: {e}')
            raise UserError(_('Failed to stop ngrok: %s') % str(e))
    
    def action_refresh_ngrok_url(self):
        """Refresh Ä‘á»ƒ láº¥y ngrok URL má»›i"""
        self._compute_ngrok_tunnel_url()
        
        if self.ngrok_tunnel_url:
            message = _('Ngrok URL: %s') % self.ngrok_tunnel_url
            msg_type = 'success'
        else:
            message = _('Ngrok is not running or URL not available.')
            msg_type = 'warning'
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Ngrok Status'),
                'message': message,
                'type': msg_type,
                'sticky': False,
            }
        }
    
    def action_copy_webhook_url(self):
        """Copy webhook URL to clipboard (via notification)"""
        self.ensure_one()
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Webhook URL'),
                'message': _('Webhook URL: %s\nCopy vÃ  dÃ¡n vÃ o Facebook App Settings!') % self.facebook_webhook_url,
                'type': 'info',
                'sticky': True,
            }
        }
    



################################################################################
## FILE 18: social_account.py
## ÄÆ°á»ng dáº«n: models/social_account.py
################################################################################

from odoo import models, fields, api, _
from odoo.exceptions import UserError
import requests
import logging

_logger = logging.getLogger(__name__)


class SocialAccount(models.Model):
    _name = 'social.account'
    _description = 'Facebook Account'
    _order = 'name'
    _inherit = ['mail.thread', 'mail.activity.mixin']

    name = fields.Char(string='Page Name', required=True, tracking=True)
    platform = fields.Selection([('facebook', 'Facebook')], string='Platform', default='facebook', required=True)
    facebook_page_id = fields.Char(string='Facebook Page ID', required=True, tracking=True)
    facebook_page_url = fields.Char(string='Page URL', compute='_compute_page_url', store=True)
    
    access_token = fields.Char(string='Access Token', required=True)
    token_expires_at = fields.Datetime(string='Token Expires At')
    is_token_valid = fields.Boolean(string='Token Valid', compute='_compute_token_valid')
    
    page_category = fields.Char(string='Category')
    page_about = fields.Text(string='About')
    followers_count = fields.Integer(string='Followers', default=0)
    likes_count = fields.Integer(string='Likes', default=0)
    page_rating = fields.Float(string='Rating', digits=(2, 1))
    profile_picture_url = fields.Char(string='Profile Picture URL')
    cover_photo_url = fields.Char(string='Cover Photo URL')
    
    active = fields.Boolean(string='Active', default=True)
    state = fields.Selection([
        ('draft', 'Draft'),
        ('connected', 'Connected'),
        ('error', 'Error'),
    ], string='Status', default='draft', tracking=True)
    
    last_sync_date = fields.Datetime(string='Last Sync')
    last_message_sync_date = fields.Datetime(string='Last Message Sync')
    error_message = fields.Text(string='Error Message')
    
    auto_sync_comments = fields.Boolean(string='Auto Sync Comments', default=True)
    auto_sync_messages = fields.Boolean(string='Auto Sync Messages', default=True)
    
    company_id = fields.Many2one('res.company', string='Company', default=lambda self: self.env.company)
    post_ids = fields.One2many('social.post', 'account_id', string='Posts')
    post_count = fields.Integer(string='Posts', compute='_compute_post_count')
    
    # âœ… THÃŠM: Field Ä‘áº¿m conversations
    conversation_count = fields.Integer(string='Conversations', compute='_compute_conversation_count')
    
    _sql_constraints = [
        ('facebook_page_id_uniq', 'UNIQUE(facebook_page_id, company_id)', 
         'Facebook Page ID must be unique per company!'),
    ]
    
    @api.depends('facebook_page_id')
    def _compute_page_url(self):
        for account in self:
            if account.facebook_page_id:
                account.facebook_page_url = f'https://www.facebook.com/{account.facebook_page_id}'
            else:
                account.facebook_page_url = False
    
    @api.depends('token_expires_at')
    def _compute_token_valid(self):
        now = fields.Datetime.now()
        for account in self:
            if account.token_expires_at:
                account.is_token_valid = account.token_expires_at > now
            else:
                account.is_token_valid = True
    
    def _compute_post_count(self):
        for account in self:
            account.post_count = len(account.post_ids)
    
    # âœ… THÃŠM: Compute conversation count
    def _compute_conversation_count(self):
        for account in self:
            account.conversation_count = self.env['social.conversation'].search_count([
                ('account_id', '=', account.id)
            ])
    
    def action_test_connection(self):
        self.ensure_one()
        try:
            url = f'https://graph.facebook.com/v18.0/{self.facebook_page_id}'
            params = {'access_token': self.access_token, 'fields': 'id,name,category'}
            response = requests.get(url, params=params, timeout=10)
            
            if response.status_code == 200:
                self.write({'state': 'connected', 'error_message': False})
                return {
                    'type': 'ir.actions.client',
                    'tag': 'display_notification',
                    'params': {
                        'title': _('Success'),
                        'message': _('Connection successful!'),
                        'type': 'success',
                        'sticky': False,
                    }
                }
            else:
                raise UserError(_('Connection failed: %s') % response.text)
        except Exception as e:
            self.write({'state': 'error', 'error_message': str(e)})
            raise UserError(_('Connection error: %s') % str(e))
    
    def action_sync_page_info(self):
        self.ensure_one()
        try:
            url = f'https://graph.facebook.com/v18.0/{self.facebook_page_id}'
            params = {
                'access_token': self.access_token,
                'fields': 'name,category,about,followers_count,fan_count,overall_star_rating'
            }
            response = requests.get(url, params=params, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                self.write({
                    'name': data.get('name', self.name),
                    'page_category': data.get('category'),
                    'page_about': data.get('about'),
                    'followers_count': data.get('followers_count', 0),
                    'likes_count': data.get('fan_count', 0),
                    'page_rating': data.get('overall_star_rating', 0),
                    'last_sync_date': fields.Datetime.now(),
                })
                return True
            return False
        except Exception as e:
            _logger.error(f'Error syncing page info: {e}')
            return False
    
    def action_view_posts(self):
        self.ensure_one()
        return {
            'name': _('Posts - %s') % self.name,
            'type': 'ir.actions.act_window',
            'res_model': 'social.post',
            'view_mode': 'list,kanban,form',
            'domain': [('account_id', '=', self.id)],
            'context': {'default_account_id': self.id},
        }
    
    # =========================================================================
    # âœ… THÃŠM: ACTION SYNC CONVERSATIONS
    # =========================================================================
    def action_sync_conversations(self):
        """
        Äá»“ng bá»™ táº¥t cáº£ conversations cá»§a account nÃ y tá»« Facebook.
        """
        self.ensure_one()
        
        if self.state != 'connected':
            raise UserError(_('Please connect the account first!'))
        
        try:
            from .social_message import SocialMessage
            
            # Gá»i method sync cho account nÃ y
            self.env['social.message']._sync_account_conversations(self)
            
            # Cáº­p nháº­t last sync date
            self.write({
                'last_message_sync_date': fields.Datetime.now(),
            })
            
            # Äáº¿m sá»‘ conversations Ä‘Ã£ sync
            conv_count = self.env['social.conversation'].search_count([
                ('account_id', '=', self.id)
            ])
            
            return {
                'type': 'ir.actions.client',
                'tag': 'display_notification',
                'params': {
                    'title': _('Success'),
                    'message': _('Synced conversations! Total: %d conversations') % conv_count,
                    'type': 'success',
                    'sticky': False,
                }
            }
            
        except Exception as e:
            _logger.error(f'Error syncing conversations for account {self.id}: {e}')
            raise UserError(_('Error syncing conversations: %s') % str(e))
    
    # âœ… THÃŠM: Action view conversations
    def action_view_conversations(self):
        """Xem táº¥t cáº£ conversations cá»§a account nÃ y"""
        self.ensure_one()
        return {
            'name': _('Conversations - %s') % self.name,
            'type': 'ir.actions.act_window',
            'res_model': 'social.conversation',
            'view_mode': 'list,form',
            'domain': [('account_id', '=', self.id)],
            'context': {'default_account_id': self.id},
        }
    
    @api.model
    def cron_refresh_facebook_tokens(self):
        accounts = self.search([('platform', '=', 'facebook'), ('state', '=', 'connected')])
        for account in accounts:
            try:
                _logger.info(f'Refreshing token for account {account.id}')
            except Exception as e:
                _logger.error(f'Error refreshing token: {e}')



################################################################################
## FILE 19: social_analytics.py
## ÄÆ°á»ng dáº«n: models/social_analytics.py
################################################################################

from odoo import models, fields, api, tools
import logging

_logger = logging.getLogger(__name__)


class SocialAnalytics(models.Model):
    """
    Model phÃ¢n tÃ­ch insights tá»« Facebook.
    
    ÄÃ¢y lÃ  SQL View model (khÃ´ng cÃ³ table tháº­t trong database).
    View nÃ y tá»•ng há»£p dá»¯ liá»‡u tá»« social_post Ä‘á»ƒ táº¡o bÃ¡o cÃ¡o analytics.
    """
    _name = 'social.analytics'
    _description = 'Facebook Analytics'
    _auto = False
    _rec_name = 'account_id'
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # FIELDS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    account_id = fields.Many2one(
        'social.account',
        string='Page',
        readonly=True,
    )
    
    date = fields.Date(
        string='Date',
        readonly=True,
    )
    
    total_posts = fields.Integer(
        string='Total Posts',
        readonly=True,
    )
    
    total_likes = fields.Integer(
        string='Total Likes',
        readonly=True,
    )
    
    total_comments = fields.Integer(
        string='Total Comments',
        readonly=True,
    )
    
    total_shares = fields.Integer(
        string='Total Shares',
        readonly=True,
    )
    
    avg_engagement_rate = fields.Float(
        string='Avg Engagement Rate',
        readonly=True,
    )
    
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        readonly=True,
    )
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # INIT METHOD - XÃ“A VÃ€ THAY Báº°NG @api.model_create_multi
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    # âŒ XÃ“A method init() cÅ© vÃ¬ gÃ¢y lá»—i khi load module
    # def init(self):
    #     """Táº¡o SQL view cho analytics"""
    #     tools.drop_view_if_exists(self._cr, self._table)
    #     self._cr.execute("""...""")
    
    # âœ… THAY Báº°NG: Táº¡o view thá»§ cÃ´ng sau khi module Ä‘Ã£ install xong
    # Hoáº·c dÃ¹ng post_init_hook trong __manifest__.py
    
    @api.model
    def init(self):
        """
        Táº¡o SQL view cho analytics.
        
        Version an toÃ n: Kiá»ƒm tra table social_post tá»“n táº¡i trÆ°á»›c khi táº¡o view.
        """
        # Kiá»ƒm tra table social_post Ä‘Ã£ tá»“n táº¡i chÆ°a
        self._cr.execute("""
            SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE table_schema = 'public' 
                AND table_name = 'social_post'
            )
        """)
        
        table_exists = self._cr.fetchone()[0]
        
        if not table_exists:
            _logger.warning(
                'Table social_post does not exist yet. '
                'Skipping social.analytics view creation. '
                'View will be created later via post_init_hook.'
            )
            return
        
        # Table tá»“n táº¡i â†’ Táº¡o view
        _logger.info('Creating social.analytics SQL view...')
        
        try:
            tools.drop_view_if_exists(self._cr, self._table)
            
            self._cr.execute("""
                CREATE OR REPLACE VIEW %s AS (
                    SELECT
                        ROW_NUMBER() OVER (ORDER BY sp.account_id, DATE(sp.published_date)) AS id,
                        sp.account_id AS account_id,
                        DATE(sp.published_date) AS date,
                        COUNT(sp.id) AS total_posts,
                        COALESCE(SUM(sp.likes_count), 0) AS total_likes,
                        COALESCE(SUM(sp.comments_count), 0) AS total_comments,
                        COALESCE(SUM(sp.shares_count), 0) AS total_shares,
                        AVG(sp.engagement_rate) AS avg_engagement_rate,
                        sp.company_id AS company_id
                    FROM
                        social_post sp
                    WHERE
                        sp.state = 'published'
                        AND sp.published_date IS NOT NULL
                    GROUP BY
                        sp.account_id, DATE(sp.published_date), sp.company_id
                )
            """ % self._table)
            
            _logger.info('âœ… Social analytics view created successfully')
            
        except Exception as e:
            _logger.error(f'âŒ Error creating view: {e}')
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CRON & ACTIONS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    @api.model
    def cron_update_facebook_insights(self):
        """
        Cron job Ä‘á»ƒ update insights tá»« Facebook.
        
        Job nÃ y cháº¡y Ä‘á»‹nh ká»³ Ä‘á»ƒ pull data má»›i tá»« Facebook API
        vÃ  cáº­p nháº­t vÃ o social_post.
        """
        _logger.info('Updating Facebook insights...')
        
        try:
            # Láº¥y táº¥t cáº£ accounts Ä‘ang active
            accounts = self.env['social.account'].search([
                ('platform', '=', 'facebook'),
                ('state', '=', 'connected'),
            ])
            
            for account in accounts:
                try:
                    # TODO: Implement Facebook Insights API call
                    # account.sync_insights()
                    _logger.info(f'Updated insights for account {account.name}')
                except Exception as e:
                    _logger.error(f'Error updating insights for {account.name}: {e}')
            
            _logger.info('âœ… Facebook insights update completed')
            
        except Exception as e:
            _logger.error(f'âŒ Error in cron_update_facebook_insights: {e}')



################################################################################
## FILE 20: social_chatbot_automation.py
## ÄÆ°á»ng dáº«n: models/social_chatbot_automation.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _
from odoo.exceptions import ValidationError
import logging

_logger = logging.getLogger(__name__)


class SocialChatbotAutomation(models.Model):
    """
    Model quáº£n lÃ½ Chatbot Automation Rules.
    
    Má»—i rule Ä‘á»‹nh nghÄ©a:
    - Trigger keywords: Tá»« khÃ³a kÃ­ch hoáº¡t
    - Response text: Ná»™i dung pháº£n há»“i tá»± Ä‘á»™ng
    - Priority: Äá»™ Æ°u tiÃªn (sá»‘ cao = Æ°u tiÃªn cao)
    - Active: Báº­t/táº¯t rule
    """
    
    _name = 'social.chatbot.automation'
    _description = 'Chatbot Automation Rule'
    _order = 'priority desc, sequence, id'
    _rec_name = 'name'
    
    # BASIC FIELDS
    name = fields.Char(
        string='Rule Name',
        required=True,
        help='TÃªn cá»§a automation rule',
    )
    
    active = fields.Boolean(
        string='Active',
        default=True,
        help='Báº­t/táº¯t rule nÃ y',
    )
    
    sequence = fields.Integer(
        string='Sequence',
        default=10,
        help='Thá»© tá»± hiá»ƒn thá»‹',
    )
    
    priority = fields.Integer(
        string='Priority',
        default=50,
        help='Äá»™ Æ°u tiÃªn (100 = cao nháº¥t, 0 = tháº¥p nháº¥t)',
    )
    
    # TRIGGER CONFIGURATION
    trigger_keywords = fields.Char(
        string='Trigger Keywords',
        required=True,
        help='Tá»« khÃ³a kÃ­ch hoáº¡t rule (phÃ¢n cÃ¡ch bá»Ÿi dáº¥u pháº©y). VÃ­ dá»¥: mua,Ä‘áº·t hÃ ng,order',
    )
    
    # RESPONSE CONFIGURATION
    response_text = fields.Text(
        string='Response Text',
        required=True,
        help='Ná»™i dung tin nháº¯n pháº£n há»“i tá»± Ä‘á»™ng',
    )
    
    # SCOPE
    account_id = fields.Many2one(
        'social.account',
        string='Facebook Page',
        help='Rule chá»‰ Ã¡p dá»¥ng cho page cá»¥ thá»ƒ (Ä‘á»ƒ trá»‘ng = Ã¡p dá»¥ng cho táº¥t cáº£)',
        ondelete='cascade',
    )
    
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        default=lambda self: self.env.company,
        required=True,
        index=True,
    )
    
    # STATISTICS
    triggered_count = fields.Integer(
        string='Triggered Count',
        default=0,
        readonly=True,
        help='Sá»‘ láº§n rule Ä‘Æ°á»£c kÃ­ch hoáº¡t',
    )
    
    last_triggered_date = fields.Datetime(
        string='Last Triggered',
        readonly=True,
        help='Láº§n cuá»‘i rule Ä‘Æ°á»£c kÃ­ch hoáº¡t',
    )
    
    # CONSTRAINTS
    @api.constrains('trigger_keywords')
    def _check_trigger_keywords(self):
        """Validate trigger keywords format"""
        for rule in self:
            if not rule.trigger_keywords:
                continue
            
            keywords = [kw.strip() for kw in rule.trigger_keywords.split(',')]
            if not keywords or all(not kw for kw in keywords):
                raise ValidationError(_(
                    'Trigger keywords must be separated by commas and not empty.\n'
                    'Example: mua,Ä‘áº·t hÃ ng,order'
                ))
    
    @api.constrains('priority')
    def _check_priority(self):
        """Validate priority range"""
        for rule in self:
            if rule.priority < 0 or rule.priority > 100:
                raise ValidationError(_('Priority must be between 0 and 100'))
    
    # BUSINESS METHODS
    def mark_as_triggered(self):
        """
        ÄÃ¡nh dáº¥u rule Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t.
        TÄƒng counter vÃ  cáº­p nháº­t last triggered date.
        """
        self.ensure_one()
        self.write({
            'triggered_count': self.triggered_count + 1,
            'last_triggered_date': fields.Datetime.now(),
        })
        _logger.info(f"Chatbot rule '{self.name}' triggered. Total count: {self.triggered_count}")
    
    def check_match(self, message_text):
        """
        Kiá»ƒm tra xem message cÃ³ match vá»›i rule hay khÃ´ng.
        
        Args:
            message_text (str): Ná»™i dung tin nháº¯n cáº§n kiá»ƒm tra
        
        Returns:
            bool: True náº¿u match, False náº¿u khÃ´ng
        """
        self.ensure_one()
        
        if not self.active:
            return False
        
        if not message_text:
            return False
        
        message_lower = message_text.lower().strip()
        keywords = [kw.strip().lower() for kw in self.trigger_keywords.split(',')]
        
        return any(keyword in message_lower for keyword in keywords if keyword)
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ACTION METHODS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    def action_test_rule(self):
        """
        Test chatbot rule vá»›i tin nháº¯n máº«u.
        
        Hiá»ƒn thá»‹ popup vá»›i:
        - Trigger keywords
        - Response text
        - Test message input
        """
        self.ensure_one()
        
        # Build test message
        test_message = f"""
ğŸ¤– **Test Chatbot Rule: {self.name}**

ğŸ“Œ **Trigger Keywords:**
{self.trigger_keywords}

ğŸ’¬ **Response Text:**
{self.response_text}

âœ… **Status:** {'Active' if self.active else 'Inactive'}
ğŸ¯ **Priority:** {self.priority}
ğŸ“Š **Triggered:** {self.triggered_count} times

---
**Test vá»›i tin nháº¯n máº«u:**
Gá»­i tin nháº¯n chá»©a báº¥t ká»³ keyword nÃ o á»Ÿ trÃªn Ä‘á»ƒ test rule nÃ y.
        """
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Test Chatbot Rule'),
                'message': test_message,
                'type': 'info',
                'sticky': True,
            }
        }
    
    def action_view_triggered_messages(self):
        """
        Xem cÃ¡c tin nháº¯n Ä‘Ã£ trigger rule nÃ y.
        
        Note: Hiá»‡n táº¡i chÆ°a track messages chi tiáº¿t,
        chá»‰ hiá»ƒn thá»‹ thÃ´ng bÃ¡o sá»‘ lÆ°á»£ng.
        """
        self.ensure_one()
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Triggered Messages'),
                'message': _('This rule has been triggered %d times.') % self.triggered_count,
                'type': 'info',
                'sticky': False,
            }
        }



################################################################################
## FILE 21: social_comment.py
## ÄÆ°á»ng dáº«n: models/social_comment.py
################################################################################

from odoo import models, fields, api, _
from odoo.exceptions import UserError
import requests
import logging

_logger = logging.getLogger(__name__)


class SocialComment(models.Model):
    _name = 'social.comment'
    _description = 'Facebook Comment'
    _order = 'comment_date desc'

    display_name = fields.Char(string='Display Name', compute='_compute_display_name', store=True)
    post_id = fields.Many2one('social.post', string='Post', required=True, ondelete='cascade')
    facebook_comment_id = fields.Char(string='Facebook Comment ID', required=True)
    author_name = fields.Char(string='Author', required=True)
    author_facebook_id = fields.Char(string='Author FB ID')
    message = fields.Text(string='Message', required=True)
    comment_date = fields.Datetime(string='Date', required=True, default=fields.Datetime.now)
    parent_id = fields.Many2one('social.comment', string='Parent Comment')
    is_hidden = fields.Boolean(string='Hidden', default=False)
    is_spam = fields.Boolean(string='Spam', default=False)
    reply_text = fields.Text(string='Reply')
    replied = fields.Boolean(string='Replied', default=False)
    company_id = fields.Many2one('res.company', related='post_id.company_id', store=True)
    
    @api.depends('author_name', 'message')
    def _compute_display_name(self):
        for comment in self:
            preview = comment.message[:50] + '...' if len(comment.message or '') > 50 else comment.message
            comment.display_name = f"{comment.author_name}: {preview}"
    
    def action_reply(self):
        self.ensure_one()
        if not self.reply_text:
            raise UserError(_('Please enter a reply message!'))
        try:
            url = f'https://graph.facebook.com/v18.0/{self.facebook_comment_id}/comments'
            data = {'access_token': self.post_id.account_id.access_token, 'message': self.reply_text}
            response = requests.post(url, data=data, timeout=30)
            if response.status_code == 200:
                self.replied = True
                return {'type': 'ir.actions.client', 'tag': 'display_notification',
                        'params': {'title': _('Success'), 'message': _('Reply sent!'), 'type': 'success'}}
            else:
                raise UserError(_('Failed to reply: %s') % response.text)
        except Exception as e:
            raise UserError(_('Error: %s') % str(e))
    
    def action_hide(self):
        self.ensure_one()
        self.is_hidden = True
    
    def action_mark_spam(self):
        self.ensure_one()
        self.is_spam = True



################################################################################
## FILE 22: social_conversation.py
## ÄÆ°á»ng dáº«n: models/social_conversation.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _
from odoo.exceptions import UserError
import logging

_logger = logging.getLogger(__name__)


class SocialConversation(models.Model):
    """
    Model quáº£n lÃ½ Conversations - Cuá»™c há»™i thoáº¡i Facebook Messenger.
    
    Má»—i conversation Ä‘áº¡i diá»‡n cho 1 cuá»™c há»™i thoáº¡i vá»›i 1 khÃ¡ch hÃ ng cá»¥ thá»ƒ (PSID).
    Má»™t conversation chá»©a nhiá»u messages (social.message).
    """
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # MODEL DEFINITION
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    _name = 'social.conversation'
    _description = 'Facebook Messenger Conversation'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _order = 'last_message_date desc, id desc'
    _rec_name = 'customer_name'
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # BASIC FIELDS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    # Conversation Identity
    facebook_psid = fields.Char(
        string='Facebook PSID',
        required=True,
        index=True,
        help='Page-Scoped User ID - unique identifier cá»§a user trong context cá»§a page',
    )
    
    account_id = fields.Many2one(
        'social.account',
        string='Facebook Page',
        required=True,
        ondelete='cascade',
        index=True,
        help='Facebook Page nÆ¡i conversation diá»…n ra',
    )
    
    # Customer Information
    customer_name = fields.Char(
        string='Customer Name',
        tracking=True,
        help='TÃªn khÃ¡ch hÃ ng (cÃ³ thá»ƒ thu tháº­p tá»« chatbot)',
    )
    
    customer_phone = fields.Char(
        string='Customer Phone',
        tracking=True,
        help='Sá»‘ Ä‘iá»‡n thoáº¡i khÃ¡ch hÃ ng',
    )
    
    customer_email = fields.Char(
        string='Customer Email',
        tracking=True,
        help='Email khÃ¡ch hÃ ng',
    )
    
    # Conversation Status
    state = fields.Selection([
        ('new', 'New'),
        ('ongoing', 'Ongoing'),
        ('resolved', 'Resolved'),
        ('closed', 'Closed'),
    ], string='State', default='new', tracking=True)
    
    # Timestamps
    last_message_date = fields.Datetime(
        string='Last Message',
        default=fields.Datetime.now,
        index=True,
        tracking=True,
    )
    
    # Tracking
    last_message_from = fields.Selection([
        ('customer', 'Customer'),
        ('page', 'Page'),
    ], string='Last Message From')
    
    unread_count = fields.Integer(
        string='Unread Messages',
        default=0,
        help='Sá»‘ tin nháº¯n chÆ°a Ä‘á»c tá»« khÃ¡ch hÃ ng',
    )
    
    first_response_time = fields.Float(
        string='First Response Time (minutes)',
        help='Thá»i gian pháº£n há»“i tin nháº¯n Ä‘áº§u tiÃªn',
    )
    
    # Organization
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        default=lambda self: self.env.company,
        required=True,
        index=True,
    )
    
    active = fields.Boolean(
        string='Active',
        default=True,
    )
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # RELATIONSHIP FIELDS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    message_ids = fields.One2many(
        'social.message',
        'conversation_id',
        string='Messages',
        help='Táº¥t cáº£ tin nháº¯n trong conversation nÃ y',
    )
    
    message_count = fields.Integer(
        string='Message Count',
        compute='_compute_message_count',
        store=True,
    )
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CRM INTEGRATION
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    lead_id = fields.Many2one(
        'crm.lead',
        string='CRM Lead',
        ondelete='set null',
        tracking=True,
        help='Lead Ä‘Æ°á»£c táº¡o tá»« conversation nÃ y khi cÃ³ purchase intent',
    )
    
    conversation_id = fields.Char(
        string='Conversation ID',
        help='Facebook Conversation ID (náº¿u cÃ³)',
    )
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CONSTRAINTS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    _sql_constraints = [
        ('facebook_psid_account_uniq',
         'UNIQUE(facebook_psid, account_id)',
         'Conversation already exists for this user and page!'),
    ]
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # COMPUTE METHODS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    @api.depends('message_ids')
    def _compute_message_count(self):
        """Äáº¿m sá»‘ lÆ°á»£ng messages"""
        for conv in self:
            conv.message_count = len(conv.message_ids)
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CRM INTEGRATION METHODS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    def _check_purchase_intent(self, message):
        """
        Kiá»ƒm tra náº¿u tin nháº¯n thá»ƒ hiá»‡n Ã½ Ä‘á»‹nh mua hÃ ng.
        Chá»‰ táº¡o/update lead khi khÃ¡ch hÃ ng xÃ¡c nháº­n quyáº¿t Ä‘á»‹nh mua.
        
        Args:
            message (social.message): Message record cáº§n kiá»ƒm tra
        """
        self.ensure_one()
        
        message_content = (message.message or '').lower().strip()
        
        # Danh sÃ¡ch keyword mua hÃ ng
        purchase_keywords = [
            'mua', 'Ä‘áº·t hÃ ng', 'order', 'buy', 
            'muá»‘n mua', 'Ä‘áº·t mua', 'book', 'booking'
        ]
        
        # Kiá»ƒm tra cÃ³ keyword mua hÃ ng khÃ´ng
        has_purchase_intent = any(
            keyword in message_content 
            for keyword in purchase_keywords
        )
        
        if not has_purchase_intent:
            return
        
        _logger.info(f"ğŸ›’ Purchase intent detected in conversation {self.id}")
        
        # Táº¡o hoáº·c cáº­p nháº­t CRM lead
        self._create_or_update_lead(message)
    
    def _create_or_update_lead(self, message):
        """
        Táº¡o lead má»›i hoáº·c cáº­p nháº­t lead hiá»‡n cÃ³ khi phÃ¡t hiá»‡n purchase intent.
        
        Args:
            message (social.message): Message trigger viá»‡c táº¡o/update lead
        """
        self.ensure_one()
        
        Lead = self.env['crm.lead']
        
        # Náº¿u Ä‘Ã£ cÃ³ lead â†’ cáº­p nháº­t
        if self.lead_id:
            lead = self.lead_id
            
            # ThÃªm message vÃ o chatter
            lead.message_post(
                body=_(
                    "<strong>Purchase intent detected in Facebook Messenger</strong><br/>"
                    "Customer message: <em>%s</em>"
                ) % (message.message or ''),
                message_type='comment',
                subtype_xmlid='mail.mt_comment'
            )
            
            # Cáº­p nháº­t stage náº¿u chÆ°a won/lost
            if lead.probability < 100 and lead.probability != 0:
                # TÃ¬m stage "Qualified"
                qualified_stage = self.env['crm.stage'].search([
                    '|',
                    ('name', 'ilike', 'qualified'),
                    ('name', 'ilike', 'qualification')
                ], limit=1)
                
                if qualified_stage:
                    lead.write({
                        'stage_id': qualified_stage.id,
                        'probability': 60,
                    })
            
            _logger.info(f"âœ… Updated existing lead {lead.id} with purchase intent")
            
        else:
            # Táº¡o lead má»›i
            lead_vals = {
                'name': _('Facebook Lead - %s') % (
                    self.customer_name or self.facebook_psid
                ),
                'type': 'opportunity',
                'contact_name': self.customer_name,
                'phone': self.customer_phone,
                'email_from': self.customer_email,
                'description': _(
                    "Lead created from Facebook Messenger conversation\n"
                    "Customer PSID: %s\n"
                    "Last message: %s\n"
                    "Purchase intent detected at: %s"
                ) % (
                    self.facebook_psid,
                    message.message or '',
                    fields.Datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                ),
                'company_id': self.company_id.id,
            }
            
            # TÃ¬m Facebook source
            source = self.env['utm.source'].search([
                ('name', '=', 'Facebook')
            ], limit=1)
            if not source:
                source = self.env['utm.source'].create({'name': 'Facebook'})
            lead_vals['source_id'] = source.id
            
            # TÃ¬m stage "New" hoáº·c "Qualified"
            new_stage = self.env['crm.stage'].search([
                '|',
                ('name', 'ilike', 'new'),
                ('name', 'ilike', 'qualified')
            ], limit=1)
            
            if new_stage:
                lead_vals['stage_id'] = new_stage.id
                lead_vals['probability'] = (
                    20 if 'new' in new_stage.name.lower() else 60
                )
            
            # Táº¡o lead
            lead = Lead.create(lead_vals)
            
            # Link lead vá»›i conversation
            self.write({'lead_id': lead.id})
            
            # ThÃªm message vÃ o lead chatter
            lead.message_post(
                body=_(
                    "<strong>Lead created from Facebook Messenger</strong><br/>"
                    "Customer message: <em>%s</em><br/>"
                    "<a href='/web#id=%s&model=social.conversation&view_type=form'>"
                    "View Conversation</a>"
                ) % (message.message or '', self.id),
                message_type='notification',
                subtype_xmlid='mail.mt_note'
            )
            
            _logger.info(f"âœ… Created new lead {lead.id} from conversation {self.id}")
        
        # Cáº­p nháº­t conversation state
        if self.state == 'new':
            self.write({'state': 'ongoing'})
        
        return lead
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ACTION METHODS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    def action_create_lead(self):
        """Táº¡o lead thá»§ cÃ´ng tá»« conversation"""
        self.ensure_one()
        
        if self.lead_id:
            raise UserError(_('Lead already exists for this conversation!'))
        
        # Táº¡o fake message Ä‘á»ƒ trigger lead creation
        fake_message = self.env['social.message'].create({
            'conversation_id': self.id,
            'account_id': self.account_id.id,
            'message': '[Manual lead creation from conversation]',
            'is_from_customer': True,
            'company_id': self.company_id.id,
        })
        
        # Táº¡o lead
        lead = self._create_or_update_lead(fake_message)
        
        # XÃ³a fake message
        fake_message.unlink()
        
        return {
            'type': 'ir.actions.act_window',
            'name': _('Lead Created'),
            'res_model': 'crm.lead',
            'res_id': lead.id,
            'view_mode': 'form',
            'target': 'current',
        }
    
    def action_mark_resolved(self):
        """ÄÃ¡nh dáº¥u conversation lÃ  Ä‘Ã£ giáº£i quyáº¿t"""
        for conv in self:
            conv.write({'state': 'resolved'})
            conv.message_post(
                body=_('Conversation marked as resolved'),
                message_type='notification',
                subtype_xmlid='mail.mt_note'
            )
    
    def action_close(self):
        """ÄÃ³ng conversation"""
        for conv in self:
            conv.write({'state': 'closed'})
            conv.message_post(
                body=_('Conversation closed'),
                message_type='notification',
                subtype_xmlid='mail.mt_note'
            )
    
    def action_reopen(self):
        """Má»Ÿ láº¡i conversation Ä‘Ã£ Ä‘Ã³ng"""
        for conv in self:
            conv.write({'state': 'ongoing'})
            conv.message_post(
                body=_('Conversation reopened'),
                message_type='notification',
                subtype_xmlid='mail.mt_note'
            )
    
    def action_view_lead(self):
        """Xem CRM lead liÃªn káº¿t"""
        self.ensure_one()
        
        if not self.lead_id:
            raise UserError(_('No lead linked to this conversation'))
        
        return {
            'type': 'ir.actions.act_window',
            'name': _('Lead'),
            'res_model': 'crm.lead',
            'res_id': self.lead_id.id,
            'view_mode': 'form',
            'target': 'current',
        }
    
    def action_view_messages(self):
        """Xem táº¥t cáº£ messages trong conversation"""
        self.ensure_one()
        
        return {
            'type': 'ir.actions.act_window',
            'name': _('Messages'),
            'res_model': 'social.message',
            'view_mode': 'tree,form',
            'domain': [('conversation_id', '=', self.id)],
            'context': {'default_conversation_id': self.id},
        }



################################################################################
## FILE 23: social_message.py
## ÄÆ°á»ng dáº«n: models/social_message.py
################################################################################

from odoo import api, fields, models, _
from odoo.exceptions import UserError, ValidationError
import logging
import re

_logger = logging.getLogger(__name__)


class SocialMessage(models.Model):
    """
    Model quáº£n lÃ½ Facebook Messenger conversations.
    
    âœ… UPGRADED VERSION vá»›i Ä‘áº§y Ä‘á»§ field cho chatbot nÃ¢ng cao
    """
    
    _name = 'social.message'
    _description = 'Social Message / Conversation'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _order = 'create_date desc'
    _rec_name = 'facebook_user_id'
    
    # =========================================================================
    # BASIC FIELDS
    # =========================================================================
    
    facebook_user_id = fields.Char(
        string='Facebook User ID (PSID)',
        required=True,
        index=True,
        help='Page-Scoped User ID from Facebook',
    )
    
    account_id = fields.Many2one(
        'social.account',
        string='Facebook Page',
        required=True,
        ondelete='cascade',
        index=True,
    )
    
    message_id = fields.Char(
        string='Message ID',
        index=True,
        help='Facebook Message ID',
    )
    
    message = fields.Text(
        string='Message Content',
    )
    
    is_from_customer = fields.Boolean(
        string='From Customer',
        default=True,
    )
    
    attachments = fields.Text(
        string='Attachments',
        help='JSON data',
    )
    
    created_date = fields.Datetime(
        string='Created Date',
        default=fields.Datetime.now,
        index=True,
    )
    
    last_message_date = fields.Datetime(
        string='Last Message',
    )
    
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        default=lambda self: self.env.company,
        required=True,
        index=True,
    )
    
    # =========================================================================
    # âœ… CHATBOT FIELDS
    # =========================================================================
    
    chatbot_state = fields.Selection([
        ('idle', 'Idle'),
        ('ask_name', 'Asking Name'),
        ('ask_phone', 'Asking Phone'),
        ('ask_address', 'Asking Address'),  # âœ… Má»šI
        ('show_products', 'Showing Products'),
        ('ask_quantity', 'Asking Quantity'),  # âœ… Má»šI
        ('confirm_order', 'Confirming Order'),
        ('completed', 'Completed'),
    ], string='Chatbot State', default='idle', tracking=True, index=True)
    
    customer_name = fields.Char(
        string='Customer Name',
        tracking=True,
        help='TÃªn khÃ¡ch hÃ ng (Ä‘Ã£ chuáº©n hÃ³a)',
    )
    
    customer_phone = fields.Char(
        string='Customer Phone',
        tracking=True,
        help='Sá»‘ Ä‘iá»‡n thoáº¡i (Ä‘Ã£ chuáº©n hÃ³a vá» format 0XXXXXXXXX)',
    )
    
    # âœ… THÃŠM VÃ€O CUá»I PHáº¦N CHATBOT FIELDS (sau chatbot_state)
    
    customer_address = fields.Char(
        string='Customer Address',
        tracking=True,
        help='Äá»‹a chá»‰ giao hÃ ng',
    )
    
    product_quantity = fields.Integer(
        string='Product Quantity',
        default=1,
        help='Sá»‘ lÆ°á»£ng sáº£n pháº©m khÃ¡ch Ä‘áº·t',
    )
    
    selected_product_ids = fields.Many2many(
        'social.messenger.product',
        'social_message_product_rel',
        'message_id',
        'product_id',
        string='Selected Products',
    )
    
    # âœ… NÃ‚NG Cáº¤P 7: Cooldown field
    cooldown_until = fields.Datetime(
        string='Cooldown Until',
        help='Thá»i gian káº¿t thÃºc cooldown sau khi hoÃ n táº¥t Ä‘Æ¡n hÃ ng (trÃ¡nh spam)',
    )
    
    # =========================================================================
    # CRM & SALES INTEGRATION
    # =========================================================================
    
    lead_id = fields.Many2one(
        'crm.lead',
        string='Lead',
        ondelete='set null',
        tracking=True,
    )
    
    messenger_order_id = fields.Many2one(
        'social.messenger.order',
        string='Messenger Order',
        ondelete='set null',
        tracking=True,
    )
    
    conversation_id = fields.Many2one(
        'social.conversation',
        string='Conversation',
        ondelete='cascade',
    )
    
    # =========================================================================
    # CONSTRAINTS
    # =========================================================================
    
    _sql_constraints = [
        ('facebook_user_account_uniq',
         'UNIQUE(facebook_user_id, account_id)',
         'Conversation already exists for this user and page!'),
    ]



################################################################################
## FILE 24: social_messenger_order.py
## ÄÆ°á»ng dáº«n: models/social_messenger_order.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _
from odoo.exceptions import UserError
import logging

_logger = logging.getLogger(__name__)


class SocialMessengerOrder(models.Model):
    """
    âœ… VERSION ÄÆ N GIáº¢N - KHÃ”NG Gá»ŒI send_order_confirmation() trong create_sale_order()
    """
    _name = 'social.messenger.order'
    _description = 'Messenger Sales Order'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _order = 'order_date desc, id desc'
    _rec_name = 'name'

    # Basic Info
    name = fields.Char(
        string='Order Reference',
        required=True,
        copy=False,
        readonly=True,
        default=lambda self: _('New'),
    )
    sale_order_id = fields.Many2one(
        'sale.order',
        string='Sale Order',
        ondelete='cascade',
        tracking=True,
    )
    conversation_id = fields.Many2one(
        'social.message',
        string='Conversation',
        ondelete='set null',
    )
    
    # Customer Info
    partner_id = fields.Many2one(
        'res.partner',
        string='Customer',
        related='sale_order_id.partner_id',
        store=True,
        readonly=True,
    )
    facebook_user_id = fields.Char(
        string='Facebook User ID',
        tracking=True,
    )
    customer_name = fields.Char(
        string='Customer Name',
        required=True,
        tracking=True,
    )
    customer_phone = fields.Char(
        string='Phone',
        required=True,
        tracking=True,
    )
    customer_email = fields.Char(
        string='Email',
        tracking=True,
    )
    
    # Order Details
    state = fields.Selection([
        ('draft', 'Draft'),
        ('confirmed', 'Confirmed'),
        ('sale', 'Sale Order'),
        ('cancelled', 'Cancelled'),
    ], string='Status', default='draft', required=True, tracking=True)
    
    order_date = fields.Datetime(
        string='Order Date',
        default=fields.Datetime.now,
        required=True,
        tracking=True,
    )
    
    # Products
    product_ids = fields.Many2many(
        'social.messenger.product',
        string='Products',
    )
    
    # Pricing
    total_amount = fields.Monetary(
        string='Total',
        compute='_compute_total_amount',
        store=True,
        currency_field='currency_id',
    )
    currency_id = fields.Many2one(
        'res.currency',
        string='Currency',
        default=lambda self: self.env.company.currency_id,
    )
    
    # Organization
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        required=True,
        default=lambda self: self.env.company,
    )
    user_id = fields.Many2one(
        'res.users',
        string='Salesperson',
        default=lambda self: self.env.user,
        tracking=True,
    )
    
    # Notes
    notes = fields.Text(
        string='Internal Notes',
    )
    
    @api.model
    def create(self, vals):
        """Override create Ä‘á»ƒ táº¡o sequence"""
        if vals.get('name', _('New')) == _('New'):
            vals['name'] = self.env['ir.sequence'].next_by_code(
                'social.messenger.order'
            ) or _('New')
        return super().create(vals)
    
    @api.depends('sale_order_id', 'sale_order_id.amount_total')
    def _compute_total_amount(self):
        """TÃ­nh tá»•ng tiá»n"""
        for record in self:
            if record.sale_order_id:
                record.total_amount = record.sale_order_id.amount_total
            else:
                total = sum(record.product_ids.mapped('price'))
                record.total_amount = total
    
    def create_sale_order(self):
        """
        âœ… Táº O SALE ORDER - KHÃ”NG Gá»ŒI send_order_confirmation()
        
        Webhook sáº½ tá»± gá»­i tin nháº¯n confirmation.
        """
        self.ensure_one()
        
        if self.sale_order_id:
            raise UserError(_('Sale Order already exists!'))
        
        if not self.product_ids:
            raise UserError(_('No products selected!'))
        
        # 1. Find or create partner
        partner = self._find_or_create_partner()
        
        # 2. Create sale.order
        sale_vals = {
            'partner_id': partner.id,
            'user_id': self.user_id.id,
            'company_id': self.company_id.id,
            'date_order': self.order_date,
            'origin': f'Messenger: {self.name}',
            'note': f'Order from Facebook Messenger\nPSID: {self.facebook_user_id}',
        }
        
        sale_order = self.env['sale.order'].create(sale_vals)
        
        # 3. Add order lines
        for product in self.product_ids:
            line_vals = {
                'order_id': sale_order.id,
                'product_id': product.product_id.id,
                'product_uom_qty': 1,
                'price_unit': product.price,
            }
            self.env['sale.order.line'].create(line_vals)
        
        # 4. Link sale order
        self.sale_order_id = sale_order.id
        self.state = 'sale'
        
        # âœ… KHÃ”NG Gá»ŒI send_order_confirmation() - Webhook tá»± gá»­i
        
        # 5. Log activity
        self.message_post(
            body=_('Sale Order %s created from Messenger') % sale_order.name,
            subject=_('Sale Order Created'),
        )
        
        _logger.info(f'âœ… Created sale order {sale_order.name} for {self.name}')
        
        return sale_order
    
    def _find_or_create_partner(self):
        """TÃ¬m hoáº·c táº¡o res.partner"""
        Partner = self.env['res.partner']
        
        # Search by phone
        if self.customer_phone:
            partner = Partner.search([
                ('phone', '=', self.customer_phone),
                ('company_id', 'in', [False, self.company_id.id]),
            ], limit=1)
            if partner:
                return partner
        
        # Create new partner
        partner_vals = {
            'name': self.customer_name,
            'phone': self.customer_phone,
            'email': self.customer_email,
            'company_id': self.company_id.id,
            'comment': f'Created from Messenger Order: {self.name}',
        }
        
        partner = Partner.create(partner_vals)
        
        _logger.info(f'Created partner {partner.id} for order {self.name}')
        
        return partner
    
    # âœ… XÃ“A METHOD send_order_confirmation() - Webhook tá»± xá»­ lÃ½
    
    def action_confirm(self):
        """XÃ¡c nháº­n Ä‘Æ¡n hÃ ng"""
        for record in self:
            if record.state != 'draft':
                raise UserError(_('Only draft orders can be confirmed!'))
            record.state = 'confirmed'
            record.message_post(body=_('Order confirmed'))
    
    def action_create_sale_order(self):
        """Button action: Táº¡o sale.order"""
        self.ensure_one()
        sale_order = self.create_sale_order()
        
        return {
            'type': 'ir.actions.act_window',
            'name': _('Sale Order'),
            'res_model': 'sale.order',
            'res_id': sale_order.id,
            'view_mode': 'form',
            'target': 'current',
        }
    
    def action_view_sale_order(self):
        """Xem sale.order"""
        self.ensure_one()
        if not self.sale_order_id:
            raise UserError(_('No Sale Order linked yet!'))
        
        return {
            'type': 'ir.actions.act_window',
            'name': _('Sale Order'),
            'res_model': 'sale.order',
            'res_id': self.sale_order_id.id,
            'view_mode': 'form',
            'target': 'current',
        }
    
    def action_cancel(self):
        """Há»§y Ä‘Æ¡n hÃ ng"""
        for record in self:
            record.state = 'cancelled'
            record.message_post(body=_('Order cancelled'))


class ResPartner(models.Model):
    _inherit = 'res.partner'
    
    facebook_user_id = fields.Char(
        string='Facebook User ID (PSID)',
    )
    messenger_order_count = fields.Integer(
        string='Messenger Orders',
        compute='_compute_messenger_order_count',
    )
    
    def _compute_messenger_order_count(self):
        for partner in self:
            partner.messenger_order_count = self.env['social.messenger.order'].search_count([
                ('partner_id', '=', partner.id)
            ])
    
    def action_view_messenger_orders(self):
        self.ensure_one()
        return {
            'name': _('Messenger Orders'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.messenger.order',
            'view_mode': 'tree,form',
            'domain': [('partner_id', '=', self.id)],
        }



################################################################################
## FILE 25: social_messenger_product.py
## ÄÆ°á»ng dáº«n: models/social_messenger_product.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _
from odoo.exceptions import ValidationError
import logging

_logger = logging.getLogger(__name__)


class SocialMessengerProduct(models.Model):
    """
    Sáº£n pháº©m Ä‘Æ°á»£c bÃ¡n qua Facebook Messenger.
    Chá»‰ cÃ¡c sáº£n pháº©m Ä‘Æ°á»£c tick 'active' má»›i hiá»ƒn thá»‹ trong chatbot.
    """
    _name = 'social.messenger.product'
    _description = 'Messenger Product Catalog'
    _order = 'sequence, id'
    _rec_name = 'display_name'

    # Basic Info
    product_id = fields.Many2one(
        'product.product',
        string='Product',
        required=True,
        ondelete='cascade',
        domain=[('sale_ok', '=', True)],
    )
    display_name = fields.Char(
        string='Display Name',
        compute='_compute_display_name',
        store=True,
    )
    active = fields.Boolean(
        string='Sell on Messenger',
        default=True,
        help='Báº­t Ä‘á»ƒ sáº£n pháº©m xuáº¥t hiá»‡n trong chatbot Messenger'
    )
    
    # Messenger Customization
    quick_reply_title = fields.Char(
        string='Quick Reply Title',
        size=20,
        help='TiÃªu Ä‘á» hiá»ƒn thá»‹ trong quick reply button (max 20 kÃ½ tá»±)',
        compute='_compute_quick_reply_title',
        store=True,
        readonly=False,
    )
    description = fields.Text(
        string='Messenger Description',
        help='MÃ´ táº£ gá»­i cho khÃ¡ch hÃ ng qua Messenger',
        compute='_compute_description',
        store=True,
        readonly=False,
    )
    image_url = fields.Char(
        string='Image URL',
        compute='_compute_image_url',
        help='URL hÃ¬nh áº£nh gá»­i trong Messenger (tá»« product.image_1920)'
    )
    
    # Pricing
    price = fields.Float(
        string='Price',
        related='product_id.list_price',
        readonly=True,
    )
    currency_id = fields.Many2one(
        'res.currency',
        related='product_id.currency_id',
        readonly=True,
    )
    
    # Organization
    sequence = fields.Integer(
        string='Sequence',
        default=10,
        help='Thá»© tá»± hiá»ƒn thá»‹ trong danh sÃ¡ch sáº£n pháº©m'
    )
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        default=lambda self: self.env.company,
        required=True,
    )
    
    # Statistics
    order_count = fields.Integer(
        string='Orders',
        compute='_compute_order_count',
    )
    
    _sql_constraints = [
        ('product_company_uniq', 
         'UNIQUE(product_id, company_id)', 
         'Product already exists in Messenger catalog for this company!'),
    ]
    
    @api.depends('product_id', 'product_id.name')
    def _compute_display_name(self):
        """TÃªn hiá»ƒn thá»‹ = tÃªn sáº£n pháº©m"""
        for record in self:
            record.display_name = record.product_id.name if record.product_id else ''
    
    @api.depends('product_id', 'product_id.name')
    def _compute_quick_reply_title(self):
        """Auto-fill quick reply title tá»« tÃªn sáº£n pháº©m (max 20 chars)"""
        for record in self:
            if record.product_id and not record.quick_reply_title:
                name = record.product_id.name
                record.quick_reply_title = name[:20] if len(name) > 20 else name
    
    @api.depends('product_id', 'product_id.description_sale')
    def _compute_description(self):
        """Auto-fill description tá»« product"""
        for record in self:
            if record.product_id and not record.description:
                desc = record.product_id.description_sale or record.product_id.name
                record.description = desc
    
    @api.depends('product_id', 'product_id.image_1920')
    def _compute_image_url(self):
        """Generate public URL cho hÃ¬nh áº£nh"""
        for record in self:
            if record.product_id and record.product_id.image_1920:
                base_url = self.env['ir.config_parameter'].sudo().get_param('web.base.url')
                record.image_url = f"{base_url}/web/image/product.product/{record.product_id.id}/image_1920"
            else:
                record.image_url = False
    
    def _compute_order_count(self):
        """Äáº¿m sá»‘ Ä‘Æ¡n hÃ ng tá»« sáº£n pháº©m nÃ y"""
        for record in self:
            # Count sale.order.line cÃ³ product nÃ y tá»« messenger orders
            orders = self.env['social.messenger.order'].search([
                ('sale_order_id.order_line.product_id', '=', record.product_id.id),
                ('company_id', '=', record.company_id.id),
            ])
            record.order_count = len(orders)
    
    @api.constrains('quick_reply_title')
    def _check_quick_reply_title(self):
        """Validate quick reply title length"""
        for record in self:
            if record.quick_reply_title and len(record.quick_reply_title) > 20:
                raise ValidationError(
                    _('Quick Reply Title cannot exceed 20 characters!')
                )
    
    # -------------------------------------------------------------------------
    # BUSINESS METHODS
    # -------------------------------------------------------------------------
    
    @api.model
    def get_active_products(self, company_id=None):
        """
        Láº¥y danh sÃ¡ch sáº£n pháº©m Ä‘ang active cho Messenger.
        
        Returns:
            recordset: social.messenger.product records
        """
        domain = [('active', '=', True)]
        if company_id:
            domain.append(('company_id', '=', company_id))
        else:
            domain.append(('company_id', '=', self.env.company.id))
        
        return self.search(domain, order='sequence, id')
    
    def format_for_messenger(self):
        """
        Format sáº£n pháº©m thÃ nh quick reply buttons cho Messenger.
        
        Returns:
            list: Danh sÃ¡ch quick reply buttons
            [
                {
                    'content_type': 'text',
                    'title': 'Product Name',
                    'payload': 'PRODUCT_123',
                },
                ...
            ]
        """
        self.ensure_one()
        return {
            'content_type': 'text',
            'title': self.quick_reply_title or self.product_id.name[:20],
            'payload': f'PRODUCT_{self.id}',
        }
    
    def get_product_message(self):
        """
        Táº¡o tin nháº¯n giá»›i thiá»‡u sáº£n pháº©m.
        
        Returns:
            str: Message text
        """
        self.ensure_one()
        price_formatted = f"{self.price:,.0f} {self.currency_id.symbol}"
        message = f"ğŸ›ï¸ {self.product_id.name}\n"
        message += f"ğŸ’° GiÃ¡: {price_formatted}\n"
        if self.description:
            message += f"ğŸ“ {self.description}\n"
        return message
    
    # -------------------------------------------------------------------------
    # ACTIONS
    # -------------------------------------------------------------------------
    
    def action_view_orders(self):
        """Xem cÃ¡c Ä‘Æ¡n hÃ ng tá»« sáº£n pháº©m nÃ y"""
        self.ensure_one()
        return {
            'name': _('Messenger Orders'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.messenger.order',
            'view_mode': 'tree,form',
            'domain': [
                ('sale_order_id.order_line.product_id', '=', self.product_id.id),
                ('company_id', '=', self.company_id.id),
            ],
            'context': {'default_product_id': self.product_id.id},
        }
    
    def action_toggle_active(self):
        """Toggle active state"""
        for record in self:
            record.active = not record.active



################################################################################
## FILE 26: social_post.py
## ÄÆ°á»ng dáº«n: models/social_post.py
################################################################################

# FILE: social_post_fixed.py
# PhiÃªn báº£n sá»­a lá»—i khÃ´ng thá»ƒ Ä‘Äƒng áº£nh

from odoo import models, fields, api, _
from odoo.exceptions import UserError
import requests
import logging
from datetime import datetime
import base64  # âœ… THÃŠM IMPORT


_logger = logging.getLogger(__name__)


class SocialPost(models.Model):
    """
    Model quáº£n lÃ½ bÃ i Ä‘Äƒng Facebook.
    """
    _name = 'social.post'
    _description = 'Facebook Post'
    _order = 'create_date desc'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _rec_name = 'display_name'

    # -------------------------------------------------------------------------
    # BASIC INFO
    # -------------------------------------------------------------------------
    display_name = fields.Char(
        string='Display Name',
        compute='_compute_display_name',
        store=True,
    )
    
    account_id = fields.Many2one(
        'social.account',
        string='Facebook Page',
        required=True,
        domain=[('platform', '=', 'facebook')],
    )
    
    content = fields.Text(
        string='Content',
        required=True,
        tracking=True,
    )
    
    # -------------------------------------------------------------------------
    # MEDIA
    # -------------------------------------------------------------------------
    media_type = fields.Selection([
        ('text', 'Text Only'),
        ('photo', 'Photo'),
        ('video', 'Video'),
        ('link', 'Link'),
    ], string='Media Type', default='text')
    
    image = fields.Binary(string='Image', attachment=True)
    image_filename = fields.Char(string='Image Filename')
    video_url = fields.Char(string='Video URL')
    link_url = fields.Char(string='Link URL')
    
    # -------------------------------------------------------------------------
    # SCHEDULING
    # -------------------------------------------------------------------------
    post_type = fields.Selection([
        ('now', 'Publish Now'),
        ('scheduled', 'Scheduled'),
    ], string='Post Type', default='now', required=True)
    
    scheduled_date = fields.Datetime(
        string='Scheduled Date',
        tracking=True,
    )
    
    # -------------------------------------------------------------------------
    # FACEBOOK DATA
    # -------------------------------------------------------------------------
    facebook_post_id = fields.Char(
        string='Facebook Post ID',
        readonly=True,
        copy=False,
    )
    
    facebook_post_url = fields.Char(
        string='Facebook URL',
        compute='_compute_facebook_url',
        store=True,
    )
    
    published_date = fields.Datetime(
        string='Published Date',
        readonly=True,
        copy=False,
    )
    
    # -------------------------------------------------------------------------
    # STATUS
    # -------------------------------------------------------------------------
    state = fields.Selection([
        ('draft', 'Draft'),
        ('scheduled', 'Scheduled'),
        ('published', 'Published'),
        ('failed', 'Failed'),
    ], string='Status', default='draft', tracking=True)
    
    error_message = fields.Text(string='Error Message')
    
    # -------------------------------------------------------------------------
    # ENGAGEMENT STATS
    # -------------------------------------------------------------------------
    likes_count = fields.Integer(string='Likes', default=0)
    comments_count = fields.Integer(string='Comments', default=0)
    shares_count = fields.Integer(string='Shares', default=0)
    reach = fields.Integer(string='Reach', default=0)
    impressions = fields.Integer(string='Impressions', default=0)
    engagement_rate = fields.Float(
        string='Engagement Rate (%)',
        compute='_compute_engagement_rate',
        store=True,
    )
    
    # -------------------------------------------------------------------------
    # RELATIONS
    # -------------------------------------------------------------------------
    comment_ids = fields.One2many(
        'social.comment',
        'post_id',
        string='Comments',
    )
    
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        related='account_id.company_id',
        store=True,
    )
    
    user_id = fields.Many2one(
        'res.users',
        string='Created By',
        default=lambda self: self.env.user,
    )
    
    # -------------------------------------------------------------------------
    # COMPUTE METHODS
    # -------------------------------------------------------------------------
    @api.depends('content', 'account_id')
    def _compute_display_name(self):
        for post in self:
            if post.content:
                preview = post.content[:50] + '...' if len(post.content) > 50 else post.content
                post.display_name = f"{post.account_id.name}: {preview}"
            else:
                post.display_name = f"Post #{post.id}"
    
    @api.depends('facebook_post_id', 'account_id')
    def _compute_facebook_url(self):
        for post in self:
            if post.facebook_post_id and post.account_id:
                post.facebook_post_url = f"https://www.facebook.com/{post.facebook_post_id}"
            else:
                post.facebook_post_url = False
    
    @api.depends('likes_count', 'comments_count', 'shares_count', 'reach')
    def _compute_engagement_rate(self):
        for post in self:
            if post.reach > 0:
                total_engagement = post.likes_count + post.comments_count + post.shares_count
                post.engagement_rate = (total_engagement / post.reach) * 100
            else:
                post.engagement_rate = 0
    
    # -------------------------------------------------------------------------
    # BUSINESS METHODS
    # -------------------------------------------------------------------------
    
    def _prepare_facebook_post_data(self):
        """
        âœ… HÃ m má»›i: Chuáº©n bá»‹ dá»¯ liá»‡u post theo media_type
        
        Return: (url, data_dict, files_dict)
        """
        base_url = f'https://graph.facebook.com/v18.0/{self.account_id.facebook_page_id}'
        
        # Dá»¯ liá»‡u cÆ¡ báº£n
        data = {
            'access_token': self.account_id.access_token,
            'message': self.content,
        }
        
        files = None
        
        # Xá»­ lÃ½ dá»±a trÃªn media_type
        if self.media_type == 'photo':
            if not self.image:
                raise UserError(_('Please upload an image for photo post!'))
            
            # Decode base64 image
            image_binary = base64.b64decode(self.image)
            filename = self.image_filename or 'image.jpg'
            files = {'source': (filename, image_binary)}
            url = f'{base_url}/photos'
            
        elif self.media_type == 'video':
            if not self.video_url:
                raise UserError(_('Please provide a video URL!'))
            
            data['video_url'] = self.video_url
            url = f'{base_url}/feed'
            
        elif self.media_type == 'link':
            if not self.link_url:
                raise UserError(_('Please provide a link URL!'))
            
            data['link'] = self.link_url
            url = f'{base_url}/feed'
            
        else:  # text only
            url = f'{base_url}/feed'
        
        return url, data, files
    
    def action_publish_now(self):
        """âœ… Sá»¬A: ÄÄƒng bÃ i ngay láº­p tá»©c - Há»– TRá»¢ IMAGE"""
        self.ensure_one()
        
        if self.state != 'draft':
            raise UserError(_('Only draft posts can be published!'))
        
        try:
            # âœ… Cáº¦U DIá»†N Äáº¦U TIÃŠN: Chuáº©n bá»‹ dá»¯ liá»‡u
            url, data, files = self._prepare_facebook_post_data()
            
            # âœ… THAY Äá»”I: Gá»­i request vá»›i files náº¿u cÃ³ image
            if files:
                # Vá»›i image: dÃ¹ng multipart/form-data
                response = requests.post(url, data=data, files=files, timeout=30)
            else:
                # Chá»‰ text: dÃ¹ng form-urlencoded thÆ°á»ng
                response = requests.post(url, data=data, timeout=30)
            
            # Xá»­ lÃ½ response
            if response.status_code == 200:
                result = response.json()
                self.write({
                    'facebook_post_id': result.get('id'),
                    'published_date': fields.Datetime.now(),
                    'state': 'published',
                    'error_message': False,
                })
                
                self.message_post(body=_('Post published successfully!'))
                
                return {
                    'type': 'ir.actions.client',
                    'tag': 'display_notification',
                    'params': {
                        'title': _('Success'),
                        'message': _('Post published to Facebook!'),
                        'type': 'success',
                        'sticky': False,
                    }
                }
            else:
                # âœ… THÃŠM: Error handling tá»‘t hÆ¡n
                try:
                    error_detail = response.json().get('error', {})
                    error_msg = error_detail.get('message', response.text)
                except:
                    error_msg = response.text
                
                raise UserError(_('Failed to publish: %s') % error_msg)
                
        except Exception as e:
            error_str = str(e)
            self.write({
                'state': 'failed',
                'error_message': error_str,
            })
            _logger.error(f'Error publishing post {self.id}: {error_str}')
            raise UserError(_('Error publishing post: %s') % error_str)
    
    def action_schedule_post(self):
        """LÃªn lá»‹ch Ä‘Äƒng bÃ i"""
        self.ensure_one()
        
        if not self.scheduled_date:
            raise UserError(_('Please set a scheduled date!'))
        
        if self.scheduled_date <= fields.Datetime.now():
            raise UserError(_('Scheduled date must be in the future!'))
        
        self.state = 'scheduled'
        self.message_post(body=_('Post scheduled for %s') % self.scheduled_date)
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Success'),
                'message': _('Post scheduled successfully!'),
                'type': 'success',
                'sticky': False,
            }
        }
    
    def action_sync_stats(self):
        """Äá»“ng bá»™ thá»‘ng kÃª tá»« Facebook"""
        self.ensure_one()
        
        if not self.facebook_post_id:
            return False
        
        try:
            url = f'https://graph.facebook.com/v18.0/{self.facebook_post_id}'
            params = {
                'access_token': self.account_id.access_token,
                'fields': 'likes.summary(true),comments.summary(true),shares'
            }
            
            response = requests.get(url, params=params, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                self.write({
                    'likes_count': data.get('likes', {}).get('summary', {}).get('total_count', 0),
                    'comments_count': data.get('comments', {}).get('summary', {}).get('total_count', 0),
                    'shares_count': data.get('shares', {}).get('count', 0),
                })
                return True
            else:
                _logger.error(f'Failed to sync stats: {response.text}')
                return False
                
        except Exception as e:
            _logger.error(f'Error syncing stats: {e}')
            return False
    
    def action_view_comments(self):
        """Xem comments"""
        self.ensure_one()
        return {
            'name': _('Comments'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.comment',
            'view_mode': 'list,form',
            'domain': [('post_id', '=', self.id)],
            'context': {'default_post_id': self.id},
        }
    
    @api.model
    def cron_publish_scheduled_posts(self):
        """Cron job Ä‘á»ƒ publish scheduled posts"""
        now = fields.Datetime.now()
        posts = self.search([
            ('state', '=', 'scheduled'),
            ('scheduled_date', '<=', now),
        ])
        
        for post in posts:
            try:
                post.action_publish_now()
            except Exception as e:
                _logger.error(f'Error publishing scheduled post {post.id}: {e}')
    
    @api.model
    def cron_sync_facebook_comments(self):
        """Cron job Ä‘á»ƒ sync comments"""
        posts = self.search([
            ('state', '=', 'published'),
            ('facebook_post_id', '!=', False),
        ], limit=50)
        
        for post in posts:
            try:
                post.action_sync_stats()
            except Exception as e:
                _logger.error(f'Error syncing post {post.id}: {e}')
                
    def action_sync_comments(self):
        """Äá»“ng bá»™ chi tiáº¿t tá»«ng comment tá»« Facebook vá» Odoo"""
        self.ensure_one()
        if not self.facebook_post_id:
            raise UserError(_('Post not published yet!'))
        
        try:
            # Gá»i Graph API láº¥y comments
            url = f'https://graph.facebook.com/v18.0/{self.facebook_post_id}/comments'
            params = {
                'access_token': self.account_id.access_token,
                'fields': 'id,message,from,created_time,parent',
                'limit': 100
            }
            
            response = requests.get(url, params=params, timeout=30)
            if response.status_code == 200:
                data = response.json()
                
                # Loop qua tá»«ng comment
                for fb_comment in data.get('data', []):
                    # Kiá»ƒm tra xem comment Ä‘Ã£ cÃ³ chÆ°a
                    existing = self.env['social.comment'].search([
                        ('facebook_comment_id', '=', fb_comment['id']),
                        ('post_id', '=', self.id)
                    ], limit=1)
                    
                    if not existing:
                        # Táº¡o má»›i comment record
                        author = fb_comment.get('from', {})
                        self.env['social.comment'].create({
                            'post_id': self.id,
                            'facebook_comment_id': fb_comment['id'],
                            'author_name': author.get('name', 'Unknown'),
                            'author_facebook_id': author.get('id', ''),
                            'message': fb_comment.get('message', ''),
                            'comment_date': fb_comment.get('created_time'),
                            'company_id': self.company_id.id,
                        })
                
                self.message_post(body=_('Comments synced from Facebook!'))
                return True
            else:
                raise UserError(_('Failed to sync comments: %s') % response.text)
                
        except Exception as e:
            raise UserError(_('Error syncing comments: %s') % str(e))




################################################################################
## FILE 27: social_post_template.py
## ÄÆ°á»ng dáº«n: models/social_post_template.py
################################################################################

from odoo import models, fields, api, _


class SocialPostTemplate(models.Model):
    """
    Model quáº£n lÃ½ templates cho bÃ i Ä‘Äƒng.
    """
    _name = 'social.post.template'
    _description = 'Social Post Template'
    _order = 'name'

    name = fields.Char(
        string='Template Name',
        required=True,
    )
    
    template_type = fields.Selection([
        ('product_launch', 'Product Launch'),
        ('promotion', 'Promotion'),
        ('testimonial', 'Testimonial'),
        ('educational', 'Educational'),
        ('engagement', 'Engagement'),
        ('event', 'Event'),
        ('custom', 'Custom'),
    ], string='Type', default='custom')
    
    content = fields.Text(
        string='Content Template',
        required=True,
        help='Use {{variable_name}} for dynamic content'
    )
    
    description = fields.Text(string='Description')
    
    active = fields.Boolean(string='Active', default=True)
    
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        default=lambda self: self.env.company,
    )
    
    def action_use_template(self):
        """Sá»­ dá»¥ng template Ä‘á»ƒ táº¡o post má»›i"""
        self.ensure_one()
        return {
            'name': _('New Post from Template'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.post',
            'view_mode': 'form',
            'context': {
                'default_content': self.content,
            },
        }



################################################################################
## FILE 28: ok.py
## ÄÆ°á»ng dáº«n: ok.py
################################################################################

lol



################################################################################
## FILE 29: ir.model.access.csv
## ÄÆ°á»ng dáº«n: security/ir.model.access.csv
################################################################################

id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
access_social_account_user,social.account.user,model_social_account,base.group_user,1,1,1,1
access_social_post_user,social.post.user,model_social_post,base.group_user,1,1,1,1
access_social_comment_user,social.comment.user,model_social_comment,base.group_user,1,1,1,1
access_social_message_user,social.message.user,model_social_message,base.group_user,1,1,1,1
access_social_analytics_user,social.analytics.user,model_social_analytics,base.group_user,1,0,0,0
access_social_post_template_user,social.post.template.user,model_social_post_template,base.group_user,1,1,1,1
access_social_messenger_product_user,social.messenger.product.user,model_social_messenger_product,base.group_user,1,1,1,1
access_social_messenger_order_user,social.messenger.order.user,model_social_messenger_order,base.group_user,1,1,1,1
access_social_conversation_user,social.conversation.user,model_social_conversation,base.group_user,1,1,1,1

access_social_chatbot_automation_user,access_social_chatbot_automation_user,model_social_chatbot_automation,base.group_user,1,0,0,0
access_social_chatbot_automation_manager,access_social_chatbot_automation_manager,model_social_chatbot_automation,group_social_facebook_manager,1,1,1,1



################################################################################
## FILE 30: social_security.xml
## ÄÆ°á»ng dáº«n: security/social_security.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- USER GROUPS                                                        -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    
    <!-- âœ… Sá»¬A: Äá»•i tÃªn group cho khá»›p vá»›i ir.model.access.csv -->
    <record id="group_social_facebook_user" model="res.groups">
        <field name="name">Social Media User</field>
        <field name="implied_ids" eval="[(4, ref('base.group_user'))]"/>
        <field name="comment">CÃ³ thá»ƒ xem vÃ  táº¡o bÃ i Ä‘Äƒng trÃªn Facebook</field>
    </record>

    <record id="group_social_facebook_manager" model="res.groups">
        <field name="name">Social Media Manager</field>
        <field name="implied_ids" eval="[(4, ref('group_social_facebook_user'))]"/>
        <field name="comment">CÃ³ thá»ƒ quáº£n lÃ½ táº¥t cáº£ cáº¥u hÃ¬nh vÃ  tÃ i khoáº£n Facebook</field>
    </record>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- RECORD RULES                                                       -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    
    <!-- Social Account Rules -->
    <record id="social_account_rule_user" model="ir.rule">
        <field name="name">Social Account: User Access</field>
        <field name="model_id" ref="model_social_account"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_facebook_user'))]"/>
    </record>

    <!-- Social Post Rules -->
    <record id="social_post_rule_user" model="ir.rule">
        <field name="name">Social Post: User Access</field>
        <field name="model_id" ref="model_social_post"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_facebook_user'))]"/>
    </record>

    <!-- Social Comment Rules -->
    <record id="social_comment_rule_user" model="ir.rule">
        <field name="name">Social Comment: User Access</field>
        <field name="model_id" ref="model_social_comment"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_facebook_user'))]"/>
    </record>

    <!-- Social Conversation Rules -->
    <record id="social_conversation_rule_user" model="ir.rule">
        <field name="name">Social Conversation: User Access</field>
        <field name="model_id" ref="model_social_conversation"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_facebook_user'))]"/>
    </record>
    
    <!-- Social Message Rules -->
    <record id="social_message_rule_user" model="ir.rule">
        <field name="name">Social Message: User Access</field>
        <field name="model_id" ref="model_social_message"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_facebook_user'))]"/>
    </record>

    <!-- Social Chatbot Automation Rules -->
    <record id="social_chatbot_automation_rule_user" model="ir.rule">
        <field name="name">Social Chatbot Automation: User Access</field>
        <field name="model_id" ref="model_social_chatbot_automation"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_facebook_user'))]"/>
    </record>

</odoo>



################################################################################
## FILE 31: icon.png
## ÄÆ°á»ng dáº«n: static/description/icon.png
################################################################################

[KhÃ´ng Ä‘á»c Ä‘Æ°á»£c file â€“ cÃ³ thá»ƒ lÃ  binary hoáº·c lá»—i mÃ£ hÃ³a]



################################################################################
## FILE 32: social_facebook.css
## ÄÆ°á»ng dáº«n: static/src/css/social_facebook.css
################################################################################

/*
 * CSS for Social Facebook Module
 */

.social_post_card {
    border-left: 4px solid #1877f2;
    transition: transform 0.2s;
}

.social_post_card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.facebook_badge {
    background-color: #1877f2;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

.engagement_stats {
    display: flex;
    gap: 1rem;
}

.engagement_stats .stat {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}



################################################################################
## FILE 33: social_conversation_list.js
## ÄÆ°á»ng dáº«n: static/src/js/social_conversation_list.js
################################################################################

/** @odoo-module **/

import { ListController } from "@web/views/list/list_controller";
import { listView } from "@web/views/list/list_view";
import { registry } from "@web/core/registry";
import { useService } from "@web/core/utils/hooks";

/**
 * Custom List Controller for Social Conversation
 * Adds "Sync All Conversations" button to the toolbar
 */
export class SocialConversationListController extends ListController {
    setup() {
        super.setup();
        this.orm = useService("orm");
        this.action = useService("action");
        this.notification = useService("notification");
    }

    /**
     * Handler for Sync All Conversations button
     */
    async onClickSyncConversations() {
        // Show loading notification
        this.notification.add("Äang Ä‘á»“ng bá»™ conversations tá»« Facebook...", {
            type: "info",
        });

        try {
            // Call the server method
            const result = await this.orm.call(
                "social.conversation",
                "action_sync_all_conversations",
                [[]]
            );

            // Reload the list view
            await this.model.load();

            // Show success notification
            if (result && result.params) {
                this.notification.add(result.params.message, {
                    type: result.params.type || "success",
                    sticky: result.params.sticky || false,
                });
            } else {
                this.notification.add("Äá»“ng bá»™ hoÃ n táº¥t!", {
                    type: "success",
                });
            }
        } catch (error) {
            console.error("Error syncing conversations:", error);
            this.notification.add("Lá»—i khi Ä‘á»“ng bá»™: " + (error.message || error), {
                type: "danger",
                sticky: true,
            });
        }
    }
}

// Define the template with the sync button
SocialConversationListController.template = "module_social_facebook.SocialConversationListView";

// Create custom list view for social.conversation
export const SocialConversationListView = {
    ...listView,
    Controller: SocialConversationListController,
    buttonTemplate: "module_social_facebook.SocialConversationListView.Buttons",
};

// Register the view
registry.category("views").add("social_conversation_list", SocialConversationListView);



################################################################################
## FILE 34: social_dashboard.js
## ÄÆ°á»ng dáº«n: static/src/js/social_dashboard.js
################################################################################

/** @odoo-module **/

console.log('Social Facebook Dashboard JS loaded');



################################################################################
## FILE 35: social_conversation_templates.xml
## ÄÆ°á»ng dáº«n: static/src/xml/social_conversation_templates.xml
################################################################################

<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <!-- Template for Sync button in list view toolbar -->
    <t t-name="module_social_facebook.SocialConversationListView.Buttons" t-inherit="web.ListView.Buttons">
        <xpath expr="//div[hasclass('o_list_buttons')]" position="inside">
            <button type="button" 
                    class="btn btn-primary o_sync_conversations_button ms-2"
                    t-on-click="() => this.onClickSyncConversations()">
                <i class="fa fa-refresh me-1"/>
                Sync Conversations
            </button>
        </xpath>
    </t>

    <!-- Alternative: Full button template -->
    <t t-name="module_social_facebook.SocialConversationListView">
        <t t-call="web.ListView"/>
    </t>

</templates>



################################################################################
## FILE 36: dashboard_views.xml
## ÄÆ°á»ng dáº«n: views/dashboard_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Dashboard Action -->
    <record id="action_social_dashboard" model="ir.actions.act_window">
        <field name="name">Social Media Dashboard</field>
        <field name="res_model">social.analytics</field>
        <field name="view_mode">pivot,graph,list</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Welcome to Social Media Dashboard!
            </p>
            <p>
                Connect your Facebook pages and start tracking analytics.
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 37: menu_views.xml
## ÄÆ°á»ng dáº«n: views/menu_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- ROOT MENU                                                             -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_marketing_root"
              name="Social"
              web_icon="module_social_facebook,static/description/icon.png"
              sequence="100"/>

    <!-- ===================================================================== -->
    <!-- DASHBOARD                                                             -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_dashboard"
              name="Dashboard"
              parent="menu_social_marketing_root"
              action="action_social_dashboard"
              sequence="1"/>

    <!-- ===================================================================== -->
    <!-- FACEBOOK PAGES                                                        -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_accounts"
              name="Facebook Pages"
              parent="menu_social_marketing_root"
              action="action_social_account"
              sequence="10"/>

    <!-- ===================================================================== -->
    <!-- POSTS                                                                 -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_posts"
              name="Posts"
              parent="menu_social_marketing_root"
              sequence="20"/>

    <menuitem id="menu_social_all_posts"
              name="All Posts"
              parent="menu_social_posts"
              action="action_social_post"
              sequence="10"/>

    <menuitem id="menu_social_post_calendar"
              name="Content Calendar"
              parent="menu_social_posts"
              action="action_social_post_calendar"
              sequence="15"/>

    <!-- ===================================================================== -->
    <!-- TEMPLATES                                                             -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_templates"
              name="Templates"
              parent="menu_social_marketing_root"
              action="action_social_post_template"
              sequence="30"/>

    <!-- ===================================================================== -->
    <!-- COMMENTS                                                              -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_comments"
              name="Comments"
              parent="menu_social_marketing_root"
              action="action_social_comment"
              sequence="40"/>

    <!-- ===================================================================== -->
    <!-- CONVERSATIONS                                                         -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_conversations"
              name="Messenger Conversations"
              parent="menu_social_marketing_root"
              action="action_social_conversation"
              sequence="50"/>

    <!-- ===================================================================== -->
    <!-- MESSENGER SALES                                                       -->
    <!-- ===================================================================== -->
    <menuitem id="menu_messenger_sales"
              name="Messenger Sales"
              parent="menu_social_marketing_root"
              sequence="60"/>

    <menuitem id="menu_messenger_products"
              name="Products"
              parent="menu_messenger_sales"
              action="action_social_messenger_product"
              sequence="10"/>

    <!-- âœ… FIX: Äá»”I ACTION REFERENCE -->
    <menuitem id="menu_messenger_orders"
              name="Orders"
              parent="menu_messenger_sales"
              action="action_messenger_orders_from_sales"
              sequence="20"/>

    <!-- ===================================================================== -->
    <!-- ANALYTICS                                                             -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_analytics"
              name="Analytics"
              parent="menu_social_marketing_root"
              action="action_social_analytics"
              sequence="70"/>

    <!-- ===================================================================== -->
    <!-- CONFIGURATION                                                         -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_configuration"
              name="Configuration"
              parent="menu_social_marketing_root"
              sequence="100"/>

    <menuitem id="menu_social_chatbot_automation"
              name="Chatbot Automation"
              parent="menu_social_configuration"
              action="action_social_chatbot_automation"
              sequence="30"/>

</odoo>



################################################################################
## FILE 38: res_config_settings_views.md
## ÄÆ°á»ng dáº«n: views/res_config_settings_views.md
################################################################################

<odoo>

    <record id="res_config_settings_view_form_social_facebook" model="ir.ui.view">
        <field name="name">res.config.settings.view.form.inherit.social.facebook</field>
        <field name="model">res.config.settings</field>
        <field name="inherit_id" ref="base.res_config_settings_view_form"/>
        <field name="arch" type="xml">
            <!-- FIX: Target vÃ o sheet thay vÃ¬ div[class='settings'] -->
            <xpath expr="//sheet" position="inside">
                
                <div class="app_settings_block" data_key="module_social_facebook" 
                     string="Facebook Integration">
                    <h2>Facebook Integration</h2>
                    
                    <!-- Webhook Configuration -->
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane"></div>
                            <div class="o_setting_right_pane">
                                <span class="o_form_label">Webhook Configuration</span>
                                <div class="text-muted">
                                    Configure your Facebook webhook settings
                                </div>
                                <div class="content-group mt16">
                                    <div class="row">
                                        <label for="facebook_verify_token" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="facebook_verify_token" 
                                               placeholder="e.g., 16112005"/>
                                    </div>
                                    <div class="row mt8">
                                        <label string="Webhook URL" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="facebook_webhook_url" readonly="1"/>
                                        <button name="action_copy_webhook_url" 
                                                type="object" 
                                                string="Copy URL" 
                                                class="btn-link ml8"
                                                icon="fa-copy"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ngrok Integration -->
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane"></div>
                            <div class="o_setting_right_pane">
                                <span class="o_form_label">Ngrok Integration</span>
                                <div class="text-muted">
                                    Manage ngrok tunnel for localhost development
                                </div>
                                <div class="content-group mt16">
                                    <div class="row">
                                        <label for="ngrok_executable_path" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="ngrok_executable_path" 
                                               placeholder="C:/ngrok/ngrok.exe"/>
                                    </div>
                                    <div class="row mt8">
                                        <label string="Ngrok Status" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="ngrok_is_running" readonly="1" 
                                               widget="boolean"/>
                                        <span class="ml8" 
                                              invisible="not ngrok_is_running">
                                            âœ… Running
                                        </span>
                                        <span class="ml8 text-muted" 
                                              invisible="ngrok_is_running">
                                            â›” Not Running
                                        </span>
                                    </div>
                                    <div class="row mt8" 
                                         invisible="not ngrok_tunnel_url">
                                        <label string="Public URL" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="ngrok_tunnel_url" readonly="1" 
                                               class="text-primary font-weight-bold"/>
                                    </div>
                                    <div class="row mt16">
                                        <div class="col-lg-3"></div>
                                        <div>
                                            <button name="action_start_ngrok" 
                                                    type="object" 
                                                    string="Start Ngrok" 
                                                    class="btn-primary"
                                                    icon="fa-play"
                                                    invisible="ngrok_is_running"/>
                                            <button name="action_stop_ngrok" 
                                                    type="object" 
                                                    string="Stop Ngrok" 
                                                    class="btn-secondary ml8"
                                                    icon="fa-stop"
                                                    invisible="not ngrok_is_running"/>
                                            <button name="action_refresh_ngrok_url" 
                                                    type="object" 
                                                    string="Refresh" 
                                                    class="btn-link ml8"
                                                    icon="fa-refresh"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CRM Integration -->
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane">
                                <field name="auto_create_lead"/>
                            </div>
                            <div class="o_setting_right_pane">
                                <label for="auto_create_lead"/>
                                <div class="text-muted">
                                    Automatically create CRM leads from Messenger conversations
                                </div>
                                <div class="content-group mt16" 
                                     invisible="not auto_create_lead">
                                    <div class="row">
                                        <label for="lead_default_user_id" 
                                               string="Default Salesperson" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="lead_default_user_id"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chatbot Configuration -->
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane">
                                <field name="chatbot_enabled"/>
                            </div>
                            <div class="o_setting_right_pane">
                                <label for="chatbot_enabled"/>
                                <div class="text-muted">
                                    Enable automatic sales chatbot on Messenger
                                </div>
                                <div class="content-group mt16" 
                                     invisible="not chatbot_enabled">
                                    <div class="row">
                                        <label for="chatbot_welcome_message" 
                                               string="Welcome Message" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="chatbot_welcome_message" 
                                               widget="text"/>
                                    </div>
                                    <div class="alert alert-info mt16" role="alert">
                                        <strong>Chatbot Flow:</strong><br/>
                                        1. Ask customer name<br/>
                                        2. Ask phone number<br/>
                                        3. Show product catalog<br/>
                                        4. Confirm order<br/>
                                        5. Create sale order automatically
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
            </xpath>
        </field>
    </record>

</odoo>



################################################################################
## FILE 39: social_account_views.xml
## ÄÆ°á»ng dáº«n: views/social_account_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ============================================================
         SOCIAL ACCOUNT - LIST VIEW
         ============================================================ -->
    <record id="social_account_view_tree" model="ir.ui.view">
        <field name="name">social.account.list</field>
        <field name="model">social.account</field>
        <field name="arch" type="xml">
            <list string="Facebook Pages" decoration-muted="not active">
                <field name="name"/>
                <field name="facebook_page_id"/>
                <field name="state" widget="badge" decoration-success="state == 'connected'" decoration-danger="state == 'error'" decoration-info="state == 'draft'"/>
                <field name="followers_count"/>
                <field name="likes_count"/>
                <field name="post_count"/>
                <field name="conversation_count"/>
                <field name="last_sync_date"/>
                <field name="last_message_sync_date"/>
                <field name="active" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- ============================================================
         SOCIAL ACCOUNT - FORM VIEW (Cáº¬P NHáº¬T Vá»šI NÃšT SYNC CONVERSATIONS)
         ============================================================ -->
    <record id="social_account_view_form" model="ir.ui.view">
        <field name="name">social.account.form</field>
        <field name="model">social.account</field>
        <field name="arch" type="xml">
            <form string="Facebook Page">
                <header>
                    <button name="action_test_connection" type="object" string="Test Connection" class="btn-primary" invisible="state == 'connected'"/>
                    <button name="action_sync_page_info" type="object" string="Sync Page Info" class="btn-secondary" invisible="state != 'connected'"/>
                    <!-- âœ… THÃŠM: NÃšT SYNC CONVERSATIONS -->
                    <button name="action_sync_conversations" type="object" string="ğŸ”„ Sync Conversations" class="btn-primary" invisible="state != 'connected'"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,connected"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_posts" type="object" class="oe_stat_button" icon="fa-newspaper-o">
                            <field name="post_count" widget="statinfo" string="Posts"/>
                        </button>
                        <!-- âœ… THÃŠM: NÃšT XEM CONVERSATIONS -->
                        <button name="action_view_conversations" type="object" class="oe_stat_button" icon="fa-comments">
                            <field name="conversation_count" widget="statinfo" string="Conversations"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name" placeholder="Enter Facebook Page Name..."/>
                        </h1>
                    </div>
                    <group>
                        <group string="Facebook Information">
                            <field name="platform" readonly="1"/>
                            <field name="facebook_page_id" placeholder="Enter Page ID..."/>
                            <field name="facebook_page_url" widget="url" readonly="1"/>
                            <field name="page_category" readonly="1"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                            <field name="active" widget="boolean_toggle"/>
                        </group>
                        <group string="Statistics">
                            <field name="followers_count" readonly="1"/>
                            <field name="likes_count" readonly="1"/>
                            <field name="page_rating" readonly="1"/>
                            <field name="last_sync_date" readonly="1"/>
                            <field name="last_message_sync_date" readonly="1"/>
                        </group>
                    </group>
                    <group string="Authentication">
                        <group>
                            <field name="access_token" password="True"/>
                        </group>
                        <group>
                            <field name="token_expires_at"/>
                            <field name="is_token_valid"/>
                        </group>
                    </group>
                    <group string="Settings">
                        <group>
                            <field name="auto_sync_comments"/>
                        </group>
                        <group>
                            <field name="auto_sync_messages"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="About" name="about">
                            <field name="page_about" readonly="1"/>
                        </page>
                        <page string="Error Log" name="errors" invisible="not error_message">
                            <field name="error_message" readonly="1"/>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ============================================================
         SOCIAL ACCOUNT - KANBAN VIEW
         ============================================================ -->
    <record id="social_account_view_kanban" model="ir.ui.view">
        <field name="name">social.account.kanban</field>
        <field name="model">social.account</field>
        <field name="arch" type="xml">
            <kanban>
                <field name="name"/>
                <field name="state"/>
                <field name="followers_count"/>
                <field name="likes_count"/>
                <field name="post_count"/>
                <field name="conversation_count"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_content">
                            <div class="o_kanban_record_top">
                                <strong class="o_kanban_record_title">
                                    <field name="name"/>
                                </strong>
                            </div>
                            <div class="o_kanban_record_body">
                                <div>Status: <field name="state"/></div>
                                <div><field name="followers_count"/> followers</div>
                                <div><field name="likes_count"/> likes</div>
                                <div><field name="post_count"/> posts</div>
                                <div><field name="conversation_count"/> conversations</div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ============================================================
         SOCIAL ACCOUNT - SEARCH VIEW
         ============================================================ -->
    <record id="social_account_view_search" model="ir.ui.view">
        <field name="name">social.account.search</field>
        <field name="model">social.account</field>
        <field name="arch" type="xml">
            <search string="Search Facebook Pages">
                <field name="name"/>
                <field name="facebook_page_id"/>
                <field name="state"/>
                <field name="company_id" groups="base.group_multi_company"/>
                <filter string="Connected" name="filter_connected" domain="[('state', '=', 'connected')]"/>
                <filter string="Draft" name="filter_draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Error" name="filter_error" domain="[('state', '=', 'error')]"/>
                <filter string="Active" name="filter_active" domain="[('active', '=', True)]"/>
                <filter string="Group By Status" name="group_state" context="{'group_by': 'state'}"/>
                <filter string="Group By Company" name="group_company" context="{'group_by': 'company_id'}" groups="base.group_multi_company"/>
            </search>
        </field>
    </record>

    <!-- ============================================================
         SOCIAL ACCOUNT - ACTION
         ============================================================ -->
    <record id="action_social_account" model="ir.actions.act_window">
        <field name="name">Facebook Pages</field>
        <field name="res_model">social.account</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="search_view_id" ref="social_account_view_search"/>
        <field name="context">{'search_default_filter_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Connect your first Facebook Page!
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 40: social_analytics_views.xml
## ÄÆ°á»ng dáº«n: views/social_analytics_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="social_analytics_view_pivot" model="ir.ui.view">
        <field name="name">social.analytics.pivot</field>
        <field name="model">social.analytics</field>
        <field name="arch" type="xml">
            <pivot string="Facebook Analytics">
                <field name="account_id" type="row"/>
                <field name="date" interval="month" type="col"/>
                <field name="total_posts" type="measure"/>
                <field name="total_likes" type="measure"/>
                <field name="total_comments" type="measure"/>
            </pivot>
        </field>
    </record>

    <record id="social_analytics_view_graph" model="ir.ui.view">
        <field name="name">social.analytics.graph</field>
        <field name="model">social.analytics</field>
        <field name="arch" type="xml">
            <graph string="Facebook Analytics" type="line">
                <field name="date" interval="day"/>
                <field name="total_likes" type="measure"/>
                <field name="total_comments" type="measure"/>
            </graph>
        </field>
    </record>

    <record id="social_analytics_view_tree" model="ir.ui.view">
        <field name="name">social.analytics.list</field>
        <field name="model">social.analytics</field>
        <field name="arch" type="xml">
            <list string="Facebook Analytics" create="0" edit="0" delete="0">
                <field name="date"/>
                <field name="account_id"/>
                <field name="total_posts"/>
                <field name="total_likes"/>
                <field name="total_comments"/>
                <field name="total_shares"/>
                <field name="avg_engagement_rate"/>
            </list>
        </field>
    </record>

    <record id="action_social_analytics" model="ir.actions.act_window">
        <field name="name">Facebook Analytics</field>
        <field name="res_model">social.analytics</field>
        <field name="view_mode">pivot,graph,list</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">No analytics data yet!</p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 41: social_chatbot_automation_views.xml
## ÄÆ°á»ng dáº«n: views/social_chatbot_automation_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- TREE VIEW                                                             -->
    <!-- ===================================================================== -->
    <record id="social_chatbot_automation_view_tree" model="ir.ui.view">
        <field name="name">social.chatbot.automation.tree</field>
        <field name="model">social.chatbot.automation</field>
        <field name="arch" type="xml">
            <list string="Chatbot Automation Rules" 
                  decoration-muted="not active">
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="trigger_keywords"/>
                <field name="priority"/>
                <field name="account_id"/>
                <field name="triggered_count"/>
                <field name="active" widget="boolean_toggle"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- FORM VIEW                                                             -->
    <!-- ===================================================================== -->
    <record id="social_chatbot_automation_view_form" model="ir.ui.view">
        <field name="name">social.chatbot.automation.form</field>
        <field name="model">social.chatbot.automation</field>
        <field name="arch" type="xml">
            <form string="Chatbot Automation Rule">
                <header>
                    <button name="action_test_rule" type="object" 
                            string="Test Rule" class="btn-primary"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_triggered_messages" type="object"
                                class="oe_stat_button" icon="fa-comment">
                            <field name="triggered_count" widget="statinfo" 
                                   string="Triggered"/>
                        </button>
                    </div>
                    <widget name="web_ribbon" title="Archived" 
                            bg_color="text-bg-danger" 
                            invisible="active"/>
                    <group>
                        <group>
                            <field name="name"/>
                            <field name="active" invisible="1"/>
                            <field name="account_id"/>
                        </group>
                        <group>
                            <field name="priority"/>
                            <field name="sequence"/>
                            <field name="last_triggered_date" readonly="1"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Configuration">
                            <group>
                                <field name="trigger_keywords" 
                                       placeholder="mua,Ä‘áº·t hÃ ng,order,buy"/>
                                <field name="response_text" 
                                       widget="text" 
                                       placeholder="Enter response message..."/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SEARCH VIEW                                                           -->
    <!-- ===================================================================== -->
    <record id="social_chatbot_automation_view_search" model="ir.ui.view">
        <field name="name">social.chatbot.automation.search</field>
        <field name="model">social.chatbot.automation</field>
        <field name="arch" type="xml">
            <search string="Search Chatbot Rules">
                <field name="name"/>
                <field name="trigger_keywords"/>
                <field name="account_id"/>
                
                <filter string="Active" name="filter_active" 
                        domain="[('active', '=', True)]"/>
                <filter string="Archived" name="filter_archived" 
                        domain="[('active', '=', False)]"/>
                
                <separator/>
                
                <filter string="Group By Page" name="group_account" 
                        context="{'group_by': 'account_id'}"/>
                <filter string="Group By Priority" name="group_priority" 
                        context="{'group_by': 'priority'}"/>
            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- ACTION                                                                -->
    <!-- ===================================================================== -->
    <record id="action_social_chatbot_automation" model="ir.actions.act_window">
        <field name="name">Chatbot Automation</field>
        <field name="res_model">social.chatbot.automation</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="social_chatbot_automation_view_search"/>
        <field name="context">{'search_default_filter_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first chatbot automation rule!
            </p>
            <p>
                Chatbot rules automatically respond to customer messages based on keywords.
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 42: social_comment_views.xml
## ÄÆ°á»ng dáº«n: views/social_comment_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="social_comment_view_tree" model="ir.ui.view">
        <field name="name">social.comment.list</field>
        <field name="model">social.comment</field>
        <field name="arch" type="xml">
            <list string="Facebook Comments" 
                  decoration-muted="is_hidden"
                  decoration-danger="is_spam"
                  decoration-success="replied">
                <field name="comment_date"/>
                <field name="post_id"/>
                <field name="author_name"/>
                <field name="message"/>
                <field name="replied"/>
                <field name="is_hidden" optional="hide"/>
                <field name="is_spam" optional="hide"/>
            </list>
        </field>
    </record>

    <record id="social_comment_view_form" model="ir.ui.view">
        <field name="name">social.comment.form</field>
        <field name="model">social.comment</field>
        <field name="arch" type="xml">
            <form string="Facebook Comment">
                <header>
                    <button name="action_reply" type="object" string="Reply" class="btn-primary" invisible="replied"/>
                    <button name="action_hide" type="object" string="Hide" class="btn-secondary" invisible="is_hidden"/>
                    <button name="action_mark_spam" type="object" string="Mark Spam" class="btn-danger" invisible="is_spam"/>
                </header>
                <sheet>
                    <group>
                        <group string="Comment Info">
                            <field name="post_id"/>
                            <field name="comment_date"/>
                            <field name="facebook_comment_id"/>
                        </group>
                        <group string="Author">
                            <field name="author_name"/>
                            <field name="author_facebook_id"/>
                        </group>
                    </group>
                    <group string="Message">
                        <field name="message" nolabel="1" readonly="1"/>
                    </group>
                    <group string="Reply" invisible="replied">
                        <field name="reply_text" nolabel="1"/>
                    </group>
                    <group string="Status">
                        <field name="replied"/>
                        <field name="is_hidden"/>
                        <field name="is_spam"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_social_comment" model="ir.actions.act_window">
        <field name="name">Facebook Comments</field>
        <field name="res_model">social.comment</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">No comments yet!</p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 43: social_conversation_views.xml
## ÄÆ°á»ng dáº«n: views/social_conversation_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Form View -->
    <record id="social_conversation_view_form" model="ir.ui.view">
        <field name="name">social.conversation.form</field>
        <field name="model">social.conversation</field>
        <field name="arch" type="xml">
            <form string="Messenger Conversation">
                <header>
                    <button name="action_create_lead" type="object" string="Create Lead" class="btn-primary" invisible="lead_id"/>
                    <button name="action_mark_resolved" type="object" string="Mark Resolved" class="btn-success" invisible="state in ['resolved', 'closed']"/>
                    <button name="action_close" type="object" string="Close" class="btn-secondary" invisible="state == 'closed'"/>
                    <button name="action_reopen" type="object" string="Reopen" class="btn-warning" invisible="state != 'closed'"/>
                    <field name="state" widget="statusbar" statusbar_visible="new,ongoing,resolved"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_messages" type="object" class="oe_stat_button" icon="fa-comments">
                            <field name="message_count" widget="statinfo" string="Messages"/>
                        </button>
                    </div>
                    <group>
                        <group string="Customer Information">
                            <field name="customer_name"/>
                            <field name="facebook_psid"/>
                            <field name="customer_phone"/>
                            <field name="customer_email"/>
                        </group>
                        <group string="Conversation Details">
                            <field name="account_id"/>
                            <field name="conversation_id"/>
                            <field name="lead_id"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                        </group>
                    </group>
                    <group>
                        <group string="Tracking">
                            <field name="last_message_date"/>
                            <field name="last_message_from"/>
                            <field name="unread_count"/>
                            <field name="first_response_time"/>
                        </group>
                        <group string="Status">
                            <field name="active"/>
                        </group>
                    </group>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- List View -->
    <record id="social_conversation_view_list" model="ir.ui.view">
        <field name="name">social.conversation.list</field>
        <field name="model">social.conversation</field>
        <field name="arch" type="xml">
            <list string="Messenger Conversations">
                <field name="customer_name"/>
                <field name="account_id"/>
                <field name="state"/>
                <field name="message_count"/>
                <field name="unread_count"/>
                <field name="last_message_date"/>
                <field name="lead_id"/>
            </list>
        </field>
    </record>

    <!-- Search View - SIMPLIFIED -->
    <record id="social_conversation_view_search" model="ir.ui.view">
        <field name="name">social.conversation.search</field>
        <field name="model">social.conversation</field>
        <field name="arch" type="xml">
            <search>
                <field name="customer_name"/>
                <field name="account_id"/>
                <field name="lead_id"/>
            </search>
        </field>
    </record>

    <!-- Action -->
    <record id="action_social_conversation" model="ir.actions.act_window">
        <field name="name">Messenger Conversations</field>
        <field name="res_model">social.conversation</field>
        <field name="view_mode">list,form</field>
    </record>

</odoo>



################################################################################
## FILE 44: social_message_views.xml
## ÄÆ°á»ng dáº«n: views/social_message_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- MESSAGE (CONVERSATION) - LIST VIEW                                    -->
    <!-- ===================================================================== -->
    <record id="social_message_view_tree" model="ir.ui.view">
        <field name="name">social.message.list</field>
        <field name="model">social.message</field>
        <field name="arch" type="xml">
            <list string="Facebook Conversations" 
                  decoration-info="is_from_customer == False"
                  decoration-muted="is_from_customer == True">
                <field name="account_id"/>
                <field name="facebook_user_id"/>
                <field name="customer_name"/>
                <field name="message"/>
                <field name="created_date"/>
                <field name="last_message_date"/>
                <field name="is_from_customer" widget="boolean"/>
                <field name="chatbot_state" widget="badge"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSAGE - FORM VIEW                                                   -->
    <!-- ===================================================================== -->
    <record id="social_message_view_form" model="ir.ui.view">
        <field name="name">social.message.form</field>
        <field name="model">social.message</field>
        <field name="arch" type="xml">
            <form string="Facebook Message / Conversation">
                <header>
                    <field name="chatbot_state" widget="statusbar" 
                           statusbar_visible="idle,ask_name,ask_phone,show_products,confirm_order,completed"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <label for="facebook_user_id" string="Conversation with"/>
                        <h1>
                            <field name="customer_name" placeholder="Customer Name"/>
                        </h1>
                        <h3>
                            <field name="facebook_user_id" readonly="1"/>
                        </h3>
                    </div>
                    
                    <group>
                        <group string="Conversation Info">
                            <field name="account_id" readonly="1"/>
                            <field name="message_id" readonly="1"/>
                            <field name="is_from_customer" widget="boolean"/>
                        </group>
                        <group string="Timestamps">
                            <field name="created_date" readonly="1"/>
                            <field name="last_message_date" readonly="1"/>
                        </group>
                    </group>
                    
                    <group string="Message Content">
                        <field name="message" nolabel="1" widget="text"/>
                    </group>
                    
                    <group string="Customer Info (Chatbot)">
                        <group>
                            <field name="customer_phone"/>
                        </group>
                        <group>
                            <field name="chatbot_state"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Products" name="products">
                            <field name="selected_product_ids" nolabel="1">
                                <list>
                                    <field name="display_name"/>
                                    <field name="price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                    <field name="currency_id" column_invisible="1"/>
                                    <field name="active" widget="boolean"/>
                                    <field name="sequence"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="Related Records" name="related">
                            <group>
                                <field name="lead_id"/>
                                <field name="messenger_order_id"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_ids" widget="mail_thread"/>
                    <field name="activity_ids" widget="mail_activity"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSAGE - SEARCH VIEW                                                 -->
    <!-- ===================================================================== -->
    <record id="social_message_view_search" model="ir.ui.view">
        <field name="name">social.message.search</field>
        <field name="model">social.message</field>
        <field name="arch" type="xml">
            <search string="Search Conversations">
                <field name="facebook_user_id"/>
                <field name="customer_name"/>
                <field name="message"/>
                <field name="account_id"/>
                
                <filter string="From Customer" name="filter_from_customer" 
                        domain="[('is_from_customer', '=', True)]"/>
                <filter string="From Page" name="filter_from_page" 
                        domain="[('is_from_customer', '=', False)]"/>
                <separator/>
                
                <filter string="Idle" name="filter_idle" 
                        domain="[('chatbot_state', '=', 'idle')]"/>
                <filter string="In Progress" name="filter_progress" 
                        domain="[('chatbot_state', 'in', ['ask_name', 'ask_phone', 'show_products', 'confirm_order'])]"/>
                <filter string="Completed" name="filter_completed" 
                        domain="[('chatbot_state', '=', 'completed')]"/>
                <separator/>
                
                <filter string="This Week" name="filter_week" 
                        domain="[('created_date', '&gt;=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                <filter string="This Month" name="filter_month" 
                        domain="[('created_date', '&gt;=', (context_today().replace(day=1)).strftime('%Y-%m-%d'))]"/>
                <separator/>
                
                <filter string="Has Lead" name="filter_has_lead" 
                        domain="[('lead_id', '!=', False)]"/>
                <filter string="Has Order" name="filter_has_order" 
                        domain="[('messenger_order_id', '!=', False)]"/>
                <separator/>
                
                <filter string="Group By Page" name="group_account" 
                        context="{'group_by': 'account_id'}"/>
                <filter string="Group By State" name="group_state" 
                        context="{'group_by': 'chatbot_state'}"/>
                <filter string="Group By Date" name="group_date" 
                        context="{'group_by': 'created_date:month'}"/>
            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSAGE - ACTION                                                      -->
    <!-- ===================================================================== -->
    <record id="action_social_message" model="ir.actions.act_window">
        <field name="name">Facebook Conversations</field>
        <field name="res_model">social.message</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="social_message_view_search"/>
        <field name="context">{'search_default_filter_from_customer': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No conversations yet!
            </p>
            <p>
                Conversations will appear here when customers message your Facebook page.
            </p>
            <p>
                <strong>Webhook must be configured to receive messages automatically.</strong>
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 45: social_messenger_order_views.xml
## ÄÆ°á»ng dáº«n: views/social_messenger_order_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- MESSENGER ORDER - LIST VIEW (HIá»‚N THá»Š ORDERS Tá»ª SALE.ORDER)           -->
    <!-- ===================================================================== -->
    <record id="view_sale_order_messenger_list" model="ir.ui.view">
        <field name="name">sale.order.messenger.list</field>
        <field name="model">sale.order</field>
        <field name="arch" type="xml">
            <list string="Messenger Orders" 
                  decoration-success="state == 'sale'" 
                  decoration-info="state == 'draft'"
                  decoration-muted="state == 'cancel'"
                  create="false">
                <field name="name"/>
                <field name="date_order"/>
                <field name="partner_id"/>
                <field name="amount_total" widget="monetary" sum="Total"/>
                <field name="state" widget="badge" 
                       decoration-success="state == 'sale'"
                       decoration-info="state == 'draft'"
                       decoration-warning="state == 'sent'"
                       decoration-muted="state == 'cancel'"/>
                <field name="user_id" widget="many2one_avatar_user"/>
                <field name="company_id" groups="base.group_multi_company" column_invisible="1"/>
                <field name="currency_id" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER ORDER - ACTION (Láº¤Y Tá»ª SALE.ORDER)                          -->
    <!-- ===================================================================== -->
    <record id="action_messenger_orders_from_sales" model="ir.actions.act_window">
        <field name="name">Messenger Orders</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">list,form</field>
        <field name="view_id" ref="view_sale_order_messenger_list"/>
        <field name="domain">[('partner_id.category_id.name', 'ilike', 'Facebook-Messenger')]</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ğŸ“¦ No Messenger Orders Yet
            </p>
            <p>
                Orders from Facebook Messenger customers will appear here.<br/>
                Customers with tag "Facebook-Messenger" are automatically tracked!
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 46: social_messenger_product_views.xml
## ÄÆ°á»ng dáº«n: views/social_messenger_product_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - LIST VIEW                                         -->
    <!-- ===================================================================== -->
    <record id="social_messenger_product_view_tree" model="ir.ui.view">
        <field name="name">social.messenger.product.list</field>
        <field name="model">social.messenger.product</field>
        <field name="arch" type="xml">
            <list string="Messenger Products" 
                  decoration-muted="active == False"
                  editable="bottom">
                <field name="sequence" widget="handle"/>
                <field name="product_id"/>
                <field name="quick_reply_title"/>
                <field name="price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                <field name="currency_id" column_invisible="1"/>
                <field name="active" widget="boolean_toggle"/>
                <field name="order_count"/>
                <field name="company_id" groups="base.group_multi_company" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - FORM VIEW                                         -->
    <!-- ===================================================================== -->
    <record id="social_messenger_product_view_form" model="ir.ui.view">
        <field name="name">social.messenger.product.form</field>
        <field name="model">social.messenger.product</field>
        <field name="arch" type="xml">
            <form string="Messenger Product">
                <header>
                    <button name="action_toggle_active" type="object" 
                            string="Enable" class="btn-primary"
                            invisible="active == True"/>
                    <button name="action_toggle_active" type="object" 
                            string="Disable" class="btn-secondary"
                            invisible="active == False"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_orders" type="object" 
                                class="oe_stat_button" icon="fa-shopping-cart"
                                invisible="order_count == 0">
                            <field name="order_count" widget="statinfo" 
                                   string="Orders"/>
                        </button>
                    </div>
                    
                    <field name="image_url" widget="image" class="oe_avatar"/>
                    
                    <div class="oe_title">
                        <h1>
                            <field name="product_id" 
                                   placeholder="Select Product..."
                                   options="{'no_create': True}"/>
                        </h1>
                    </div>
                    
                    <group>
                        <group string="Product Info">
                            <field name="display_name" invisible="1"/>
                            <field name="quick_reply_title" 
                                   placeholder="Max 20 characters"/>
                            <field name="price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                            <field name="currency_id" column_invisible="1"/>
                            <field name="sequence"/>
                        </group>
                        <group string="Organization">
                            <field name="company_id" 
                                   groups="base.group_multi_company"/>
                        </group>
                    </group>
                    
                    <group string="Messenger Description">
                        <field name="description" nolabel="1" 
                               placeholder="Description sent to customers..."/>
                    </group>
                    
                    <notebook>
                        <page string="Preview" name="preview">
                            <group>
                                <group string="How it appears in Messenger">
                                    <div class="alert alert-info" role="alert">
                                        <h4>Quick Reply Button:</h4>
                                        <p>
                                            <strong>
                                                <field name="quick_reply_title" readonly="1"/>
                                            </strong>
                                        </p>
                                        
                                        <h4>Product Message:</h4>
                                        <p>
                                            ğŸ›ï¸ <field name="product_id" readonly="1"/><br/>
                                            ğŸ’° GiÃ¡: <field name="price" readonly="1"/> 
                                            <field name="currency_id" readonly="1"/><br/>
                                            ğŸ“ <field name="description" readonly="1"/>
                                        </p>
                                    </div>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - KANBAN VIEW                                       -->
    <!-- ===================================================================== -->
    <record id="social_messenger_product_view_kanban" model="ir.ui.view">
        <field name="name">social.messenger.product.kanban</field>
        <field name="model">social.messenger.product</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile">
                <field name="product_id"/>
                <field name="quick_reply_title"/>
                <field name="price"/>
                <field name="currency_id"/>
                <field name="active"/>
                <field name="order_count"/>
                
                <templates>
                    <t t-name="card" t-translation="off">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="product_id"/>
                                    </strong>
                                </div>
                                <span class="badge rounded-pill" 
                                      t-att-class="record.active.raw_value ? 'text-bg-success' : 'text-bg-secondary'">
                                    <t t-if="record.active.raw_value">Active</t>
                                    <t t-else="">Inactive</t>
                                </span>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="quick_reply_title"/>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <field name="price" widget="monetary"/>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <i class="fa fa-shopping-cart"/> 
                                    <field name="order_count"/> orders
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - SEARCH VIEW                                       -->
    <!-- ===================================================================== -->
    <record id="social_messenger_product_view_search" model="ir.ui.view">
        <field name="name">social.messenger.product.search</field>
        <field name="model">social.messenger.product</field>
        <field name="arch" type="xml">
            <search string="Search Products">
                <field name="product_id"/>
                <field name="quick_reply_title"/>
                
                <filter string="Active" name="filter_active" 
                        domain="[('active', '=', True)]"/>
                <filter string="Inactive" name="filter_inactive" 
                        domain="[('active', '=', False)]"/>
                <separator/>
                
                <!-- XÃ“A FILTER "Has Orders" VÃŒ order_count LÃ€ COMPUTED FIELD -->
                
                <filter string="Group By Product" name="group_product" 
                        context="{'group_by': 'product_id'}"/>
            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - ACTION                                            -->
    <!-- ===================================================================== -->
    <record id="action_social_messenger_product" model="ir.actions.act_window">
        <field name="name">Messenger Products</field>
        <field name="res_model">social.messenger.product</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="search_view_id" ref="social_messenger_product_view_search"/>
        <field name="context">{'search_default_filter_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No products configured for Messenger!
            </p>
            <p>
                Add products to sell via Facebook Messenger chatbot.
            </p>
            <p>
                <strong>Only active products will appear in the chatbot.</strong>
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 47: social_post_calendar_views.xml
## ÄÆ°á»ng dáº«n: views/social_post_calendar_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="social_post_view_calendar" model="ir.ui.view">
        <field name="name">social.post.calendar</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <calendar
                string="Content Calendar"
                date_start="scheduled_date"
                mode="month"
                color="state"
                quick_create="0"
                event_open_popup="1">
                
                <!-- Required fields for calendar -->
                <field name="content"/>
                <field name="account_id"/>
                <field name="state"/>
                
            </calendar>
        </field>
    </record>

    <record id="action_social_post_calendar" model="ir.actions.act_window">
        <field name="name">Content Calendar</field>
        <field name="res_model">social.post</field>
        <field name="view_mode">calendar,tree,form</field>
        <field name="domain">[('scheduled_date', '!=', False)]</field>
        <field name="context">{'default_post_type': 'scheduled'}</field>
    </record>

</odoo>



################################################################################
## FILE 48: social_post_template_views.xml
## ÄÆ°á»ng dáº«n: views/social_post_template_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - LIST VIEW                                      -->
    <!-- ===================================================================== -->
    <record id="social_post_template_view_tree" model="ir.ui.view">
        <field name="name">social.post.template.list</field>
        <field name="model">social.post.template</field>
        <field name="arch" type="xml">
            <list string="Post Templates" decoration-muted="not active">
                <field name="name"/>
                <field name="template_type" widget="badge"/>
                <field name="description"/>
                <field name="active" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - FORM VIEW                                      -->
    <!-- ===================================================================== -->
    <record id="social_post_template_view_form" model="ir.ui.view">
        <field name="name">social.post.template.form</field>
        <field name="model">social.post.template</field>
        <field name="arch" type="xml">
            <form string="Post Template">
                <sheet>
                    <div class="oe_title">
                        <label for="name" string="Template Name"/>
                        <h1>
                            <field name="name" placeholder="Enter template name..."/>
                        </h1>
                    </div>
                    <group>
                        <group string="Template Info">
                            <field name="template_type"/>
                            <field name="active" widget="boolean_toggle"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                        </group>
                        <group string="Description">
                            <field name="description" nolabel="1" placeholder="Optional description..."/>
                        </group>
                    </group>
                    <group string="Content Template">
                        <field name="content" nolabel="1" placeholder="Enter your template content here. Use {{variable_name}} for dynamic content..."/>
                    </group>
                    <div class="mt-3">
                        <button name="action_use_template" type="object"
                                string="Use This Template" class="btn-primary"/>
                    </div>
                </sheet>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - KANBAN VIEW (FIXED FOR ODOO 19)                -->
    <!-- ===================================================================== -->
    <record id="social_post_template_view_kanban" model="ir.ui.view">
        <field name="name">social.post.template.kanban</field>
        <field name="model">social.post.template</field>
        <field name="arch" type="xml">
            <kanban>
                <field name="name"/>
                <field name="template_type"/>
                <field name="content"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_content">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <div>Type: <field name="template_type"/></div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - SEARCH VIEW                                    -->
    <!-- ===================================================================== -->
    <record id="social_post_template_view_search" model="ir.ui.view">
        <field name="name">social.post.template.search</field>
        <field name="model">social.post.template</field>
        <field name="arch" type="xml">
            <search string="Search Templates">
                <field name="name"/>
                <field name="content"/>
                <filter string="Active" name="filter_active" domain="[('active', '=', True)]"/>
<!-- Group By -->
                <filter string="Group By Type" name="group_type" context="{'group_by': 'template_type'}"/>
            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - ACTION                                         -->
    <!-- ===================================================================== -->
    <record id="action_social_post_template" model="ir.actions.act_window">
        <field name="name">Post Templates</field>
        <field name="res_model">social.post.template</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="search_view_id" ref="social_post_template_view_search"/>
        <field name="context">{'search_default_filter_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first post template!
            </p>
            <p>
                Templates help you quickly create consistent social media posts.
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 49: social_post_views.xml
## ÄÆ°á»ng dáº«n: views/social_post_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - LIST VIEW                                               -->
    <!-- ===================================================================== -->
    <record id="social_post_view_tree" model="ir.ui.view">
        <field name="name">social.post.list</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <list string="Facebook Posts" 
                  decoration-success="state == 'published'"
                  decoration-info="state == 'scheduled'"
                  decoration-danger="state == 'failed'">
                <field name="account_id"/>
                <field name="content"/>
                <field name="state" widget="badge"
                       decoration-success="state == 'published'"
                       decoration-info="state == 'scheduled'"
                       decoration-danger="state == 'failed'"
                       decoration-warning="state == 'draft'"/>
                <field name="scheduled_date" optional="show"/>
                <field name="published_date" optional="show"/>
                <field name="likes_count"/>
                <field name="comments_count"/>
                <field name="shares_count"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - FORM VIEW (FIXED FOR ODOO 19)                           -->
    <!-- ===================================================================== -->
    <record id="social_post_view_form" model="ir.ui.view">
        <field name="name">social.post.form</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <form string="Facebook Post">
                <header>
                    <button name="action_publish_now" type="object"
                            string="Publish Now" class="btn-primary"
                            invisible="state != 'draft'"/>
                    <button name="action_schedule_post" type="object"
                            string="Schedule" class="btn-secondary"
                            invisible="state != 'draft'"/>
                    <button name="action_sync_stats" type="object"
                            string="Sync Stats" class="btn-secondary"
                            invisible="state != 'published'"/>
                                <!-- NÃšT Má»šI: SYNC COMMENTS -->
                    <button name="action_sync_comments" type="object"
                            string="Sync Comments" class="btn-secondary"
                            invisible="state != 'published'"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,scheduled,published"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_comments" type="object"
                                class="oe_stat_button" icon="fa-comments"
                                invisible="comments_count == 0">
                            <field name="comments_count" widget="statinfo" string="Comments"/>
                        </button>
                    </div>
                    
                    <group>
                        <group string="Post Information">
                            <field name="account_id" options="{'no_create': True}"/>
                            <field name="post_type" widget="radio"/>
                            <field name="scheduled_date" invisible="post_type != 'scheduled'"/>
                            <field name="user_id" readonly="1"/>
                        </group>
                        <group string="Engagement Stats" invisible="state != 'published'">
                            <field name="likes_count" readonly="1"/>
                            <field name="comments_count" readonly="1"/>
                            <field name="shares_count" readonly="1"/>
                            <field name="engagement_rate" readonly="1"/>
                        </group>
                    </group>
                    
                    <group string="Content">
                        <field name="content" nolabel="1" placeholder="What do you want to share?"/>
                    </group>
                    
                    <group string="Media">
                        <group>
                            <field name="media_type" widget="radio"/>
                        </group>
                        <group>
                            <field name="image" widget="image" invisible="media_type != 'photo'" class="oe_avatar"/>
                            <field name="link_url" invisible="media_type != 'link'" placeholder="https://..."/>
                            <field name="video_url" invisible="media_type != 'video'" placeholder="https://..."/>
                        </group>
                    </group>
                    
                    <notebook invisible="state == 'draft'">
                        <page string="Facebook Info" name="fb_info" invisible="not facebook_post_id">
                            <group>
                                <group>
                                    <field name="facebook_post_id" readonly="1"/>
                                    <field name="facebook_post_url" widget="url" readonly="1"/>
                                </group>
                                <group>
                                    <field name="published_date" readonly="1"/>
                                    <field name="reach" readonly="1"/>
                                    <field name="impressions" readonly="1"/>
                                </group>
                            </group>
                        </page>
                        <page string="Error Log" name="errors" invisible="not error_message">
                            <group>
                                <field name="error_message" nolabel="1" readonly="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - KANBAN VIEW (FIXED FOR ODOO 19)                         -->
    <!-- ===================================================================== -->
    <record id="social_post_view_kanban" model="ir.ui.view">
        <field name="name">social.post.kanban</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state">
                <field name="content"/>
                <field name="state"/>
                <field name="account_id"/>
                <field name="likes_count"/>
                <field name="comments_count"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_content">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="account_id"/>
                                    </strong>
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="content"/>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <span><field name="likes_count"/> likes</span>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <span><field name="comments_count"/> comments</span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - SEARCH VIEW                                             -->
    <!-- ===================================================================== -->
    <record id="social_post_view_search" model="ir.ui.view">
        <field name="name">social.post.search</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <search string="Search Posts">
                <field name="content"/>
                <field name="account_id"/>
                <filter string="Draft" name="filter_draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Scheduled" name="filter_scheduled" domain="[('state', '=', 'scheduled')]"/>
                <filter string="Published" name="filter_published" domain="[('state', '=', 'published')]"/>
                <filter string="Failed" name="filter_failed" domain="[('state', '=', 'failed')]"/>
                <filter string="Group By Status" name="group_state" context="{'group_by': 'state'}"/>
                <filter string="Group By Page" name="group_account" context="{'group_by': 'account_id'}"/>

            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - ACTION                                                  -->
    <!-- ===================================================================== -->
    <record id="action_social_post" model="ir.actions.act_window">
        <field name="name">Facebook Posts</field>
        <field name="res_model">social.post</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="search_view_id" ref="social_post_view_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first Facebook post!
            </p>
            <p>
                Click the "New" button to create a new post.
            </p>
        </field>
    </record>
    
</odoo>



################################################################################
## FILE 50: __init__.py
## ÄÆ°á»ng dáº«n: wizard/__init__.py
################################################################################

from . import post_composer_wizard
from . import bulk_schedule_wizard



################################################################################
## FILE 51: bulk_schedule_wizard.py
## ÄÆ°á»ng dáº«n: wizard/bulk_schedule_wizard.py
################################################################################

from odoo import models, fields, api, _
from odoo.exceptions import UserError, ValidationError
from datetime import timedelta
import logging

_logger = logging.getLogger(__name__)


class BulkScheduleWizard(models.TransientModel):
    _name = 'social.bulk.schedule.wizard'
    _description = 'Bulk Post Scheduler Wizard'

    account_ids = fields.Many2many('social.account', string='Facebook Pages', required=True,
                                    domain=[('platform', '=', 'facebook'), ('state', '=', 'connected')])
    post_template_ids = fields.Many2many('social.post.template', string='Post Templates')
    
    schedule_type = fields.Selection([
        ('specific', 'Specific Dates'),
        ('recurring', 'Recurring Schedule'),
    ], string='Schedule Type', default='specific', required=True)
    
    start_date = fields.Datetime(string='Start Date', default=lambda self: fields.Datetime.now() + timedelta(hours=1))
    end_date = fields.Datetime(string='End Date')
    time_slots = fields.Text(string='Time Slots', default='09:00\n12:00\n15:00\n18:00')
    
    frequency = fields.Selection([
        ('daily', 'Daily'),
        ('weekly', 'Weekly'),
        ('monthly', 'Monthly'),
    ], string='Frequency', default='daily')
    
    interval = fields.Integer(string='Every', default=1)
    
    weekday_monday = fields.Boolean(string='Monday', default=True)
    weekday_tuesday = fields.Boolean(string='Tuesday', default=True)
    weekday_wednesday = fields.Boolean(string='Wednesday', default=True)
    weekday_thursday = fields.Boolean(string='Thursday', default=True)
    weekday_friday = fields.Boolean(string='Friday', default=True)
    weekday_saturday = fields.Boolean(string='Saturday', default=False)
    weekday_sunday = fields.Boolean(string='Sunday', default=False)
    
    day_of_month = fields.Integer(string='Day of Month', default=1)
    posting_times = fields.Text(string='Daily Posting Times', default='09:00\n15:00')
    duration_days = fields.Integer(string='Duration (Days)', default=30)
    
    content_rotation = fields.Selection([
        ('sequential', 'Sequential'),
        ('random', 'Random'),
    ], string='Content Rotation', default='sequential')
    
    preview_count = fields.Integer(string='Posts to Create', compute='_compute_preview_count')
    
    @api.depends('account_ids', 'post_template_ids', 'schedule_type', 'start_date', 'end_date', 'duration_days')
    def _compute_preview_count(self):
        for wizard in self:
            try:
                schedule = wizard._generate_schedule()
                wizard.preview_count = len(schedule) * len(wizard.account_ids)
            except:
                wizard.preview_count = 0
    
    def _get_selected_weekdays(self):
        self.ensure_one()
        weekdays = []
        if self.weekday_monday: weekdays.append(0)
        if self.weekday_tuesday: weekdays.append(1)
        if self.weekday_wednesday: weekdays.append(2)
        if self.weekday_thursday: weekdays.append(3)
        if self.weekday_friday: weekdays.append(4)
        if self.weekday_saturday: weekdays.append(5)
        if self.weekday_sunday: weekdays.append(6)
        return weekdays
    
    def _parse_time_slots(self, time_text):
        times = []
        for line in (time_text or '').split('\n'):
            line = line.strip()
            if not line:
                continue
            try:
                hour, minute = map(int, line.split(':'))
                if 0 <= hour <= 23 and 0 <= minute <= 59:
                    times.append((hour, minute))
            except:
                pass
        return times if times else [(9, 0)]
    
    def _generate_schedule(self):
        self.ensure_one()
        schedule = []
        
        if not self.start_date:
            return schedule
        
        if self.schedule_type == 'specific':
            current = self.start_date
            end = self.end_date or (self.start_date + timedelta(days=30))
            times = self._parse_time_slots(self.time_slots)
            
            while current <= end:
                for hour, minute in times:
                    scheduled_time = current.replace(hour=hour, minute=minute, second=0, microsecond=0)
                    if scheduled_time > fields.Datetime.now():
                        schedule.append(scheduled_time)
                current += timedelta(days=1)
        else:
            current = self.start_date
            end_date = current + timedelta(days=self.duration_days)
            times = self._parse_time_slots(self.posting_times)
            selected_weekdays = self._get_selected_weekdays()
            
            while current <= end_date:
                should_post = False
                if self.frequency == 'daily':
                    should_post = True
                elif self.frequency == 'weekly':
                    should_post = current.weekday() in selected_weekdays
                elif self.frequency == 'monthly':
                    should_post = current.day == self.day_of_month
                
                if should_post:
                    for hour, minute in times:
                        scheduled_time = current.replace(hour=hour, minute=minute, second=0, microsecond=0)
                        if scheduled_time > fields.Datetime.now():
                            schedule.append(scheduled_time)
                
                current += timedelta(days=1)
        
        return sorted(schedule)
    
    def action_schedule_posts(self):
        self.ensure_one()
        
        if not self.account_ids:
            raise UserError(_('Please select at least one Facebook Page!'))
        if not self.post_template_ids:
            raise UserError(_('Please select at least one post template!'))
        
        schedule = self._generate_schedule()
        if not schedule:
            raise UserError(_('No valid schedule dates found!'))
        
        created_posts = self.env['social.post']
        template_index = 0
        templates_list = list(self.post_template_ids)
        
        for scheduled_time in schedule:
            template = templates_list[template_index % len(templates_list)]
            template_index += 1
            
            for account in self.account_ids:
                post = self.env['social.post'].create({
                    'account_id': account.id,
                    'content': template.content,
                    'post_type': 'scheduled',
                    'scheduled_date': scheduled_time,
                    'state': 'scheduled',
                })
                created_posts |= post
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Success'),
                'message': _('Successfully scheduled %d posts!') % len(created_posts),
                'type': 'success',
                'sticky': False,
            }
        }




################################################################################
## FILE 52: post_composer_wizard.py
## ÄÆ°á»ng dáº«n: wizard/post_composer_wizard.py
################################################################################

from odoo import models, fields, api, _
from odoo.exceptions import UserError, ValidationError
import logging

_logger = logging.getLogger(__name__)


class PostComposerWizard(models.TransientModel):
    """
    Wizard Ä‘á»ƒ táº¡o vÃ  Ä‘Äƒng bÃ i nhanh lÃªn Facebook.
    Cho phÃ©p publish ngay hoáº·c lÃªn lá»‹ch.
    """
    _name = 'social.post.composer.wizard'
    _description = 'Quick Post Composer Wizard'

    # -------------------------------------------------------------------------
    # BASIC FIELDS
    # -------------------------------------------------------------------------
    account_ids = fields.Many2many(
        'social.account',
        string='Facebook Pages',
        required=True,
        domain=[('platform', '=', 'facebook'), ('state', '=', 'connected')],
        help='Select which pages to post to'
    )
    
    content = fields.Text(
        string='Post Content',
        required=True,
        help='What do you want to share?'
    )
    
    template_id = fields.Many2one(
        'social.post.template',
        string='Use Template',
        help='Select a template to start with'
    )
    
    # -------------------------------------------------------------------------
    # MEDIA
    # -------------------------------------------------------------------------
    media_type = fields.Selection([
        ('text', 'Text Only'),
        ('photo', 'Photo'),
        ('link', 'Link'),
    ], string='Post Type', default='text', required=True)
    
    image = fields.Binary(
        string='Image',
        attachment=True,
    )
    
    image_filename = fields.Char(string='Image Filename')
    
    link_url = fields.Char(
        string='Link URL',
        help='Share a link (optional)'
    )
    
    # -------------------------------------------------------------------------
    # SCHEDULING
    # -------------------------------------------------------------------------
    post_method = fields.Selection([
        ('now', 'Publish Now'),
        ('scheduled', 'Schedule for Later'),
    ], string='When to Post', default='now', required=True)
    
    scheduled_date = fields.Datetime(
        string='Schedule Date',
        help='When should this post be published?'
    )
    
    # -------------------------------------------------------------------------
    # PREVIEW
    # -------------------------------------------------------------------------
    preview_text = fields.Html(
        string='Preview',
        compute='_compute_preview_text',
        sanitize=False,
    )
    
    character_count = fields.Integer(
        string='Characters',
        compute='_compute_character_count',
    )
    
    # -------------------------------------------------------------------------
    # STATS
    # -------------------------------------------------------------------------
    page_count = fields.Integer(
        string='Number of Pages',
        compute='_compute_page_count',
    )
    
    # -------------------------------------------------------------------------
    # COMPUTE METHODS
    # -------------------------------------------------------------------------
    @api.onchange('template_id')
    def _onchange_template_id(self):
        """Load template content"""
        if self.template_id:
            self.content = self.template_id.content
    
    @api.depends('content')
    def _compute_character_count(self):
        """Count characters in content"""
        for wizard in self:
            wizard.character_count = len(wizard.content or '')
    
    @api.depends('account_ids')
    def _compute_page_count(self):
        """Count selected pages"""
        for wizard in self:
            wizard.page_count = len(wizard.account_ids)
    
    @api.depends('content', 'link_url', 'media_type')
    def _compute_preview_text(self):
        """Generate preview of the post"""
        for wizard in self:
            preview = '<div style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background-color: #f9f9f9;">'
            preview += '<div style="margin-bottom: 10px;">'
            preview += '<i class="fa fa-facebook-square" style="color: #1877f2; font-size: 20px;"></i> '
            preview += '<strong>Facebook Post Preview</strong>'
            preview += '</div>'
            
            if wizard.content:
                preview += f'<p style="white-space: pre-wrap; margin-bottom: 10px;">{wizard.content}</p>'
            
            if wizard.link_url:
                preview += f'<div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; background-color: #fff;">'
                preview += f'<i class="fa fa-link"></i> <a href="{wizard.link_url}" target="_blank">{wizard.link_url}</a>'
                preview += '</div>'
            
            if wizard.media_type == 'photo':
                preview += '<div style="margin-top: 10px;">'
                preview += '<i class="fa fa-camera"></i> <em>Image will be attached</em>'
                preview += '</div>'
            
            preview += '</div>'
            wizard.preview_text = preview
    
    # -------------------------------------------------------------------------
    # VALIDATION
    # -------------------------------------------------------------------------
    @api.constrains('scheduled_date', 'post_method')
    def _check_scheduled_date(self):
        """Validate scheduled date"""
        for wizard in self:
            if wizard.post_method == 'scheduled':
                if not wizard.scheduled_date:
                    raise ValidationError(_('Please set a scheduled date!'))
                if wizard.scheduled_date <= fields.Datetime.now():
                    raise ValidationError(_('Scheduled date must be in the future!'))
    
    @api.constrains('content')
    def _check_content_length(self):
        """Check content length"""
        for wizard in self:
            if wizard.content and len(wizard.content) > 63206:
                raise ValidationError(_('Facebook posts are limited to 63,206 characters!'))
    
    # -------------------------------------------------------------------------
    # ACTIONS
    # -------------------------------------------------------------------------
    def action_publish(self):
        """Create and publish/schedule posts"""
        self.ensure_one()
        
        if not self.account_ids:
            raise UserError(_('Please select at least one Facebook Page!'))
        
        created_posts = self.env['social.post']
        
        for account in self.account_ids:
            post_vals = {
                'account_id': account.id,
                'content': self.content,
                'media_type': self.media_type,
                'link_url': self.link_url,
                'post_type': self.post_method,
            }
            
            if self.media_type == 'photo' and self.image:
                post_vals.update({
                    'image': self.image,
                    'image_filename': self.image_filename,
                })
            
            if self.post_method == 'scheduled':
                post_vals['scheduled_date'] = self.scheduled_date
            
            post = self.env['social.post'].create(post_vals)
            created_posts |= post
            
            # If publish now, trigger publish action
            if self.post_method == 'now':
                try:
                    post.action_publish_now()
                except Exception as e:
                    _logger.error(f'Error publishing post {post.id}: {e}')
                    raise UserError(_('Error publishing to %s: %s') % (account.name, str(e)))
            else:
                post.state = 'scheduled'
        
        # Show success notification
        message = _('Successfully created %d post(s)!') % len(created_posts)
        if self.post_method == 'now':
            message = _('Successfully published to %d page(s)!') % len(self.account_ids)
        else:
            message = _('Successfully scheduled %d post(s) for %s') % (
                len(created_posts), 
                self.scheduled_date.strftime('%Y-%m-%d %H:%M')
            )
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Success'),
                'message': message,
                'type': 'success',
                'sticky': False,
                'next': {
                    'type': 'ir.actions.act_window',
                    'res_model': 'social.post',
                    'view_mode': 'list,form',
                    'domain': [('id', 'in', created_posts.ids)],
                }
            }
        }
    
    def action_preview(self):
        """Show preview of the post"""
        self.ensure_one()
        return {
            'type': 'ir.actions.act_window',
            'name': _('Post Preview'),
            'res_model': 'social.post.composer.wizard',
            'view_mode': 'form',
            'res_id': self.id,
            'target': 'new',
        }




################################################################################
## FILE 53: wizard_views.xml
## ÄÆ°á»ng dáº«n: wizard/wizard_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="post_composer_wizard_view_form" model="ir.ui.view">
        <field name="name">social.post.composer.wizard.form</field>
        <field name="model">social.post.composer.wizard</field>
        <field name="arch" type="xml">
            <form string="Quick Post Composer">
                <sheet>
                    <group>
                        <group string="Select Pages">
                            <field name="account_ids" widget="many2many_tags"/>
                        </group>
                        <group string="Options">
                            <field name="template_id"/>
                            <field name="post_method" widget="radio"/>
                        </group>
                    </group>
                    <group string="Content">
                        <field name="content" nolabel="1"/>
                    </group>
                    <group>
                        <group string="Media">
                            <field name="media_type" widget="radio"/>
                            <field name="image" widget="image" invisible="media_type != 'photo'"/>
                            <field name="link_url" invisible="media_type != 'link'"/>
                        </group>
                        <group string="Scheduling" invisible="post_method != 'scheduled'">
                            <field name="scheduled_date"/>
                        </group>
                    </group>
                </sheet>
                <footer>
                    <button name="action_publish" type="object" string="Publish/Schedule" class="btn-primary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <record id="action_post_composer_wizard" model="ir.actions.act_window">
        <field name="name">Create Post</field>
        <field name="res_model">social.post.composer.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

    <record id="bulk_schedule_wizard_view_form" model="ir.ui.view">
        <field name="name">social.bulk.schedule.wizard.form</field>
        <field name="model">social.bulk.schedule.wizard</field>
        <field name="arch" type="xml">
            <form string="Bulk Post Scheduler">
                <sheet>
                    <group>
                        <group string="Select Pages">
                            <field name="account_ids" widget="many2many_tags"/>
                        </group>
                        <group string="Select Templates">
                            <field name="post_template_ids" widget="many2many_tags"/>
                            <field name="content_rotation" widget="radio"/>
                        </group>
                    </group>
                    <group string="Schedule Type">
                        <field name="schedule_type" widget="radio"/>
                    </group>
                    <group invisible="schedule_type != 'specific'">
                        <group string="Date Range">
                            <field name="start_date"/>
                            <field name="end_date"/>
                        </group>
                        <group string="Time Slots">
                            <field name="time_slots" nolabel="1"/>
                        </group>
                    </group>
                    <group invisible="schedule_type != 'recurring'">
                        <group string="Frequency">
                            <field name="frequency" widget="radio"/>
                            <field name="interval"/>
                            <field name="duration_days"/>
                            <field name="day_of_month" invisible="frequency != 'monthly'"/>
                        </group>
                        <group string="Posting Times">
                            <field name="posting_times" nolabel="1"/>
                        </group>
                    </group>
                    <group string="Weekdays" invisible="schedule_type != 'recurring' or frequency != 'weekly'">
                        <group>
                            <field name="weekday_monday"/>
                            <field name="weekday_tuesday"/>
                            <field name="weekday_wednesday"/>
                            <field name="weekday_thursday"/>
                        </group>
                        <group>
                            <field name="weekday_friday"/>
                            <field name="weekday_saturday"/>
                            <field name="weekday_sunday"/>
                        </group>
                    </group>
                    <group string="Preview">
                        <field name="preview_count" readonly="1"/>
                    </group>
                </sheet>
                <footer>
                    <button name="action_schedule_posts" type="object" string="Schedule All Posts" class="btn-primary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <record id="action_bulk_schedule_wizard" model="ir.actions.act_window">
        <field name="name">Bulk Schedule Posts</field>
        <field name="res_model">social.bulk.schedule.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

</odoo>


