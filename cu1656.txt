
################################################################################
#                      MODULE_SOCIAL_FACEBOOK                            #
#                   ODOO MODULE DOCUMENTATION GENERATOR                     #
#                           Version 1.2.0 - Enterprise Style                #
################################################################################

================================================================================
                                ğŸ“‚ DIRECTORY TREE
================================================================================
ğŸ“„ CÅ©.txt
ğŸ“„ __init__.py
ğŸ“„ __manifest__.py
ğŸ“ controllers
â”œâ”€â”€ ğŸ“„ __init__.py
â”œâ”€â”€ ğŸ“„ main.py
â””â”€â”€ ğŸ“„ webhook.py
ğŸ“ data
â”œâ”€â”€ ğŸ“„ chatbot_data.xml
â”œâ”€â”€ ğŸ“„ facebook_post_template_data.xml
â”œâ”€â”€ ğŸ“„ ir_cron_data.xml
â”œâ”€â”€ ğŸ“„ mail_template_data.xml
â””â”€â”€ ğŸ“„ user_groups_data.xml
ğŸ“„ generate_doc_3.py
ğŸ“ lib
â”œâ”€â”€ ğŸ“„ __init__.py
â””â”€â”€ ğŸ“„ facebook_api.py
ğŸ“ models
â”œâ”€â”€ ğŸ“„ __init__.py
â”œâ”€â”€ ğŸ“„ crm_lead.py
â”œâ”€â”€ ğŸ“„ res_company.py
â”œâ”€â”€ ğŸ“„ res_config_settings.py
â”œâ”€â”€ ğŸ“„ social_account.py
â”œâ”€â”€ ğŸ“„ social_analytics.py
â”œâ”€â”€ ğŸ“„ social_comment.py
â”œâ”€â”€ ğŸ“„ social_conversation.py
â”œâ”€â”€ ğŸ“„ social_message.py
â”œâ”€â”€ ğŸ“„ social_messenger_order.py
â”œâ”€â”€ ğŸ“„ social_messenger_product.py
â”œâ”€â”€ ğŸ“„ social_post.py
â””â”€â”€ ğŸ“„ social_post_template.py
ğŸ“ security
â”œâ”€â”€ ğŸ“„ ir.model.access.csv
â””â”€â”€ ğŸ“„ social_security.xml
ğŸ“ static
â”œâ”€â”€ ğŸ“ description
â”‚   â””â”€â”€ ğŸ“„ icon.png
â””â”€â”€ ğŸ“ src
    â”œâ”€â”€ ğŸ“ css
    â”‚   â””â”€â”€ ğŸ“„ social_facebook.css
    â”œâ”€â”€ ğŸ“ js
    â”‚   â”œâ”€â”€ ğŸ“„ social_conversation_list.js
    â”‚   â””â”€â”€ ğŸ“„ social_dashboard.js
    â””â”€â”€ ğŸ“ xml
        â””â”€â”€ ğŸ“„ social_conversation_templates.xml
ğŸ“ views
â”œâ”€â”€ ğŸ“„ dashboard_views.xml
â”œâ”€â”€ ğŸ“„ menu_views.xml
â”œâ”€â”€ ğŸ“„ res_config_settings_views.md
â”œâ”€â”€ ğŸ“„ social_account_views.xml
â”œâ”€â”€ ğŸ“„ social_analytics_views.xml
â”œâ”€â”€ ğŸ“„ social_comment_views.xml
â”œâ”€â”€ ğŸ“„ social_conversation_views.xml
â”œâ”€â”€ ğŸ“„ social_message_views.xml
â”œâ”€â”€ ğŸ“„ social_messenger_order_views.xml
â”œâ”€â”€ ğŸ“„ social_messenger_product_views.xml
â”œâ”€â”€ ğŸ“„ social_post_calendar_views.xml
â”œâ”€â”€ ğŸ“„ social_post_template_views.xml
â””â”€â”€ ğŸ“„ social_post_views.xml
ğŸ“ wizard
â”œâ”€â”€ ğŸ“„ __init__.py
â”œâ”€â”€ ğŸ“„ bulk_schedule_wizard.py
â”œâ”€â”€ ğŸ“„ post_composer_wizard.py
â””â”€â”€ ğŸ“„ wizard_views.xml


================================================================================
                              Cáº¤U TRÃšC THÆ¯ Má»¤C - 51 FILES
================================================================================

  1.  CÅ©.txt
  2.  __init__.py
  3.  __manifest__.py
  4.  controllers/__init__.py
  5.  controllers/main.py
  6.  controllers/webhook.py
  7.  data/chatbot_data.xml
  8.  data/facebook_post_template_data.xml
  9.  data/ir_cron_data.xml
 10.  data/mail_template_data.xml
 11.  data/user_groups_data.xml
 12.  generate_doc_3.py
 13.  lib/__init__.py
 14.  lib/facebook_api.py
 15.  models/__init__.py
 16.  models/crm_lead.py
 17.  models/res_company.py
 18.  models/res_config_settings.py
 19.  models/social_account.py
 20.  models/social_analytics.py
 21.  models/social_comment.py
 22.  models/social_conversation.py
 23.  models/social_message.py
 24.  models/social_messenger_order.py
 25.  models/social_messenger_product.py
 26.  models/social_post.py
 27.  models/social_post_template.py
 28.  security/ir.model.access.csv
 29.  security/social_security.xml
 30.  static/description/icon.png
 31.  static/src/css/social_facebook.css
 32.  static/src/js/social_conversation_list.js
 33.  static/src/js/social_dashboard.js
 34.  static/src/xml/social_conversation_templates.xml
 35.  views/dashboard_views.xml
 36.  views/menu_views.xml
 37.  views/res_config_settings_views.md
 38.  views/social_account_views.xml
 39.  views/social_analytics_views.xml
 40.  views/social_comment_views.xml
 41.  views/social_conversation_views.xml
 42.  views/social_message_views.xml
 43.  views/social_messenger_order_views.xml
 44.  views/social_messenger_product_views.xml
 45.  views/social_post_calendar_views.xml
 46.  views/social_post_template_views.xml
 47.  views/social_post_views.xml
 48.  wizard/__init__.py
 49.  wizard/bulk_schedule_wizard.py
 50.  wizard/post_composer_wizard.py
 51.  wizard/wizard_views.xml


================================================================================
                         Báº¢NG Tá»”NG Káº¾T 51 FILES
================================================================================
â”‚  #  â”‚ ÄÆ°á»ng dáº«n file                                     â”‚ Loáº¡i     â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1   â”‚ CÅ©.txt                                             â”‚ Other    â”‚
â”‚ 2   â”‚ __init__.py                                        â”‚ Python   â”‚
â”‚ 3   â”‚ __manifest__.py                                    â”‚ Python   â”‚
â”‚ 4   â”‚ controllers/__init__.py                            â”‚ Python   â”‚
â”‚ 5   â”‚ controllers/main.py                                â”‚ Python   â”‚
â”‚ 6   â”‚ controllers/webhook.py                             â”‚ Python   â”‚
â”‚ 7   â”‚ data/chatbot_data.xml                              â”‚ XML      â”‚
â”‚ 8   â”‚ data/facebook_post_template_data.xml               â”‚ XML      â”‚
â”‚ 9   â”‚ data/ir_cron_data.xml                              â”‚ XML      â”‚
â”‚ 10  â”‚ data/mail_template_data.xml                        â”‚ XML      â”‚
â”‚ 11  â”‚ data/user_groups_data.xml                          â”‚ XML      â”‚
â”‚ 12  â”‚ generate_doc_3.py                                  â”‚ Python   â”‚
â”‚ 13  â”‚ lib/__init__.py                                    â”‚ Python   â”‚
â”‚ 14  â”‚ lib/facebook_api.py                                â”‚ Python   â”‚
â”‚ 15  â”‚ models/__init__.py                                 â”‚ Python   â”‚
â”‚ 16  â”‚ models/crm_lead.py                                 â”‚ Python   â”‚
â”‚ 17  â”‚ models/res_company.py                              â”‚ Python   â”‚
â”‚ 18  â”‚ models/res_config_settings.py                      â”‚ Python   â”‚
â”‚ 19  â”‚ models/social_account.py                           â”‚ Python   â”‚
â”‚ 20  â”‚ models/social_analytics.py                         â”‚ Python   â”‚
â”‚ 21  â”‚ models/social_comment.py                           â”‚ Python   â”‚
â”‚ 22  â”‚ models/social_conversation.py                      â”‚ Python   â”‚
â”‚ 23  â”‚ models/social_message.py                           â”‚ Python   â”‚
â”‚ 24  â”‚ models/social_messenger_order.py                   â”‚ Python   â”‚
â”‚ 25  â”‚ models/social_messenger_product.py                 â”‚ Python   â”‚
â”‚ 26  â”‚ models/social_post.py                              â”‚ Python   â”‚
â”‚ 27  â”‚ models/social_post_template.py                     â”‚ Python   â”‚
â”‚ 28  â”‚ security/ir.model.access.csv                       â”‚ CSV      â”‚
â”‚ 29  â”‚ security/social_security.xml                       â”‚ XML      â”‚
â”‚ 30  â”‚ static/description/icon.png                        â”‚ Image    â”‚
â”‚ 31  â”‚ static/src/css/social_facebook.css                 â”‚ CSS      â”‚
â”‚ 32  â”‚ static/src/js/social_conversation_list.js          â”‚ JS       â”‚
â”‚ 33  â”‚ static/src/js/social_dashboard.js                  â”‚ JS       â”‚
â”‚ 34  â”‚ static/src/xml/social_conversation_templates.xml   â”‚ XML      â”‚
â”‚ 35  â”‚ views/dashboard_views.xml                          â”‚ XML      â”‚
â”‚ 36  â”‚ views/menu_views.xml                               â”‚ XML      â”‚
â”‚ 37  â”‚ views/res_config_settings_views.md                 â”‚ Other    â”‚
â”‚ 38  â”‚ views/social_account_views.xml                     â”‚ XML      â”‚
â”‚ 39  â”‚ views/social_analytics_views.xml                   â”‚ XML      â”‚
â”‚ 40  â”‚ views/social_comment_views.xml                     â”‚ XML      â”‚
â”‚ 41  â”‚ views/social_conversation_views.xml                â”‚ XML      â”‚
â”‚ 42  â”‚ views/social_message_views.xml                     â”‚ XML      â”‚
â”‚ 43  â”‚ views/social_messenger_order_views.xml             â”‚ XML      â”‚
â”‚ 44  â”‚ views/social_messenger_product_views.xml           â”‚ XML      â”‚
â”‚ 45  â”‚ views/social_post_calendar_views.xml               â”‚ XML      â”‚
â”‚ 46  â”‚ views/social_post_template_views.xml               â”‚ XML      â”‚
â”‚ 47  â”‚ views/social_post_views.xml                        â”‚ XML      â”‚
â”‚ 48  â”‚ wizard/__init__.py                                 â”‚ Python   â”‚
â”‚ 49  â”‚ wizard/bulk_schedule_wizard.py                     â”‚ Python   â”‚
â”‚ 50  â”‚ wizard/post_composer_wizard.py                     â”‚ Python   â”‚
â”‚ 51  â”‚ wizard/wizard_views.xml                            â”‚ XML      â”‚



================================================================================
                              Ná»˜I DUNG CÃC FILES
================================================================================

################################################################################
## FILE 1: CÅ©.txt
## ÄÆ°á»ng dáº«n: CÅ©.txt
################################################################################


################################################################################
#                      MODULE_SOCIAL_FACEBOOK                            #
#                   ODOO MODULE DOCUMENTATION GENERATOR                     #
#                           Version 1.2.0 - Enterprise Style                #
################################################################################

================================================================================
                                ğŸ“‚ DIRECTORY TREE
================================================================================
ğŸ“„ __init__.py
ğŸ“„ __manifest__.py
ğŸ“ controllers
â”œâ”€â”€ ğŸ“„ __init__.py
â”œâ”€â”€ ğŸ“„ main.py
â””â”€â”€ ğŸ“„ webhook.py
ğŸ“ data
â”œâ”€â”€ ğŸ“„ chatbot_data.xml
â”œâ”€â”€ ğŸ“„ facebook_post_template_data.xml
â”œâ”€â”€ ğŸ“„ ir_cron_data.xml
â”œâ”€â”€ ğŸ“„ mail_template_data.xml
â””â”€â”€ ğŸ“„ user_groups_data.xml
ğŸ“„ generate_doc_3.py
ğŸ“ lib
â”œâ”€â”€ ğŸ“„ __init__.py
â””â”€â”€ ğŸ“„ facebook_api.py
ğŸ“ models
â”œâ”€â”€ ğŸ“„ __init__.py
â”œâ”€â”€ ğŸ“„ crm_lead.py
â”œâ”€â”€ ğŸ“„ res_company.py
â”œâ”€â”€ ğŸ“„ res_config_settings.py
â”œâ”€â”€ ğŸ“„ social_account.py
â”œâ”€â”€ ğŸ“„ social_analytics.py
â”œâ”€â”€ ğŸ“„ social_comment.py
â”œâ”€â”€ ğŸ“„ social_message.py
â”œâ”€â”€ ğŸ“„ social_messenger_order.py
â”œâ”€â”€ ğŸ“„ social_messenger_product.py
â”œâ”€â”€ ğŸ“„ social_post.py
â””â”€â”€ ğŸ“„ social_post_template.py
ğŸ“ security
â”œâ”€â”€ ğŸ“„ ir.model.access.csv
â””â”€â”€ ğŸ“„ social_security.xml
ğŸ“ static
â”œâ”€â”€ ğŸ“ description
â”‚   â””â”€â”€ ğŸ“„ icon.png
â””â”€â”€ ğŸ“ src
    â”œâ”€â”€ ğŸ“ css
    â”‚   â””â”€â”€ ğŸ“„ social_facebook.css
    â”œâ”€â”€ ğŸ“ js
    â”‚   â”œâ”€â”€ ğŸ“„ social_conversation_list.js
    â”‚   â””â”€â”€ ğŸ“„ social_dashboard.js
    â””â”€â”€ ğŸ“ xml
        â””â”€â”€ ğŸ“„ social_conversation_templates.xml
ğŸ“ views
â”œâ”€â”€ ğŸ“„ dashboard_views.xml
â”œâ”€â”€ ğŸ“„ menu_views.xml
â”œâ”€â”€ ğŸ“„ res_config_settings_views.md
â”œâ”€â”€ ğŸ“„ social_account_views.xml
â”œâ”€â”€ ğŸ“„ social_analytics_views.xml
â”œâ”€â”€ ğŸ“„ social_comment_views.xml
â”œâ”€â”€ ğŸ“„ social_message_views.xml
â”œâ”€â”€ ğŸ“„ social_messenger_order_views.xml
â”œâ”€â”€ ğŸ“„ social_messenger_product_views.xml
â”œâ”€â”€ ğŸ“„ social_post_calendar_views.xml
â”œâ”€â”€ ğŸ“„ social_post_template_views.xml
â””â”€â”€ ğŸ“„ social_post_views.xml
ğŸ“ wizard
â”œâ”€â”€ ğŸ“„ __init__.py
â”œâ”€â”€ ğŸ“„ bulk_schedule_wizard.py
â”œâ”€â”€ ğŸ“„ post_composer_wizard.py
â””â”€â”€ ğŸ“„ wizard_views.xml


================================================================================
                              Cáº¤U TRÃšC THÆ¯ Má»¤C - 48 FILES
================================================================================

  1.  __init__.py
  2.  __manifest__.py
  3.  controllers/__init__.py
  4.  controllers/main.py
  5.  controllers/webhook.py
  6.  data/chatbot_data.xml
  7.  data/facebook_post_template_data.xml
  8.  data/ir_cron_data.xml
  9.  data/mail_template_data.xml
 10.  data/user_groups_data.xml
 11.  generate_doc_3.py
 12.  lib/__init__.py
 13.  lib/facebook_api.py
 14.  models/__init__.py
 15.  models/crm_lead.py
 16.  models/res_company.py
 17.  models/res_config_settings.py
 18.  models/social_account.py
 19.  models/social_analytics.py
 20.  models/social_comment.py
 21.  models/social_message.py
 22.  models/social_messenger_order.py
 23.  models/social_messenger_product.py
 24.  models/social_post.py
 25.  models/social_post_template.py
 26.  security/ir.model.access.csv
 27.  security/social_security.xml
 28.  static/description/icon.png
 29.  static/src/css/social_facebook.css
 30.  static/src/js/social_conversation_list.js
 31.  static/src/js/social_dashboard.js
 32.  static/src/xml/social_conversation_templates.xml
 33.  views/dashboard_views.xml
 34.  views/menu_views.xml
 35.  views/res_config_settings_views.md
 36.  views/social_account_views.xml
 37.  views/social_analytics_views.xml
 38.  views/social_comment_views.xml
 39.  views/social_message_views.xml
 40.  views/social_messenger_order_views.xml
 41.  views/social_messenger_product_views.xml
 42.  views/social_post_calendar_views.xml
 43.  views/social_post_template_views.xml
 44.  views/social_post_views.xml
 45.  wizard/__init__.py
 46.  wizard/bulk_schedule_wizard.py
 47.  wizard/post_composer_wizard.py
 48.  wizard/wizard_views.xml


================================================================================
                         Báº¢NG Tá»”NG Káº¾T 48 FILES
================================================================================
â”‚  #  â”‚ ÄÆ°á»ng dáº«n file                                     â”‚ Loáº¡i     â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1   â”‚ __init__.py                                        â”‚ Python   â”‚
â”‚ 2   â”‚ __manifest__.py                                    â”‚ Python   â”‚
â”‚ 3   â”‚ controllers/__init__.py                            â”‚ Python   â”‚
â”‚ 4   â”‚ controllers/main.py                                â”‚ Python   â”‚
â”‚ 5   â”‚ controllers/webhook.py                             â”‚ Python   â”‚
â”‚ 6   â”‚ data/chatbot_data.xml                              â”‚ XML      â”‚
â”‚ 7   â”‚ data/facebook_post_template_data.xml               â”‚ XML      â”‚
â”‚ 8   â”‚ data/ir_cron_data.xml                              â”‚ XML      â”‚
â”‚ 9   â”‚ data/mail_template_data.xml                        â”‚ XML      â”‚
â”‚ 10  â”‚ data/user_groups_data.xml                          â”‚ XML      â”‚
â”‚ 11  â”‚ generate_doc_3.py                                  â”‚ Python   â”‚
â”‚ 12  â”‚ lib/__init__.py                                    â”‚ Python   â”‚
â”‚ 13  â”‚ lib/facebook_api.py                                â”‚ Python   â”‚
â”‚ 14  â”‚ models/__init__.py                                 â”‚ Python   â”‚
â”‚ 15  â”‚ models/crm_lead.py                                 â”‚ Python   â”‚
â”‚ 16  â”‚ models/res_company.py                              â”‚ Python   â”‚
â”‚ 17  â”‚ models/res_config_settings.py                      â”‚ Python   â”‚
â”‚ 18  â”‚ models/social_account.py                           â”‚ Python   â”‚
â”‚ 19  â”‚ models/social_analytics.py                         â”‚ Python   â”‚
â”‚ 20  â”‚ models/social_comment.py                           â”‚ Python   â”‚
â”‚ 21  â”‚ models/social_message.py                           â”‚ Python   â”‚
â”‚ 22  â”‚ models/social_messenger_order.py                   â”‚ Python   â”‚
â”‚ 23  â”‚ models/social_messenger_product.py                 â”‚ Python   â”‚
â”‚ 24  â”‚ models/social_post.py                              â”‚ Python   â”‚
â”‚ 25  â”‚ models/social_post_template.py                     â”‚ Python   â”‚
â”‚ 26  â”‚ security/ir.model.access.csv                       â”‚ CSV      â”‚
â”‚ 27  â”‚ security/social_security.xml                       â”‚ XML      â”‚
â”‚ 28  â”‚ static/description/icon.png                        â”‚ Image    â”‚
â”‚ 29  â”‚ static/src/css/social_facebook.css                 â”‚ CSS      â”‚
â”‚ 30  â”‚ static/src/js/social_conversation_list.js          â”‚ JS       â”‚
â”‚ 31  â”‚ static/src/js/social_dashboard.js                  â”‚ JS       â”‚
â”‚ 32  â”‚ static/src/xml/social_conversation_templates.xml   â”‚ XML      â”‚
â”‚ 33  â”‚ views/dashboard_views.xml                          â”‚ XML      â”‚
â”‚ 34  â”‚ views/menu_views.xml                               â”‚ XML      â”‚
â”‚ 35  â”‚ views/res_config_settings_views.md                 â”‚ Other    â”‚
â”‚ 36  â”‚ views/social_account_views.xml                     â”‚ XML      â”‚
â”‚ 37  â”‚ views/social_analytics_views.xml                   â”‚ XML      â”‚
â”‚ 38  â”‚ views/social_comment_views.xml                     â”‚ XML      â”‚
â”‚ 39  â”‚ views/social_message_views.xml                     â”‚ XML      â”‚
â”‚ 40  â”‚ views/social_messenger_order_views.xml             â”‚ XML      â”‚
â”‚ 41  â”‚ views/social_messenger_product_views.xml           â”‚ XML      â”‚
â”‚ 42  â”‚ views/social_post_calendar_views.xml               â”‚ XML      â”‚
â”‚ 43  â”‚ views/social_post_template_views.xml               â”‚ XML      â”‚
â”‚ 44  â”‚ views/social_post_views.xml                        â”‚ XML      â”‚
â”‚ 45  â”‚ wizard/__init__.py                                 â”‚ Python   â”‚
â”‚ 46  â”‚ wizard/bulk_schedule_wizard.py                     â”‚ Python   â”‚
â”‚ 47  â”‚ wizard/post_composer_wizard.py                     â”‚ Python   â”‚
â”‚ 48  â”‚ wizard/wizard_views.xml                            â”‚ XML      â”‚



================================================================================
                              Ná»˜I DUNG CÃC FILES
================================================================================

################################################################################
## FILE 1: __init__.py
## ÄÆ°á»ng dáº«n: __init__.py
################################################################################

from . import models
from . import controllers
from . import wizard
from . import lib
import logging

_logger = logging.getLogger(__name__)

def post_init_hook(env):
    """
    Hook cháº¡y sau khi cÃ i Ä‘áº·t module.
    Chá»‰ khá»Ÿi táº¡o Webhook Token, KHÃ”NG can thiá»‡p vÃ o quyá»n user.
    """
    param = env['ir.config_parameter'].sudo()
    if not param.get_param('social_facebook.webhook_verify_token'):
        import secrets
        verify_token = secrets.token_urlsafe(32)
        param.set_param('social_facebook.webhook_verify_token', verify_token)

def uninstall_hook(env):
    """Hook cháº¡y trÆ°á»›c khi gá»¡ cÃ i Ä‘áº·t module."""
    try:
        accounts = env['social.account'].search([('platform', '=', 'facebook')])
        accounts.write({'active': False})
    except Exception as e:
        _logger.warning(f'Error during uninstall: {e}')




################################################################################
## FILE 2: __manifest__.py
## ÄÆ°á»ng dáº«n: __manifest__.py
################################################################################

# -*- coding: utf-8 -*-
{
    'name': 'Social Media - Facebook Enhanced',
    'version': '19.0.2.0.0',
    'category': 'Marketing/Social Marketing',
    'summary': 'Facebook Integration with CRM, Messenger Sales & Content Calendar',
    'description': """
Facebook Integration - Enterprise Edition
==========================================

Core Features:
--------------
* Facebook Pages Management
* Posts Publishing & Scheduling
* Comments & Reactions Tracking
* Messenger Conversations
* Analytics & Insights
* Webhook Integration

NEW Features (v2.0):
-------------------
* âœ¨ CRM Lead Auto-creation from Messenger & Lead Ads
* âœ¨ Messenger Sales Bot with Order Creation
* âœ¨ Content Calendar View
* âœ¨ Ngrok Integration for Local Development
* âœ¨ Webhook Configuration UI
* âœ¨ Messenger Product Catalog
* âœ¨ Sale Order Integration

Technical Requirements:
-----------------------
* Odoo 19.0+
* Python 3.10+
* Facebook Graph API v18.0+
* Ngrok (optional, for localhost webhooks)
    """,
    'author': 'Your Company',
    'website': 'https://www.yourcompany.com',
    'license': 'LGPL-3',
    'depends': [
        'base',
        'mail',
        'web',
        'crm',              # NEW - CRM integration
        'sale_management',  # NEW - Sales integration
        'product',          # NEW - Product catalog
    ],
    'data': [
        # Security
        'security/social_security.xml',
        'security/ir.model.access.csv',
        
        # Data
        'data/user_groups_data.xml',
        'data/ir_cron_data.xml',
        'data/mail_template_data.xml',
        'data/facebook_post_template_data.xml',
        'data/chatbot_data.xml',
        
        # Views - Actions TRÆ¯á»šC, Menu SAU
        'views/dashboard_views.xml',               # âœ… TRÆ¯á»šC (define action)
        # 'views/res_config_settings_views.xml',
        'views/social_account_views.xml',
        'views/social_post_views.xml',
        'views/social_post_calendar_views.xml',
        'views/social_post_template_views.xml',
        'views/social_comment_views.xml',
        'views/social_message_views.xml',
        'views/social_analytics_views.xml',
        'views/social_messenger_product_views.xml',
        'views/social_messenger_order_views.xml',
        'views/menu_views.xml',                    # âœ… SAU (reference action)
        
        # Wizards
        'wizard/wizard_views.xml',
    ],
    'assets': {
        'web.assets_backend': [
            'module_social_facebook/static/src/css/social_facebook.css',
            'module_social_facebook/static/src/js/social_dashboard.js',
            'module_social_facebook/static/src/js/social_conversation_list.js',
            'module_social_facebook/static/src/js/ngrok_controller.js',  # NEW
        ],
        'web.assets_qweb': [
            'module_social_facebook/static/src/xml/social_conversation_templates.xml',
        ],
    },
    'external_dependencies': {
        'python': ['requests'],
    },
    'installable': True,
    'application': True,
    'auto_install': False,
}



################################################################################
## FILE 3: __init__.py
## ÄÆ°á»ng dáº«n: controllers/__init__.py
################################################################################

from . import main
from . import webhook




################################################################################
## FILE 4: main.py
## ÄÆ°á»ng dáº«n: controllers/main.py
################################################################################

from odoo import http
from odoo.http import request


class SocialFacebookController(http.Controller):
    """
    Controller chÃ­nh cho Facebook integration.
    """

    @http.route('/social/facebook/oauth/callback', type='http', auth='user', website=True)
    def facebook_oauth_callback(self, **kwargs):
        """
        Callback URL sau khi user authorize Facebook app.
        """
        code = kwargs.get('code')
        state = kwargs.get('state')
        
        if not code:
            return request.render('module_social_facebook.oauth_error', {
                'error': 'No authorization code received'
            })
        
        # Process OAuth code and exchange for access token
        # Logic xá»­ lÃ½ á»Ÿ Ä‘Ã¢y
        
        return request.redirect('/web#action=module_social_facebook.action_social_account')




################################################################################
## FILE 5: webhook.py
## ÄÆ°á»ng dáº«n: controllers/webhook.py
################################################################################

# -*- coding: utf-8 -*-

import json
import logging
from odoo import http
from odoo.http import request

_logger = logging.getLogger(__name__)


class FacebookWebhookController(http.Controller):
    """
    Controller xá»­ lÃ½ webhook tá»« Facebook.
    
    Endpoint: /social/facebook/webhook
    Methods:
    - GET: Verify webhook (subscription)
    - POST: Nháº­n events tá»« Facebook
    """
    
    @http.route('/social/facebook/webhook', type='http', auth='public', 
                methods=['GET'], csrf=False)
    def webhook_verify(self, **kwargs):
        """
        Verify webhook theo Facebook requirements.
        
        Facebook sáº½ gá»­i GET request vá»›i params:
        - hub.mode = 'subscribe'
        - hub.verify_token = token báº¡n set
        - hub.challenge = random string
        
        Response: echo láº¡i hub.challenge
        """
        mode = kwargs.get('hub.mode')
        token = kwargs.get('hub.verify_token')
        challenge = kwargs.get('hub.challenge')
        
        # Get verify token from settings
        verify_token = request.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.verify_token', '16112005'
        )
        
        _logger.info(f'Webhook verify attempt - mode: {mode}, token: {token}')
        
        if mode == 'subscribe' and token == verify_token:
            _logger.info('Webhook verified successfully!')
            return challenge
        else:
            _logger.warning(f'Webhook verify failed - token mismatch')
            return 'Forbidden', 403
    
    @http.route('/social/facebook/webhook', type='http', auth='public', 
                methods=['POST'], csrf=False)
    def webhook_callback(self, **kwargs):
        """
        Nháº­n vÃ  xá»­ lÃ½ events tá»« Facebook.
        
        Events types:
        - messages: Tin nháº¯n Messenger
        - messaging_postbacks: Postback tá»« buttons
        - leadgen: Lead form submissions
        - feed: Post updates
        """
        try:
            # Parse JSON body
            body = request.httprequest.get_data(as_text=True)
            data = json.loads(body)
            
            _logger.info(f'Received webhook data: {json.dumps(data, indent=2)}')
            
            # Verify object type
            if data.get('object') != 'page':
                _logger.warning(f'Unknown object type: {data.get("object")}')
                return 'OK'
            
            # Process each entry
            for entry in data.get('entry', []):
                self._process_entry(entry)
            
            return 'OK'
            
        except Exception as e:
            _logger.error(f'Error processing webhook: {e}', exc_info=True)
            return 'OK'  # Always return 200 to Facebook
    
    def _process_entry(self, entry):
        """
        Xá»­ lÃ½ má»™t entry tá»« webhook.
        
        Entry cÃ³ thá»ƒ chá»©a:
        - messaging: Messenger events
        - changes: Page changes (posts, comments)
        - leadgen: Lead ads submissions
        """
        # Process messaging events
        if 'messaging' in entry:
            for event in entry['messaging']:
                self._process_messaging_event(event)
        
        # Process changes (posts, comments, etc.)
        if 'changes' in entry:
            for change in entry['changes']:
                self._process_change_event(change)
    
    def _process_messaging_event(self, event):
        """
        Xá»­ lÃ½ messaging events.
        
        Event types:
        - message: Tin nháº¯n má»›i
        - postback: User click button
        - read: User Ä‘Ã£ Ä‘á»c
        - delivery: Tin Ä‘Ã£ gá»­i
        """
        sender_id = event.get('sender', {}).get('id')
        recipient_id = event.get('recipient', {}).get('id')
        
        if not sender_id or not recipient_id:
            return
        
        # Find or create conversation
        conversation = self._find_or_create_conversation(sender_id, recipient_id)
        
        # Handle message
        if 'message' in event:
            self._handle_message(conversation, event['message'], sender_id)
        
        # Handle postback
        elif 'postback' in event:
            self._handle_postback(conversation, event['postback'], sender_id)
        
        # Handle read
        elif 'read' in event:
            self._handle_read(conversation, event['read'])
    
    def _process_change_event(self, change):
        """
        Xá»­ lÃ½ change events (posts, comments, reactions).
        
        Change types:
        - feed: Post created/updated
        - comments: New comment
        - reactions: New reaction
        - leadgen: Lead form submission (NEW)
        """
        field = change.get('field')
        value = change.get('value')
        
        if field == 'leadgen':
            # NEW: Handle lead generation
            self._handle_leadgen_event(value)
        
        elif field == 'feed':
            self._handle_feed_event(value)
        
        elif field == 'comments':
            self._handle_comment_event(value)
    
    # -------------------------------------------------------------------------
    # MESSAGE HANDLERS
    # -------------------------------------------------------------------------
    
    def _handle_message(self, conversation, message_data, sender_id):
        """
        Xá»­ lÃ½ tin nháº¯n má»›i.
        
        Actions:
        1. LÆ°u message vÃ o database
        2. Check chatbot flow
        3. Auto-reply náº¿u cáº§n
        """
        mid = message_data.get('mid')
        text = message_data.get('text', '')
        attachments = message_data.get('attachments', [])
        
        # Check duplicate
        existing = request.env['social.message'].sudo().search([
            ('message_id', '=', mid)
        ], limit=1)
        
        if existing:
            _logger.debug(f'Message {mid} already exists')
            return
        
        # Create message record
        message_vals = {
            'conversation_id': conversation.id,
            'message_id': mid,
            'message': text,
            'is_from_customer': True,
            'facebook_user_id': sender_id,
            'account_id': conversation.account_id.id,
            'company_id': conversation.company_id.id,
        }
        
        if attachments:
            message_vals['attachments'] = json.dumps(attachments)
        
        msg_record = request.env['social.message'].sudo().create(message_vals)
        
        _logger.info(f'Created message {msg_record.id} for conversation {conversation.id}')
        
        # Process chatbot flow
        self._process_chatbot(conversation, text)
        
        # Auto-create lead if enabled
        self._auto_create_lead(conversation)
    
    def _handle_postback(self, conversation, postback_data, sender_id):
        """
        Xá»­ lÃ½ postback tá»« button clicks.
        
        Postback payload format: PRODUCT_123, CONFIRM_YES, etc.
        """
        payload = postback_data.get('payload', '')
        title = postback_data.get('title', '')
        
        _logger.info(f'Postback received - payload: {payload}, title: {title}')
        
        # Process as chatbot message (treat payload as user input)
        self._process_chatbot(conversation, payload)
    
    def _handle_read(self, conversation, read_data):
        """Handle read receipts"""
        watermark = read_data.get('watermark')
        _logger.debug(f'Message read - watermark: {watermark}')
        # Optional: Update message read status
    
    # -------------------------------------------------------------------------
    # LEADGEN HANDLER (NEW)
    # -------------------------------------------------------------------------
    
    def _handle_leadgen_event(self, leadgen_data):
        """
        Xá»­ lÃ½ lead form submissions tá»« Facebook Lead Ads.
        
        Data structure:
        {
            'ad_id': '123',
            'form_id': '456',
            'leadgen_id': '789',
            'created_time': 1234567890,
            'page_id': 'PAGE_ID',
            'adgroup_id': '...'
        }
        
        Flow:
        1. Fetch lead data tá»« Graph API
        2. Parse fields (name, phone, email)
        3. Check duplicate
        4. Create crm.lead
        """
        leadgen_id = leadgen_data.get('leadgen_id')
        page_id = leadgen_data.get('page_id')
        
        if not leadgen_id or not page_id:
            _logger.warning('Missing leadgen_id or page_id')
            return
        
        # Find Facebook account
        account = request.env['social.account'].sudo().search([
            ('facebook_id', '=', page_id)
        ], limit=1)
        
        if not account or not account.access_token:
            _logger.error(f'No account found for page {page_id}')
            return
        
        # Fetch lead data from Graph API
        try:
            from odoo.addons.module_social_facebook.lib import facebook_api
            api = facebook_api.FacebookAPI(account.access_token)
            
            lead_data = api.get_leadgen_data(leadgen_id)
            
            # Parse field data
            field_data = {}
            for field in lead_data.get('field_data', []):
                field_name = field.get('name')
                field_value = field.get('values', [None])[0]
                field_data[field_name] = field_value
            
            # Extract common fields
            name = field_data.get('full_name') or field_data.get('first_name', 'Unknown')
            phone = field_data.get('phone_number') or field_data.get('phone')
            email = field_data.get('email')
            
            # Check duplicate
            existing_lead = request.env['crm.lead'].sudo().search([
                ('phone', '=', phone),
                ('type', '=', 'lead'),
            ], limit=1)
            
            if existing_lead:
                _logger.info(f'Lead already exists for phone {phone}')
                existing_lead.message_post(
                    body=f'Duplicate lead form submission from Facebook: {leadgen_id}'
                )
                return
            
            # Create crm.lead
            lead_vals = {
                'name': f'Facebook Lead: {name}',
                'contact_name': name,
                'phone': phone,
                'email_from': email,
                'type': 'lead',
                'source_id': self._get_facebook_source(),
                'description': f'Lead from Facebook Lead Ads\nForm ID: {leadgen_data.get("form_id")}\nLead ID: {leadgen_id}\n\nFields:\n{json.dumps(field_data, indent=2)}',
                'company_id': account.company_id.id,
            }
            
            lead = request.env['crm.lead'].sudo().create(lead_vals)
            
            _logger.info(f'Created lead {lead.id} from Facebook leadgen {leadgen_id}')
            
            # Assign to default user if configured
            default_user_id = request.env['ir.config_parameter'].sudo().get_param(
                'module_social_facebook.lead_default_user_id'
            )
            if default_user_id:
                lead.user_id = int(default_user_id)
            
        except Exception as e:
            _logger.error(f'Failed to process leadgen {leadgen_id}: {e}', exc_info=True)
    
    def _get_facebook_source(self):
        """Get or create Facebook source"""
        Source = request.env['utm.source'].sudo()
        source = Source.search([('name', '=', 'Facebook')], limit=1)
        if not source:
            source = Source.create({'name': 'Facebook'})
        return source.id
    
    # -------------------------------------------------------------------------
    # CHATBOT FLOW
    # -------------------------------------------------------------------------
    
    def _process_chatbot(self, conversation, user_message):
        """
        Xá»­ lÃ½ chatbot flow.
        
        Gá»i conversation.process_chatbot_flow() vÃ  gá»­i reply.
        """
        chatbot_enabled = request.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.chatbot_enabled', 'False'
        )
        
        if chatbot_enabled != 'True':
            return
        
        try:
            # Process chatbot logic
            response = conversation.process_chatbot_flow(user_message)
            
            if response:
                # Send message
                conversation.send_chatbot_message(response)
                
        except Exception as e:
            _logger.error(f'Chatbot error: {e}', exc_info=True)
    
    # -------------------------------------------------------------------------
    # AUTO LEAD CREATION
    # -------------------------------------------------------------------------
    
    def _auto_create_lead(self, conversation):
        """
        Tá»± Ä‘á»™ng táº¡o lead tá»« conversation náº¿u enabled.
        
        Conditions:
        - auto_create_lead = True
        - Conversation chÆ°a cÃ³ lead_id
        - CÃ³ Ä‘á»§ thÃ´ng tin (name, phone)
        """
        auto_create = request.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.auto_create_lead', 'False'
        )
        
        if auto_create != 'True':
            return
        
        if conversation.lead_id:
            return  # Already has lead
        
        if not conversation.customer_name or not conversation.customer_phone:
            return  # Not enough info
        
        try:
            lead = conversation.create_lead_from_conversation()
            if lead:
                _logger.info(f'Auto-created lead {lead.id} from conversation {conversation.id}')
        except Exception as e:
            _logger.error(f'Failed to auto-create lead: {e}')
    
    # -------------------------------------------------------------------------
    # FEED/COMMENT HANDLERS
    # -------------------------------------------------------------------------
    
    def _handle_feed_event(self, feed_data):
        """Handle post events"""
        # Existing implementation from original module
        pass
    
    def _handle_comment_event(self, comment_data):
        """Handle comment events"""
        # Existing implementation from original module
        pass
    
    # -------------------------------------------------------------------------
    # HELPERS
    # -------------------------------------------------------------------------
    
    def _find_or_create_conversation(self, sender_id, recipient_id):
        """
        TÃ¬m hoáº·c táº¡o conversation.
        
        Args:
            sender_id (str): Facebook user PSID
            recipient_id (str): Facebook page ID
        
        Returns:
            social.message: Conversation record
        """
        # Find account by Facebook page ID
        account = request.env['social.account'].sudo().search([
            ('facebook_id', '=', recipient_id)
        ], limit=1)
        
        if not account:
            _logger.error(f'No account found for page {recipient_id}')
            return None
        
        # Find existing conversation
        conversation = request.env['social.message'].sudo().search([
            ('facebook_user_id', '=', sender_id),
            ('account_id', '=', account.id),
        ], limit=1)
        
        if conversation:
            return conversation
        
        # Create new conversation
        conv_vals = {
            'facebook_user_id': sender_id,
            'account_id': account.id,
            'company_id': account.company_id.id,
            'chatbot_state': 'idle',  # NEW
        }
        
        conversation = request.env['social.message'].sudo().create(conv_vals)
        
        _logger.info(f'Created new conversation {conversation.id} for user {sender_id}')
        
        return conversation



################################################################################
## FILE 6: chatbot_data.xml
## ÄÆ°á»ng dáº«n: data/chatbot_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!-- Sequence cho Messenger Orders -->
        <record id="seq_social_messenger_order" model="ir.sequence">
            <field name="name">Messenger Order</field>
            <field name="code">social.messenger.order</field>
            <field name="prefix">MO</field>
            <field name="padding">5</field>
            <field name="number_next">1</field>
            <field name="number_increment">1</field>
        </record>

        <!-- Default Chatbot Welcome Message -->
        <record id="default_chatbot_welcome_message" model="ir.config_parameter">
            <field name="key">module_social_facebook.chatbot_welcome_message</field>
            <field name="value">Xin chÃ o! ğŸ‘‹

TÃ´i lÃ  trá»£ lÃ½ bÃ¡n hÃ ng tá»± Ä‘á»™ng cá»§a chÃºng tÃ´i. Ráº¥t vui Ä‘Æ°á»£c phá»¥c vá»¥ báº¡n!

Äá»ƒ báº¯t Ä‘áº§u, báº¡n vui lÃ²ng cho tÃ´i biáº¿t tÃªn cá»§a báº¡n? ğŸ˜Š</field>
        </record>

        <!-- Default Verify Token -->
        <record id="default_verify_token" model="ir.config_parameter">
            <field name="key">module_social_facebook.verify_token</field>
            <field name="value">16112005</field>
        </record>

        <!-- Default Ngrok Path -->
        <record id="default_ngrok_path" model="ir.config_parameter">
            <field name="key">module_social_facebook.ngrok_path</field>
            <field name="value">C:/ngrok/ngrok.exe</field>
        </record>

    </data>
</odoo>



################################################################################
## FILE 7: facebook_post_template_data.xml
## ÄÆ°á»ng dáº«n: data/facebook_post_template_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!-- TEMPLATE BÃ€I ÄÄ‚NG MáºªU -->

        <record id="template_new_product_launch" model="social.post.template">
            <field name="name">ğŸš€ Ra Máº¯t Sáº£n Pháº©m Má»›i</field>
            <field name="template_type">product_launch</field>
            <field name="content"><![CDATA[ğŸ‰ EXCITING NEWS! ğŸ‰

We're thrilled to announce our latest product: {{product_name}}!

âœ¨ Key Features:
{{feature_list}}

ğŸ’° Special Launch Price: {{price}}
ğŸ Limited time offer: {{offer_details}}

ğŸ‘‰ Shop now: {{shop_link}}

#NewProduct #Launch #{{company_name}}]]></field>
        </record>

        <record id="template_flash_sale" model="social.post.template">
            <field name="name">âš¡ Flash Sale</field>
            <field name="template_type">promotion</field>
            <field name="content"><![CDATA[âš¡ FLASH SALE ALERT! âš¡

ğŸ”¥ {{discount_percentage}}% OFF on {{product_category}}!

â° Hurry! Only {{hours_left}} hours left!
ğŸ›’ Shop now: {{shop_link}}

Don't miss out on this amazing deal! ğŸ¯

#FlashSale #Discount #LimitedOffer #{{company_name}}]]></field>
        </record>

        <record id="template_customer_testimonial" model="social.post.template">
            <field name="name">ğŸ’¬ ÄÃ¡nh GiÃ¡ KhÃ¡ch HÃ ng</field>
            <field name="template_type">testimonial</field>
            <field name="content"><![CDATA[â­â­â­â­â­

"{{testimonial_text}}"

- {{customer_name}}

Thank you for your amazing feedback! ğŸ’™

We love hearing from our satisfied customers. Your trust means the world to us! ğŸ™

#CustomerLove #Testimonial #{{company_name}}]]></field>
        </record>

        <record id="template_weekly_tips" model="social.post.template">
            <field name="name">ğŸ’¡ Tips HÃ ng Tuáº§n</field>
            <field name="template_type">educational</field>
            <field name="content"><![CDATA[ğŸ’¡ TIP OF THE WEEK ğŸ’¡

{{tip_title}}

{{tip_description}}

ğŸ‘‰ Try it out and let us know your results!

Have questions? Drop them in the comments below! ğŸ‘‡

#Tips #DidYouKnow #{{company_name}}]]></field>
        </record>

        <record id="template_behind_the_scenes" model="social.post.template">
            <field name="name">ğŸ¬ Behind The Scenes</field>
            <field name="template_type">engagement</field>
            <field name="content"><![CDATA[ğŸ¬ BEHIND THE SCENES ğŸ¬

Ever wondered how we {{process_description}}?

Here's a sneak peek into our {{department_name}} team! ğŸ‘€

{{additional_details}}

Drop a â¤ï¸ if you'd like to see more behind-the-scenes content!

#BehindTheScenes #TeamWork #{{company_name}}]]></field>
        </record>

        <record id="template_event_announcement" model="social.post.template">
            <field name="name">ğŸ“… ThÃ´ng BÃ¡o Sá»± Kiá»‡n</field>
            <field name="template_type">event</field>
            <field name="content"><![CDATA[ğŸ“… SAVE THE DATE! ğŸ“…

{{event_name}}

ğŸ“ Location: {{location}}
ğŸ—“ï¸ Date: {{event_date}}
â° Time: {{event_time}}

{{event_description}}

ğŸŸï¸ Register now: {{registration_link}}

Limited seats available! Don't miss out! ğŸ¯

#Event #SaveTheDate #{{company_name}}]]></field>
        </record>

    </data>
</odoo>



################################################################################
## FILE 8: ir_cron_data.xml
## ÄÆ°á»ng dáº«n: data/ir_cron_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- CRON JOBS - Facebook Synchronization -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->

    <!-- Cron: Sync Facebook Posts -->
    <record id="cron_sync_facebook_posts" model="ir.cron">
        <field name="name">Facebook: Sync Posts</field>
        <field name="model_id" ref="model_social_post"/>
        <field name="state">code</field>
        <field name="code">model._cron_sync_posts()</field>
        <field name="interval_number">15</field>
        <field name="interval_type">minutes</field>
        <field name="active">True</field>
    </record>

    <!-- Cron: Sync Facebook Comments -->
    <record id="cron_sync_facebook_comments" model="ir.cron">
        <field name="name">Facebook: Sync Comments</field>
        <field name="model_id" ref="model_social_comment"/>
        <field name="state">code</field>
        <field name="code">model._cron_sync_comments()</field>
        <field name="interval_number">10</field>
        <field name="interval_type">minutes</field>
        <field name="active">True</field>
    </record>

    <!-- Cron: Publish Scheduled Posts -->
    <record id="cron_publish_scheduled_posts" model="ir.cron">
        <field name="name">Facebook: Publish Scheduled Posts</field>
        <field name="model_id" ref="model_social_post"/>
        <field name="state">code</field>
        <field name="code">model._cron_publish_scheduled_posts()</field>
        <field name="interval_number">5</field>
        <field name="interval_type">minutes</field>
        <field name="active">True</field>
    </record>

    <!-- 
    NOTE: Ngrok health check Ä‘Ã£ bá»‹ XÃ“A
    LÃ½ do: Odoo 19 cáº¥m opcode IMPORT_NAME trong cron code
    Náº¿u cáº§n kiá»ƒm tra ngrok, dÃ¹ng external monitoring tool
    -->

</odoo>



################################################################################
## FILE 9: mail_template_data.xml
## ÄÆ°á»ng dáº«n: data/mail_template_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!-- EMAIL NOTIFICATION TEMPLATES -->

        <record id="mail_template_post_published" model="mail.template">
            <field name="name">Social Facebook: Post Published</field>
            <field name="model_id" ref="model_social_post"/>
            <field name="subject">Your Facebook post has been published</field>
            <field name="body_html"><![CDATA[
<div style="font-family: Arial, sans-serif;">
    <h3>Post Published Successfully!</h3>
    <p>Your post has been published to Facebook:</p>
    <blockquote style="border-left: 3px solid #1877f2; padding-left: 10px;">
        ${object.content}
    </blockquote>
    <p>
        <strong>Page:</strong> ${object.account_id.name}<br/>
        <strong>Published:</strong> ${object.published_date}<br/>
    </p>
    <p><a href="${object.facebook_post_url}" style="color: #1877f2;">View on Facebook</a></p>
</div>
            ]]></field>
        </record>

        <record id="mail_template_new_comment" model="mail.template">
            <field name="name">Social Facebook: New Comment</field>
            <field name="model_id" ref="model_social_comment"/>
            <field name="subject">New comment on your Facebook post</field>
            <field name="body_html"><![CDATA[
<div style="font-family: Arial, sans-serif;">
    <h3>New Comment Received!</h3>
    <p><strong>${object.author_name}</strong> commented:</p>
    <blockquote style="border-left: 3px solid #1877f2; padding-left: 10px;">
        ${object.message}
    </blockquote>
    <p>On post: "${object.post_id.content[:100]}..."</p>
    <p><a href="/web#id=${object.id}&model=social.comment" style="color: #1877f2;">Reply in Odoo</a></p>
</div>
            ]]></field>
        </record>

    </data>
</odoo>



################################################################################
## FILE 10: user_groups_data.xml
## ÄÆ°á»ng dáº«n: data/user_groups_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ThÃªm Admin vÃ o groups Social Facebook -->
    <record id="base.user_admin" model="res.users">
        <field name="group_ids" eval="[(4, ref('module_social_facebook.group_social_manager'))]"/>
    </record>

</odoo>




################################################################################
## FILE 11: generate_doc_3.py
## ÄÆ°á»ng dáº«n: generate_doc_3.py
################################################################################

import os
import datetime

# -------------------------------------------------------------
# CONFIG
# -------------------------------------------------------------
OUTPUT_NAME = None  # None -> tá»± Ä‘áº·t tÃªn theo thÆ° má»¥c module

# ThÆ° má»¥c bá»‹ loáº¡i trá»« á»Ÿ má»i cáº¥p
EXCLUDED_DIRS = {"__pycache__"}


# -------------------------------------------------------------
# HÃ€M Táº O BANNER
# -------------------------------------------------------------
def make_banner(module_name):
    banner = f"""
################################################################################
#                      {module_name.upper():<50}#
#                   ODOO MODULE DOCUMENTATION GENERATOR                     #
#                           Version 1.2.0 - Enterprise Style                #
################################################################################
"""
    return banner


# -------------------------------------------------------------
# HÃ€M QUÃ‰T FILES (Bá» QUA __pycache__)
# -------------------------------------------------------------
def scan_files(root):
    file_list = []

    for base, dirs, files in os.walk(root):
        # ğŸ”¥ CHáº¶N __pycache__ á» Má»ŒI Cáº¤P
        dirs[:] = [d for d in dirs if d not in EXCLUDED_DIRS]

        dirs.sort()
        files.sort()

        for f in files:
            full_path = os.path.join(base, f)
            rel = os.path.relpath(full_path, root).replace("\\", "/")
            file_list.append(rel)

    return file_list


# -------------------------------------------------------------
# HÃ€M XÃC Äá»ŠNH LOáº I FILE
# -------------------------------------------------------------
def detect_type(file):
    ext = file.lower().split(".")[-1]
    if ext == "py":
        return "Python"
    if ext == "xml":
        return "XML"
    if ext == "csv":
        return "CSV"
    if ext == "js":
        return "JS"
    if ext == "css":
        return "CSS"
    if ext in ["png", "jpg", "jpeg", "svg"]:
        return "Image"
    return "Other"


# -------------------------------------------------------------
# HÃ€M SINH CÃ‚Y THÆ¯ Má»¤C Dáº NG TREE (ASCII)
# -------------------------------------------------------------
def generate_directory_tree(files):
    """
    Sinh cÃ¢y thÆ° má»¥c dáº¡ng ASCII tá»« danh sÃ¡ch file path
    """
    if not files:
        return ""

    # XÃ¢y dá»±ng cáº¥u trÃºc cÃ¢y dáº¡ng dict
    tree = {}
    for path in files:
        parts = path.split("/")
        current = tree
        for part in parts:
            current = current.setdefault(part, {})

    lines = []

    def render(node, prefix="", is_root=True):
        items = list(node.items())
        for i, (name, children) in enumerate(items):
            is_last = (i == len(items) - 1)

            if is_root:
                connector = ""
                new_prefix = ""
            else:
                connector = "â””â”€â”€ " if is_last else "â”œâ”€â”€ "
                new_prefix = prefix + ("    " if is_last else "â”‚   ")

            icon = "ğŸ“" if children else "ğŸ“„"
            lines.append(f"{prefix}{connector}{icon} {name}")

            if children:
                render(children, new_prefix, is_root=False)

    render(tree)

    output = []
    output.append("================================================================================")
    output.append("                                ğŸ“‚ DIRECTORY TREE")
    output.append("================================================================================")
    output.append("\n".join(lines))
    output.append("\n")

    return "\n".join(output)


# -------------------------------------------------------------
# HÃ€M SINH Cáº¤U TRÃšC THÆ¯ Má»¤C Dáº NG STT (GIá»® NGUYÃŠN)
# -------------------------------------------------------------
def generate_tree(files, root):
    lines = []
    counter = 1

    lines.append("================================================================================")
    lines.append(f"                              Cáº¤U TRÃšC THÆ¯ Má»¤C - {len(files)} FILES")
    lines.append("================================================================================\n")

    for f in files:
        lines.append(f"{counter:>3}.  {f}")
        counter += 1

    lines.append("\n")
    return "\n".join(lines)


# -------------------------------------------------------------
# HÃ€M SINH Báº¢NG Tá»”NG Káº¾T FILES
# -------------------------------------------------------------
def generate_summary(files):
    lines = []

    lines.append("================================================================================")
    lines.append(f"                         Báº¢NG Tá»”NG Káº¾T {len(files)} FILES")
    lines.append("================================================================================")
    lines.append("â”‚  #  â”‚ ÄÆ°á»ng dáº«n file                                     â”‚ Loáº¡i     â”‚")
    lines.append("â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")

    idx = 1
    for f in files:
        ftype = detect_type(f)
        lines.append(f"â”‚ {idx:<3} â”‚ {f:<50} â”‚ {ftype:<8} â”‚")
        idx += 1

    lines.append("\n")
    return "\n".join(lines)


# -------------------------------------------------------------
# HÃ€M Äá»ŒC Ná»˜I DUNG FILE
# -------------------------------------------------------------
def read_file(fullpath):
    try:
        with open(fullpath, "r", encoding="utf-8") as f:
            return f.read()
    except:
        return "[KhÃ´ng Ä‘á»c Ä‘Æ°á»£c file â€“ cÃ³ thá»ƒ lÃ  binary hoáº·c lá»—i mÃ£ hÃ³a]"


# -------------------------------------------------------------
# HÃ€M SINH Ná»˜I DUNG CÃC FILE
# -------------------------------------------------------------
def generate_file_contents(files, root):
    lines = []

    lines.append("\n================================================================================")
    lines.append("                              Ná»˜I DUNG CÃC FILES")
    lines.append("================================================================================\n")

    idx = 1
    for f in files:
        fullpath = os.path.join(root, f)

        lines.append("################################################################################")
        lines.append(f"## FILE {idx}: {os.path.basename(f)}")
        lines.append(f"## ÄÆ°á»ng dáº«n: {f}")
        lines.append("################################################################################\n")

        content = read_file(fullpath)
        lines.append(content)
        lines.append("\n\n")

        idx += 1

    return "\n".join(lines)


# -------------------------------------------------------------
# MAIN
# -------------------------------------------------------------
def main():
    root = os.path.dirname(os.path.abspath(__file__))
    module_name = os.path.basename(root)

    now = datetime.datetime.now().strftime("%Y-%m-%d_%Hh%M")
    output_file = OUTPUT_NAME or f"{module_name}_DOCUMENTATION_{now}.txt"

    files = scan_files(root)
    files = sorted(files)

    output = []
    output.append(make_banner(module_name))
    output.append(generate_directory_tree(files))   # ğŸŒ³ CÃ‚Y THÆ¯ Má»¤C (Má»šI)
    output.append(generate_tree(files, root))       # ğŸ“„ DANH SÃCH FILE
    output.append(generate_summary(files))           # ğŸ“Š Báº¢NG Tá»”NG Káº¾T
    output.append(generate_file_contents(files, root))

    with open(output_file, "w", encoding="utf-8") as f:
        f.write("\n".join(output))

    print(f"\nDONE! File generated: {output_file}")


if __name__ == "__main__":
    main()




################################################################################
## FILE 12: __init__.py
## ÄÆ°á»ng dáº«n: lib/__init__.py
################################################################################

from . import facebook_api



################################################################################
## FILE 13: facebook_api.py
## ÄÆ°á»ng dáº«n: lib/facebook_api.py
################################################################################

# -*- coding: utf-8 -*-

import requests
import logging

_logger = logging.getLogger(__name__)


class FacebookAPI:
    """
    Wrapper for Facebook Graph API.
    Version: v18.0
    """
    
    API_VERSION = 'v18.0'
    BASE_URL = f'https://graph.facebook.com/{API_VERSION}'
    
    def __init__(self, access_token):
        """
        Initialize API wrapper.
        
        Args:
            access_token (str): Page Access Token
        """
        self.access_token = access_token
    
    # -------------------------------------------------------------------------
    # EXISTING METHODS (from original module)
    # -------------------------------------------------------------------------
    
    def get_page_info(self, page_id):
        """Get page information"""
        url = f"{self.BASE_URL}/{page_id}"
        params = {
            'access_token': self.access_token,
            'fields': 'id,name,category,picture,fan_count,link'
        }
        response = requests.get(url, params=params)
        return response.json()
    
    def publish_post(self, page_id, message, **kwargs):
        """Publish a post to page"""
        url = f"{self.BASE_URL}/{page_id}/feed"
        data = {
            'access_token': self.access_token,
            'message': message,
        }
        data.update(kwargs)
        response = requests.post(url, data=data)
        return response.json()
    
    def send_message(self, recipient_id, message):
        """
        Send message via Messenger.
        
        Args:
            recipient_id (str): PSID of recipient
            message (dict): Message object
                {
                    'text': 'Hello',
                    'quick_replies': [...]  (optional)
                }
        
        Returns:
            dict: API response
        """
        url = f"{self.BASE_URL}/me/messages"
        data = {
            'access_token': self.access_token,
            'recipient': {'id': recipient_id},
            'message': message,
        }
        response = requests.post(url, json=data)
        return response.json()
    
    def get_conversation_messages(self, conversation_id, limit=25):
        """Get messages from a conversation"""
        url = f"{self.BASE_URL}/{conversation_id}"
        params = {
            'access_token': self.access_token,
            'fields': f'messages.limit({limit}){{id,created_time,from,to,message}}'
        }
        response = requests.get(url, params=params)
        return response.json()
    
    # -------------------------------------------------------------------------
    # NEW: LEADGEN API
    # -------------------------------------------------------------------------
    
    def get_leadgen_data(self, leadgen_id):
        """
        Láº¥y dá»¯ liá»‡u lead form tá»« Facebook.
        
        Endpoint: /{leadgen_id}
        Fields: field_data (contains name, phone, email, etc.)
        
        Args:
            leadgen_id (str): Lead generation ID from webhook
        
        Returns:
            dict: Lead data
                {
                    'id': '123',
                    'created_time': '2025-01-01T10:00:00+0000',
                    'field_data': [
                        {'name': 'full_name', 'values': ['John Doe']},
                        {'name': 'phone_number', 'values': ['+1234567890']},
                        {'name': 'email', 'values': ['john@example.com']},
                    ]
                }
        """
        url = f"{self.BASE_URL}/{leadgen_id}"
        params = {
            'access_token': self.access_token,
            'fields': 'id,created_time,field_data'
        }
        
        try:
            response = requests.get(url, params=params, timeout=10)
            response.raise_for_status()
            data = response.json()
            
            _logger.info(f'Successfully fetched leadgen data for {leadgen_id}')
            return data
            
        except requests.exceptions.RequestException as e:
            _logger.error(f'Failed to fetch leadgen {leadgen_id}: {e}')
            raise
    
    def get_leadgen_forms(self, page_id):
        """
        Láº¥y danh sÃ¡ch lead forms cá»§a page.
        
        Args:
            page_id (str): Facebook Page ID
        
        Returns:
            list: List of lead forms
        """
        url = f"{self.BASE_URL}/{page_id}/leadgen_forms"
        params = {
            'access_token': self.access_token,
            'fields': 'id,name,status,questions'
        }
        
        try:
            response = requests.get(url, params=params, timeout=10)
            response.raise_for_status()
            data = response.json()
            
            return data.get('data', [])
            
        except requests.exceptions.RequestException as e:
            _logger.error(f'Failed to fetch leadgen forms: {e}')
            return []
    
    # -------------------------------------------------------------------------
    # MESSENGER PROFILE API
    # -------------------------------------------------------------------------
    
    def set_get_started_button(self, payload='GET_STARTED'):
        """
        Set Get Started button for Messenger.
        
        Args:
            payload (str): Postback payload when button clicked
        """
        url = f"{self.BASE_URL}/me/messenger_profile"
        data = {
            'access_token': self.access_token,
            'get_started': {'payload': payload}
        }
        response = requests.post(url, json=data)
        return response.json()
    
    def set_greeting_text(self, greeting_text):
        """
        Set greeting text for Messenger.
        
        Args:
            greeting_text (str): Greeting message
        """
        url = f"{self.BASE_URL}/me/messenger_profile"
        data = {
            'access_token': self.access_token,
            'greeting': [
                {
                    'locale': 'default',
                    'text': greeting_text
                }
            ]
        }
        response = requests.post(url, json=data)
        return response.json()



################################################################################
## FILE 14: __init__.py
## ÄÆ°á»ng dáº«n: models/__init__.py
################################################################################

# -*- coding: utf-8 -*-

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# QUAN TRá»ŒNG: THá»¨ Tá»° IMPORT MODELS
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Quy táº¯c: Base models TRÆ¯á»šC, Extended models SAU
# Models cÃ³ dependencies pháº£i load SAU models Ä‘Æ°á»£c reference
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# -------------------------------------------------------------------------
# STEP 1: Core Odoo models extension (khÃ´ng dependencies)
# -------------------------------------------------------------------------
from . import res_company
from . import res_config_settings

# -------------------------------------------------------------------------
# STEP 2: Base Social models (foundation - Ä‘Æ°á»£c reference bá»Ÿi models khÃ¡c)
# -------------------------------------------------------------------------
from . import social_account        # Base: Facebook Pages
from . import social_post           # Depends: social_account
from . import social_post_template  # Depends: social_account, social_post
from . import social_comment        # Depends: social_account, social_post
from . import social_message        # Base: Conversations & Messages (â— QUAN TRá»ŒNG)
from . import social_analytics      # Depends: social_account, social_post

# -------------------------------------------------------------------------
# STEP 3: Extended/New Social models (reference base models)
# -------------------------------------------------------------------------
from . import social_messenger_product  # Depends: product.product
from . import social_messenger_order    # Depends: social_message â† ÄÃ‚Y!

# -------------------------------------------------------------------------
# STEP 4: CRM Integration (reference social models)
# -------------------------------------------------------------------------
from . import crm_lead  # Depends: social_message â† ÄÃ‚Y!



################################################################################
## FILE 15: crm_lead.py
## ÄÆ°á»ng dáº«n: models/crm_lead.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _


class CrmLead(models.Model):
    """
    Má»Ÿ rá»™ng crm.lead Ä‘á»ƒ link vá»›i Facebook conversations.
    """
    _inherit = 'crm.lead'
    
    # Link to Facebook
    facebook_conversation_id = fields.Many2one(
        'social.message',
        string='Facebook Conversation',
        ondelete='set null',
        help='Conversation Messenger táº¡o ra lead nÃ y',
    )
    facebook_user_id = fields.Char(
        string='Facebook User ID',
        help='PSID cá»§a khÃ¡ch hÃ ng',
    )
    
    # Statistics
    messenger_message_count = fields.Integer(
        string='Messenger Messages',
        compute='_compute_messenger_stats',
        help='Sá»‘ tin nháº¯n trong conversation',
    )
    
    def _compute_messenger_stats(self):
        """TÃ­nh sá»‘ tin nháº¯n Messenger"""
        for lead in self:
            if lead.facebook_conversation_id:
                messages = self.env['social.message'].search_count([
                    ('conversation_id', '=', lead.facebook_conversation_id.id)
                ])
                lead.messenger_message_count = messages
            else:
                lead.messenger_message_count = 0
    
    def action_view_messenger_conversation(self):
        """Xem conversation Messenger"""
        self.ensure_one()
        if not self.facebook_conversation_id:
            return {'type': 'ir.actions.act_window_close'}
        
        return {
            'name': _('Messenger Conversation'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.message',
            'res_id': self.facebook_conversation_id.id,
            'view_mode': 'form',
            'target': 'current',
        }



################################################################################
## FILE 16: res_company.py
## ÄÆ°á»ng dáº«n: models/res_company.py
################################################################################

from odoo import models, fields


class ResCompany(models.Model):
    _inherit = 'res.company'

    facebook_app_id = fields.Char(
        string='Facebook App ID',
        help='Facebook App ID for authentication'
    )
    
    facebook_app_secret = fields.Char(
        string='Facebook App Secret',
        help='Facebook App Secret for authentication'
    )
    
    facebook_webhook_verify_token = fields.Char(
        string='Webhook Verify Token',
        help='Token for Facebook webhook verification'
    )




################################################################################
## FILE 17: res_config_settings.py
## ÄÆ°á»ng dáº«n: models/res_config_settings.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _
from odoo.exceptions import UserError
import subprocess
import requests
import logging
import os

_logger = logging.getLogger(__name__)


class ResConfigSettings(models.TransientModel):
    _inherit = 'res.config.settings'
    
    # -------------------------------------------------------------------------
    # FACEBOOK WEBHOOK CONFIG
    # -------------------------------------------------------------------------
    
    facebook_verify_token = fields.Char(
        string='Webhook Verify Token',
        config_parameter='module_social_facebook.verify_token',
        help='Token Ä‘á»ƒ verify webhook tá»« Facebook (GET request)',
    )
    facebook_webhook_url = fields.Char(
        string='Webhook URL',
        compute='_compute_webhook_url',
        help='URL webhook hiá»‡n táº¡i (localhost hoáº·c ngrok)',
    )
    
    # -------------------------------------------------------------------------
    # NGROK CONFIG
    # -------------------------------------------------------------------------
    
    ngrok_executable_path = fields.Char(
        string='Ngrok Executable Path',
        config_parameter='module_social_facebook.ngrok_path',
        default='C:/ngrok/ngrok.exe',
        help='ÄÆ°á»ng dáº«n Ä‘áº§y Ä‘á»§ tá»›i file ngrok.exe',
    )
    ngrok_tunnel_url = fields.Char(
        string='Ngrok Public URL',
        compute='_compute_ngrok_tunnel_url',
        help='URL cÃ´ng khai tá»« ngrok (https)',
    )
    ngrok_is_running = fields.Boolean(
        string='Ngrok Running',
        compute='_compute_ngrok_is_running',
        help='Tráº¡ng thÃ¡i ngrok',
    )
    
    # -------------------------------------------------------------------------
    # CRM INTEGRATION CONFIG
    # -------------------------------------------------------------------------
    
    auto_create_lead = fields.Boolean(
        string='Auto Create Leads',
        config_parameter='module_social_facebook.auto_create_lead',
        default=True,
        help='Tá»± Ä‘á»™ng táº¡o crm.lead tá»« Messenger conversations',
    )
    lead_default_user_id = fields.Many2one(
        'res.users',
        string='Default Salesperson',
        config_parameter='module_social_facebook.lead_default_user_id',
        help='NgÆ°á»i Ä‘Æ°á»£c assign lead máº·c Ä‘á»‹nh',
    )
    
    # -------------------------------------------------------------------------
    # CHATBOT CONFIG
    # -------------------------------------------------------------------------
    
    chatbot_enabled = fields.Boolean(
        string='Enable Sales Chatbot',
        config_parameter='module_social_facebook.chatbot_enabled',
        default=False,
        help='Báº­t chatbot bÃ¡n hÃ ng tá»± Ä‘á»™ng qua Messenger',
    )
    chatbot_welcome_message = fields.Text(
        string='Welcome Message',
        config_parameter='module_social_facebook.chatbot_welcome_message',
        default='Xin chÃ o! TÃ´i lÃ  trá»£ lÃ½ bÃ¡n hÃ ng tá»± Ä‘á»™ng. ğŸ˜Š\nBáº¡n vui lÃ²ng cho tÃ´i biáº¿t tÃªn cá»§a báº¡n?',
        help='Tin nháº¯n chÃ o má»«ng khi báº¯t Ä‘áº§u flow',
    )
    
    # -------------------------------------------------------------------------
    # COMPUTE METHODS
    # -------------------------------------------------------------------------
    
    @api.depends('ngrok_tunnel_url')
    def _compute_webhook_url(self):
        """TÃ­nh toÃ¡n webhook URL (ngrok hoáº·c localhost)"""
        for record in self:
            base_url = record.ngrok_tunnel_url or self.env['ir.config_parameter'].sudo().get_param('web.base.url', 'http://localhost:8069')
            record.facebook_webhook_url = f"{base_url}/social/facebook/webhook"
    
    def _compute_ngrok_tunnel_url(self):
        """Láº¥y URL ngrok tá»« API"""
        for record in self:
            try:
                # Query ngrok API (default: http://127.0.0.1:4040/api/tunnels)
                response = requests.get('http://127.0.0.1:4040/api/tunnels', timeout=2)
                if response.status_code == 200:
                    data = response.json()
                    tunnels = data.get('tunnels', [])
                    for tunnel in tunnels:
                        if tunnel.get('proto') == 'https':
                            record.ngrok_tunnel_url = tunnel.get('public_url')
                            return
                record.ngrok_tunnel_url = False
            except Exception as e:
                _logger.debug(f'Failed to get ngrok URL: {e}')
                record.ngrok_tunnel_url = False
    
    def _compute_ngrok_is_running(self):
        """Kiá»ƒm tra ngrok cÃ³ Ä‘ang cháº¡y khÃ´ng"""
        for record in self:
            record.ngrok_is_running = bool(record.ngrok_tunnel_url)
    
    # -------------------------------------------------------------------------
    # NGROK ACTIONS
    # -------------------------------------------------------------------------
    
    def action_start_ngrok(self):
        """
        Khá»Ÿi Ä‘á»™ng ngrok subprocess.
        
        Command: ngrok.exe http 8069
        Process cháº¡y background, khÃ´ng block Odoo.
        """
        self.ensure_one()
        
        ngrok_path = self.ngrok_executable_path or 'C:/ngrok/ngrok.exe'
        
        # Check if file exists
        if not os.path.exists(ngrok_path):
            raise UserError(_(
                'Ngrok executable not found at: %s\n'
                'Please update the path in settings!'
            ) % ngrok_path)
        
        # Check if already running
        if self.ngrok_is_running:
            raise UserError(_('Ngrok is already running!'))
        
        try:
            # Start ngrok subprocess
            # Use Popen to run in background
            subprocess.Popen(
                [ngrok_path, 'http', '8069'],
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
                creationflags=subprocess.CREATE_NEW_CONSOLE if os.name == 'nt' else 0
            )
            
            _logger.info('Ngrok started successfully')
            
            return {
                'type': 'ir.actions.client',
                'tag': 'display_notification',
                'params': {
                    'title': _('Success'),
                    'message': _('Ngrok started! Please wait 5 seconds then refresh to see the URL.'),
                    'type': 'success',
                    'sticky': False,
                }
            }
            
        except Exception as e:
            _logger.error(f'Failed to start ngrok: {e}')
            raise UserError(_(
                'Failed to start ngrok: %s\n'
                'Please check the executable path and try again.'
            ) % str(e))
    
    def action_stop_ngrok(self):
        """
        Dá»«ng ngrok process.
        
        Kill táº¥t cáº£ process ngrok Ä‘ang cháº¡y.
        """
        self.ensure_one()
        
        try:
            if os.name == 'nt':  # Windows
                subprocess.run(['taskkill', '/F', '/IM', 'ngrok.exe'], 
                             stdout=subprocess.DEVNULL, 
                             stderr=subprocess.DEVNULL)
            else:  # Linux/Mac
                subprocess.run(['pkill', 'ngrok'], 
                             stdout=subprocess.DEVNULL, 
                             stderr=subprocess.DEVNULL)
            
            _logger.info('Ngrok stopped')
            
            return {
                'type': 'ir.actions.client',
                'tag': 'display_notification',
                'params': {
                    'title': _('Success'),
                    'message': _('Ngrok stopped successfully!'),
                    'type': 'success',
                    'sticky': False,
                }
            }
            
        except Exception as e:
            _logger.error(f'Failed to stop ngrok: {e}')
            raise UserError(_('Failed to stop ngrok: %s') % str(e))
    
    def action_refresh_ngrok_url(self):
        """Refresh Ä‘á»ƒ láº¥y ngrok URL má»›i"""
        self._compute_ngrok_tunnel_url()
        
        if self.ngrok_tunnel_url:
            message = _('Ngrok URL: %s') % self.ngrok_tunnel_url
            msg_type = 'success'
        else:
            message = _('Ngrok is not running or URL not available.')
            msg_type = 'warning'
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Ngrok Status'),
                'message': message,
                'type': msg_type,
                'sticky': False,
            }
        }
    
    def action_copy_webhook_url(self):
        """Copy webhook URL to clipboard (via notification)"""
        self.ensure_one()
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Webhook URL'),
                'message': _('Webhook URL: %s\nCopy vÃ  dÃ¡n vÃ o Facebook App Settings!') % self.facebook_webhook_url,
                'type': 'info',
                'sticky': True,
            }
        }
    



################################################################################
## FILE 18: social_account.py
## ÄÆ°á»ng dáº«n: models/social_account.py
################################################################################

from odoo import models, fields, api, _
from odoo.exceptions import UserError
import requests
import logging

_logger = logging.getLogger(__name__)


class SocialAccount(models.Model):
    _name = 'social.account'
    _description = 'Facebook Account'
    _order = 'name'
    _inherit = ['mail.thread', 'mail.activity.mixin']

    name = fields.Char(string='Page Name', required=True, tracking=True)
    platform = fields.Selection([('facebook', 'Facebook')], string='Platform', default='facebook', required=True)
    facebook_page_id = fields.Char(string='Facebook Page ID', required=True, tracking=True)
    facebook_page_url = fields.Char(string='Page URL', compute='_compute_page_url', store=True)
    
    access_token = fields.Char(string='Access Token', required=True)
    token_expires_at = fields.Datetime(string='Token Expires At')
    is_token_valid = fields.Boolean(string='Token Valid', compute='_compute_token_valid')
    
    page_category = fields.Char(string='Category')
    page_about = fields.Text(string='About')
    followers_count = fields.Integer(string='Followers', default=0)
    likes_count = fields.Integer(string='Likes', default=0)
    page_rating = fields.Float(string='Rating', digits=(2, 1))
    profile_picture_url = fields.Char(string='Profile Picture URL')
    cover_photo_url = fields.Char(string='Cover Photo URL')
    
    active = fields.Boolean(string='Active', default=True)
    state = fields.Selection([
        ('draft', 'Draft'),
        ('connected', 'Connected'),
        ('error', 'Error'),
    ], string='Status', default='draft', tracking=True)
    
    last_sync_date = fields.Datetime(string='Last Sync')
    last_message_sync_date = fields.Datetime(string='Last Message Sync')
    error_message = fields.Text(string='Error Message')
    
    auto_sync_comments = fields.Boolean(string='Auto Sync Comments', default=True)
    auto_sync_messages = fields.Boolean(string='Auto Sync Messages', default=True)
    
    company_id = fields.Many2one('res.company', string='Company', default=lambda self: self.env.company)
    post_ids = fields.One2many('social.post', 'account_id', string='Posts')
    post_count = fields.Integer(string='Posts', compute='_compute_post_count')
    
    # âœ… THÃŠM: Field Ä‘áº¿m conversations
    conversation_count = fields.Integer(string='Conversations', compute='_compute_conversation_count')
    
    _sql_constraints = [
        ('facebook_page_id_uniq', 'UNIQUE(facebook_page_id, company_id)', 
         'Facebook Page ID must be unique per company!'),
    ]
    
    @api.depends('facebook_page_id')
    def _compute_page_url(self):
        for account in self:
            if account.facebook_page_id:
                account.facebook_page_url = f'https://www.facebook.com/{account.facebook_page_id}'
            else:
                account.facebook_page_url = False
    
    @api.depends('token_expires_at')
    def _compute_token_valid(self):
        now = fields.Datetime.now()
        for account in self:
            if account.token_expires_at:
                account.is_token_valid = account.token_expires_at > now
            else:
                account.is_token_valid = True
    
    def _compute_post_count(self):
        for account in self:
            account.post_count = len(account.post_ids)
    
    # âœ… THÃŠM: Compute conversation count
    def _compute_conversation_count(self):
        for account in self:
            account.conversation_count = self.env['social.conversation'].search_count([
                ('account_id', '=', account.id)
            ])
    
    def action_test_connection(self):
        self.ensure_one()
        try:
            url = f'https://graph.facebook.com/v18.0/{self.facebook_page_id}'
            params = {'access_token': self.access_token, 'fields': 'id,name,category'}
            response = requests.get(url, params=params, timeout=10)
            
            if response.status_code == 200:
                self.write({'state': 'connected', 'error_message': False})
                return {
                    'type': 'ir.actions.client',
                    'tag': 'display_notification',
                    'params': {
                        'title': _('Success'),
                        'message': _('Connection successful!'),
                        'type': 'success',
                        'sticky': False,
                    }
                }
            else:
                raise UserError(_('Connection failed: %s') % response.text)
        except Exception as e:
            self.write({'state': 'error', 'error_message': str(e)})
            raise UserError(_('Connection error: %s') % str(e))
    
    def action_sync_page_info(self):
        self.ensure_one()
        try:
            url = f'https://graph.facebook.com/v18.0/{self.facebook_page_id}'
            params = {
                'access_token': self.access_token,
                'fields': 'name,category,about,followers_count,fan_count,overall_star_rating'
            }
            response = requests.get(url, params=params, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                self.write({
                    'name': data.get('name', self.name),
                    'page_category': data.get('category'),
                    'page_about': data.get('about'),
                    'followers_count': data.get('followers_count', 0),
                    'likes_count': data.get('fan_count', 0),
                    'page_rating': data.get('overall_star_rating', 0),
                    'last_sync_date': fields.Datetime.now(),
                })
                return True
            return False
        except Exception as e:
            _logger.error(f'Error syncing page info: {e}')
            return False
    
    def action_view_posts(self):
        self.ensure_one()
        return {
            'name': _('Posts - %s') % self.name,
            'type': 'ir.actions.act_window',
            'res_model': 'social.post',
            'view_mode': 'list,kanban,form',
            'domain': [('account_id', '=', self.id)],
            'context': {'default_account_id': self.id},
        }
    
    # =========================================================================
    # âœ… THÃŠM: ACTION SYNC CONVERSATIONS
    # =========================================================================
    def action_sync_conversations(self):
        """
        Äá»“ng bá»™ táº¥t cáº£ conversations cá»§a account nÃ y tá»« Facebook.
        """
        self.ensure_one()
        
        if self.state != 'connected':
            raise UserError(_('Please connect the account first!'))
        
        try:
            from .social_message import SocialMessage
            
            # Gá»i method sync cho account nÃ y
            self.env['social.message']._sync_account_conversations(self)
            
            # Cáº­p nháº­t last sync date
            self.write({
                'last_message_sync_date': fields.Datetime.now(),
            })
            
            # Äáº¿m sá»‘ conversations Ä‘Ã£ sync
            conv_count = self.env['social.conversation'].search_count([
                ('account_id', '=', self.id)
            ])
            
            return {
                'type': 'ir.actions.client',
                'tag': 'display_notification',
                'params': {
                    'title': _('Success'),
                    'message': _('Synced conversations! Total: %d conversations') % conv_count,
                    'type': 'success',
                    'sticky': False,
                }
            }
            
        except Exception as e:
            _logger.error(f'Error syncing conversations for account {self.id}: {e}')
            raise UserError(_('Error syncing conversations: %s') % str(e))
    
    # âœ… THÃŠM: Action view conversations
    def action_view_conversations(self):
        """Xem táº¥t cáº£ conversations cá»§a account nÃ y"""
        self.ensure_one()
        return {
            'name': _('Conversations - %s') % self.name,
            'type': 'ir.actions.act_window',
            'res_model': 'social.conversation',
            'view_mode': 'list,form',
            'domain': [('account_id', '=', self.id)],
            'context': {'default_account_id': self.id},
        }
    
    @api.model
    def cron_refresh_facebook_tokens(self):
        accounts = self.search([('platform', '=', 'facebook'), ('state', '=', 'connected')])
        for account in accounts:
            try:
                _logger.info(f'Refreshing token for account {account.id}')
            except Exception as e:
                _logger.error(f'Error refreshing token: {e}')



################################################################################
## FILE 19: social_analytics.py
## ÄÆ°á»ng dáº«n: models/social_analytics.py
################################################################################

from odoo import models, fields, api, tools
import logging

_logger = logging.getLogger(__name__)


class SocialAnalytics(models.Model):
    """
    Model phÃ¢n tÃ­ch insights tá»« Facebook.
    """
    _name = 'social.analytics'
    _description = 'Facebook Analytics'
    _auto = False
    _rec_name = 'account_id'

    account_id = fields.Many2one('social.account', string='Page', readonly=True)
    date = fields.Date(string='Date', readonly=True)
    total_posts = fields.Integer(string='Total Posts', readonly=True)
    total_likes = fields.Integer(string='Total Likes', readonly=True)
    total_comments = fields.Integer(string='Total Comments', readonly=True)
    total_shares = fields.Integer(string='Total Shares', readonly=True)
    avg_engagement_rate = fields.Float(string='Avg Engagement Rate', readonly=True)
    company_id = fields.Many2one('res.company', string='Company', readonly=True)
    
    def init(self):
        """Táº¡o SQL view cho analytics"""
        tools.drop_view_if_exists(self._cr, self._table)
        self._cr.execute("""
            CREATE OR REPLACE VIEW %s AS (
                SELECT
                    ROW_NUMBER() OVER (ORDER BY sp.account_id, DATE(sp.published_date)) AS id,
                    sp.account_id AS account_id,
                    DATE(sp.published_date) AS date,
                    COUNT(sp.id) AS total_posts,
                    SUM(sp.likes_count) AS total_likes,
                    SUM(sp.comments_count) AS total_comments,
                    SUM(sp.shares_count) AS total_shares,
                    AVG(sp.engagement_rate) AS avg_engagement_rate,
                    sp.company_id AS company_id
                FROM
                    social_post sp
                WHERE
                    sp.state = 'published'
                    AND sp.published_date IS NOT NULL
                GROUP BY
                    sp.account_id, DATE(sp.published_date), sp.company_id
            )
        """ % self._table)
    
    @api.model
    def cron_update_facebook_insights(self):
        """Cron job Ä‘á»ƒ update insights"""
        _logger.info('Updating Facebook insights...')
        # Logic update insights



################################################################################
## FILE 20: social_comment.py
## ÄÆ°á»ng dáº«n: models/social_comment.py
################################################################################

from odoo import models, fields, api, _
from odoo.exceptions import UserError
import requests
import logging

_logger = logging.getLogger(__name__)


class SocialComment(models.Model):
    _name = 'social.comment'
    _description = 'Facebook Comment'
    _order = 'comment_date desc'

    display_name = fields.Char(string='Display Name', compute='_compute_display_name', store=True)
    post_id = fields.Many2one('social.post', string='Post', required=True, ondelete='cascade')
    facebook_comment_id = fields.Char(string='Facebook Comment ID', required=True)
    author_name = fields.Char(string='Author', required=True)
    author_facebook_id = fields.Char(string='Author FB ID')
    message = fields.Text(string='Message', required=True)
    comment_date = fields.Datetime(string='Date', required=True, default=fields.Datetime.now)
    parent_id = fields.Many2one('social.comment', string='Parent Comment')
    is_hidden = fields.Boolean(string='Hidden', default=False)
    is_spam = fields.Boolean(string='Spam', default=False)
    reply_text = fields.Text(string='Reply')
    replied = fields.Boolean(string='Replied', default=False)
    company_id = fields.Many2one('res.company', related='post_id.company_id', store=True)
    
    @api.depends('author_name', 'message')
    def _compute_display_name(self):
        for comment in self:
            preview = comment.message[:50] + '...' if len(comment.message or '') > 50 else comment.message
            comment.display_name = f"{comment.author_name}: {preview}"
    
    def action_reply(self):
        self.ensure_one()
        if not self.reply_text:
            raise UserError(_('Please enter a reply message!'))
        try:
            url = f'https://graph.facebook.com/v18.0/{self.facebook_comment_id}/comments'
            data = {'access_token': self.post_id.account_id.access_token, 'message': self.reply_text}
            response = requests.post(url, data=data, timeout=30)
            if response.status_code == 200:
                self.replied = True
                return {'type': 'ir.actions.client', 'tag': 'display_notification',
                        'params': {'title': _('Success'), 'message': _('Reply sent!'), 'type': 'success'}}
            else:
                raise UserError(_('Failed to reply: %s') % response.text)
        except Exception as e:
            raise UserError(_('Error: %s') % str(e))
    
    def action_hide(self):
        self.ensure_one()
        self.is_hidden = True
    
    def action_mark_spam(self):
        self.ensure_one()
        self.is_spam = True



################################################################################
## FILE 21: social_message.py
## ÄÆ°á»ng dáº«n: models/social_message.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _
from odoo.exceptions import UserError, ValidationError
import logging
import re

_logger = logging.getLogger(__name__)


class SocialMessage(models.Model):
    """
    Model quáº£n lÃ½ Facebook Messenger conversations vÃ  messages.
    
    Model nÃ y Ä‘áº¡i diá»‡n cho:
    1. Conversations: Cuá»™c há»™i thoáº¡i vá»›i má»™t user (identified by PSID)
    2. Messages: Tin nháº¯n riÃªng láº» trong conversation
    
    Chatbot Flow:
    - idle â†’ ask_name â†’ ask_phone â†’ show_products â†’ confirm_order â†’ completed
    
    Integration:
    - CRM: Auto-create crm.lead tá»« conversations
    - Sales: Create sale.order tá»« chatbot
    """
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # MODEL DEFINITION
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    _name = 'social.message'
    _description = 'Social Message / Conversation'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _order = 'create_date desc'
    _rec_name = 'facebook_user_id'
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # BASIC CONVERSATION FIELDS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    # Conversation Identification
    facebook_user_id = fields.Char(
        string='Facebook User ID (PSID)',
        required=True,
        index=True,
        help='Page-Scoped User ID from Facebook',
    )
    account_id = fields.Many2one(
        'social.account',
        string='Facebook Page',
        required=True,
        ondelete='cascade',
        index=True,
        help='Facebook Page nháº­n tin nháº¯n',
    )
    
    # Message Details
    message_id = fields.Char(
        string='Message ID',
        index=True,
        help='Facebook Message ID (unique cho má»—i message)',
    )
    message = fields.Text(
        string='Message Content',
        help='Ná»™i dung tin nháº¯n',
    )
    is_from_customer = fields.Boolean(
        string='From Customer',
        default=True,
        help='True = tá»« khÃ¡ch hÃ ng, False = tá»« Page',
    )
    attachments = fields.Text(
        string='Attachments',
        help='JSON data cá»§a file Ä‘Ã­nh kÃ¨m (images, files, etc.)',
    )
    
    # Timestamps
    created_date = fields.Datetime(
        string='Created Date',
        default=fields.Datetime.now,
        index=True,
    )
    last_message_date = fields.Datetime(
        string='Last Message',
        help='Thá»i Ä‘iá»ƒm tin nháº¯n cuá»‘i cÃ¹ng',
    )
    
    # Organization
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        default=lambda self: self.env.company,
        required=True,
        index=True,
    )
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CHATBOT FIELDS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    chatbot_state = fields.Selection([
        ('idle', 'Idle'),
        ('ask_name', 'Asking Name'),
        ('ask_phone', 'Asking Phone'),
        ('show_products', 'Showing Products'),
        ('confirm_order', 'Confirming Order'),
        ('completed', 'Completed'),
    ], string='Chatbot State', default='idle', tracking=True)
    
    customer_name = fields.Char(
        string='Customer Name',
        help='TÃªn khÃ¡ch hÃ ng trong cuá»™c há»™i thoáº¡i',
    )
    customer_phone = fields.Char(
        string='Customer Phone',
        help='Sá»‘ Ä‘iá»‡n thoáº¡i khÃ¡ch hÃ ng',
    )
    selected_product_ids = fields.Many2many(
        'social.messenger.product',
        string='Selected Products',
        help='Sáº£n pháº©m khÃ¡ch hÃ ng Ä‘Ã£ chá»n',
    )
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CRM & SALES INTEGRATION
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    lead_id = fields.Many2one(
        'crm.lead',
        string='Lead',
        ondelete='set null',
        help='Lead Ä‘Æ°á»£c táº¡o tá»« conversation nÃ y',
    )
    messenger_order_id = fields.Many2one(
        'social.messenger.order',
        string='Messenger Order',
        ondelete='set null',
        help='ÄÆ¡n hÃ ng Ä‘Æ°á»£c táº¡o tá»« conversation nÃ y',
    )
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CONSTRAINTS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    _sql_constraints = [
        ('facebook_user_account_uniq',
         'UNIQUE(facebook_user_id, account_id)',
         'Conversation already exists for this user and page!'),
    ]
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CHATBOT FLOW METHODS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    def process_chatbot_flow(self, user_message):
        """
        Xá»­ lÃ½ luá»“ng há»™i thoáº¡i chatbot bÃ¡n hÃ ng.
        
        Flow:
        1. idle â†’ ask_name: ChÃ o há»i, xin tÃªn
        2. ask_name â†’ ask_phone: LÆ°u tÃªn, xin SÄT
        3. ask_phone â†’ show_products: LÆ°u SÄT, show danh sÃ¡ch SP
        4. show_products â†’ confirm_order: LÆ°u SP Ä‘Ã£ chá»n
        5. confirm_order â†’ completed: Táº¡o Ä‘Æ¡n hÃ ng
        
        Args:
            user_message (str): Tin nháº¯n cá»§a user
        
        Returns:
            dict: Response message to send
        """
        self.ensure_one()
        
        # Check if chatbot is enabled
        chatbot_enabled = self.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.chatbot_enabled', 'False'
        )
        if chatbot_enabled != 'True':
            return None
        
        current_state = self.chatbot_state
        
        if current_state == 'idle':
            return self._chatbot_ask_name()
        
        elif current_state == 'ask_name':
            return self._chatbot_save_name_ask_phone(user_message)
        
        elif current_state == 'ask_phone':
            return self._chatbot_save_phone_show_products(user_message)
        
        elif current_state == 'show_products':
            return self._chatbot_save_product_selection(user_message)
        
        elif current_state == 'confirm_order':
            return self._chatbot_create_order(user_message)
        
        return None
    
    def _chatbot_ask_name(self):
        """State 1: Há»i tÃªn khÃ¡ch hÃ ng"""
        self.chatbot_state = 'ask_name'
        
        welcome_msg = self.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.chatbot_welcome_message',
            'Xin chÃ o! TÃ´i lÃ  trá»£ lÃ½ bÃ¡n hÃ ng tá»± Ä‘á»™ng. ğŸ˜Š\nBáº¡n vui lÃ²ng cho tÃ´i biáº¿t tÃªn cá»§a báº¡n?'
        )
        
        return {
            'text': welcome_msg
        }
    
    def _chatbot_save_name_ask_phone(self, user_message):
        """State 2: LÆ°u tÃªn, há»i SÄT"""
        # Extract name from message
        name = user_message.strip()
        if len(name) < 2:
            return {
                'text': 'TÃªn báº¡n cÃ³ váº» hÆ¡i ngáº¯n. Báº¡n vui lÃ²ng nháº­p láº¡i tÃªn Ä‘áº§y Ä‘á»§ nhÃ©! ğŸ˜Š'
            }
        
        self.customer_name = name
        self.chatbot_state = 'ask_phone'
        
        return {
            'text': f'Ráº¥t vui Ä‘Æ°á»£c lÃ m quen vá»›i {name}! ğŸ‘‹\n\nÄá»ƒ chÃºng tÃ´i cÃ³ thá»ƒ liÃªn há»‡ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng, báº¡n vui lÃ²ng cung cáº¥p sá»‘ Ä‘iá»‡n thoáº¡i?'
        }
    
    def _chatbot_save_phone_show_products(self, user_message):
        """State 3: LÆ°u SÄT, hiá»ƒn thá»‹ sáº£n pháº©m"""
        # Validate phone number (simple regex)
        phone = user_message.strip()
        phone_pattern = r'^[0-9\s\+\-\(\)]{9,15}$'
        
        if not re.match(phone_pattern, phone):
            return {
                'text': 'Sá»‘ Ä‘iá»‡n thoáº¡i cÃ³ váº» khÃ´ng há»£p lá»‡. Vui lÃ²ng nháº­p láº¡i sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n (10-11 sá»‘).'
            }
        
        self.customer_phone = phone
        self.chatbot_state = 'show_products'
        
        # Get active products
        products = self.env['social.messenger.product'].get_active_products(
            company_id=self.company_id.id
        )
        
        if not products:
            return {
                'text': 'Xin lá»—i, hiá»‡n táº¡i chÃºng tÃ´i chÆ°a cÃ³ sáº£n pháº©m nÃ o. Vui lÃ²ng quay láº¡i sau! ğŸ˜Š'
            }
        
        # Create quick replies for products
        quick_replies = []
        product_list = "ğŸ“¦ Danh sÃ¡ch sáº£n pháº©m:\n\n"
        
        for idx, product in enumerate(products, 1):
            product_list += f"{idx}. {product.product_id.name}\n"
            product_list += f"   ğŸ’° {product.price:,.0f} {product.currency_id.symbol}\n"
            if product.description:
                product_list += f"   ğŸ“ {product.description[:50]}...\n"
            product_list += "\n"
            
            quick_replies.append(product.format_for_messenger())
        
        product_list += "Vui lÃ²ng chá»n sáº£n pháº©m báº¡n muá»‘n mua:"
        
        return {
            'text': product_list,
            'quick_replies': quick_replies
        }
    
    def _chatbot_save_product_selection(self, user_message):
        """State 4: LÆ°u sáº£n pháº©m Ä‘Ã£ chá»n, xÃ¡c nháº­n"""
        # Parse product ID from payload (format: PRODUCT_123)
        if user_message.startswith('PRODUCT_'):
            try:
                product_id = int(user_message.replace('PRODUCT_', ''))
                product = self.env['social.messenger.product'].browse(product_id)
                
                if not product.exists() or not product.active:
                    return {
                        'text': 'Sáº£n pháº©m khÃ´ng tá»“n táº¡i hoáº·c Ä‘Ã£ háº¿t hÃ ng. Vui lÃ²ng chá»n sáº£n pháº©m khÃ¡c.'
                    }
                
                # Add to selected products
                self.selected_product_ids = [(4, product.id)]
                self.chatbot_state = 'confirm_order'
                
                # Build confirmation message
                total = sum(self.selected_product_ids.mapped('price'))
                product_list = '\n'.join([
                    f"  â€¢ {p.product_id.name} - {p.price:,.0f} {p.currency_id.symbol}"
                    for p in self.selected_product_ids
                ])
                
                confirm_msg = f"""âœ… Báº¡n Ä‘Ã£ chá»n:

{product_list}

ğŸ’° Tá»•ng tiá»n: {total:,.0f} {self.selected_product_ids[0].currency_id.symbol}

ğŸ“‹ ThÃ´ng tin cá»§a báº¡n:
ğŸ‘¤ TÃªn: {self.customer_name}
ğŸ“ SÄT: {self.customer_phone}

Báº¡n cÃ³ muá»‘n xÃ¡c nháº­n Ä‘Æ¡n hÃ ng khÃ´ng?
Tráº£ lá»i "CÃ³" Ä‘á»ƒ xÃ¡c nháº­n, hoáº·c "KhÃ´ng" Ä‘á»ƒ há»§y."""
                
                return {
                    'text': confirm_msg,
                    'quick_replies': [
                        {'content_type': 'text', 'title': 'âœ… CÃ³', 'payload': 'CONFIRM_YES'},
                        {'content_type': 'text', 'title': 'âŒ KhÃ´ng', 'payload': 'CONFIRM_NO'},
                    ]
                }
                
            except ValueError:
                pass
        
        # If not valid product selection, ask again
        return {
            'text': 'Vui lÃ²ng chá»n má»™t sáº£n pháº©m tá»« danh sÃ¡ch bÃªn trÃªn.'
        }
    
    def _chatbot_create_order(self, user_message):
        """State 5: Táº¡o Ä‘Æ¡n hÃ ng hoáº·c há»§y"""
        if user_message == 'CONFIRM_YES' or user_message.lower() in ['cÃ³', 'yes', 'ok', 'Ä‘á»“ng Ã½']:
            # Create messenger order
            order_vals = {
                'conversation_id': self.id,
                'facebook_user_id': self.facebook_user_id,
                'customer_name': self.customer_name,
                'customer_phone': self.customer_phone,
                'product_ids': [(6, 0, self.selected_product_ids.ids)],
                'company_id': self.company_id.id,
                'state': 'confirmed',
            }
            
            order = self.env['social.messenger.order'].create(order_vals)
            self.messenger_order_id = order.id
            
            # Create sale.order
            try:
                sale_order = order.create_sale_order()
                
                self.chatbot_state = 'completed'
                
                return {
                    'text': f"""ğŸ‰ Äáº·t hÃ ng thÃ nh cÃ´ng!

MÃ£ Ä‘Æ¡n hÃ ng: {order.name}
MÃ£ Ä‘Æ¡n bÃ¡n hÃ ng: {sale_order.name}

ChÃºng tÃ´i sáº½ liÃªn há»‡ vá»›i báº¡n trong thá»i gian sá»›m nháº¥t Ä‘á»ƒ xÃ¡c nháº­n vÃ  giao hÃ ng.

Cáº£m Æ¡n báº¡n Ä‘Ã£ tin tÆ°á»Ÿng! ğŸ™"""
                }
            
            except Exception as e:
                _logger.error(f'Failed to create sale order: {e}')
                return {
                    'text': f'ÄÃ£ cÃ³ lá»—i xáº£y ra khi táº¡o Ä‘Æ¡n hÃ ng. Vui lÃ²ng liÃªn há»‡ vá»›i chÃºng tÃ´i qua hotline. Xin lá»—i vÃ¬ sá»± báº¥t tiá»‡n nÃ y! ğŸ˜”'
                }
        
        else:
            # Cancel order
            self.chatbot_state = 'idle'
            self.customer_name = False
            self.customer_phone = False
            self.selected_product_ids = [(5, 0, 0)]
            
            return {
                'text': 'ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c há»§y. Náº¿u báº¡n cáº§n há»— trá»£, vui lÃ²ng gá»­i tin nháº¯n báº¥t ká»³! ğŸ˜Š'
            }
    
    def send_chatbot_message(self, message_data):
        """
        Gá»­i tin nháº¯n chatbot qua Messenger.
        
        Args:
            message_data (dict): Message structure
                {
                    'text': 'Message text',
                    'quick_replies': [...]  (optional)
                }
        """
        self.ensure_one()
        
        if not message_data:
            return
        
        try:
            from odoo.addons.module_social_facebook.lib import facebook_api
            
            account = self.account_id
            if not account or not account.access_token:
                _logger.error(f'No access token for conversation {self.id}')
                return
            
            api = facebook_api.FacebookAPI(account.access_token)
            
            # Build message
            message = {'text': message_data['text']}
            
            if 'quick_replies' in message_data:
                message['quick_replies'] = message_data['quick_replies']
            
            # Send
            api.send_message(
                recipient_id=self.facebook_user_id,
                message=message
            )
            
            _logger.info(f'Sent chatbot message to {self.facebook_user_id}')
            
        except Exception as e:
            _logger.error(f'Failed to send chatbot message: {e}')
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CRM LEAD CREATION
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    def create_lead_from_conversation(self):
        """
        Táº¡o crm.lead tá»« conversation.
        
        Returns:
            crm.lead: Lead record
        """
        self.ensure_one()
        
        if self.lead_id:
            _logger.warning(f'Lead already exists for conversation {self.id}')
            return self.lead_id
        
        # Check auto_create_lead setting
        auto_create = self.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.auto_create_lead', 'False'
        )
        if auto_create != 'True':
            return None
        
        # Build lead vals
        lead_vals = {
            'name': f'Facebook Lead: {self.customer_name or self.facebook_user_id}',
            'type': 'lead',
            'source_id': self._get_facebook_source(),
            'description': self._build_lead_description(),
            'company_id': self.company_id.id,
        }
        
        # Add contact info if available
        if self.customer_name:
            lead_vals['contact_name'] = self.customer_name
        if self.customer_phone:
            lead_vals['phone'] = self.customer_phone
        
        # Create lead
        lead = self.env['crm.lead'].create(lead_vals)
        self.lead_id = lead.id
        
        _logger.info(f'Created lead {lead.id} from conversation {self.id}')
        
        # Log activity
        lead.message_post(
            body=_('Lead created from Facebook Messenger conversation'),
            subject=_('Facebook Lead'),
        )
        
        return lead
    
    def _get_facebook_source(self):
        """Get or create 'Facebook' source"""
        Source = self.env['utm.source']
        source = Source.search([('name', '=', 'Facebook')], limit=1)
        if not source:
            source = Source.create({'name': 'Facebook'})
        return source.id
    
    def _build_lead_description(self):
        """Build description from conversation messages"""
        messages = self.env['social.message'].search([
            ('conversation_id', '=', self.id)
        ], order='created_date asc', limit=10)
        
        desc = "Conversation from Facebook Messenger:\n\n"
        for msg in messages:
            sender = 'Customer' if msg.is_from_customer else 'Page'
            desc += f"[{sender}] {msg.message}\n"
        
        return desc



################################################################################
## FILE 22: social_messenger_order.py
## ÄÆ°á»ng dáº«n: models/social_messenger_order.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _
from odoo.exceptions import UserError, ValidationError
import logging

_logger = logging.getLogger(__name__)


class SocialMessengerOrder(models.Model):
    """
    ÄÆ¡n hÃ ng Ä‘Æ°á»£c táº¡o tá»« Facebook Messenger.
    Link vá»›i sale.order vÃ  social.conversation.
    """
    _name = 'social.messenger.order'
    _description = 'Messenger Sales Order'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _order = 'order_date desc, id desc'
    _rec_name = 'name'

    # Basic Info
    name = fields.Char(
        string='Order Reference',
        required=True,
        copy=False,
        readonly=True,
        default=lambda self: _('New'),
    )
    sale_order_id = fields.Many2one(
        'sale.order',
        string='Sale Order',
        ondelete='cascade',
        tracking=True,
    )
    conversation_id = fields.Many2one(
        'social.message',  # Link tá»›i conversation
        string='Conversation',
        ondelete='set null',
        help='Cuá»™c há»™i thoáº¡i Messenger táº¡o ra Ä‘Æ¡n hÃ ng nÃ y',
    )
    
    # Customer Info
    partner_id = fields.Many2one(
        'res.partner',
        string='Customer',
        related='sale_order_id.partner_id',
        store=True,
        readonly=True,
    )
    facebook_user_id = fields.Char(
        string='Facebook User ID',
        help='PSID cá»§a khÃ¡ch hÃ ng',
        tracking=True,
    )
    customer_name = fields.Char(
        string='Customer Name',
        required=True,
        tracking=True,
    )
    customer_phone = fields.Char(
        string='Phone',
        required=True,
        tracking=True,
    )
    customer_email = fields.Char(
        string='Email',
        tracking=True,
    )
    
    # Order Details
    state = fields.Selection([
        ('draft', 'Draft'),
        ('confirmed', 'Confirmed'),
        ('sale', 'Sale Order'),
        ('cancelled', 'Cancelled'),
    ], string='Status', default='draft', required=True, tracking=True)
    
    order_date = fields.Datetime(
        string='Order Date',
        default=fields.Datetime.now,
        required=True,
        tracking=True,
    )
    
    # Products
    product_ids = fields.Many2many(
        'social.messenger.product',
        string='Products',
        help='Sáº£n pháº©m khÃ¡ch hÃ ng Ä‘Ã£ chá»n',
    )
    
    # Pricing
    total_amount = fields.Monetary(
        string='Total',
        compute='_compute_total_amount',
        store=True,
        currency_field='currency_id',
    )
    currency_id = fields.Many2one(
        'res.currency',
        string='Currency',
        default=lambda self: self.env.company.currency_id,
    )
    
    # Organization
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        required=True,
        default=lambda self: self.env.company,
    )
    user_id = fields.Many2one(
        'res.users',
        string='Salesperson',
        default=lambda self: self.env.user,
        tracking=True,
    )
    
    # Notes
    notes = fields.Text(
        string='Internal Notes',
    )
    
    @api.model
    def create(self, vals):
        """Override create Ä‘á»ƒ táº¡o sequence"""
        if vals.get('name', _('New')) == _('New'):
            vals['name'] = self.env['ir.sequence'].next_by_code(
                'social.messenger.order'
            ) or _('New')
        return super().create(vals)
    
    @api.depends('sale_order_id', 'sale_order_id.amount_total')
    def _compute_total_amount(self):
        """TÃ­nh tá»•ng tiá»n tá»« sale.order hoáº·c products"""
        for record in self:
            if record.sale_order_id:
                record.total_amount = record.sale_order_id.amount_total
            else:
                # TÃ­nh tá»•ng tá»« products
                total = sum(record.product_ids.mapped('price'))
                record.total_amount = total
    
    # -------------------------------------------------------------------------
    # BUSINESS METHODS
    # -------------------------------------------------------------------------
    
    def create_sale_order(self):
        """
        Táº¡o sale.order tá»« messenger order.
        
        Flow:
        1. TÃ¬m hoáº·c táº¡o res.partner
        2. Táº¡o sale.order
        3. ThÃªm order lines tá»« products
        4. Link sale_order_id
        5. Chuyá»ƒn state â†’ 'sale'
        """
        self.ensure_one()
        
        if self.sale_order_id:
            raise UserError(_('Sale Order already exists for this Messenger Order!'))
        
        if not self.product_ids:
            raise UserError(_('Please select at least one product!'))
        
        # 1. Find or create partner
        partner = self._find_or_create_partner()
        
        # 2. Create sale.order
        sale_vals = {
            'partner_id': partner.id,
            'user_id': self.user_id.id,
            'company_id': self.company_id.id,
            'date_order': self.order_date,
            'origin': f'Messenger: {self.name}',
            'note': self.notes or f'Order from Facebook Messenger\nFacebook User: {self.facebook_user_id}',
        }
        
        sale_order = self.env['sale.order'].create(sale_vals)
        
        # 3. Add order lines
        for product in self.product_ids:
            line_vals = {
                'order_id': sale_order.id,
                'product_id': product.product_id.id,
                'product_uom_qty': 1,  # Default quantity
                'price_unit': product.price,
            }
            self.env['sale.order.line'].create(line_vals)
        
        # 4. Link sale order
        self.sale_order_id = sale_order.id
        self.state = 'sale'
        
        # 5. Send confirmation message
        self.send_order_confirmation()
        
        # 6. Log activity
        self.message_post(
            body=_('Sale Order %s created from Messenger') % sale_order.name,
            subject=_('Sale Order Created'),
        )
        
        return sale_order
    
    def _find_or_create_partner(self):
        """
        TÃ¬m hoáº·c táº¡o res.partner tá»« thÃ´ng tin khÃ¡ch hÃ ng.
        
        Logic:
        - TÃ¬m theo facebook_user_id (custom field)
        - Náº¿u khÃ´ng cÃ³, tÃ¬m theo phone
        - Náº¿u khÃ´ng cÃ³, táº¡o má»›i
        
        Returns:
            res.partner: Partner record
        """
        Partner = self.env['res.partner']
        
        # Check if partner has facebook_user_id field (custom field)
        if 'facebook_user_id' in Partner._fields:
            partner = Partner.search([
                ('facebook_user_id', '=', self.facebook_user_id),
                ('company_id', 'in', [False, self.company_id.id]),
            ], limit=1)
            if partner:
                return partner
        
        # Search by phone
        if self.customer_phone:
            partner = Partner.search([
                ('phone', '=', self.customer_phone),
                ('company_id', 'in', [False, self.company_id.id]),
            ], limit=1)
            if partner:
                # Update facebook_user_id if field exists
                if 'facebook_user_id' in Partner._fields and not partner.facebook_user_id:
                    partner.facebook_user_id = self.facebook_user_id
                return partner
        
        # Create new partner
        partner_vals = {
            'name': self.customer_name,
            'phone': self.customer_phone,
            'email': self.customer_email,
            'company_id': self.company_id.id,
            'comment': f'Created from Facebook Messenger Order: {self.name}',
        }
        
        # Add facebook_user_id if field exists
        if 'facebook_user_id' in Partner._fields:
            partner_vals['facebook_user_id'] = self.facebook_user_id
        
        partner = Partner.create(partner_vals)
        
        _logger.info(f'Created new partner {partner.id} for Messenger Order {self.name}')
        
        return partner
    
    def send_order_confirmation(self):
        """
        Gá»­i tin nháº¯n xÃ¡c nháº­n Ä‘Æ¡n hÃ ng qua Messenger.
        
        Message format:
        âœ… ÄÆ¡n hÃ ng #{name} Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n!
        ğŸ“¦ Sáº£n pháº©m: [Product List]
        ğŸ’° Tá»•ng tiá»n: {total}
        ğŸ“ ChÃºng tÃ´i sáº½ liÃªn há»‡ báº¡n sá»›m!
        """
        self.ensure_one()
        
        if not self.conversation_id:
            _logger.warning(f'No conversation found for order {self.name}')
            return
        
        # Build message
        product_list = '\n'.join([
            f"  â€¢ {p.product_id.name} - {p.price:,.0f} {p.currency_id.symbol}"
            for p in self.product_ids
        ])
        
        message = f"""âœ… ÄÆ¡n hÃ ng #{self.name} Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n!

ğŸ“¦ Sáº£n pháº©m:
{product_list}

ğŸ’° Tá»•ng tiá»n: {self.total_amount:,.0f} {self.currency_id.symbol}

ğŸ“ ChÃºng tÃ´i sáº½ liÃªn há»‡ vá»›i báº¡n trong thá»i gian sá»›m nháº¥t!
Cáº£m Æ¡n báº¡n Ä‘Ã£ mua hÃ ng."""
        
        # Send via Messenger API
        try:
            # Get Facebook API wrapper
            from odoo.addons.module_social_facebook.lib import facebook_api
            
            # Get page access token from conversation's account
            account = self.conversation_id.account_id
            if not account or not account.access_token:
                _logger.error(f'No access token found for conversation {self.conversation_id.id}')
                return
            
            api = facebook_api.FacebookAPI(account.access_token)
            
            # Send message
            api.send_message(
                recipient_id=self.facebook_user_id,
                message={'text': message}
            )
            
            _logger.info(f'Sent order confirmation for {self.name} to {self.facebook_user_id}')
            
            # Log to chatter
            self.message_post(
                body=_('Order confirmation sent via Messenger'),
                subject=_('Confirmation Sent'),
            )
            
        except Exception as e:
            _logger.error(f'Failed to send confirmation for order {self.name}: {e}')
            self.message_post(
                body=_('Failed to send confirmation: %s') % str(e),
                subject=_('Error'),
            )
    
    # -------------------------------------------------------------------------
    # ACTIONS
    # -------------------------------------------------------------------------
    
    def action_confirm(self):
        """XÃ¡c nháº­n Ä‘Æ¡n hÃ ng"""
        for record in self:
            if record.state != 'draft':
                raise UserError(_('Only draft orders can be confirmed!'))
            record.state = 'confirmed'
            record.message_post(body=_('Order confirmed'))
    
    def action_create_sale_order(self):
        """Button action: Táº¡o sale.order"""
        self.ensure_one()
        sale_order = self.create_sale_order()
        
        return {
            'type': 'ir.actions.act_window',
            'name': _('Sale Order'),
            'res_model': 'sale.order',
            'res_id': sale_order.id,
            'view_mode': 'form',
            'target': 'current',
        }
    
    def action_view_sale_order(self):
        """Xem sale.order"""
        self.ensure_one()
        if not self.sale_order_id:
            raise UserError(_('No Sale Order linked yet!'))
        
        return {
            'type': 'ir.actions.act_window',
            'name': _('Sale Order'),
            'res_model': 'sale.order',
            'res_id': self.sale_order_id.id,
            'view_mode': 'form',
            'target': 'current',
        }
    
    def action_cancel(self):
        """Há»§y Ä‘Æ¡n hÃ ng"""
        for record in self:
            record.state = 'cancelled'
            record.message_post(body=_('Order cancelled'))


# -------------------------------------------------------------------------
# EXTEND res.partner (OPTIONAL)
# -------------------------------------------------------------------------
# ThÃªm field facebook_user_id vÃ o res.partner Ä‘á»ƒ tracking

class ResPartner(models.Model):
    _inherit = 'res.partner'
    
    facebook_user_id = fields.Char(
        string='Facebook User ID (PSID)',
        help='Facebook Page-Scoped User ID',
    )
    messenger_order_count = fields.Integer(
        string='Messenger Orders',
        compute='_compute_messenger_order_count',
    )
    
    def _compute_messenger_order_count(self):
        """Äáº¿m sá»‘ Ä‘Æ¡n hÃ ng Messenger"""
        for partner in self:
            partner.messenger_order_count = self.env['social.messenger.order'].search_count([
                ('partner_id', '=', partner.id)
            ])
    
    def action_view_messenger_orders(self):
        """Xem Ä‘Æ¡n hÃ ng Messenger"""
        self.ensure_one()
        return {
            'name': _('Messenger Orders'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.messenger.order',
            'view_mode': 'tree,form',
            'domain': [('partner_id', '=', self.id)],
        }



################################################################################
## FILE 23: social_messenger_product.py
## ÄÆ°á»ng dáº«n: models/social_messenger_product.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _
from odoo.exceptions import ValidationError
import logging

_logger = logging.getLogger(__name__)


class SocialMessengerProduct(models.Model):
    """
    Sáº£n pháº©m Ä‘Æ°á»£c bÃ¡n qua Facebook Messenger.
    Chá»‰ cÃ¡c sáº£n pháº©m Ä‘Æ°á»£c tick 'active' má»›i hiá»ƒn thá»‹ trong chatbot.
    """
    _name = 'social.messenger.product'
    _description = 'Messenger Product Catalog'
    _order = 'sequence, id'
    _rec_name = 'display_name'

    # Basic Info
    product_id = fields.Many2one(
        'product.product',
        string='Product',
        required=True,
        ondelete='cascade',
        domain=[('sale_ok', '=', True)],
    )
    display_name = fields.Char(
        string='Display Name',
        compute='_compute_display_name',
        store=True,
    )
    active = fields.Boolean(
        string='Sell on Messenger',
        default=True,
        help='Báº­t Ä‘á»ƒ sáº£n pháº©m xuáº¥t hiá»‡n trong chatbot Messenger'
    )
    
    # Messenger Customization
    quick_reply_title = fields.Char(
        string='Quick Reply Title',
        size=20,
        help='TiÃªu Ä‘á» hiá»ƒn thá»‹ trong quick reply button (max 20 kÃ½ tá»±)',
        compute='_compute_quick_reply_title',
        store=True,
        readonly=False,
    )
    description = fields.Text(
        string='Messenger Description',
        help='MÃ´ táº£ gá»­i cho khÃ¡ch hÃ ng qua Messenger',
        compute='_compute_description',
        store=True,
        readonly=False,
    )
    image_url = fields.Char(
        string='Image URL',
        compute='_compute_image_url',
        help='URL hÃ¬nh áº£nh gá»­i trong Messenger (tá»« product.image_1920)'
    )
    
    # Pricing
    price = fields.Float(
        string='Price',
        related='product_id.list_price',
        readonly=True,
    )
    currency_id = fields.Many2one(
        'res.currency',
        related='product_id.currency_id',
        readonly=True,
    )
    
    # Organization
    sequence = fields.Integer(
        string='Sequence',
        default=10,
        help='Thá»© tá»± hiá»ƒn thá»‹ trong danh sÃ¡ch sáº£n pháº©m'
    )
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        default=lambda self: self.env.company,
        required=True,
    )
    
    # Statistics
    order_count = fields.Integer(
        string='Orders',
        compute='_compute_order_count',
    )
    
    _sql_constraints = [
        ('product_company_uniq', 
         'UNIQUE(product_id, company_id)', 
         'Product already exists in Messenger catalog for this company!'),
    ]
    
    @api.depends('product_id', 'product_id.name')
    def _compute_display_name(self):
        """TÃªn hiá»ƒn thá»‹ = tÃªn sáº£n pháº©m"""
        for record in self:
            record.display_name = record.product_id.name if record.product_id else ''
    
    @api.depends('product_id', 'product_id.name')
    def _compute_quick_reply_title(self):
        """Auto-fill quick reply title tá»« tÃªn sáº£n pháº©m (max 20 chars)"""
        for record in self:
            if record.product_id and not record.quick_reply_title:
                name = record.product_id.name
                record.quick_reply_title = name[:20] if len(name) > 20 else name
    
    @api.depends('product_id', 'product_id.description_sale')
    def _compute_description(self):
        """Auto-fill description tá»« product"""
        for record in self:
            if record.product_id and not record.description:
                desc = record.product_id.description_sale or record.product_id.name
                record.description = desc
    
    @api.depends('product_id', 'product_id.image_1920')
    def _compute_image_url(self):
        """Generate public URL cho hÃ¬nh áº£nh"""
        for record in self:
            if record.product_id and record.product_id.image_1920:
                base_url = self.env['ir.config_parameter'].sudo().get_param('web.base.url')
                record.image_url = f"{base_url}/web/image/product.product/{record.product_id.id}/image_1920"
            else:
                record.image_url = False
    
    def _compute_order_count(self):
        """Äáº¿m sá»‘ Ä‘Æ¡n hÃ ng tá»« sáº£n pháº©m nÃ y"""
        for record in self:
            # Count sale.order.line cÃ³ product nÃ y tá»« messenger orders
            orders = self.env['social.messenger.order'].search([
                ('sale_order_id.order_line.product_id', '=', record.product_id.id),
                ('company_id', '=', record.company_id.id),
            ])
            record.order_count = len(orders)
    
    @api.constrains('quick_reply_title')
    def _check_quick_reply_title(self):
        """Validate quick reply title length"""
        for record in self:
            if record.quick_reply_title and len(record.quick_reply_title) > 20:
                raise ValidationError(
                    _('Quick Reply Title cannot exceed 20 characters!')
                )
    
    # -------------------------------------------------------------------------
    # BUSINESS METHODS
    # -------------------------------------------------------------------------
    
    @api.model
    def get_active_products(self, company_id=None):
        """
        Láº¥y danh sÃ¡ch sáº£n pháº©m Ä‘ang active cho Messenger.
        
        Returns:
            recordset: social.messenger.product records
        """
        domain = [('active', '=', True)]
        if company_id:
            domain.append(('company_id', '=', company_id))
        else:
            domain.append(('company_id', '=', self.env.company.id))
        
        return self.search(domain, order='sequence, id')
    
    def format_for_messenger(self):
        """
        Format sáº£n pháº©m thÃ nh quick reply buttons cho Messenger.
        
        Returns:
            list: Danh sÃ¡ch quick reply buttons
            [
                {
                    'content_type': 'text',
                    'title': 'Product Name',
                    'payload': 'PRODUCT_123',
                },
                ...
            ]
        """
        self.ensure_one()
        return {
            'content_type': 'text',
            'title': self.quick_reply_title or self.product_id.name[:20],
            'payload': f'PRODUCT_{self.id}',
        }
    
    def get_product_message(self):
        """
        Táº¡o tin nháº¯n giá»›i thiá»‡u sáº£n pháº©m.
        
        Returns:
            str: Message text
        """
        self.ensure_one()
        price_formatted = f"{self.price:,.0f} {self.currency_id.symbol}"
        message = f"ğŸ›ï¸ {self.product_id.name}\n"
        message += f"ğŸ’° GiÃ¡: {price_formatted}\n"
        if self.description:
            message += f"ğŸ“ {self.description}\n"
        return message
    
    # -------------------------------------------------------------------------
    # ACTIONS
    # -------------------------------------------------------------------------
    
    def action_view_orders(self):
        """Xem cÃ¡c Ä‘Æ¡n hÃ ng tá»« sáº£n pháº©m nÃ y"""
        self.ensure_one()
        return {
            'name': _('Messenger Orders'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.messenger.order',
            'view_mode': 'tree,form',
            'domain': [
                ('sale_order_id.order_line.product_id', '=', self.product_id.id),
                ('company_id', '=', self.company_id.id),
            ],
            'context': {'default_product_id': self.product_id.id},
        }
    
    def action_toggle_active(self):
        """Toggle active state"""
        for record in self:
            record.active = not record.active



################################################################################
## FILE 24: social_post.py
## ÄÆ°á»ng dáº«n: models/social_post.py
################################################################################

# FILE: social_post_fixed.py
# PhiÃªn báº£n sá»­a lá»—i khÃ´ng thá»ƒ Ä‘Äƒng áº£nh

from odoo import models, fields, api, _
from odoo.exceptions import UserError
import requests
import logging
from datetime import datetime
import base64  # âœ… THÃŠM IMPORT


_logger = logging.getLogger(__name__)


class SocialPost(models.Model):
    """
    Model quáº£n lÃ½ bÃ i Ä‘Äƒng Facebook.
    """
    _name = 'social.post'
    _description = 'Facebook Post'
    _order = 'create_date desc'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _rec_name = 'display_name'

    # -------------------------------------------------------------------------
    # BASIC INFO
    # -------------------------------------------------------------------------
    display_name = fields.Char(
        string='Display Name',
        compute='_compute_display_name',
        store=True,
    )
    
    account_id = fields.Many2one(
        'social.account',
        string='Facebook Page',
        required=True,
        domain=[('platform', '=', 'facebook')],
    )
    
    content = fields.Text(
        string='Content',
        required=True,
        tracking=True,
    )
    
    # -------------------------------------------------------------------------
    # MEDIA
    # -------------------------------------------------------------------------
    media_type = fields.Selection([
        ('text', 'Text Only'),
        ('photo', 'Photo'),
        ('video', 'Video'),
        ('link', 'Link'),
    ], string='Media Type', default='text')
    
    image = fields.Binary(string='Image', attachment=True)
    image_filename = fields.Char(string='Image Filename')
    video_url = fields.Char(string='Video URL')
    link_url = fields.Char(string='Link URL')
    
    # -------------------------------------------------------------------------
    # SCHEDULING
    # -------------------------------------------------------------------------
    post_type = fields.Selection([
        ('now', 'Publish Now'),
        ('scheduled', 'Scheduled'),
    ], string='Post Type', default='now', required=True)
    
    scheduled_date = fields.Datetime(
        string='Scheduled Date',
        tracking=True,
    )
    
    # -------------------------------------------------------------------------
    # FACEBOOK DATA
    # -------------------------------------------------------------------------
    facebook_post_id = fields.Char(
        string='Facebook Post ID',
        readonly=True,
        copy=False,
    )
    
    facebook_post_url = fields.Char(
        string='Facebook URL',
        compute='_compute_facebook_url',
        store=True,
    )
    
    published_date = fields.Datetime(
        string='Published Date',
        readonly=True,
        copy=False,
    )
    
    # -------------------------------------------------------------------------
    # STATUS
    # -------------------------------------------------------------------------
    state = fields.Selection([
        ('draft', 'Draft'),
        ('scheduled', 'Scheduled'),
        ('published', 'Published'),
        ('failed', 'Failed'),
    ], string='Status', default='draft', tracking=True)
    
    error_message = fields.Text(string='Error Message')
    
    # -------------------------------------------------------------------------
    # ENGAGEMENT STATS
    # -------------------------------------------------------------------------
    likes_count = fields.Integer(string='Likes', default=0)
    comments_count = fields.Integer(string='Comments', default=0)
    shares_count = fields.Integer(string='Shares', default=0)
    reach = fields.Integer(string='Reach', default=0)
    impressions = fields.Integer(string='Impressions', default=0)
    engagement_rate = fields.Float(
        string='Engagement Rate (%)',
        compute='_compute_engagement_rate',
        store=True,
    )
    
    # -------------------------------------------------------------------------
    # RELATIONS
    # -------------------------------------------------------------------------
    comment_ids = fields.One2many(
        'social.comment',
        'post_id',
        string='Comments',
    )
    
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        related='account_id.company_id',
        store=True,
    )
    
    user_id = fields.Many2one(
        'res.users',
        string='Created By',
        default=lambda self: self.env.user,
    )
    
    # -------------------------------------------------------------------------
    # COMPUTE METHODS
    # -------------------------------------------------------------------------
    @api.depends('content', 'account_id')
    def _compute_display_name(self):
        for post in self:
            if post.content:
                preview = post.content[:50] + '...' if len(post.content) > 50 else post.content
                post.display_name = f"{post.account_id.name}: {preview}"
            else:
                post.display_name = f"Post #{post.id}"
    
    @api.depends('facebook_post_id', 'account_id')
    def _compute_facebook_url(self):
        for post in self:
            if post.facebook_post_id and post.account_id:
                post.facebook_post_url = f"https://www.facebook.com/{post.facebook_post_id}"
            else:
                post.facebook_post_url = False
    
    @api.depends('likes_count', 'comments_count', 'shares_count', 'reach')
    def _compute_engagement_rate(self):
        for post in self:
            if post.reach > 0:
                total_engagement = post.likes_count + post.comments_count + post.shares_count
                post.engagement_rate = (total_engagement / post.reach) * 100
            else:
                post.engagement_rate = 0
    
    # -------------------------------------------------------------------------
    # BUSINESS METHODS
    # -------------------------------------------------------------------------
    
    def _prepare_facebook_post_data(self):
        """
        âœ… HÃ m má»›i: Chuáº©n bá»‹ dá»¯ liá»‡u post theo media_type
        
        Return: (url, data_dict, files_dict)
        """
        base_url = f'https://graph.facebook.com/v18.0/{self.account_id.facebook_page_id}'
        
        # Dá»¯ liá»‡u cÆ¡ báº£n
        data = {
            'access_token': self.account_id.access_token,
            'message': self.content,
        }
        
        files = None
        
        # Xá»­ lÃ½ dá»±a trÃªn media_type
        if self.media_type == 'photo':
            if not self.image:
                raise UserError(_('Please upload an image for photo post!'))
            
            # Decode base64 image
            image_binary = base64.b64decode(self.image)
            filename = self.image_filename or 'image.jpg'
            files = {'source': (filename, image_binary)}
            url = f'{base_url}/photos'
            
        elif self.media_type == 'video':
            if not self.video_url:
                raise UserError(_('Please provide a video URL!'))
            
            data['video_url'] = self.video_url
            url = f'{base_url}/feed'
            
        elif self.media_type == 'link':
            if not self.link_url:
                raise UserError(_('Please provide a link URL!'))
            
            data['link'] = self.link_url
            url = f'{base_url}/feed'
            
        else:  # text only
            url = f'{base_url}/feed'
        
        return url, data, files
    
    def action_publish_now(self):
        """âœ… Sá»¬A: ÄÄƒng bÃ i ngay láº­p tá»©c - Há»– TRá»¢ IMAGE"""
        self.ensure_one()
        
        if self.state != 'draft':
            raise UserError(_('Only draft posts can be published!'))
        
        try:
            # âœ… Cáº¦U DIá»†N Äáº¦U TIÃŠN: Chuáº©n bá»‹ dá»¯ liá»‡u
            url, data, files = self._prepare_facebook_post_data()
            
            # âœ… THAY Äá»”I: Gá»­i request vá»›i files náº¿u cÃ³ image
            if files:
                # Vá»›i image: dÃ¹ng multipart/form-data
                response = requests.post(url, data=data, files=files, timeout=30)
            else:
                # Chá»‰ text: dÃ¹ng form-urlencoded thÆ°á»ng
                response = requests.post(url, data=data, timeout=30)
            
            # Xá»­ lÃ½ response
            if response.status_code == 200:
                result = response.json()
                self.write({
                    'facebook_post_id': result.get('id'),
                    'published_date': fields.Datetime.now(),
                    'state': 'published',
                    'error_message': False,
                })
                
                self.message_post(body=_('Post published successfully!'))
                
                return {
                    'type': 'ir.actions.client',
                    'tag': 'display_notification',
                    'params': {
                        'title': _('Success'),
                        'message': _('Post published to Facebook!'),
                        'type': 'success',
                        'sticky': False,
                    }
                }
            else:
                # âœ… THÃŠM: Error handling tá»‘t hÆ¡n
                try:
                    error_detail = response.json().get('error', {})
                    error_msg = error_detail.get('message', response.text)
                except:
                    error_msg = response.text
                
                raise UserError(_('Failed to publish: %s') % error_msg)
                
        except Exception as e:
            error_str = str(e)
            self.write({
                'state': 'failed',
                'error_message': error_str,
            })
            _logger.error(f'Error publishing post {self.id}: {error_str}')
            raise UserError(_('Error publishing post: %s') % error_str)
    
    def action_schedule_post(self):
        """LÃªn lá»‹ch Ä‘Äƒng bÃ i"""
        self.ensure_one()
        
        if not self.scheduled_date:
            raise UserError(_('Please set a scheduled date!'))
        
        if self.scheduled_date <= fields.Datetime.now():
            raise UserError(_('Scheduled date must be in the future!'))
        
        self.state = 'scheduled'
        self.message_post(body=_('Post scheduled for %s') % self.scheduled_date)
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Success'),
                'message': _('Post scheduled successfully!'),
                'type': 'success',
                'sticky': False,
            }
        }
    
    def action_sync_stats(self):
        """Äá»“ng bá»™ thá»‘ng kÃª tá»« Facebook"""
        self.ensure_one()
        
        if not self.facebook_post_id:
            return False
        
        try:
            url = f'https://graph.facebook.com/v18.0/{self.facebook_post_id}'
            params = {
                'access_token': self.account_id.access_token,
                'fields': 'likes.summary(true),comments.summary(true),shares'
            }
            
            response = requests.get(url, params=params, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                self.write({
                    'likes_count': data.get('likes', {}).get('summary', {}).get('total_count', 0),
                    'comments_count': data.get('comments', {}).get('summary', {}).get('total_count', 0),
                    'shares_count': data.get('shares', {}).get('count', 0),
                })
                return True
            else:
                _logger.error(f'Failed to sync stats: {response.text}')
                return False
                
        except Exception as e:
            _logger.error(f'Error syncing stats: {e}')
            return False
    
    def action_view_comments(self):
        """Xem comments"""
        self.ensure_one()
        return {
            'name': _('Comments'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.comment',
            'view_mode': 'list,form',
            'domain': [('post_id', '=', self.id)],
            'context': {'default_post_id': self.id},
        }
    
    @api.model
    def cron_publish_scheduled_posts(self):
        """Cron job Ä‘á»ƒ publish scheduled posts"""
        now = fields.Datetime.now()
        posts = self.search([
            ('state', '=', 'scheduled'),
            ('scheduled_date', '<=', now),
        ])
        
        for post in posts:
            try:
                post.action_publish_now()
            except Exception as e:
                _logger.error(f'Error publishing scheduled post {post.id}: {e}')
    
    @api.model
    def cron_sync_facebook_comments(self):
        """Cron job Ä‘á»ƒ sync comments"""
        posts = self.search([
            ('state', '=', 'published'),
            ('facebook_post_id', '!=', False),
        ], limit=50)
        
        for post in posts:
            try:
                post.action_sync_stats()
            except Exception as e:
                _logger.error(f'Error syncing post {post.id}: {e}')
                
    def action_sync_comments(self):
        """Äá»“ng bá»™ chi tiáº¿t tá»«ng comment tá»« Facebook vá» Odoo"""
        self.ensure_one()
        if not self.facebook_post_id:
            raise UserError(_('Post not published yet!'))
        
        try:
            # Gá»i Graph API láº¥y comments
            url = f'https://graph.facebook.com/v18.0/{self.facebook_post_id}/comments'
            params = {
                'access_token': self.account_id.access_token,
                'fields': 'id,message,from,created_time,parent',
                'limit': 100
            }
            
            response = requests.get(url, params=params, timeout=30)
            if response.status_code == 200:
                data = response.json()
                
                # Loop qua tá»«ng comment
                for fb_comment in data.get('data', []):
                    # Kiá»ƒm tra xem comment Ä‘Ã£ cÃ³ chÆ°a
                    existing = self.env['social.comment'].search([
                        ('facebook_comment_id', '=', fb_comment['id']),
                        ('post_id', '=', self.id)
                    ], limit=1)
                    
                    if not existing:
                        # Táº¡o má»›i comment record
                        author = fb_comment.get('from', {})
                        self.env['social.comment'].create({
                            'post_id': self.id,
                            'facebook_comment_id': fb_comment['id'],
                            'author_name': author.get('name', 'Unknown'),
                            'author_facebook_id': author.get('id', ''),
                            'message': fb_comment.get('message', ''),
                            'comment_date': fb_comment.get('created_time'),
                            'company_id': self.company_id.id,
                        })
                
                self.message_post(body=_('Comments synced from Facebook!'))
                return True
            else:
                raise UserError(_('Failed to sync comments: %s') % response.text)
                
        except Exception as e:
            raise UserError(_('Error syncing comments: %s') % str(e))




################################################################################
## FILE 25: social_post_template.py
## ÄÆ°á»ng dáº«n: models/social_post_template.py
################################################################################

from odoo import models, fields, api, _


class SocialPostTemplate(models.Model):
    """
    Model quáº£n lÃ½ templates cho bÃ i Ä‘Äƒng.
    """
    _name = 'social.post.template'
    _description = 'Social Post Template'
    _order = 'name'

    name = fields.Char(
        string='Template Name',
        required=True,
    )
    
    template_type = fields.Selection([
        ('product_launch', 'Product Launch'),
        ('promotion', 'Promotion'),
        ('testimonial', 'Testimonial'),
        ('educational', 'Educational'),
        ('engagement', 'Engagement'),
        ('event', 'Event'),
        ('custom', 'Custom'),
    ], string='Type', default='custom')
    
    content = fields.Text(
        string='Content Template',
        required=True,
        help='Use {{variable_name}} for dynamic content'
    )
    
    description = fields.Text(string='Description')
    
    active = fields.Boolean(string='Active', default=True)
    
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        default=lambda self: self.env.company,
    )
    
    def action_use_template(self):
        """Sá»­ dá»¥ng template Ä‘á»ƒ táº¡o post má»›i"""
        self.ensure_one()
        return {
            'name': _('New Post from Template'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.post',
            'view_mode': 'form',
            'context': {
                'default_content': self.content,
            },
        }



################################################################################
## FILE 26: ir.model.access.csv
## ÄÆ°á»ng dáº«n: security/ir.model.access.csv
################################################################################

id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink

access_social_account_manager,social.account.manager,model_social_account,group_social_manager,1,1,1,1
access_social_account_user,social.account.user,model_social_account,group_social_user,1,0,0,0

access_social_post_manager,social.post.manager,model_social_post,group_social_manager,1,1,1,1
access_social_post_user,social.post.user,model_social_post,group_social_user,1,1,1,0

access_social_post_template_manager,social.post.template.manager,model_social_post_template,group_social_manager,1,1,1,1
access_social_post_template_user,social.post.template.user,model_social_post_template,group_social_user,1,0,0,0

access_social_comment_manager,social.comment.manager,model_social_comment,group_social_manager,1,1,1,1
access_social_comment_user,social.comment.user,model_social_comment,group_social_user,1,0,0,0

access_social_message_manager,social.message.manager,model_social_message,group_social_manager,1,1,1,1
access_social_message_user,social.message.user,model_social_message,group_social_user,1,1,0,0

access_social_analytics_manager,social.analytics.manager,model_social_analytics,group_social_manager,1,1,1,1
access_social_analytics_user,social.analytics.user,model_social_analytics,group_social_user,1,0,0,0

access_social_messenger_product_manager,social.messenger.product.manager,model_social_messenger_product,group_social_manager,1,1,1,1
access_social_messenger_product_user,social.messenger.product.user,model_social_messenger_product,group_social_user,1,0,0,0

access_social_messenger_order_manager,social.messenger.order.manager,model_social_messenger_order,group_social_manager,1,1,1,1
access_social_messenger_order_user,social.messenger.order.user,model_social_messenger_order,group_social_user,1,1,0,0

access_social_bulk_schedule_wizard_manager,social.bulk.schedule.wizard.manager,model_social_bulk_schedule_wizard,group_social_manager,1,1,1,1
access_social_bulk_schedule_wizard_user,social.bulk.schedule.wizard.user,model_social_bulk_schedule_wizard,group_social_user,1,1,1,0

access_social_post_composer_wizard_manager,social.post.composer.wizard.manager,model_social_post_composer_wizard,group_social_manager,1,1,1,1
access_social_post_composer_wizard_user,social.post.composer.wizard.user,model_social_post_composer_wizard,group_social_user,1,1,1,0



################################################################################
## FILE 27: social_security.xml
## ÄÆ°á»ng dáº«n: security/social_security.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- USER GROUPS -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    
    <record id="group_social_user" model="res.groups">
        <field name="name">Social Media User</field>
        <field name="implied_ids" eval="[(4, ref('base.group_user'))]"/>
        <field name="comment">CÃ³ thá»ƒ xem vÃ  táº¡o bÃ i Ä‘Äƒng trÃªn Facebook</field>
    </record>

    <record id="group_social_manager" model="res.groups">
        <field name="name">Social Media Manager</field>
        <field name="implied_ids" eval="[(4, ref('group_social_user'))]"/>
        <field name="comment">CÃ³ thá»ƒ quáº£n lÃ½ táº¥t cáº£ cáº¥u hÃ¬nh vÃ  tÃ i khoáº£n Facebook</field>
    </record>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- RECORD RULES - Multi-company Access Control -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    
    <!-- Social Account Rules -->
    <record id="social_account_rule_user" model="ir.rule">
        <field name="name">Social Account: User Access</field>
        <field name="model_id" ref="model_social_account"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>

    <!-- Social Post Rules -->
    <record id="social_post_rule_user" model="ir.rule">
        <field name="name">Social Post: User Access</field>
        <field name="model_id" ref="model_social_post"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>

    <!-- Social Post Template Rules -->
    <record id="social_post_template_rule_user" model="ir.rule">
        <field name="name">Social Post Template: User Access</field>
        <field name="model_id" ref="model_social_post_template"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>

    <!-- Social Comment Rules -->
    <record id="social_comment_rule_user" model="ir.rule">
        <field name="name">Social Comment: User Access</field>
        <field name="model_id" ref="model_social_comment"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>
    
    <!-- Social Message Rules -->
    <record id="social_message_rule_user" model="ir.rule">
        <field name="name">Social Message: User Access</field>
        <field name="model_id" ref="model_social_message"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>
    
    <!-- Social Analytics Rules -->
    <record id="social_analytics_rule_user" model="ir.rule">
        <field name="name">Social Analytics: User Access</field>
        <field name="model_id" ref="model_social_analytics"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>
    
    <!-- Social Messenger Product Rules -->
    <record id="social_messenger_product_rule_user" model="ir.rule">
        <field name="name">Messenger Product: User Access</field>
        <field name="model_id" ref="model_social_messenger_product"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>
    
    <!-- Social Messenger Order Rules -->
    <record id="social_messenger_order_rule_user" model="ir.rule">
        <field name="name">Messenger Order: User Access</field>
        <field name="model_id" ref="model_social_messenger_order"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>

</odoo>



################################################################################
## FILE 28: icon.png
## ÄÆ°á»ng dáº«n: static/description/icon.png
################################################################################

[KhÃ´ng Ä‘á»c Ä‘Æ°á»£c file â€“ cÃ³ thá»ƒ lÃ  binary hoáº·c lá»—i mÃ£ hÃ³a]



################################################################################
## FILE 29: social_facebook.css
## ÄÆ°á»ng dáº«n: static/src/css/social_facebook.css
################################################################################

/*
 * CSS for Social Facebook Module
 */

.social_post_card {
    border-left: 4px solid #1877f2;
    transition: transform 0.2s;
}

.social_post_card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.facebook_badge {
    background-color: #1877f2;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

.engagement_stats {
    display: flex;
    gap: 1rem;
}

.engagement_stats .stat {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}



################################################################################
## FILE 30: social_conversation_list.js
## ÄÆ°á»ng dáº«n: static/src/js/social_conversation_list.js
################################################################################

/** @odoo-module **/

import { ListController } from "@web/views/list/list_controller";
import { listView } from "@web/views/list/list_view";
import { registry } from "@web/core/registry";
import { useService } from "@web/core/utils/hooks";

/**
 * Custom List Controller for Social Conversation
 * Adds "Sync All Conversations" button to the toolbar
 */
export class SocialConversationListController extends ListController {
    setup() {
        super.setup();
        this.orm = useService("orm");
        this.action = useService("action");
        this.notification = useService("notification");
    }

    /**
     * Handler for Sync All Conversations button
     */
    async onClickSyncConversations() {
        // Show loading notification
        this.notification.add("Äang Ä‘á»“ng bá»™ conversations tá»« Facebook...", {
            type: "info",
        });

        try {
            // Call the server method
            const result = await this.orm.call(
                "social.conversation",
                "action_sync_all_conversations",
                [[]]
            );

            // Reload the list view
            await this.model.load();

            // Show success notification
            if (result && result.params) {
                this.notification.add(result.params.message, {
                    type: result.params.type || "success",
                    sticky: result.params.sticky || false,
                });
            } else {
                this.notification.add("Äá»“ng bá»™ hoÃ n táº¥t!", {
                    type: "success",
                });
            }
        } catch (error) {
            console.error("Error syncing conversations:", error);
            this.notification.add("Lá»—i khi Ä‘á»“ng bá»™: " + (error.message || error), {
                type: "danger",
                sticky: true,
            });
        }
    }
}

// Define the template with the sync button
SocialConversationListController.template = "module_social_facebook.SocialConversationListView";

// Create custom list view for social.conversation
export const SocialConversationListView = {
    ...listView,
    Controller: SocialConversationListController,
    buttonTemplate: "module_social_facebook.SocialConversationListView.Buttons",
};

// Register the view
registry.category("views").add("social_conversation_list", SocialConversationListView);



################################################################################
## FILE 31: social_dashboard.js
## ÄÆ°á»ng dáº«n: static/src/js/social_dashboard.js
################################################################################

/** @odoo-module **/

console.log('Social Facebook Dashboard JS loaded');



################################################################################
## FILE 32: social_conversation_templates.xml
## ÄÆ°á»ng dáº«n: static/src/xml/social_conversation_templates.xml
################################################################################

<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <!-- Template for Sync button in list view toolbar -->
    <t t-name="module_social_facebook.SocialConversationListView.Buttons" t-inherit="web.ListView.Buttons">
        <xpath expr="//div[hasclass('o_list_buttons')]" position="inside">
            <button type="button" 
                    class="btn btn-primary o_sync_conversations_button ms-2"
                    t-on-click="() => this.onClickSyncConversations()">
                <i class="fa fa-refresh me-1"/>
                Sync Conversations
            </button>
        </xpath>
    </t>

    <!-- Alternative: Full button template -->
    <t t-name="module_social_facebook.SocialConversationListView">
        <t t-call="web.ListView"/>
    </t>

</templates>



################################################################################
## FILE 33: dashboard_views.xml
## ÄÆ°á»ng dáº«n: views/dashboard_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="action_social_dashboard" model="ir.actions.act_window">
        <field name="name">Social Media Dashboard</field>
        <field name="res_model">social.analytics</field>
        <field name="view_mode">pivot,graph,list</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">Welcome to Social Media Dashboard!</p>
        </field>
    </record>

</odoo>




################################################################################
## FILE 34: menu_views.xml
## ÄÆ°á»ng dáº«n: views/menu_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- ROOT MENU                                                             -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_marketing_root"
              name="Social"
              web_icon="module_social_facebook,static/description/icon.png"
              sequence="100"/>

    <!-- ===================================================================== -->
    <!-- DASHBOARD                                                             -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_dashboard"
              name="Dashboard"
              parent="menu_social_marketing_root"
              action="action_social_dashboard"
              sequence="1"/>

    <!-- ===================================================================== -->
    <!-- FACEBOOK PAGES                                                        -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_accounts"
              name="Facebook Pages"
              parent="menu_social_marketing_root"
              action="action_social_account"
              sequence="10"/>

    <!-- ===================================================================== -->
    <!-- POSTS                                                                 -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_posts"
              name="Posts"
              parent="menu_social_marketing_root"
              sequence="20"/>

    <menuitem id="menu_social_all_posts"
              name="All Posts"
              parent="menu_social_posts"
              action="action_social_post"
              sequence="10"/>

    <menuitem id="menu_social_post_calendar"
              name="Content Calendar"
              parent="menu_social_posts"
              action="action_social_post_calendar"
              sequence="15"/>

    <!-- ===================================================================== -->
    <!-- TEMPLATES                                                             -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_templates"
              name="Templates"
              parent="menu_social_marketing_root"
              action="action_social_post_template"
              sequence="30"/>

    <!-- ===================================================================== -->
    <!-- COMMENTS                                                              -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_comments"
              name="Comments"
              parent="menu_social_marketing_root"
              action="action_social_comment"
              sequence="40"/>

    <!-- ===================================================================== -->
    <!-- CONVERSATIONS                                                         -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_conversations"
              name="Conversations"
              parent="menu_social_marketing_root"
              action="action_social_message"
              sequence="50"/>

    <!-- ===================================================================== -->
    <!-- MESSENGER SALES                                                       -->
    <!-- ===================================================================== -->
    <menuitem id="menu_messenger_sales"
              name="Messenger Sales"
              parent="menu_social_marketing_root"
              sequence="60"/>

    <menuitem id="menu_messenger_products"
              name="Products"
              parent="menu_messenger_sales"
              action="action_social_messenger_product"
              sequence="10"/>

    <menuitem id="menu_messenger_orders"
              name="Orders"
              parent="menu_messenger_sales"
              action="action_social_messenger_order"
              sequence="20"/>

    <!-- ===================================================================== -->
    <!-- ANALYTICS                                                             -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_analytics"
              name="Analytics"
              parent="menu_social_marketing_root"
              action="action_social_analytics"
              sequence="70"/>

    <!-- ===================================================================== -->
    <!-- CONFIGURATION                                                         -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_configuration"
              name="Configuration"
              parent="menu_social_marketing_root"
              sequence="100"/>

    <!-- XÃ“A MENU SETTINGS VÃŒ ACTION KHÃ”NG Tá»’N Táº I -->
    <!-- <menuitem id="menu_social_settings"
              name="Settings"
              parent="menu_social_configuration"
              action="base.action_res_config_settings"
              sequence="10"/> -->

</odoo>



################################################################################
## FILE 35: res_config_settings_views.md
## ÄÆ°á»ng dáº«n: views/res_config_settings_views.md
################################################################################

<odoo>

    <record id="res_config_settings_view_form_social_facebook" model="ir.ui.view">
        <field name="name">res.config.settings.view.form.inherit.social.facebook</field>
        <field name="model">res.config.settings</field>
        <field name="inherit_id" ref="base.res_config_settings_view_form"/>
        <field name="arch" type="xml">
            <!-- FIX: Target vÃ o sheet thay vÃ¬ div[class='settings'] -->
            <xpath expr="//sheet" position="inside">
                
                <div class="app_settings_block" data_key="module_social_facebook" 
                     string="Facebook Integration">
                    <h2>Facebook Integration</h2>
                    
                    <!-- Webhook Configuration -->
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane"></div>
                            <div class="o_setting_right_pane">
                                <span class="o_form_label">Webhook Configuration</span>
                                <div class="text-muted">
                                    Configure your Facebook webhook settings
                                </div>
                                <div class="content-group mt16">
                                    <div class="row">
                                        <label for="facebook_verify_token" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="facebook_verify_token" 
                                               placeholder="e.g., 16112005"/>
                                    </div>
                                    <div class="row mt8">
                                        <label string="Webhook URL" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="facebook_webhook_url" readonly="1"/>
                                        <button name="action_copy_webhook_url" 
                                                type="object" 
                                                string="Copy URL" 
                                                class="btn-link ml8"
                                                icon="fa-copy"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ngrok Integration -->
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane"></div>
                            <div class="o_setting_right_pane">
                                <span class="o_form_label">Ngrok Integration</span>
                                <div class="text-muted">
                                    Manage ngrok tunnel for localhost development
                                </div>
                                <div class="content-group mt16">
                                    <div class="row">
                                        <label for="ngrok_executable_path" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="ngrok_executable_path" 
                                               placeholder="C:/ngrok/ngrok.exe"/>
                                    </div>
                                    <div class="row mt8">
                                        <label string="Ngrok Status" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="ngrok_is_running" readonly="1" 
                                               widget="boolean"/>
                                        <span class="ml8" 
                                              invisible="not ngrok_is_running">
                                            âœ… Running
                                        </span>
                                        <span class="ml8 text-muted" 
                                              invisible="ngrok_is_running">
                                            â›” Not Running
                                        </span>
                                    </div>
                                    <div class="row mt8" 
                                         invisible="not ngrok_tunnel_url">
                                        <label string="Public URL" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="ngrok_tunnel_url" readonly="1" 
                                               class="text-primary font-weight-bold"/>
                                    </div>
                                    <div class="row mt16">
                                        <div class="col-lg-3"></div>
                                        <div>
                                            <button name="action_start_ngrok" 
                                                    type="object" 
                                                    string="Start Ngrok" 
                                                    class="btn-primary"
                                                    icon="fa-play"
                                                    invisible="ngrok_is_running"/>
                                            <button name="action_stop_ngrok" 
                                                    type="object" 
                                                    string="Stop Ngrok" 
                                                    class="btn-secondary ml8"
                                                    icon="fa-stop"
                                                    invisible="not ngrok_is_running"/>
                                            <button name="action_refresh_ngrok_url" 
                                                    type="object" 
                                                    string="Refresh" 
                                                    class="btn-link ml8"
                                                    icon="fa-refresh"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CRM Integration -->
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane">
                                <field name="auto_create_lead"/>
                            </div>
                            <div class="o_setting_right_pane">
                                <label for="auto_create_lead"/>
                                <div class="text-muted">
                                    Automatically create CRM leads from Messenger conversations
                                </div>
                                <div class="content-group mt16" 
                                     invisible="not auto_create_lead">
                                    <div class="row">
                                        <label for="lead_default_user_id" 
                                               string="Default Salesperson" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="lead_default_user_id"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chatbot Configuration -->
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane">
                                <field name="chatbot_enabled"/>
                            </div>
                            <div class="o_setting_right_pane">
                                <label for="chatbot_enabled"/>
                                <div class="text-muted">
                                    Enable automatic sales chatbot on Messenger
                                </div>
                                <div class="content-group mt16" 
                                     invisible="not chatbot_enabled">
                                    <div class="row">
                                        <label for="chatbot_welcome_message" 
                                               string="Welcome Message" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="chatbot_welcome_message" 
                                               widget="text"/>
                                    </div>
                                    <div class="alert alert-info mt16" role="alert">
                                        <strong>Chatbot Flow:</strong><br/>
                                        1. Ask customer name<br/>
                                        2. Ask phone number<br/>
                                        3. Show product catalog<br/>
                                        4. Confirm order<br/>
                                        5. Create sale order automatically
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
            </xpath>
        </field>
    </record>

</odoo>



################################################################################
## FILE 36: social_account_views.xml
## ÄÆ°á»ng dáº«n: views/social_account_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ============================================================
         SOCIAL ACCOUNT - LIST VIEW
         ============================================================ -->
    <record id="social_account_view_tree" model="ir.ui.view">
        <field name="name">social.account.list</field>
        <field name="model">social.account</field>
        <field name="arch" type="xml">
            <list string="Facebook Pages" decoration-muted="not active">
                <field name="name"/>
                <field name="facebook_page_id"/>
                <field name="state" widget="badge" decoration-success="state == 'connected'" decoration-danger="state == 'error'" decoration-info="state == 'draft'"/>
                <field name="followers_count"/>
                <field name="likes_count"/>
                <field name="post_count"/>
                <field name="conversation_count"/>
                <field name="last_sync_date"/>
                <field name="last_message_sync_date"/>
                <field name="active" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- ============================================================
         SOCIAL ACCOUNT - FORM VIEW (Cáº¬P NHáº¬T Vá»šI NÃšT SYNC CONVERSATIONS)
         ============================================================ -->
    <record id="social_account_view_form" model="ir.ui.view">
        <field name="name">social.account.form</field>
        <field name="model">social.account</field>
        <field name="arch" type="xml">
            <form string="Facebook Page">
                <header>
                    <button name="action_test_connection" type="object" string="Test Connection" class="btn-primary" invisible="state == 'connected'"/>
                    <button name="action_sync_page_info" type="object" string="Sync Page Info" class="btn-secondary" invisible="state != 'connected'"/>
                    <!-- âœ… THÃŠM: NÃšT SYNC CONVERSATIONS -->
                    <button name="action_sync_conversations" type="object" string="ğŸ”„ Sync Conversations" class="btn-primary" invisible="state != 'connected'"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,connected"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_posts" type="object" class="oe_stat_button" icon="fa-newspaper-o">
                            <field name="post_count" widget="statinfo" string="Posts"/>
                        </button>
                        <!-- âœ… THÃŠM: NÃšT XEM CONVERSATIONS -->
                        <button name="action_view_conversations" type="object" class="oe_stat_button" icon="fa-comments">
                            <field name="conversation_count" widget="statinfo" string="Conversations"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name" placeholder="Enter Facebook Page Name..."/>
                        </h1>
                    </div>
                    <group>
                        <group string="Facebook Information">
                            <field name="platform" readonly="1"/>
                            <field name="facebook_page_id" placeholder="Enter Page ID..."/>
                            <field name="facebook_page_url" widget="url" readonly="1"/>
                            <field name="page_category" readonly="1"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                            <field name="active" widget="boolean_toggle"/>
                        </group>
                        <group string="Statistics">
                            <field name="followers_count" readonly="1"/>
                            <field name="likes_count" readonly="1"/>
                            <field name="page_rating" readonly="1"/>
                            <field name="last_sync_date" readonly="1"/>
                            <field name="last_message_sync_date" readonly="1"/>
                        </group>
                    </group>
                    <group string="Authentication">
                        <group>
                            <field name="access_token" password="True"/>
                        </group>
                        <group>
                            <field name="token_expires_at"/>
                            <field name="is_token_valid"/>
                        </group>
                    </group>
                    <group string="Settings">
                        <group>
                            <field name="auto_sync_comments"/>
                        </group>
                        <group>
                            <field name="auto_sync_messages"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="About" name="about">
                            <field name="page_about" readonly="1"/>
                        </page>
                        <page string="Error Log" name="errors" invisible="not error_message">
                            <field name="error_message" readonly="1"/>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ============================================================
         SOCIAL ACCOUNT - KANBAN VIEW
         ============================================================ -->
    <record id="social_account_view_kanban" model="ir.ui.view">
        <field name="name">social.account.kanban</field>
        <field name="model">social.account</field>
        <field name="arch" type="xml">
            <kanban>
                <field name="name"/>
                <field name="state"/>
                <field name="followers_count"/>
                <field name="likes_count"/>
                <field name="post_count"/>
                <field name="conversation_count"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_content">
                            <div class="o_kanban_record_top">
                                <strong class="o_kanban_record_title">
                                    <field name="name"/>
                                </strong>
                            </div>
                            <div class="o_kanban_record_body">
                                <div>Status: <field name="state"/></div>
                                <div><field name="followers_count"/> followers</div>
                                <div><field name="likes_count"/> likes</div>
                                <div><field name="post_count"/> posts</div>
                                <div><field name="conversation_count"/> conversations</div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ============================================================
         SOCIAL ACCOUNT - SEARCH VIEW
         ============================================================ -->
    <record id="social_account_view_search" model="ir.ui.view">
        <field name="name">social.account.search</field>
        <field name="model">social.account</field>
        <field name="arch" type="xml">
            <search string="Search Facebook Pages">
                <field name="name"/>
                <field name="facebook_page_id"/>
                <field name="state"/>
                <field name="company_id" groups="base.group_multi_company"/>
                <filter string="Connected" name="filter_connected" domain="[('state', '=', 'connected')]"/>
                <filter string="Draft" name="filter_draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Error" name="filter_error" domain="[('state', '=', 'error')]"/>
                <filter string="Active" name="filter_active" domain="[('active', '=', True)]"/>
                <filter string="Group By Status" name="group_state" context="{'group_by': 'state'}"/>
                <filter string="Group By Company" name="group_company" context="{'group_by': 'company_id'}" groups="base.group_multi_company"/>
            </search>
        </field>
    </record>

    <!-- ============================================================
         SOCIAL ACCOUNT - ACTION
         ============================================================ -->
    <record id="action_social_account" model="ir.actions.act_window">
        <field name="name">Facebook Pages</field>
        <field name="res_model">social.account</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="search_view_id" ref="social_account_view_search"/>
        <field name="context">{'search_default_filter_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Connect your first Facebook Page!
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 37: social_analytics_views.xml
## ÄÆ°á»ng dáº«n: views/social_analytics_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="social_analytics_view_pivot" model="ir.ui.view">
        <field name="name">social.analytics.pivot</field>
        <field name="model">social.analytics</field>
        <field name="arch" type="xml">
            <pivot string="Facebook Analytics">
                <field name="account_id" type="row"/>
                <field name="date" interval="month" type="col"/>
                <field name="total_posts" type="measure"/>
                <field name="total_likes" type="measure"/>
                <field name="total_comments" type="measure"/>
            </pivot>
        </field>
    </record>

    <record id="social_analytics_view_graph" model="ir.ui.view">
        <field name="name">social.analytics.graph</field>
        <field name="model">social.analytics</field>
        <field name="arch" type="xml">
            <graph string="Facebook Analytics" type="line">
                <field name="date" interval="day"/>
                <field name="total_likes" type="measure"/>
                <field name="total_comments" type="measure"/>
            </graph>
        </field>
    </record>

    <record id="social_analytics_view_tree" model="ir.ui.view">
        <field name="name">social.analytics.list</field>
        <field name="model">social.analytics</field>
        <field name="arch" type="xml">
            <list string="Facebook Analytics" create="0" edit="0" delete="0">
                <field name="date"/>
                <field name="account_id"/>
                <field name="total_posts"/>
                <field name="total_likes"/>
                <field name="total_comments"/>
                <field name="total_shares"/>
                <field name="avg_engagement_rate"/>
            </list>
        </field>
    </record>

    <record id="action_social_analytics" model="ir.actions.act_window">
        <field name="name">Facebook Analytics</field>
        <field name="res_model">social.analytics</field>
        <field name="view_mode">pivot,graph,list</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">No analytics data yet!</p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 38: social_comment_views.xml
## ÄÆ°á»ng dáº«n: views/social_comment_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="social_comment_view_tree" model="ir.ui.view">
        <field name="name">social.comment.list</field>
        <field name="model">social.comment</field>
        <field name="arch" type="xml">
            <list string="Facebook Comments" 
                  decoration-muted="is_hidden"
                  decoration-danger="is_spam"
                  decoration-success="replied">
                <field name="comment_date"/>
                <field name="post_id"/>
                <field name="author_name"/>
                <field name="message"/>
                <field name="replied"/>
                <field name="is_hidden" optional="hide"/>
                <field name="is_spam" optional="hide"/>
            </list>
        </field>
    </record>

    <record id="social_comment_view_form" model="ir.ui.view">
        <field name="name">social.comment.form</field>
        <field name="model">social.comment</field>
        <field name="arch" type="xml">
            <form string="Facebook Comment">
                <header>
                    <button name="action_reply" type="object" string="Reply" class="btn-primary" invisible="replied"/>
                    <button name="action_hide" type="object" string="Hide" class="btn-secondary" invisible="is_hidden"/>
                    <button name="action_mark_spam" type="object" string="Mark Spam" class="btn-danger" invisible="is_spam"/>
                </header>
                <sheet>
                    <group>
                        <group string="Comment Info">
                            <field name="post_id"/>
                            <field name="comment_date"/>
                            <field name="facebook_comment_id"/>
                        </group>
                        <group string="Author">
                            <field name="author_name"/>
                            <field name="author_facebook_id"/>
                        </group>
                    </group>
                    <group string="Message">
                        <field name="message" nolabel="1" readonly="1"/>
                    </group>
                    <group string="Reply" invisible="replied">
                        <field name="reply_text" nolabel="1"/>
                    </group>
                    <group string="Status">
                        <field name="replied"/>
                        <field name="is_hidden"/>
                        <field name="is_spam"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_social_comment" model="ir.actions.act_window">
        <field name="name">Facebook Comments</field>
        <field name="res_model">social.comment</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">No comments yet!</p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 39: social_message_views.xml
## ÄÆ°á»ng dáº«n: views/social_message_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- MESSAGE (CONVERSATION) - LIST VIEW                                    -->
    <!-- ===================================================================== -->
    <record id="social_message_view_tree" model="ir.ui.view">
        <field name="name">social.message.list</field>
        <field name="model">social.message</field>
        <field name="arch" type="xml">
            <list string="Facebook Conversations" 
                  decoration-info="is_from_customer == False"
                  decoration-muted="is_from_customer == True">
                <field name="account_id"/>
                <field name="facebook_user_id"/>
                <field name="customer_name"/>
                <field name="message"/>
                <field name="created_date"/>
                <field name="last_message_date"/>
                <field name="is_from_customer" widget="boolean"/>
                <field name="chatbot_state" widget="badge"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSAGE - FORM VIEW                                                   -->
    <!-- ===================================================================== -->
    <record id="social_message_view_form" model="ir.ui.view">
        <field name="name">social.message.form</field>
        <field name="model">social.message</field>
        <field name="arch" type="xml">
            <form string="Facebook Message / Conversation">
                <header>
                    <field name="chatbot_state" widget="statusbar" 
                           statusbar_visible="idle,ask_name,ask_phone,show_products,confirm_order,completed"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <label for="facebook_user_id" string="Conversation with"/>
                        <h1>
                            <field name="customer_name" placeholder="Customer Name"/>
                        </h1>
                        <h3>
                            <field name="facebook_user_id" readonly="1"/>
                        </h3>
                    </div>
                    
                    <group>
                        <group string="Conversation Info">
                            <field name="account_id" readonly="1"/>
                            <field name="message_id" readonly="1"/>
                            <field name="is_from_customer" widget="boolean"/>
                        </group>
                        <group string="Timestamps">
                            <field name="created_date" readonly="1"/>
                            <field name="last_message_date" readonly="1"/>
                        </group>
                    </group>
                    
                    <group string="Message Content">
                        <field name="message" nolabel="1" widget="text"/>
                    </group>
                    
                    <group string="Customer Info (Chatbot)">
                        <group>
                            <field name="customer_phone"/>
                        </group>
                        <group>
                            <field name="chatbot_state"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Products" name="products">
                            <field name="selected_product_ids" nolabel="1">
                                <list>
                                    <field name="display_name"/>
                                    <field name="price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                    <field name="currency_id" column_invisible="1"/>
                                    <field name="active" widget="boolean"/>
                                    <field name="sequence"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="Related Records" name="related">
                            <group>
                                <field name="lead_id"/>
                                <field name="messenger_order_id"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_ids" widget="mail_thread"/>
                    <field name="activity_ids" widget="mail_activity"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSAGE - SEARCH VIEW                                                 -->
    <!-- ===================================================================== -->
    <record id="social_message_view_search" model="ir.ui.view">
        <field name="name">social.message.search</field>
        <field name="model">social.message</field>
        <field name="arch" type="xml">
            <search string="Search Conversations">
                <field name="facebook_user_id"/>
                <field name="customer_name"/>
                <field name="message"/>
                <field name="account_id"/>
                
                <filter string="From Customer" name="filter_from_customer" 
                        domain="[('is_from_customer', '=', True)]"/>
                <filter string="From Page" name="filter_from_page" 
                        domain="[('is_from_customer', '=', False)]"/>
                <separator/>
                
                <filter string="Idle" name="filter_idle" 
                        domain="[('chatbot_state', '=', 'idle')]"/>
                <filter string="In Progress" name="filter_progress" 
                        domain="[('chatbot_state', 'in', ['ask_name', 'ask_phone', 'show_products', 'confirm_order'])]"/>
                <filter string="Completed" name="filter_completed" 
                        domain="[('chatbot_state', '=', 'completed')]"/>
                <separator/>
                
                <filter string="This Week" name="filter_week" 
                        domain="[('created_date', '&gt;=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                <filter string="This Month" name="filter_month" 
                        domain="[('created_date', '&gt;=', (context_today().replace(day=1)).strftime('%Y-%m-%d'))]"/>
                <separator/>
                
                <filter string="Has Lead" name="filter_has_lead" 
                        domain="[('lead_id', '!=', False)]"/>
                <filter string="Has Order" name="filter_has_order" 
                        domain="[('messenger_order_id', '!=', False)]"/>
                <separator/>
                
                <filter string="Group By Page" name="group_account" 
                        context="{'group_by': 'account_id'}"/>
                <filter string="Group By State" name="group_state" 
                        context="{'group_by': 'chatbot_state'}"/>
                <filter string="Group By Date" name="group_date" 
                        context="{'group_by': 'created_date:month'}"/>
            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSAGE - ACTION                                                      -->
    <!-- ===================================================================== -->
    <record id="action_social_message" model="ir.actions.act_window">
        <field name="name">Facebook Conversations</field>
        <field name="res_model">social.message</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="social_message_view_search"/>
        <field name="context">{'search_default_filter_from_customer': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No conversations yet!
            </p>
            <p>
                Conversations will appear here when customers message your Facebook page.
            </p>
            <p>
                <strong>Webhook must be configured to receive messages automatically.</strong>
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 40: social_messenger_order_views.xml
## ÄÆ°á»ng dáº«n: views/social_messenger_order_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- MESSENGER ORDER - LIST VIEW                                           -->
    <!-- ===================================================================== -->
    <record id="social_messenger_order_view_tree" model="ir.ui.view">
        <field name="name">social.messenger.order.list</field>
        <field name="model">social.messenger.order</field>
        <field name="arch" type="xml">
            <list string="Messenger Orders" 
                  decoration-success="state == 'sale'" 
                  decoration-info="state == 'confirmed'"
                  decoration-muted="state == 'cancelled'">
                <field name="name"/>
                <field name="order_date"/>
                <field name="customer_name"/>
                <field name="customer_phone"/>
                <field name="total_amount" widget="monetary" options="{'currency_field': 'currency_id'}" sum="Total"/>
                <field name="currency_id" column_invisible="1"/>
                <field name="state" widget="badge" 
                       decoration-success="state == 'sale'"
                       decoration-info="state == 'confirmed'"
                       decoration-muted="state == 'cancelled'"/>
                <field name="sale_order_id"/>
                <field name="user_id" widget="many2one_avatar_user"/>
                <field name="company_id" groups="base.group_multi_company" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER ORDER - FORM VIEW                                           -->
    <!-- ===================================================================== -->
    <record id="social_messenger_order_view_form" model="ir.ui.view">
        <field name="name">social.messenger.order.form</field>
        <field name="model">social.messenger.order</field>
        <field name="arch" type="xml">
            <form string="Messenger Order">
                <header>
                    <button name="action_confirm" type="object" 
                            string="Confirm" class="btn-primary"
                            invisible="state != 'draft'"/>
                    <button name="action_create_sale_order" type="object" 
                            string="Create Sale Order" class="btn-primary"
                            invisible="state != 'confirmed' or sale_order_id != False"/>
                    <button name="action_view_sale_order" type="object" 
                            string="View Sale Order" class="btn-info"
                            invisible="sale_order_id == False"/>
                    <button name="action_cancel" type="object" 
                            string="Cancel"
                            invisible="state in ['sale', 'cancelled']"/>
                    <field name="state" widget="statusbar" 
                           statusbar_visible="draft,confirmed,sale"/>
                </header>
                
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    
                    <group>
                        <group string="Customer Information">
                            <field name="customer_name"/>
                            <field name="customer_phone"/>
                            <field name="customer_email"/>
                            <field name="facebook_user_id"/>
                            <field name="partner_id" readonly="1"/>
                        </group>
                        <group string="Order Information">
                            <field name="order_date"/>
                            <field name="user_id"/>
                            <field name="total_amount" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                            <field name="currency_id" column_invisible="1"/>
                            <field name="sale_order_id" readonly="1"/>
                            <field name="conversation_id"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Products" name="products">
                            <field name="product_ids">
                                <list>
                                    <field name="product_id"/>
                                    <field name="quick_reply_title"/>
                                    <field name="price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                    <field name="currency_id" column_invisible="1"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="Internal Notes" name="notes">
                            <field name="notes" placeholder="Add internal notes..."/>
                        </page>
                    </notebook>
                </sheet>
                
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER ORDER - SEARCH VIEW                                         -->
    <!-- ===================================================================== -->
    <record id="social_messenger_order_view_search" model="ir.ui.view">
        <field name="name">social.messenger.order.search</field>
        <field name="model">social.messenger.order</field>
        <field name="arch" type="xml">
            <search string="Search Messenger Orders">
                <field name="name"/>
                <field name="customer_name"/>
                <field name="customer_phone"/>
                <field name="sale_order_id"/>
                
                <filter string="Draft" name="filter_draft" 
                        domain="[('state', '=', 'draft')]"/>
                <filter string="Confirmed" name="filter_confirmed" 
                        domain="[('state', '=', 'confirmed')]"/>
                <filter string="Sale Order Created" name="filter_sale" 
                        domain="[('state', '=', 'sale')]"/>
                <filter string="Cancelled" name="filter_cancelled" 
                        domain="[('state', '=', 'cancelled')]"/>
                <separator/>
                
                <filter string="My Orders" name="filter_my_orders" 
                        domain="[('user_id', '=', uid)]"/>
                <filter string="This Month" name="filter_this_month" 
                        domain="[('order_date', '&gt;=', (context_today() - datetime.timedelta(days=30)).strftime('%Y-%m-%d'))]"/>
                <separator/>
                
                <filter string="Group By Salesperson" name="group_user" 
                        context="{'group_by': 'user_id'}"/>
                <filter string="Group By Status" name="group_state" 
                        context="{'group_by': 'state'}"/>
                <filter string="Group By Order Date" name="group_date" 
                        context="{'group_by': 'order_date:month'}"/>
                <filter string="Group By Company" name="group_company" 
                        context="{'group_by': 'company_id'}" 
                        groups="base.group_multi_company"/>
            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER ORDER - ACTION                                              -->
    <!-- ===================================================================== -->
    <record id="action_social_messenger_order" model="ir.actions.act_window">
        <field name="name">Messenger Orders</field>
        <field name="res_model">social.messenger.order</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="social_messenger_order_view_search"/>
        <field name="context">{'search_default_filter_confirmed': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ğŸ“¦ No Messenger Orders Yet
            </p>
            <p>
                Orders created through the Facebook Messenger chatbot will appear here.<br/>
                Enable the chatbot in Settings to start receiving orders!
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 41: social_messenger_product_views.xml
## ÄÆ°á»ng dáº«n: views/social_messenger_product_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - LIST VIEW                                         -->
    <!-- ===================================================================== -->
    <record id="social_messenger_product_view_tree" model="ir.ui.view">
        <field name="name">social.messenger.product.list</field>
        <field name="model">social.messenger.product</field>
        <field name="arch" type="xml">
            <list string="Messenger Products" 
                  decoration-muted="active == False"
                  editable="bottom">
                <field name="sequence" widget="handle"/>
                <field name="product_id"/>
                <field name="quick_reply_title"/>
                <field name="price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                <field name="currency_id" column_invisible="1"/>
                <field name="active" widget="boolean_toggle"/>
                <field name="order_count"/>
                <field name="company_id" groups="base.group_multi_company" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - FORM VIEW                                         -->
    <!-- ===================================================================== -->
    <record id="social_messenger_product_view_form" model="ir.ui.view">
        <field name="name">social.messenger.product.form</field>
        <field name="model">social.messenger.product</field>
        <field name="arch" type="xml">
            <form string="Messenger Product">
                <header>
                    <button name="action_toggle_active" type="object" 
                            string="Enable" class="btn-primary"
                            invisible="active == True"/>
                    <button name="action_toggle_active" type="object" 
                            string="Disable" class="btn-secondary"
                            invisible="active == False"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_orders" type="object" 
                                class="oe_stat_button" icon="fa-shopping-cart"
                                invisible="order_count == 0">
                            <field name="order_count" widget="statinfo" 
                                   string="Orders"/>
                        </button>
                    </div>
                    
                    <field name="image_url" widget="image" class="oe_avatar"/>
                    
                    <div class="oe_title">
                        <h1>
                            <field name="product_id" 
                                   placeholder="Select Product..."
                                   options="{'no_create': True}"/>
                        </h1>
                    </div>
                    
                    <group>
                        <group string="Product Info">
                            <field name="display_name" invisible="1"/>
                            <field name="quick_reply_title" 
                                   placeholder="Max 20 characters"/>
                            <field name="price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                            <field name="currency_id" column_invisible="1"/>
                            <field name="sequence"/>
                        </group>
                        <group string="Organization">
                            <field name="company_id" 
                                   groups="base.group_multi_company"/>
                        </group>
                    </group>
                    
                    <group string="Messenger Description">
                        <field name="description" nolabel="1" 
                               placeholder="Description sent to customers..."/>
                    </group>
                    
                    <notebook>
                        <page string="Preview" name="preview">
                            <group>
                                <group string="How it appears in Messenger">
                                    <div class="alert alert-info" role="alert">
                                        <h4>Quick Reply Button:</h4>
                                        <p>
                                            <strong>
                                                <field name="quick_reply_title" readonly="1"/>
                                            </strong>
                                        </p>
                                        
                                        <h4>Product Message:</h4>
                                        <p>
                                            ğŸ›ï¸ <field name="product_id" readonly="1"/><br/>
                                            ğŸ’° GiÃ¡: <field name="price" readonly="1"/> 
                                            <field name="currency_id" readonly="1"/><br/>
                                            ğŸ“ <field name="description" readonly="1"/>
                                        </p>
                                    </div>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - KANBAN VIEW                                       -->
    <!-- ===================================================================== -->
    <record id="social_messenger_product_view_kanban" model="ir.ui.view">
        <field name="name">social.messenger.product.kanban</field>
        <field name="model">social.messenger.product</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile">
                <field name="product_id"/>
                <field name="quick_reply_title"/>
                <field name="price"/>
                <field name="currency_id"/>
                <field name="active"/>
                <field name="order_count"/>
                
                <templates>
                    <t t-name="card" t-translation="off">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="product_id"/>
                                    </strong>
                                </div>
                                <span class="badge rounded-pill" 
                                      t-att-class="record.active.raw_value ? 'text-bg-success' : 'text-bg-secondary'">
                                    <t t-if="record.active.raw_value">Active</t>
                                    <t t-else="">Inactive</t>
                                </span>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="quick_reply_title"/>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <field name="price" widget="monetary"/>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <i class="fa fa-shopping-cart"/> 
                                    <field name="order_count"/> orders
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - SEARCH VIEW                                       -->
    <!-- ===================================================================== -->
    <record id="social_messenger_product_view_search" model="ir.ui.view">
        <field name="name">social.messenger.product.search</field>
        <field name="model">social.messenger.product</field>
        <field name="arch" type="xml">
            <search string="Search Products">
                <field name="product_id"/>
                <field name="quick_reply_title"/>
                
                <filter string="Active" name="filter_active" 
                        domain="[('active', '=', True)]"/>
                <filter string="Inactive" name="filter_inactive" 
                        domain="[('active', '=', False)]"/>
                <separator/>
                
                <!-- XÃ“A FILTER "Has Orders" VÃŒ order_count LÃ€ COMPUTED FIELD -->
                
                <filter string="Group By Product" name="group_product" 
                        context="{'group_by': 'product_id'}"/>
            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - ACTION                                            -->
    <!-- ===================================================================== -->
    <record id="action_social_messenger_product" model="ir.actions.act_window">
        <field name="name">Messenger Products</field>
        <field name="res_model">social.messenger.product</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="search_view_id" ref="social_messenger_product_view_search"/>
        <field name="context">{'search_default_filter_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No products configured for Messenger!
            </p>
            <p>
                Add products to sell via Facebook Messenger chatbot.
            </p>
            <p>
                <strong>Only active products will appear in the chatbot.</strong>
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 42: social_post_calendar_views.xml
## ÄÆ°á»ng dáº«n: views/social_post_calendar_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="social_post_view_calendar" model="ir.ui.view">
        <field name="name">social.post.calendar</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <calendar
                string="Content Calendar"
                date_start="scheduled_date"
                mode="month"
                color="state"
                quick_create="0"
                event_open_popup="1">
                
                <!-- Required fields for calendar -->
                <field name="content"/>
                <field name="account_id"/>
                <field name="state"/>
                
            </calendar>
        </field>
    </record>

    <record id="action_social_post_calendar" model="ir.actions.act_window">
        <field name="name">Content Calendar</field>
        <field name="res_model">social.post</field>
        <field name="view_mode">calendar,tree,form</field>
        <field name="domain">[('scheduled_date', '!=', False)]</field>
        <field name="context">{'default_post_type': 'scheduled'}</field>
    </record>

</odoo>



################################################################################
## FILE 43: social_post_template_views.xml
## ÄÆ°á»ng dáº«n: views/social_post_template_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - LIST VIEW                                      -->
    <!-- ===================================================================== -->
    <record id="social_post_template_view_tree" model="ir.ui.view">
        <field name="name">social.post.template.list</field>
        <field name="model">social.post.template</field>
        <field name="arch" type="xml">
            <list string="Post Templates" decoration-muted="not active">
                <field name="name"/>
                <field name="template_type" widget="badge"/>
                <field name="description"/>
                <field name="active" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - FORM VIEW                                      -->
    <!-- ===================================================================== -->
    <record id="social_post_template_view_form" model="ir.ui.view">
        <field name="name">social.post.template.form</field>
        <field name="model">social.post.template</field>
        <field name="arch" type="xml">
            <form string="Post Template">
                <sheet>
                    <div class="oe_title">
                        <label for="name" string="Template Name"/>
                        <h1>
                            <field name="name" placeholder="Enter template name..."/>
                        </h1>
                    </div>
                    <group>
                        <group string="Template Info">
                            <field name="template_type"/>
                            <field name="active" widget="boolean_toggle"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                        </group>
                        <group string="Description">
                            <field name="description" nolabel="1" placeholder="Optional description..."/>
                        </group>
                    </group>
                    <group string="Content Template">
                        <field name="content" nolabel="1" placeholder="Enter your template content here. Use {{variable_name}} for dynamic content..."/>
                    </group>
                    <div class="mt-3">
                        <button name="action_use_template" type="object"
                                string="Use This Template" class="btn-primary"/>
                    </div>
                </sheet>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - KANBAN VIEW (FIXED FOR ODOO 19)                -->
    <!-- ===================================================================== -->
    <record id="social_post_template_view_kanban" model="ir.ui.view">
        <field name="name">social.post.template.kanban</field>
        <field name="model">social.post.template</field>
        <field name="arch" type="xml">
            <kanban>
                <field name="name"/>
                <field name="template_type"/>
                <field name="content"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_content">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <div>Type: <field name="template_type"/></div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - SEARCH VIEW                                    -->
    <!-- ===================================================================== -->
    <record id="social_post_template_view_search" model="ir.ui.view">
        <field name="name">social.post.template.search</field>
        <field name="model">social.post.template</field>
        <field name="arch" type="xml">
            <search string="Search Templates">
                <field name="name"/>
                <field name="content"/>
                <filter string="Active" name="filter_active" domain="[('active', '=', True)]"/>
<!-- Group By -->
                <filter string="Group By Type" name="group_type" context="{'group_by': 'template_type'}"/>
            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - ACTION                                         -->
    <!-- ===================================================================== -->
    <record id="action_social_post_template" model="ir.actions.act_window">
        <field name="name">Post Templates</field>
        <field name="res_model">social.post.template</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="search_view_id" ref="social_post_template_view_search"/>
        <field name="context">{'search_default_filter_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first post template!
            </p>
            <p>
                Templates help you quickly create consistent social media posts.
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 44: social_post_views.xml
## ÄÆ°á»ng dáº«n: views/social_post_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - LIST VIEW                                               -->
    <!-- ===================================================================== -->
    <record id="social_post_view_tree" model="ir.ui.view">
        <field name="name">social.post.list</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <list string="Facebook Posts" 
                  decoration-success="state == 'published'"
                  decoration-info="state == 'scheduled'"
                  decoration-danger="state == 'failed'">
                <field name="account_id"/>
                <field name="content"/>
                <field name="state" widget="badge"
                       decoration-success="state == 'published'"
                       decoration-info="state == 'scheduled'"
                       decoration-danger="state == 'failed'"
                       decoration-warning="state == 'draft'"/>
                <field name="scheduled_date" optional="show"/>
                <field name="published_date" optional="show"/>
                <field name="likes_count"/>
                <field name="comments_count"/>
                <field name="shares_count"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - FORM VIEW (FIXED FOR ODOO 19)                           -->
    <!-- ===================================================================== -->
    <record id="social_post_view_form" model="ir.ui.view">
        <field name="name">social.post.form</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <form string="Facebook Post">
                <header>
                    <button name="action_publish_now" type="object"
                            string="Publish Now" class="btn-primary"
                            invisible="state != 'draft'"/>
                    <button name="action_schedule_post" type="object"
                            string="Schedule" class="btn-secondary"
                            invisible="state != 'draft'"/>
                    <button name="action_sync_stats" type="object"
                            string="Sync Stats" class="btn-secondary"
                            invisible="state != 'published'"/>
                                <!-- NÃšT Má»šI: SYNC COMMENTS -->
                    <button name="action_sync_comments" type="object"
                            string="Sync Comments" class="btn-secondary"
                            invisible="state != 'published'"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,scheduled,published"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_comments" type="object"
                                class="oe_stat_button" icon="fa-comments"
                                invisible="comments_count == 0">
                            <field name="comments_count" widget="statinfo" string="Comments"/>
                        </button>
                    </div>
                    
                    <group>
                        <group string="Post Information">
                            <field name="account_id" options="{'no_create': True}"/>
                            <field name="post_type" widget="radio"/>
                            <field name="scheduled_date" invisible="post_type != 'scheduled'"/>
                            <field name="user_id" readonly="1"/>
                        </group>
                        <group string="Engagement Stats" invisible="state != 'published'">
                            <field name="likes_count" readonly="1"/>
                            <field name="comments_count" readonly="1"/>
                            <field name="shares_count" readonly="1"/>
                            <field name="engagement_rate" readonly="1"/>
                        </group>
                    </group>
                    
                    <group string="Content">
                        <field name="content" nolabel="1" placeholder="What do you want to share?"/>
                    </group>
                    
                    <group string="Media">
                        <group>
                            <field name="media_type" widget="radio"/>
                        </group>
                        <group>
                            <field name="image" widget="image" invisible="media_type != 'photo'" class="oe_avatar"/>
                            <field name="link_url" invisible="media_type != 'link'" placeholder="https://..."/>
                            <field name="video_url" invisible="media_type != 'video'" placeholder="https://..."/>
                        </group>
                    </group>
                    
                    <notebook invisible="state == 'draft'">
                        <page string="Facebook Info" name="fb_info" invisible="not facebook_post_id">
                            <group>
                                <group>
                                    <field name="facebook_post_id" readonly="1"/>
                                    <field name="facebook_post_url" widget="url" readonly="1"/>
                                </group>
                                <group>
                                    <field name="published_date" readonly="1"/>
                                    <field name="reach" readonly="1"/>
                                    <field name="impressions" readonly="1"/>
                                </group>
                            </group>
                        </page>
                        <page string="Error Log" name="errors" invisible="not error_message">
                            <group>
                                <field name="error_message" nolabel="1" readonly="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - KANBAN VIEW (FIXED FOR ODOO 19)                         -->
    <!-- ===================================================================== -->
    <record id="social_post_view_kanban" model="ir.ui.view">
        <field name="name">social.post.kanban</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state">
                <field name="content"/>
                <field name="state"/>
                <field name="account_id"/>
                <field name="likes_count"/>
                <field name="comments_count"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_content">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="account_id"/>
                                    </strong>
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="content"/>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <span><field name="likes_count"/> likes</span>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <span><field name="comments_count"/> comments</span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - SEARCH VIEW                                             -->
    <!-- ===================================================================== -->
    <record id="social_post_view_search" model="ir.ui.view">
        <field name="name">social.post.search</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <search string="Search Posts">
                <field name="content"/>
                <field name="account_id"/>
                <filter string="Draft" name="filter_draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Scheduled" name="filter_scheduled" domain="[('state', '=', 'scheduled')]"/>
                <filter string="Published" name="filter_published" domain="[('state', '=', 'published')]"/>
                <filter string="Failed" name="filter_failed" domain="[('state', '=', 'failed')]"/>
                <filter string="Group By Status" name="group_state" context="{'group_by': 'state'}"/>
                <filter string="Group By Page" name="group_account" context="{'group_by': 'account_id'}"/>

            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - ACTION                                                  -->
    <!-- ===================================================================== -->
    <record id="action_social_post" model="ir.actions.act_window">
        <field name="name">Facebook Posts</field>
        <field name="res_model">social.post</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="search_view_id" ref="social_post_view_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first Facebook post!
            </p>
            <p>
                Click the "New" button to create a new post.
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 45: __init__.py
## ÄÆ°á»ng dáº«n: wizard/__init__.py
################################################################################

from . import post_composer_wizard
from . import bulk_schedule_wizard



################################################################################
## FILE 46: bulk_schedule_wizard.py
## ÄÆ°á»ng dáº«n: wizard/bulk_schedule_wizard.py
################################################################################

from odoo import models, fields, api, _
from odoo.exceptions import UserError, ValidationError
from datetime import timedelta
import logging

_logger = logging.getLogger(__name__)


class BulkScheduleWizard(models.TransientModel):
    _name = 'social.bulk.schedule.wizard'
    _description = 'Bulk Post Scheduler Wizard'

    account_ids = fields.Many2many('social.account', string='Facebook Pages', required=True,
                                    domain=[('platform', '=', 'facebook'), ('state', '=', 'connected')])
    post_template_ids = fields.Many2many('social.post.template', string='Post Templates')
    
    schedule_type = fields.Selection([
        ('specific', 'Specific Dates'),
        ('recurring', 'Recurring Schedule'),
    ], string='Schedule Type', default='specific', required=True)
    
    start_date = fields.Datetime(string='Start Date', default=lambda self: fields.Datetime.now() + timedelta(hours=1))
    end_date = fields.Datetime(string='End Date')
    time_slots = fields.Text(string='Time Slots', default='09:00\n12:00\n15:00\n18:00')
    
    frequency = fields.Selection([
        ('daily', 'Daily'),
        ('weekly', 'Weekly'),
        ('monthly', 'Monthly'),
    ], string='Frequency', default='daily')
    
    interval = fields.Integer(string='Every', default=1)
    
    weekday_monday = fields.Boolean(string='Monday', default=True)
    weekday_tuesday = fields.Boolean(string='Tuesday', default=True)
    weekday_wednesday = fields.Boolean(string='Wednesday', default=True)
    weekday_thursday = fields.Boolean(string='Thursday', default=True)
    weekday_friday = fields.Boolean(string='Friday', default=True)
    weekday_saturday = fields.Boolean(string='Saturday', default=False)
    weekday_sunday = fields.Boolean(string='Sunday', default=False)
    
    day_of_month = fields.Integer(string='Day of Month', default=1)
    posting_times = fields.Text(string='Daily Posting Times', default='09:00\n15:00')
    duration_days = fields.Integer(string='Duration (Days)', default=30)
    
    content_rotation = fields.Selection([
        ('sequential', 'Sequential'),
        ('random', 'Random'),
    ], string='Content Rotation', default='sequential')
    
    preview_count = fields.Integer(string='Posts to Create', compute='_compute_preview_count')
    
    @api.depends('account_ids', 'post_template_ids', 'schedule_type', 'start_date', 'end_date', 'duration_days')
    def _compute_preview_count(self):
        for wizard in self:
            try:
                schedule = wizard._generate_schedule()
                wizard.preview_count = len(schedule) * len(wizard.account_ids)
            except:
                wizard.preview_count = 0
    
    def _get_selected_weekdays(self):
        self.ensure_one()
        weekdays = []
        if self.weekday_monday: weekdays.append(0)
        if self.weekday_tuesday: weekdays.append(1)
        if self.weekday_wednesday: weekdays.append(2)
        if self.weekday_thursday: weekdays.append(3)
        if self.weekday_friday: weekdays.append(4)
        if self.weekday_saturday: weekdays.append(5)
        if self.weekday_sunday: weekdays.append(6)
        return weekdays
    
    def _parse_time_slots(self, time_text):
        times = []
        for line in (time_text or '').split('\n'):
            line = line.strip()
            if not line:
                continue
            try:
                hour, minute = map(int, line.split(':'))
                if 0 <= hour <= 23 and 0 <= minute <= 59:
                    times.append((hour, minute))
            except:
                pass
        return times if times else [(9, 0)]
    
    def _generate_schedule(self):
        self.ensure_one()
        schedule = []
        
        if not self.start_date:
            return schedule
        
        if self.schedule_type == 'specific':
            current = self.start_date
            end = self.end_date or (self.start_date + timedelta(days=30))
            times = self._parse_time_slots(self.time_slots)
            
            while current <= end:
                for hour, minute in times:
                    scheduled_time = current.replace(hour=hour, minute=minute, second=0, microsecond=0)
                    if scheduled_time > fields.Datetime.now():
                        schedule.append(scheduled_time)
                current += timedelta(days=1)
        else:
            current = self.start_date
            end_date = current + timedelta(days=self.duration_days)
            times = self._parse_time_slots(self.posting_times)
            selected_weekdays = self._get_selected_weekdays()
            
            while current <= end_date:
                should_post = False
                if self.frequency == 'daily':
                    should_post = True
                elif self.frequency == 'weekly':
                    should_post = current.weekday() in selected_weekdays
                elif self.frequency == 'monthly':
                    should_post = current.day == self.day_of_month
                
                if should_post:
                    for hour, minute in times:
                        scheduled_time = current.replace(hour=hour, minute=minute, second=0, microsecond=0)
                        if scheduled_time > fields.Datetime.now():
                            schedule.append(scheduled_time)
                
                current += timedelta(days=1)
        
        return sorted(schedule)
    
    def action_schedule_posts(self):
        self.ensure_one()
        
        if not self.account_ids:
            raise UserError(_('Please select at least one Facebook Page!'))
        if not self.post_template_ids:
            raise UserError(_('Please select at least one post template!'))
        
        schedule = self._generate_schedule()
        if not schedule:
            raise UserError(_('No valid schedule dates found!'))
        
        created_posts = self.env['social.post']
        template_index = 0
        templates_list = list(self.post_template_ids)
        
        for scheduled_time in schedule:
            template = templates_list[template_index % len(templates_list)]
            template_index += 1
            
            for account in self.account_ids:
                post = self.env['social.post'].create({
                    'account_id': account.id,
                    'content': template.content,
                    'post_type': 'scheduled',
                    'scheduled_date': scheduled_time,
                    'state': 'scheduled',
                })
                created_posts |= post
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Success'),
                'message': _('Successfully scheduled %d posts!') % len(created_posts),
                'type': 'success',
                'sticky': False,
            }
        }




################################################################################
## FILE 47: post_composer_wizard.py
## ÄÆ°á»ng dáº«n: wizard/post_composer_wizard.py
################################################################################

from odoo import models, fields, api, _
from odoo.exceptions import UserError, ValidationError
import logging

_logger = logging.getLogger(__name__)


class PostComposerWizard(models.TransientModel):
    """
    Wizard Ä‘á»ƒ táº¡o vÃ  Ä‘Äƒng bÃ i nhanh lÃªn Facebook.
    Cho phÃ©p publish ngay hoáº·c lÃªn lá»‹ch.
    """
    _name = 'social.post.composer.wizard'
    _description = 'Quick Post Composer Wizard'

    # -------------------------------------------------------------------------
    # BASIC FIELDS
    # -------------------------------------------------------------------------
    account_ids = fields.Many2many(
        'social.account',
        string='Facebook Pages',
        required=True,
        domain=[('platform', '=', 'facebook'), ('state', '=', 'connected')],
        help='Select which pages to post to'
    )
    
    content = fields.Text(
        string='Post Content',
        required=True,
        help='What do you want to share?'
    )
    
    template_id = fields.Many2one(
        'social.post.template',
        string='Use Template',
        help='Select a template to start with'
    )
    
    # -------------------------------------------------------------------------
    # MEDIA
    # -------------------------------------------------------------------------
    media_type = fields.Selection([
        ('text', 'Text Only'),
        ('photo', 'Photo'),
        ('link', 'Link'),
    ], string='Post Type', default='text', required=True)
    
    image = fields.Binary(
        string='Image',
        attachment=True,
    )
    
    image_filename = fields.Char(string='Image Filename')
    
    link_url = fields.Char(
        string='Link URL',
        help='Share a link (optional)'
    )
    
    # -------------------------------------------------------------------------
    # SCHEDULING
    # -------------------------------------------------------------------------
    post_method = fields.Selection([
        ('now', 'Publish Now'),
        ('scheduled', 'Schedule for Later'),
    ], string='When to Post', default='now', required=True)
    
    scheduled_date = fields.Datetime(
        string='Schedule Date',
        help='When should this post be published?'
    )
    
    # -------------------------------------------------------------------------
    # PREVIEW
    # -------------------------------------------------------------------------
    preview_text = fields.Html(
        string='Preview',
        compute='_compute_preview_text',
        sanitize=False,
    )
    
    character_count = fields.Integer(
        string='Characters',
        compute='_compute_character_count',
    )
    
    # -------------------------------------------------------------------------
    # STATS
    # -------------------------------------------------------------------------
    page_count = fields.Integer(
        string='Number of Pages',
        compute='_compute_page_count',
    )
    
    # -------------------------------------------------------------------------
    # COMPUTE METHODS
    # -------------------------------------------------------------------------
    @api.onchange('template_id')
    def _onchange_template_id(self):
        """Load template content"""
        if self.template_id:
            self.content = self.template_id.content
    
    @api.depends('content')
    def _compute_character_count(self):
        """Count characters in content"""
        for wizard in self:
            wizard.character_count = len(wizard.content or '')
    
    @api.depends('account_ids')
    def _compute_page_count(self):
        """Count selected pages"""
        for wizard in self:
            wizard.page_count = len(wizard.account_ids)
    
    @api.depends('content', 'link_url', 'media_type')
    def _compute_preview_text(self):
        """Generate preview of the post"""
        for wizard in self:
            preview = '<div style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background-color: #f9f9f9;">'
            preview += '<div style="margin-bottom: 10px;">'
            preview += '<i class="fa fa-facebook-square" style="color: #1877f2; font-size: 20px;"></i> '
            preview += '<strong>Facebook Post Preview</strong>'
            preview += '</div>'
            
            if wizard.content:
                preview += f'<p style="white-space: pre-wrap; margin-bottom: 10px;">{wizard.content}</p>'
            
            if wizard.link_url:
                preview += f'<div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; background-color: #fff;">'
                preview += f'<i class="fa fa-link"></i> <a href="{wizard.link_url}" target="_blank">{wizard.link_url}</a>'
                preview += '</div>'
            
            if wizard.media_type == 'photo':
                preview += '<div style="margin-top: 10px;">'
                preview += '<i class="fa fa-camera"></i> <em>Image will be attached</em>'
                preview += '</div>'
            
            preview += '</div>'
            wizard.preview_text = preview
    
    # -------------------------------------------------------------------------
    # VALIDATION
    # -------------------------------------------------------------------------
    @api.constrains('scheduled_date', 'post_method')
    def _check_scheduled_date(self):
        """Validate scheduled date"""
        for wizard in self:
            if wizard.post_method == 'scheduled':
                if not wizard.scheduled_date:
                    raise ValidationError(_('Please set a scheduled date!'))
                if wizard.scheduled_date <= fields.Datetime.now():
                    raise ValidationError(_('Scheduled date must be in the future!'))
    
    @api.constrains('content')
    def _check_content_length(self):
        """Check content length"""
        for wizard in self:
            if wizard.content and len(wizard.content) > 63206:
                raise ValidationError(_('Facebook posts are limited to 63,206 characters!'))
    
    # -------------------------------------------------------------------------
    # ACTIONS
    # -------------------------------------------------------------------------
    def action_publish(self):
        """Create and publish/schedule posts"""
        self.ensure_one()
        
        if not self.account_ids:
            raise UserError(_('Please select at least one Facebook Page!'))
        
        created_posts = self.env['social.post']
        
        for account in self.account_ids:
            post_vals = {
                'account_id': account.id,
                'content': self.content,
                'media_type': self.media_type,
                'link_url': self.link_url,
                'post_type': self.post_method,
            }
            
            if self.media_type == 'photo' and self.image:
                post_vals.update({
                    'image': self.image,
                    'image_filename': self.image_filename,
                })
            
            if self.post_method == 'scheduled':
                post_vals['scheduled_date'] = self.scheduled_date
            
            post = self.env['social.post'].create(post_vals)
            created_posts |= post
            
            # If publish now, trigger publish action
            if self.post_method == 'now':
                try:
                    post.action_publish_now()
                except Exception as e:
                    _logger.error(f'Error publishing post {post.id}: {e}')
                    raise UserError(_('Error publishing to %s: %s') % (account.name, str(e)))
            else:
                post.state = 'scheduled'
        
        # Show success notification
        message = _('Successfully created %d post(s)!') % len(created_posts)
        if self.post_method == 'now':
            message = _('Successfully published to %d page(s)!') % len(self.account_ids)
        else:
            message = _('Successfully scheduled %d post(s) for %s') % (
                len(created_posts), 
                self.scheduled_date.strftime('%Y-%m-%d %H:%M')
            )
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Success'),
                'message': message,
                'type': 'success',
                'sticky': False,
                'next': {
                    'type': 'ir.actions.act_window',
                    'res_model': 'social.post',
                    'view_mode': 'list,form',
                    'domain': [('id', 'in', created_posts.ids)],
                }
            }
        }
    
    def action_preview(self):
        """Show preview of the post"""
        self.ensure_one()
        return {
            'type': 'ir.actions.act_window',
            'name': _('Post Preview'),
            'res_model': 'social.post.composer.wizard',
            'view_mode': 'form',
            'res_id': self.id,
            'target': 'new',
        }




################################################################################
## FILE 48: wizard_views.xml
## ÄÆ°á»ng dáº«n: wizard/wizard_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="post_composer_wizard_view_form" model="ir.ui.view">
        <field name="name">social.post.composer.wizard.form</field>
        <field name="model">social.post.composer.wizard</field>
        <field name="arch" type="xml">
            <form string="Quick Post Composer">
                <sheet>
                    <group>
                        <group string="Select Pages">
                            <field name="account_ids" widget="many2many_tags"/>
                        </group>
                        <group string="Options">
                            <field name="template_id"/>
                            <field name="post_method" widget="radio"/>
                        </group>
                    </group>
                    <group string="Content">
                        <field name="content" nolabel="1"/>
                    </group>
                    <group>
                        <group string="Media">
                            <field name="media_type" widget="radio"/>
                            <field name="image" widget="image" invisible="media_type != 'photo'"/>
                            <field name="link_url" invisible="media_type != 'link'"/>
                        </group>
                        <group string="Scheduling" invisible="post_method != 'scheduled'">
                            <field name="scheduled_date"/>
                        </group>
                    </group>
                </sheet>
                <footer>
                    <button name="action_publish" type="object" string="Publish/Schedule" class="btn-primary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <record id="action_post_composer_wizard" model="ir.actions.act_window">
        <field name="name">Create Post</field>
        <field name="res_model">social.post.composer.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

    <record id="bulk_schedule_wizard_view_form" model="ir.ui.view">
        <field name="name">social.bulk.schedule.wizard.form</field>
        <field name="model">social.bulk.schedule.wizard</field>
        <field name="arch" type="xml">
            <form string="Bulk Post Scheduler">
                <sheet>
                    <group>
                        <group string="Select Pages">
                            <field name="account_ids" widget="many2many_tags"/>
                        </group>
                        <group string="Select Templates">
                            <field name="post_template_ids" widget="many2many_tags"/>
                            <field name="content_rotation" widget="radio"/>
                        </group>
                    </group>
                    <group string="Schedule Type">
                        <field name="schedule_type" widget="radio"/>
                    </group>
                    <group invisible="schedule_type != 'specific'">
                        <group string="Date Range">
                            <field name="start_date"/>
                            <field name="end_date"/>
                        </group>
                        <group string="Time Slots">
                            <field name="time_slots" nolabel="1"/>
                        </group>
                    </group>
                    <group invisible="schedule_type != 'recurring'">
                        <group string="Frequency">
                            <field name="frequency" widget="radio"/>
                            <field name="interval"/>
                            <field name="duration_days"/>
                            <field name="day_of_month" invisible="frequency != 'monthly'"/>
                        </group>
                        <group string="Posting Times">
                            <field name="posting_times" nolabel="1"/>
                        </group>
                    </group>
                    <group string="Weekdays" invisible="schedule_type != 'recurring' or frequency != 'weekly'">
                        <group>
                            <field name="weekday_monday"/>
                            <field name="weekday_tuesday"/>
                            <field name="weekday_wednesday"/>
                            <field name="weekday_thursday"/>
                        </group>
                        <group>
                            <field name="weekday_friday"/>
                            <field name="weekday_saturday"/>
                            <field name="weekday_sunday"/>
                        </group>
                    </group>
                    <group string="Preview">
                        <field name="preview_count" readonly="1"/>
                    </group>
                </sheet>
                <footer>
                    <button name="action_schedule_posts" type="object" string="Schedule All Posts" class="btn-primary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <record id="action_bulk_schedule_wizard" model="ir.actions.act_window">
        <field name="name">Bulk Schedule Posts</field>
        <field name="res_model">social.bulk.schedule.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

</odoo>






################################################################################
## FILE 2: __init__.py
## ÄÆ°á»ng dáº«n: __init__.py
################################################################################

from . import models
from . import controllers
from . import wizard
from . import lib
import logging

_logger = logging.getLogger(__name__)

def post_init_hook(env):
    """
    Hook cháº¡y sau khi cÃ i Ä‘áº·t module.
    Chá»‰ khá»Ÿi táº¡o Webhook Token, KHÃ”NG can thiá»‡p vÃ o quyá»n user.
    """
    param = env['ir.config_parameter'].sudo()
    if not param.get_param('social_facebook.webhook_verify_token'):
        import secrets
        verify_token = secrets.token_urlsafe(32)
        param.set_param('social_facebook.webhook_verify_token', verify_token)

def uninstall_hook(env):
    """Hook cháº¡y trÆ°á»›c khi gá»¡ cÃ i Ä‘áº·t module."""
    try:
        accounts = env['social.account'].search([('platform', '=', 'facebook')])
        accounts.write({'active': False})
    except Exception as e:
        _logger.warning(f'Error during uninstall: {e}')




################################################################################
## FILE 3: __manifest__.py
## ÄÆ°á»ng dáº«n: __manifest__.py
################################################################################

# -*- coding: utf-8 -*-
{
    'name': 'Social Media - Facebook Enhanced',
    'version': '19.0.2.0.0',
    'category': 'Marketing/Social Marketing',
    'summary': 'Facebook Integration with CRM, Messenger Sales & Content Calendar',
    'description': """
Facebook Integration - Enterprise Edition
==========================================

Core Features:
--------------
* Facebook Pages Management
* Posts Publishing & Scheduling
* Comments & Reactions Tracking
* Messenger Conversations
* Analytics & Insights
* Webhook Integration

NEW Features (v2.0):
-------------------
* âœ¨ CRM Lead Auto-creation from Messenger & Lead Ads
* âœ¨ Messenger Sales Bot with Order Creation
* âœ¨ Content Calendar View
* âœ¨ Ngrok Integration for Local Development
* âœ¨ Webhook Configuration UI
* âœ¨ Messenger Product Catalog
* âœ¨ Sale Order Integration

Technical Requirements:
-----------------------
* Odoo 19.0+
* Python 3.10+
* Facebook Graph API v18.0+
* Ngrok (optional, for localhost webhooks)
    """,
    'author': 'Your Company',
    'website': 'https://www.yourcompany.com',
    'license': 'LGPL-3',
    'depends': [
        'base',
        'mail',
        'web',
        'crm',              # NEW - CRM integration
        'sale_management',  # NEW - Sales integration
        'product',          # NEW - Product catalog
    ],
    'data': [
        # Security
        'security/social_security.xml',
        'security/ir.model.access.csv',
        
        # Data
        'data/user_groups_data.xml',
        'data/ir_cron_data.xml',
        'data/mail_template_data.xml',
        'data/facebook_post_template_data.xml',
        'data/chatbot_data.xml',
        
        # Views - Actions TRÆ¯á»šC, Menu SAU
        'views/dashboard_views.xml',               # âœ… TRÆ¯á»šC (define action)
        # 'views/res_config_settings_views.xml',
        'views/social_account_views.xml',
        'views/social_post_views.xml',
        'views/social_post_calendar_views.xml',
        'views/social_post_template_views.xml',
        'views/social_comment_views.xml',
        'views/social_message_views.xml',
        'views/social_conversation_views.xml', 
        'views/social_analytics_views.xml',
        'views/social_messenger_product_views.xml',
        'views/social_messenger_order_views.xml',
        'views/menu_views.xml',                    # âœ… SAU (reference action)
        
        # Wizards
        'wizard/wizard_views.xml',
    ],
    'assets': {
        'web.assets_backend': [
            'module_social_facebook/static/src/css/social_facebook.css',
            'module_social_facebook/static/src/js/social_dashboard.js',
            'module_social_facebook/static/src/js/social_conversation_list.js',
            'module_social_facebook/static/src/js/ngrok_controller.js',  # NEW
        ],
        'web.assets_qweb': [
            'module_social_facebook/static/src/xml/social_conversation_templates.xml',
        ],
    },
    'external_dependencies': {
        'python': ['requests'],
    },
    'installable': True,
    'application': True,
    'auto_install': False,
}



################################################################################
## FILE 4: __init__.py
## ÄÆ°á»ng dáº«n: controllers/__init__.py
################################################################################

from . import main
from . import webhook




################################################################################
## FILE 5: main.py
## ÄÆ°á»ng dáº«n: controllers/main.py
################################################################################

from odoo import http
from odoo.http import request


class SocialFacebookController(http.Controller):
    """
    Controller chÃ­nh cho Facebook integration.
    """

    @http.route('/social/facebook/oauth/callback', type='http', auth='user', website=True)
    def facebook_oauth_callback(self, **kwargs):
        """
        Callback URL sau khi user authorize Facebook app.
        """
        code = kwargs.get('code')
        state = kwargs.get('state')
        
        if not code:
            return request.render('module_social_facebook.oauth_error', {
                'error': 'No authorization code received'
            })
        
        # Process OAuth code and exchange for access token
        # Logic xá»­ lÃ½ á»Ÿ Ä‘Ã¢y
        
        return request.redirect('/web#action=module_social_facebook.action_social_account')




################################################################################
## FILE 6: webhook.py
## ÄÆ°á»ng dáº«n: controllers/webhook.py
################################################################################

# -*- coding: utf-8 -*-

import json
import logging
from odoo import http
from odoo.http import request

_logger = logging.getLogger(__name__)


class FacebookWebhookController(http.Controller):
    """
    Controller xá»­ lÃ½ webhook tá»« Facebook.
    
    Endpoint: /social/facebook/webhook
    Methods:
    - GET: Verify webhook (subscription)
    - POST: Nháº­n events tá»« Facebook
    """
    
    @http.route('/social/facebook/webhook', type='http', auth='public', 
                methods=['GET'], csrf=False)
    def webhook_verify(self, **kwargs):
        """
        Verify webhook theo Facebook requirements.
        
        Facebook sáº½ gá»­i GET request vá»›i params:
        - hub.mode = 'subscribe'
        - hub.verify_token = token báº¡n set
        - hub.challenge = random string
        
        Response: echo láº¡i hub.challenge
        """
        mode = kwargs.get('hub.mode')
        token = kwargs.get('hub.verify_token')
        challenge = kwargs.get('hub.challenge')
        
        # Get verify token from settings
        verify_token = request.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.verify_token', '16112005'
        )
        
        _logger.info(f'Webhook verify attempt - mode: {mode}, token: {token}')
        
        if mode == 'subscribe' and token == verify_token:
            _logger.info('Webhook verified successfully!')
            return challenge
        else:
            _logger.warning(f'Webhook verify failed - token mismatch')
            return 'Forbidden', 403
    
    @http.route('/social/facebook/webhook', type='http', auth='public', 
                methods=['POST'], csrf=False)
    def webhook_callback(self, **kwargs):
        """
        Nháº­n vÃ  xá»­ lÃ½ events tá»« Facebook.
        
        Events types:
        - messages: Tin nháº¯n Messenger
        - messaging_postbacks: Postback tá»« buttons
        - leadgen: Lead form submissions
        - feed: Post updates
        """
        try:
            # Parse JSON body
            body = request.httprequest.get_data(as_text=True)
            data = json.loads(body)
            
            _logger.info(f'Received webhook data: {json.dumps(data, indent=2)}')
            
            # Verify object type
            if data.get('object') != 'page':
                _logger.warning(f'Unknown object type: {data.get("object")}')
                return 'OK'
            
            # Process each entry
            for entry in data.get('entry', []):
                self._process_entry(entry)
            
            return 'OK'
            
        except Exception as e:
            _logger.error(f'Error processing webhook: {e}', exc_info=True)
            return 'OK'  # Always return 200 to Facebook
    
    def _process_entry(self, entry):
        """
        Xá»­ lÃ½ má»™t entry tá»« webhook.
        
        Entry cÃ³ thá»ƒ chá»©a:
        - messaging: Messenger events
        - changes: Page changes (posts, comments)
        - leadgen: Lead ads submissions
        """
        # Process messaging events
        if 'messaging' in entry:
            for event in entry['messaging']:
                self._process_messaging_event(event)
        
        # Process changes (posts, comments, etc.)
        if 'changes' in entry:
            for change in entry['changes']:
                self._process_change_event(change)
    
    def _process_messaging_event(self, event):
        """
        Xá»­ lÃ½ messaging events.
        
        Event types:
        - message: Tin nháº¯n má»›i
        - postback: User click button
        - read: User Ä‘Ã£ Ä‘á»c
        - delivery: Tin Ä‘Ã£ gá»­i
        """
        sender_id = event.get('sender', {}).get('id')
        recipient_id = event.get('recipient', {}).get('id')
        
        if not sender_id or not recipient_id:
            return
        
        # Find or create conversation
        conversation = self._find_or_create_conversation(sender_id, recipient_id)
        
        # Handle message
        if 'message' in event:
            self._handle_message(conversation, event['message'], sender_id)
        
        # Handle postback
        elif 'postback' in event:
            self._handle_postback(conversation, event['postback'], sender_id)
        
        # Handle read
        elif 'read' in event:
            self._handle_read(conversation, event['read'])
    
    def _process_change_event(self, change):
        """
        Xá»­ lÃ½ change events (posts, comments, reactions).
        
        Change types:
        - feed: Post created/updated
        - comments: New comment
        - reactions: New reaction
        - leadgen: Lead form submission (NEW)
        """
        field = change.get('field')
        value = change.get('value')
        
        if field == 'leadgen':
            # NEW: Handle lead generation
            self._handle_leadgen_event(value)
        
        elif field == 'feed':
            self._handle_feed_event(value)
        
        elif field == 'comments':
            self._handle_comment_event(value)
    
    # -------------------------------------------------------------------------
    # MESSAGE HANDLERS
    # -------------------------------------------------------------------------
    
    def _handle_message(self, conversation, message_data, sender_id):
        """
        Xá»­ lÃ½ tin nháº¯n má»›i.
        
        Actions:
        1. LÆ°u message vÃ o database
        2. Check chatbot flow
        3. Auto-reply náº¿u cáº§n
        """
        mid = message_data.get('mid')
        text = message_data.get('text', '')
        attachments = message_data.get('attachments', [])
        
        # Check duplicate
        existing = request.env['social.message'].sudo().search([
            ('message_id', '=', mid)
        ], limit=1)
        
        if existing:
            _logger.debug(f'Message {mid} already exists')
            return
        
        # Create message record
        message_vals = {
            'conversation_id': conversation.id,
            'message_id': mid,
            'message': text,
            'is_from_customer': True,
            'facebook_user_id': sender_id,
            'account_id': conversation.account_id.id,
            'company_id': conversation.company_id.id,
        }
        
        if attachments:
            message_vals['attachments'] = json.dumps(attachments)
        
        msg_record = request.env['social.message'].sudo().create(message_vals)
        
        _logger.info(f'Created message {msg_record.id} for conversation {conversation.id}')
        
        # Process chatbot flow
        self._process_chatbot(conversation, text)
        
        # Auto-create lead if enabled
        self._auto_create_lead(conversation)
    
    def _handle_postback(self, conversation, postback_data, sender_id):
        """
        Xá»­ lÃ½ postback tá»« button clicks.
        
        Postback payload format: PRODUCT_123, CONFIRM_YES, etc.
        """
        payload = postback_data.get('payload', '')
        title = postback_data.get('title', '')
        
        _logger.info(f'Postback received - payload: {payload}, title: {title}')
        
        # Process as chatbot message (treat payload as user input)
        self._process_chatbot(conversation, payload)
    
    def _handle_read(self, conversation, read_data):
        """Handle read receipts"""
        watermark = read_data.get('watermark')
        _logger.debug(f'Message read - watermark: {watermark}')
        # Optional: Update message read status
    
    # -------------------------------------------------------------------------
    # LEADGEN HANDLER (NEW)
    # -------------------------------------------------------------------------
    
    def _handle_leadgen_event(self, leadgen_data):
        """
        Xá»­ lÃ½ lead form submissions tá»« Facebook Lead Ads.
        
        Data structure:
        {
            'ad_id': '123',
            'form_id': '456',
            'leadgen_id': '789',
            'created_time': 1234567890,
            'page_id': 'PAGE_ID',
            'adgroup_id': '...'
        }
        
        Flow:
        1. Fetch lead data tá»« Graph API
        2. Parse fields (name, phone, email)
        3. Check duplicate
        4. Create crm.lead
        """
        leadgen_id = leadgen_data.get('leadgen_id')
        page_id = leadgen_data.get('page_id')
        
        if not leadgen_id or not page_id:
            _logger.warning('Missing leadgen_id or page_id')
            return
        
        # Find Facebook account
        account = request.env['social.account'].sudo().search([
            ('facebook_id', '=', page_id)
        ], limit=1)
        
        if not account or not account.access_token:
            _logger.error(f'No account found for page {page_id}')
            return
        
        # Fetch lead data from Graph API
        try:
            from odoo.addons.module_social_facebook.lib import facebook_api
            api = facebook_api.FacebookAPI(account.access_token)
            
            lead_data = api.get_leadgen_data(leadgen_id)
            
            # Parse field data
            field_data = {}
            for field in lead_data.get('field_data', []):
                field_name = field.get('name')
                field_value = field.get('values', [None])[0]
                field_data[field_name] = field_value
            
            # Extract common fields
            name = field_data.get('full_name') or field_data.get('first_name', 'Unknown')
            phone = field_data.get('phone_number') or field_data.get('phone')
            email = field_data.get('email')
            
            # Check duplicate
            existing_lead = request.env['crm.lead'].sudo().search([
                ('phone', '=', phone),
                ('type', '=', 'lead'),
            ], limit=1)
            
            if existing_lead:
                _logger.info(f'Lead already exists for phone {phone}')
                existing_lead.message_post(
                    body=f'Duplicate lead form submission from Facebook: {leadgen_id}'
                )
                return
            
            # Create crm.lead
            lead_vals = {
                'name': f'Facebook Lead: {name}',
                'contact_name': name,
                'phone': phone,
                'email_from': email,
                'type': 'lead',
                'source_id': self._get_facebook_source(),
                'description': f'Lead from Facebook Lead Ads\nForm ID: {leadgen_data.get("form_id")}\nLead ID: {leadgen_id}\n\nFields:\n{json.dumps(field_data, indent=2)}',
                'company_id': account.company_id.id,
            }
            
            lead = request.env['crm.lead'].sudo().create(lead_vals)
            
            _logger.info(f'Created lead {lead.id} from Facebook leadgen {leadgen_id}')
            
            # Assign to default user if configured
            default_user_id = request.env['ir.config_parameter'].sudo().get_param(
                'module_social_facebook.lead_default_user_id'
            )
            if default_user_id:
                lead.user_id = int(default_user_id)
            
        except Exception as e:
            _logger.error(f'Failed to process leadgen {leadgen_id}: {e}', exc_info=True)
    
    def _get_facebook_source(self):
        """Get or create Facebook source"""
        Source = request.env['utm.source'].sudo()
        source = Source.search([('name', '=', 'Facebook')], limit=1)
        if not source:
            source = Source.create({'name': 'Facebook'})
        return source.id
    
    # -------------------------------------------------------------------------
    # CHATBOT FLOW
    # -------------------------------------------------------------------------
    
    def _process_chatbot(self, conversation, user_message):
        """
        Xá»­ lÃ½ chatbot flow.
        
        Gá»i conversation.process_chatbot_flow() vÃ  gá»­i reply.
        """
        chatbot_enabled = request.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.chatbot_enabled', 'False'
        )
        
        if chatbot_enabled != 'True':
            return
        
        try:
            # Process chatbot logic
            response = conversation.process_chatbot_flow(user_message)
            
            if response:
                # Send message
                conversation.send_chatbot_message(response)
                
        except Exception as e:
            _logger.error(f'Chatbot error: {e}', exc_info=True)
    
    # -------------------------------------------------------------------------
    # AUTO LEAD CREATION
    # -------------------------------------------------------------------------
    
    def _auto_create_lead(self, conversation):
        """
        Tá»± Ä‘á»™ng táº¡o lead tá»« conversation náº¿u enabled.
        
        Conditions:
        - auto_create_lead = True
        - Conversation chÆ°a cÃ³ lead_id
        - CÃ³ Ä‘á»§ thÃ´ng tin (name, phone)
        """
        auto_create = request.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.auto_create_lead', 'False'
        )
        
        if auto_create != 'True':
            return
        
        if conversation.lead_id:
            return  # Already has lead
        
        if not conversation.customer_name or not conversation.customer_phone:
            return  # Not enough info
        
        try:
            lead = conversation.create_lead_from_conversation()
            if lead:
                _logger.info(f'Auto-created lead {lead.id} from conversation {conversation.id}')
        except Exception as e:
            _logger.error(f'Failed to auto-create lead: {e}')
    
    # -------------------------------------------------------------------------
    # FEED/COMMENT HANDLERS
    # -------------------------------------------------------------------------
    
    def _handle_feed_event(self, feed_data):
        """Handle post events"""
        # Existing implementation from original module
        pass
    
    def _handle_comment_event(self, comment_data):
        """Handle comment events"""
        # Existing implementation from original module
        pass
    
    # -------------------------------------------------------------------------
    # HELPERS
    # -------------------------------------------------------------------------
    
    def _find_or_create_conversation(self, sender_id, recipient_id):
        """
        TÃ¬m hoáº·c táº¡o conversation.
        
        Args:
            sender_id (str): Facebook user PSID
            recipient_id (str): Facebook page ID
        
        Returns:
            social.message: Conversation record
        """
        # Find account by Facebook page ID
        account = request.env['social.account'].sudo().search([
            ('facebook_id', '=', recipient_id)
        ], limit=1)
        
        if not account:
            _logger.error(f'No account found for page {recipient_id}')
            return None
        
        # Find existing conversation
        conversation = request.env['social.message'].sudo().search([
            ('facebook_user_id', '=', sender_id),
            ('account_id', '=', account.id),
        ], limit=1)
        
        if conversation:
            return conversation
        
        # Create new conversation
        conv_vals = {
            'facebook_user_id': sender_id,
            'account_id': account.id,
            'company_id': account.company_id.id,
            'chatbot_state': 'idle',  # NEW
        }
        
        conversation = request.env['social.message'].sudo().create(conv_vals)
        
        _logger.info(f'Created new conversation {conversation.id} for user {sender_id}')
        
        return conversation



################################################################################
## FILE 7: chatbot_data.xml
## ÄÆ°á»ng dáº«n: data/chatbot_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!-- Sequence cho Messenger Orders -->
        <record id="seq_social_messenger_order" model="ir.sequence">
            <field name="name">Messenger Order</field>
            <field name="code">social.messenger.order</field>
            <field name="prefix">MO</field>
            <field name="padding">5</field>
            <field name="number_next">1</field>
            <field name="number_increment">1</field>
        </record>

        <!-- Default Chatbot Welcome Message -->
        <record id="default_chatbot_welcome_message" model="ir.config_parameter">
            <field name="key">module_social_facebook.chatbot_welcome_message</field>
            <field name="value">Xin chÃ o! ğŸ‘‹

TÃ´i lÃ  trá»£ lÃ½ bÃ¡n hÃ ng tá»± Ä‘á»™ng cá»§a chÃºng tÃ´i. Ráº¥t vui Ä‘Æ°á»£c phá»¥c vá»¥ báº¡n!

Äá»ƒ báº¯t Ä‘áº§u, báº¡n vui lÃ²ng cho tÃ´i biáº¿t tÃªn cá»§a báº¡n? ğŸ˜Š</field>
        </record>

        <!-- Default Verify Token -->
        <record id="default_verify_token" model="ir.config_parameter">
            <field name="key">module_social_facebook.verify_token</field>
            <field name="value">16112005</field>
        </record>

        <!-- Default Ngrok Path -->
        <record id="default_ngrok_path" model="ir.config_parameter">
            <field name="key">module_social_facebook.ngrok_path</field>
            <field name="value">C:/ngrok/ngrok.exe</field>
        </record>

    </data>
</odoo>



################################################################################
## FILE 8: facebook_post_template_data.xml
## ÄÆ°á»ng dáº«n: data/facebook_post_template_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!-- TEMPLATE BÃ€I ÄÄ‚NG MáºªU -->

        <record id="template_new_product_launch" model="social.post.template">
            <field name="name">ğŸš€ Ra Máº¯t Sáº£n Pháº©m Má»›i</field>
            <field name="template_type">product_launch</field>
            <field name="content"><![CDATA[ğŸ‰ EXCITING NEWS! ğŸ‰

We're thrilled to announce our latest product: {{product_name}}!

âœ¨ Key Features:
{{feature_list}}

ğŸ’° Special Launch Price: {{price}}
ğŸ Limited time offer: {{offer_details}}

ğŸ‘‰ Shop now: {{shop_link}}

#NewProduct #Launch #{{company_name}}]]></field>
        </record>

        <record id="template_flash_sale" model="social.post.template">
            <field name="name">âš¡ Flash Sale</field>
            <field name="template_type">promotion</field>
            <field name="content"><![CDATA[âš¡ FLASH SALE ALERT! âš¡

ğŸ”¥ {{discount_percentage}}% OFF on {{product_category}}!

â° Hurry! Only {{hours_left}} hours left!
ğŸ›’ Shop now: {{shop_link}}

Don't miss out on this amazing deal! ğŸ¯

#FlashSale #Discount #LimitedOffer #{{company_name}}]]></field>
        </record>

        <record id="template_customer_testimonial" model="social.post.template">
            <field name="name">ğŸ’¬ ÄÃ¡nh GiÃ¡ KhÃ¡ch HÃ ng</field>
            <field name="template_type">testimonial</field>
            <field name="content"><![CDATA[â­â­â­â­â­

"{{testimonial_text}}"

- {{customer_name}}

Thank you for your amazing feedback! ğŸ’™

We love hearing from our satisfied customers. Your trust means the world to us! ğŸ™

#CustomerLove #Testimonial #{{company_name}}]]></field>
        </record>

        <record id="template_weekly_tips" model="social.post.template">
            <field name="name">ğŸ’¡ Tips HÃ ng Tuáº§n</field>
            <field name="template_type">educational</field>
            <field name="content"><![CDATA[ğŸ’¡ TIP OF THE WEEK ğŸ’¡

{{tip_title}}

{{tip_description}}

ğŸ‘‰ Try it out and let us know your results!

Have questions? Drop them in the comments below! ğŸ‘‡

#Tips #DidYouKnow #{{company_name}}]]></field>
        </record>

        <record id="template_behind_the_scenes" model="social.post.template">
            <field name="name">ğŸ¬ Behind The Scenes</field>
            <field name="template_type">engagement</field>
            <field name="content"><![CDATA[ğŸ¬ BEHIND THE SCENES ğŸ¬

Ever wondered how we {{process_description}}?

Here's a sneak peek into our {{department_name}} team! ğŸ‘€

{{additional_details}}

Drop a â¤ï¸ if you'd like to see more behind-the-scenes content!

#BehindTheScenes #TeamWork #{{company_name}}]]></field>
        </record>

        <record id="template_event_announcement" model="social.post.template">
            <field name="name">ğŸ“… ThÃ´ng BÃ¡o Sá»± Kiá»‡n</field>
            <field name="template_type">event</field>
            <field name="content"><![CDATA[ğŸ“… SAVE THE DATE! ğŸ“…

{{event_name}}

ğŸ“ Location: {{location}}
ğŸ—“ï¸ Date: {{event_date}}
â° Time: {{event_time}}

{{event_description}}

ğŸŸï¸ Register now: {{registration_link}}

Limited seats available! Don't miss out! ğŸ¯

#Event #SaveTheDate #{{company_name}}]]></field>
        </record>

    </data>
</odoo>



################################################################################
## FILE 9: ir_cron_data.xml
## ÄÆ°á»ng dáº«n: data/ir_cron_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- CRON JOBS - Facebook Synchronization -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->

    <!-- Cron: Sync Facebook Posts -->
    <record id="cron_sync_facebook_posts" model="ir.cron">
        <field name="name">Facebook: Sync Posts</field>
        <field name="model_id" ref="model_social_post"/>
        <field name="state">code</field>
        <field name="code">model._cron_sync_posts()</field>
        <field name="interval_number">15</field>
        <field name="interval_type">minutes</field>
        <field name="active">True</field>
    </record>

    <!-- Cron: Sync Facebook Comments -->
    <record id="cron_sync_facebook_comments" model="ir.cron">
        <field name="name">Facebook: Sync Comments</field>
        <field name="model_id" ref="model_social_comment"/>
        <field name="state">code</field>
        <field name="code">model._cron_sync_comments()</field>
        <field name="interval_number">10</field>
        <field name="interval_type">minutes</field>
        <field name="active">True</field>
    </record>

    <!-- Cron: Publish Scheduled Posts -->
    <record id="cron_publish_scheduled_posts" model="ir.cron">
        <field name="name">Facebook: Publish Scheduled Posts</field>
        <field name="model_id" ref="model_social_post"/>
        <field name="state">code</field>
        <field name="code">model._cron_publish_scheduled_posts()</field>
        <field name="interval_number">5</field>
        <field name="interval_type">minutes</field>
        <field name="active">True</field>
    </record>

    <!-- 
    NOTE: Ngrok health check Ä‘Ã£ bá»‹ XÃ“A
    LÃ½ do: Odoo 19 cáº¥m opcode IMPORT_NAME trong cron code
    Náº¿u cáº§n kiá»ƒm tra ngrok, dÃ¹ng external monitoring tool
    -->

</odoo>



################################################################################
## FILE 10: mail_template_data.xml
## ÄÆ°á»ng dáº«n: data/mail_template_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!-- EMAIL NOTIFICATION TEMPLATES -->

        <record id="mail_template_post_published" model="mail.template">
            <field name="name">Social Facebook: Post Published</field>
            <field name="model_id" ref="model_social_post"/>
            <field name="subject">Your Facebook post has been published</field>
            <field name="body_html"><![CDATA[
<div style="font-family: Arial, sans-serif;">
    <h3>Post Published Successfully!</h3>
    <p>Your post has been published to Facebook:</p>
    <blockquote style="border-left: 3px solid #1877f2; padding-left: 10px;">
        ${object.content}
    </blockquote>
    <p>
        <strong>Page:</strong> ${object.account_id.name}<br/>
        <strong>Published:</strong> ${object.published_date}<br/>
    </p>
    <p><a href="${object.facebook_post_url}" style="color: #1877f2;">View on Facebook</a></p>
</div>
            ]]></field>
        </record>

        <record id="mail_template_new_comment" model="mail.template">
            <field name="name">Social Facebook: New Comment</field>
            <field name="model_id" ref="model_social_comment"/>
            <field name="subject">New comment on your Facebook post</field>
            <field name="body_html"><![CDATA[
<div style="font-family: Arial, sans-serif;">
    <h3>New Comment Received!</h3>
    <p><strong>${object.author_name}</strong> commented:</p>
    <blockquote style="border-left: 3px solid #1877f2; padding-left: 10px;">
        ${object.message}
    </blockquote>
    <p>On post: "${object.post_id.content[:100]}..."</p>
    <p><a href="/web#id=${object.id}&model=social.comment" style="color: #1877f2;">Reply in Odoo</a></p>
</div>
            ]]></field>
        </record>

    </data>
</odoo>



################################################################################
## FILE 11: user_groups_data.xml
## ÄÆ°á»ng dáº«n: data/user_groups_data.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ThÃªm Admin vÃ o groups Social Facebook -->
    <record id="base.user_admin" model="res.users">
        <field name="group_ids" eval="[(4, ref('module_social_facebook.group_social_manager'))]"/>
    </record>

</odoo>




################################################################################
## FILE 12: generate_doc_3.py
## ÄÆ°á»ng dáº«n: generate_doc_3.py
################################################################################

import os
import datetime

# -------------------------------------------------------------
# CONFIG
# -------------------------------------------------------------
OUTPUT_NAME = None  # None -> tá»± Ä‘áº·t tÃªn theo thÆ° má»¥c module

# ThÆ° má»¥c bá»‹ loáº¡i trá»« á»Ÿ má»i cáº¥p
EXCLUDED_DIRS = {"__pycache__"}


# -------------------------------------------------------------
# HÃ€M Táº O BANNER
# -------------------------------------------------------------
def make_banner(module_name):
    banner = f"""
################################################################################
#                      {module_name.upper():<50}#
#                   ODOO MODULE DOCUMENTATION GENERATOR                     #
#                           Version 1.2.0 - Enterprise Style                #
################################################################################
"""
    return banner


# -------------------------------------------------------------
# HÃ€M QUÃ‰T FILES (Bá» QUA __pycache__)
# -------------------------------------------------------------
def scan_files(root):
    file_list = []

    for base, dirs, files in os.walk(root):
        # ğŸ”¥ CHáº¶N __pycache__ á» Má»ŒI Cáº¤P
        dirs[:] = [d for d in dirs if d not in EXCLUDED_DIRS]

        dirs.sort()
        files.sort()

        for f in files:
            full_path = os.path.join(base, f)
            rel = os.path.relpath(full_path, root).replace("\\", "/")
            file_list.append(rel)

    return file_list


# -------------------------------------------------------------
# HÃ€M XÃC Äá»ŠNH LOáº I FILE
# -------------------------------------------------------------
def detect_type(file):
    ext = file.lower().split(".")[-1]
    if ext == "py":
        return "Python"
    if ext == "xml":
        return "XML"
    if ext == "csv":
        return "CSV"
    if ext == "js":
        return "JS"
    if ext == "css":
        return "CSS"
    if ext in ["png", "jpg", "jpeg", "svg"]:
        return "Image"
    return "Other"


# -------------------------------------------------------------
# HÃ€M SINH CÃ‚Y THÆ¯ Má»¤C Dáº NG TREE (ASCII)
# -------------------------------------------------------------
def generate_directory_tree(files):
    """
    Sinh cÃ¢y thÆ° má»¥c dáº¡ng ASCII tá»« danh sÃ¡ch file path
    """
    if not files:
        return ""

    # XÃ¢y dá»±ng cáº¥u trÃºc cÃ¢y dáº¡ng dict
    tree = {}
    for path in files:
        parts = path.split("/")
        current = tree
        for part in parts:
            current = current.setdefault(part, {})

    lines = []

    def render(node, prefix="", is_root=True):
        items = list(node.items())
        for i, (name, children) in enumerate(items):
            is_last = (i == len(items) - 1)

            if is_root:
                connector = ""
                new_prefix = ""
            else:
                connector = "â””â”€â”€ " if is_last else "â”œâ”€â”€ "
                new_prefix = prefix + ("    " if is_last else "â”‚   ")

            icon = "ğŸ“" if children else "ğŸ“„"
            lines.append(f"{prefix}{connector}{icon} {name}")

            if children:
                render(children, new_prefix, is_root=False)

    render(tree)

    output = []
    output.append("================================================================================")
    output.append("                                ğŸ“‚ DIRECTORY TREE")
    output.append("================================================================================")
    output.append("\n".join(lines))
    output.append("\n")

    return "\n".join(output)


# -------------------------------------------------------------
# HÃ€M SINH Cáº¤U TRÃšC THÆ¯ Má»¤C Dáº NG STT (GIá»® NGUYÃŠN)
# -------------------------------------------------------------
def generate_tree(files, root):
    lines = []
    counter = 1

    lines.append("================================================================================")
    lines.append(f"                              Cáº¤U TRÃšC THÆ¯ Má»¤C - {len(files)} FILES")
    lines.append("================================================================================\n")

    for f in files:
        lines.append(f"{counter:>3}.  {f}")
        counter += 1

    lines.append("\n")
    return "\n".join(lines)


# -------------------------------------------------------------
# HÃ€M SINH Báº¢NG Tá»”NG Káº¾T FILES
# -------------------------------------------------------------
def generate_summary(files):
    lines = []

    lines.append("================================================================================")
    lines.append(f"                         Báº¢NG Tá»”NG Káº¾T {len(files)} FILES")
    lines.append("================================================================================")
    lines.append("â”‚  #  â”‚ ÄÆ°á»ng dáº«n file                                     â”‚ Loáº¡i     â”‚")
    lines.append("â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")

    idx = 1
    for f in files:
        ftype = detect_type(f)
        lines.append(f"â”‚ {idx:<3} â”‚ {f:<50} â”‚ {ftype:<8} â”‚")
        idx += 1

    lines.append("\n")
    return "\n".join(lines)


# -------------------------------------------------------------
# HÃ€M Äá»ŒC Ná»˜I DUNG FILE
# -------------------------------------------------------------
def read_file(fullpath):
    try:
        with open(fullpath, "r", encoding="utf-8") as f:
            return f.read()
    except:
        return "[KhÃ´ng Ä‘á»c Ä‘Æ°á»£c file â€“ cÃ³ thá»ƒ lÃ  binary hoáº·c lá»—i mÃ£ hÃ³a]"


# -------------------------------------------------------------
# HÃ€M SINH Ná»˜I DUNG CÃC FILE
# -------------------------------------------------------------
def generate_file_contents(files, root):
    lines = []

    lines.append("\n================================================================================")
    lines.append("                              Ná»˜I DUNG CÃC FILES")
    lines.append("================================================================================\n")

    idx = 1
    for f in files:
        fullpath = os.path.join(root, f)

        lines.append("################################################################################")
        lines.append(f"## FILE {idx}: {os.path.basename(f)}")
        lines.append(f"## ÄÆ°á»ng dáº«n: {f}")
        lines.append("################################################################################\n")

        content = read_file(fullpath)
        lines.append(content)
        lines.append("\n\n")

        idx += 1

    return "\n".join(lines)


# -------------------------------------------------------------
# MAIN
# -------------------------------------------------------------
def main():
    root = os.path.dirname(os.path.abspath(__file__))
    module_name = os.path.basename(root)

    now = datetime.datetime.now().strftime("%Y-%m-%d_%Hh%M")
    output_file = OUTPUT_NAME or f"{module_name}_DOCUMENTATION_{now}.txt"

    files = scan_files(root)
    files = sorted(files)

    output = []
    output.append(make_banner(module_name))
    output.append(generate_directory_tree(files))   # ğŸŒ³ CÃ‚Y THÆ¯ Má»¤C (Má»šI)
    output.append(generate_tree(files, root))       # ğŸ“„ DANH SÃCH FILE
    output.append(generate_summary(files))           # ğŸ“Š Báº¢NG Tá»”NG Káº¾T
    output.append(generate_file_contents(files, root))

    with open(output_file, "w", encoding="utf-8") as f:
        f.write("\n".join(output))

    print(f"\nDONE! File generated: {output_file}")


if __name__ == "__main__":
    main()




################################################################################
## FILE 13: __init__.py
## ÄÆ°á»ng dáº«n: lib/__init__.py
################################################################################

from . import facebook_api



################################################################################
## FILE 14: facebook_api.py
## ÄÆ°á»ng dáº«n: lib/facebook_api.py
################################################################################

# -*- coding: utf-8 -*-

import requests
import logging

_logger = logging.getLogger(__name__)


class FacebookAPI:
    """
    Wrapper for Facebook Graph API.
    Version: v18.0
    """
    
    API_VERSION = 'v18.0'
    BASE_URL = f'https://graph.facebook.com/{API_VERSION}'
    
    def __init__(self, access_token):
        """
        Initialize API wrapper.
        
        Args:
            access_token (str): Page Access Token
        """
        self.access_token = access_token
    
    # -------------------------------------------------------------------------
    # EXISTING METHODS (from original module)
    # -------------------------------------------------------------------------
    
    def get_page_info(self, page_id):
        """Get page information"""
        url = f"{self.BASE_URL}/{page_id}"
        params = {
            'access_token': self.access_token,
            'fields': 'id,name,category,picture,fan_count,link'
        }
        response = requests.get(url, params=params)
        return response.json()
    
    def publish_post(self, page_id, message, **kwargs):
        """Publish a post to page"""
        url = f"{self.BASE_URL}/{page_id}/feed"
        data = {
            'access_token': self.access_token,
            'message': message,
        }
        data.update(kwargs)
        response = requests.post(url, data=data)
        return response.json()
    
    def send_message(self, recipient_id, message):
        """
        Send message via Messenger.
        
        Args:
            recipient_id (str): PSID of recipient
            message (dict): Message object
                {
                    'text': 'Hello',
                    'quick_replies': [...]  (optional)
                }
        
        Returns:
            dict: API response
        """
        url = f"{self.BASE_URL}/me/messages"
        data = {
            'access_token': self.access_token,
            'recipient': {'id': recipient_id},
            'message': message,
        }
        response = requests.post(url, json=data)
        return response.json()
    
    def get_conversation_messages(self, conversation_id, limit=25):
        """Get messages from a conversation"""
        url = f"{self.BASE_URL}/{conversation_id}"
        params = {
            'access_token': self.access_token,
            'fields': f'messages.limit({limit}){{id,created_time,from,to,message}}'
        }
        response = requests.get(url, params=params)
        return response.json()
    
    # -------------------------------------------------------------------------
    # NEW: LEADGEN API
    # -------------------------------------------------------------------------
    
    def get_leadgen_data(self, leadgen_id):
        """
        Láº¥y dá»¯ liá»‡u lead form tá»« Facebook.
        
        Endpoint: /{leadgen_id}
        Fields: field_data (contains name, phone, email, etc.)
        
        Args:
            leadgen_id (str): Lead generation ID from webhook
        
        Returns:
            dict: Lead data
                {
                    'id': '123',
                    'created_time': '2025-01-01T10:00:00+0000',
                    'field_data': [
                        {'name': 'full_name', 'values': ['John Doe']},
                        {'name': 'phone_number', 'values': ['+1234567890']},
                        {'name': 'email', 'values': ['john@example.com']},
                    ]
                }
        """
        url = f"{self.BASE_URL}/{leadgen_id}"
        params = {
            'access_token': self.access_token,
            'fields': 'id,created_time,field_data'
        }
        
        try:
            response = requests.get(url, params=params, timeout=10)
            response.raise_for_status()
            data = response.json()
            
            _logger.info(f'Successfully fetched leadgen data for {leadgen_id}')
            return data
            
        except requests.exceptions.RequestException as e:
            _logger.error(f'Failed to fetch leadgen {leadgen_id}: {e}')
            raise
    
    def get_leadgen_forms(self, page_id):
        """
        Láº¥y danh sÃ¡ch lead forms cá»§a page.
        
        Args:
            page_id (str): Facebook Page ID
        
        Returns:
            list: List of lead forms
        """
        url = f"{self.BASE_URL}/{page_id}/leadgen_forms"
        params = {
            'access_token': self.access_token,
            'fields': 'id,name,status,questions'
        }
        
        try:
            response = requests.get(url, params=params, timeout=10)
            response.raise_for_status()
            data = response.json()
            
            return data.get('data', [])
            
        except requests.exceptions.RequestException as e:
            _logger.error(f'Failed to fetch leadgen forms: {e}')
            return []
    
    # -------------------------------------------------------------------------
    # MESSENGER PROFILE API
    # -------------------------------------------------------------------------
    
    def set_get_started_button(self, payload='GET_STARTED'):
        """
        Set Get Started button for Messenger.
        
        Args:
            payload (str): Postback payload when button clicked
        """
        url = f"{self.BASE_URL}/me/messenger_profile"
        data = {
            'access_token': self.access_token,
            'get_started': {'payload': payload}
        }
        response = requests.post(url, json=data)
        return response.json()
    
    def set_greeting_text(self, greeting_text):
        """
        Set greeting text for Messenger.
        
        Args:
            greeting_text (str): Greeting message
        """
        url = f"{self.BASE_URL}/me/messenger_profile"
        data = {
            'access_token': self.access_token,
            'greeting': [
                {
                    'locale': 'default',
                    'text': greeting_text
                }
            ]
        }
        response = requests.post(url, json=data)
        return response.json()



################################################################################
## FILE 15: __init__.py
## ÄÆ°á»ng dáº«n: models/__init__.py
################################################################################

# -*- coding: utf-8 -*-

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# QUAN TRá»ŒNG: THá»¨ Tá»° IMPORT MODELS
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Quy táº¯c: Base models TRÆ¯á»šC, Extended models SAU
# Models cÃ³ dependencies pháº£i load SAU models Ä‘Æ°á»£c reference
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# -------------------------------------------------------------------------
# STEP 1: Core Odoo models extension (khÃ´ng dependencies)
# -------------------------------------------------------------------------
from . import res_company
from . import res_config_settings

# -------------------------------------------------------------------------
# STEP 2: Base Social models (foundation - Ä‘Æ°á»£c reference bá»Ÿi models khÃ¡c)
# -------------------------------------------------------------------------
from . import social_account        # Base: Facebook Pages
from . import social_post           # Depends: social_account
from . import social_post_template  # Depends: social_account, social_post
from . import social_comment        # Depends: social_account, social_post
from . import social_message        # Base: Conversations & Messages (â— QUAN TRá»ŒNG)

# âœ… THÃŠM Má»šI: Conversation model (pháº£i load SAU social_message)
from . import social_conversation   # Depends: social_account, social_message

from . import social_analytics      # Depends: social_account, social_post

# -------------------------------------------------------------------------
# STEP 3: Extended/New Social models (reference base models)
# -------------------------------------------------------------------------
from . import social_messenger_product  # Depends: product.product
from . import social_messenger_order    # Depends: social_message â† ÄÃ‚Y!

# -------------------------------------------------------------------------
# STEP 4: CRM Integration (reference social models)
# -------------------------------------------------------------------------
from . import crm_lead  # Depends: social_message â† ÄÃ‚Y!



################################################################################
## FILE 16: crm_lead.py
## ÄÆ°á»ng dáº«n: models/crm_lead.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _


class CrmLead(models.Model):
    """
    Má»Ÿ rá»™ng crm.lead Ä‘á»ƒ link vá»›i Facebook conversations.
    """
    _inherit = 'crm.lead'
    
    # Link to Facebook
    facebook_conversation_id = fields.Many2one(
        'social.message',
        string='Facebook Conversation',
        ondelete='set null',
        help='Conversation Messenger táº¡o ra lead nÃ y',
    )
    facebook_user_id = fields.Char(
        string='Facebook User ID',
        help='PSID cá»§a khÃ¡ch hÃ ng',
    )
    
    # Statistics
    messenger_message_count = fields.Integer(
        string='Messenger Messages',
        compute='_compute_messenger_stats',
        help='Sá»‘ tin nháº¯n trong conversation',
    )
    
    def _compute_messenger_stats(self):
        """TÃ­nh sá»‘ tin nháº¯n Messenger"""
        for lead in self:
            if lead.facebook_conversation_id:
                messages = self.env['social.message'].search_count([
                    ('conversation_id', '=', lead.facebook_conversation_id.id)
                ])
                lead.messenger_message_count = messages
            else:
                lead.messenger_message_count = 0
    
    def action_view_messenger_conversation(self):
        """Xem conversation Messenger"""
        self.ensure_one()
        if not self.facebook_conversation_id:
            return {'type': 'ir.actions.act_window_close'}
        
        return {
            'name': _('Messenger Conversation'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.message',
            'res_id': self.facebook_conversation_id.id,
            'view_mode': 'form',
            'target': 'current',
        }



################################################################################
## FILE 17: res_company.py
## ÄÆ°á»ng dáº«n: models/res_company.py
################################################################################

from odoo import models, fields


class ResCompany(models.Model):
    _inherit = 'res.company'

    facebook_app_id = fields.Char(
        string='Facebook App ID',
        help='Facebook App ID for authentication'
    )
    
    facebook_app_secret = fields.Char(
        string='Facebook App Secret',
        help='Facebook App Secret for authentication'
    )
    
    facebook_webhook_verify_token = fields.Char(
        string='Webhook Verify Token',
        help='Token for Facebook webhook verification'
    )




################################################################################
## FILE 18: res_config_settings.py
## ÄÆ°á»ng dáº«n: models/res_config_settings.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _
from odoo.exceptions import UserError
import subprocess
import requests
import logging
import os

_logger = logging.getLogger(__name__)


class ResConfigSettings(models.TransientModel):
    _inherit = 'res.config.settings'
    
    # -------------------------------------------------------------------------
    # FACEBOOK WEBHOOK CONFIG
    # -------------------------------------------------------------------------
    
    facebook_verify_token = fields.Char(
        string='Webhook Verify Token',
        config_parameter='module_social_facebook.verify_token',
        help='Token Ä‘á»ƒ verify webhook tá»« Facebook (GET request)',
    )
    facebook_webhook_url = fields.Char(
        string='Webhook URL',
        compute='_compute_webhook_url',
        help='URL webhook hiá»‡n táº¡i (localhost hoáº·c ngrok)',
    )
    
    # -------------------------------------------------------------------------
    # NGROK CONFIG
    # -------------------------------------------------------------------------
    
    ngrok_executable_path = fields.Char(
        string='Ngrok Executable Path',
        config_parameter='module_social_facebook.ngrok_path',
        default='C:/ngrok/ngrok.exe',
        help='ÄÆ°á»ng dáº«n Ä‘áº§y Ä‘á»§ tá»›i file ngrok.exe',
    )
    ngrok_tunnel_url = fields.Char(
        string='Ngrok Public URL',
        compute='_compute_ngrok_tunnel_url',
        help='URL cÃ´ng khai tá»« ngrok (https)',
    )
    ngrok_is_running = fields.Boolean(
        string='Ngrok Running',
        compute='_compute_ngrok_is_running',
        help='Tráº¡ng thÃ¡i ngrok',
    )
    
    # -------------------------------------------------------------------------
    # CRM INTEGRATION CONFIG
    # -------------------------------------------------------------------------
    
    auto_create_lead = fields.Boolean(
        string='Auto Create Leads',
        config_parameter='module_social_facebook.auto_create_lead',
        default=True,
        help='Tá»± Ä‘á»™ng táº¡o crm.lead tá»« Messenger conversations',
    )
    lead_default_user_id = fields.Many2one(
        'res.users',
        string='Default Salesperson',
        config_parameter='module_social_facebook.lead_default_user_id',
        help='NgÆ°á»i Ä‘Æ°á»£c assign lead máº·c Ä‘á»‹nh',
    )
    
    # -------------------------------------------------------------------------
    # CHATBOT CONFIG
    # -------------------------------------------------------------------------
    
    chatbot_enabled = fields.Boolean(
        string='Enable Sales Chatbot',
        config_parameter='module_social_facebook.chatbot_enabled',
        default=False,
        help='Báº­t chatbot bÃ¡n hÃ ng tá»± Ä‘á»™ng qua Messenger',
    )
    chatbot_welcome_message = fields.Text(
        string='Welcome Message',
        config_parameter='module_social_facebook.chatbot_welcome_message',
        default='Xin chÃ o! TÃ´i lÃ  trá»£ lÃ½ bÃ¡n hÃ ng tá»± Ä‘á»™ng. ğŸ˜Š\nBáº¡n vui lÃ²ng cho tÃ´i biáº¿t tÃªn cá»§a báº¡n?',
        help='Tin nháº¯n chÃ o má»«ng khi báº¯t Ä‘áº§u flow',
    )
    
    # -------------------------------------------------------------------------
    # COMPUTE METHODS
    # -------------------------------------------------------------------------
    
    @api.depends('ngrok_tunnel_url')
    def _compute_webhook_url(self):
        """TÃ­nh toÃ¡n webhook URL (ngrok hoáº·c localhost)"""
        for record in self:
            base_url = record.ngrok_tunnel_url or self.env['ir.config_parameter'].sudo().get_param('web.base.url', 'http://localhost:8069')
            record.facebook_webhook_url = f"{base_url}/social/facebook/webhook"
    
    def _compute_ngrok_tunnel_url(self):
        """Láº¥y URL ngrok tá»« API"""
        for record in self:
            try:
                # Query ngrok API (default: http://127.0.0.1:4040/api/tunnels)
                response = requests.get('http://127.0.0.1:4040/api/tunnels', timeout=2)
                if response.status_code == 200:
                    data = response.json()
                    tunnels = data.get('tunnels', [])
                    for tunnel in tunnels:
                        if tunnel.get('proto') == 'https':
                            record.ngrok_tunnel_url = tunnel.get('public_url')
                            return
                record.ngrok_tunnel_url = False
            except Exception as e:
                _logger.debug(f'Failed to get ngrok URL: {e}')
                record.ngrok_tunnel_url = False
    
    def _compute_ngrok_is_running(self):
        """Kiá»ƒm tra ngrok cÃ³ Ä‘ang cháº¡y khÃ´ng"""
        for record in self:
            record.ngrok_is_running = bool(record.ngrok_tunnel_url)
    
    # -------------------------------------------------------------------------
    # NGROK ACTIONS
    # -------------------------------------------------------------------------
    
    def action_start_ngrok(self):
        """
        Khá»Ÿi Ä‘á»™ng ngrok subprocess.
        
        Command: ngrok.exe http 8069
        Process cháº¡y background, khÃ´ng block Odoo.
        """
        self.ensure_one()
        
        ngrok_path = self.ngrok_executable_path or 'C:/ngrok/ngrok.exe'
        
        # Check if file exists
        if not os.path.exists(ngrok_path):
            raise UserError(_(
                'Ngrok executable not found at: %s\n'
                'Please update the path in settings!'
            ) % ngrok_path)
        
        # Check if already running
        if self.ngrok_is_running:
            raise UserError(_('Ngrok is already running!'))
        
        try:
            # Start ngrok subprocess
            # Use Popen to run in background
            subprocess.Popen(
                [ngrok_path, 'http', '8069'],
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
                creationflags=subprocess.CREATE_NEW_CONSOLE if os.name == 'nt' else 0
            )
            
            _logger.info('Ngrok started successfully')
            
            return {
                'type': 'ir.actions.client',
                'tag': 'display_notification',
                'params': {
                    'title': _('Success'),
                    'message': _('Ngrok started! Please wait 5 seconds then refresh to see the URL.'),
                    'type': 'success',
                    'sticky': False,
                }
            }
            
        except Exception as e:
            _logger.error(f'Failed to start ngrok: {e}')
            raise UserError(_(
                'Failed to start ngrok: %s\n'
                'Please check the executable path and try again.'
            ) % str(e))
    
    def action_stop_ngrok(self):
        """
        Dá»«ng ngrok process.
        
        Kill táº¥t cáº£ process ngrok Ä‘ang cháº¡y.
        """
        self.ensure_one()
        
        try:
            if os.name == 'nt':  # Windows
                subprocess.run(['taskkill', '/F', '/IM', 'ngrok.exe'], 
                             stdout=subprocess.DEVNULL, 
                             stderr=subprocess.DEVNULL)
            else:  # Linux/Mac
                subprocess.run(['pkill', 'ngrok'], 
                             stdout=subprocess.DEVNULL, 
                             stderr=subprocess.DEVNULL)
            
            _logger.info('Ngrok stopped')
            
            return {
                'type': 'ir.actions.client',
                'tag': 'display_notification',
                'params': {
                    'title': _('Success'),
                    'message': _('Ngrok stopped successfully!'),
                    'type': 'success',
                    'sticky': False,
                }
            }
            
        except Exception as e:
            _logger.error(f'Failed to stop ngrok: {e}')
            raise UserError(_('Failed to stop ngrok: %s') % str(e))
    
    def action_refresh_ngrok_url(self):
        """Refresh Ä‘á»ƒ láº¥y ngrok URL má»›i"""
        self._compute_ngrok_tunnel_url()
        
        if self.ngrok_tunnel_url:
            message = _('Ngrok URL: %s') % self.ngrok_tunnel_url
            msg_type = 'success'
        else:
            message = _('Ngrok is not running or URL not available.')
            msg_type = 'warning'
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Ngrok Status'),
                'message': message,
                'type': msg_type,
                'sticky': False,
            }
        }
    
    def action_copy_webhook_url(self):
        """Copy webhook URL to clipboard (via notification)"""
        self.ensure_one()
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Webhook URL'),
                'message': _('Webhook URL: %s\nCopy vÃ  dÃ¡n vÃ o Facebook App Settings!') % self.facebook_webhook_url,
                'type': 'info',
                'sticky': True,
            }
        }
    



################################################################################
## FILE 19: social_account.py
## ÄÆ°á»ng dáº«n: models/social_account.py
################################################################################

from odoo import models, fields, api, _
from odoo.exceptions import UserError
import requests
import logging

_logger = logging.getLogger(__name__)


class SocialAccount(models.Model):
    _name = 'social.account'
    _description = 'Facebook Account'
    _order = 'name'
    _inherit = ['mail.thread', 'mail.activity.mixin']

    name = fields.Char(string='Page Name', required=True, tracking=True)
    platform = fields.Selection([('facebook', 'Facebook')], string='Platform', default='facebook', required=True)
    facebook_page_id = fields.Char(string='Facebook Page ID', required=True, tracking=True)
    facebook_page_url = fields.Char(string='Page URL', compute='_compute_page_url', store=True)
    
    access_token = fields.Char(string='Access Token', required=True)
    token_expires_at = fields.Datetime(string='Token Expires At')
    is_token_valid = fields.Boolean(string='Token Valid', compute='_compute_token_valid')
    
    page_category = fields.Char(string='Category')
    page_about = fields.Text(string='About')
    followers_count = fields.Integer(string='Followers', default=0)
    likes_count = fields.Integer(string='Likes', default=0)
    page_rating = fields.Float(string='Rating', digits=(2, 1))
    profile_picture_url = fields.Char(string='Profile Picture URL')
    cover_photo_url = fields.Char(string='Cover Photo URL')
    
    active = fields.Boolean(string='Active', default=True)
    state = fields.Selection([
        ('draft', 'Draft'),
        ('connected', 'Connected'),
        ('error', 'Error'),
    ], string='Status', default='draft', tracking=True)
    
    last_sync_date = fields.Datetime(string='Last Sync')
    last_message_sync_date = fields.Datetime(string='Last Message Sync')
    error_message = fields.Text(string='Error Message')
    
    auto_sync_comments = fields.Boolean(string='Auto Sync Comments', default=True)
    auto_sync_messages = fields.Boolean(string='Auto Sync Messages', default=True)
    
    company_id = fields.Many2one('res.company', string='Company', default=lambda self: self.env.company)
    post_ids = fields.One2many('social.post', 'account_id', string='Posts')
    post_count = fields.Integer(string='Posts', compute='_compute_post_count')
    
    # âœ… THÃŠM: Field Ä‘áº¿m conversations
    conversation_count = fields.Integer(string='Conversations', compute='_compute_conversation_count')
    
    _sql_constraints = [
        ('facebook_page_id_uniq', 'UNIQUE(facebook_page_id, company_id)', 
         'Facebook Page ID must be unique per company!'),
    ]
    
    @api.depends('facebook_page_id')
    def _compute_page_url(self):
        for account in self:
            if account.facebook_page_id:
                account.facebook_page_url = f'https://www.facebook.com/{account.facebook_page_id}'
            else:
                account.facebook_page_url = False
    
    @api.depends('token_expires_at')
    def _compute_token_valid(self):
        now = fields.Datetime.now()
        for account in self:
            if account.token_expires_at:
                account.is_token_valid = account.token_expires_at > now
            else:
                account.is_token_valid = True
    
    def _compute_post_count(self):
        for account in self:
            account.post_count = len(account.post_ids)
    
    # âœ… THÃŠM: Compute conversation count
    def _compute_conversation_count(self):
        for account in self:
            account.conversation_count = self.env['social.conversation'].search_count([
                ('account_id', '=', account.id)
            ])
    
    def action_test_connection(self):
        self.ensure_one()
        try:
            url = f'https://graph.facebook.com/v18.0/{self.facebook_page_id}'
            params = {'access_token': self.access_token, 'fields': 'id,name,category'}
            response = requests.get(url, params=params, timeout=10)
            
            if response.status_code == 200:
                self.write({'state': 'connected', 'error_message': False})
                return {
                    'type': 'ir.actions.client',
                    'tag': 'display_notification',
                    'params': {
                        'title': _('Success'),
                        'message': _('Connection successful!'),
                        'type': 'success',
                        'sticky': False,
                    }
                }
            else:
                raise UserError(_('Connection failed: %s') % response.text)
        except Exception as e:
            self.write({'state': 'error', 'error_message': str(e)})
            raise UserError(_('Connection error: %s') % str(e))
    
    def action_sync_page_info(self):
        self.ensure_one()
        try:
            url = f'https://graph.facebook.com/v18.0/{self.facebook_page_id}'
            params = {
                'access_token': self.access_token,
                'fields': 'name,category,about,followers_count,fan_count,overall_star_rating'
            }
            response = requests.get(url, params=params, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                self.write({
                    'name': data.get('name', self.name),
                    'page_category': data.get('category'),
                    'page_about': data.get('about'),
                    'followers_count': data.get('followers_count', 0),
                    'likes_count': data.get('fan_count', 0),
                    'page_rating': data.get('overall_star_rating', 0),
                    'last_sync_date': fields.Datetime.now(),
                })
                return True
            return False
        except Exception as e:
            _logger.error(f'Error syncing page info: {e}')
            return False
    
    def action_view_posts(self):
        self.ensure_one()
        return {
            'name': _('Posts - %s') % self.name,
            'type': 'ir.actions.act_window',
            'res_model': 'social.post',
            'view_mode': 'list,kanban,form',
            'domain': [('account_id', '=', self.id)],
            'context': {'default_account_id': self.id},
        }
    
    # =========================================================================
    # âœ… THÃŠM: ACTION SYNC CONVERSATIONS
    # =========================================================================
    def action_sync_conversations(self):
        """
        Äá»“ng bá»™ táº¥t cáº£ conversations cá»§a account nÃ y tá»« Facebook.
        """
        self.ensure_one()
        
        if self.state != 'connected':
            raise UserError(_('Please connect the account first!'))
        
        try:
            from .social_message import SocialMessage
            
            # Gá»i method sync cho account nÃ y
            self.env['social.message']._sync_account_conversations(self)
            
            # Cáº­p nháº­t last sync date
            self.write({
                'last_message_sync_date': fields.Datetime.now(),
            })
            
            # Äáº¿m sá»‘ conversations Ä‘Ã£ sync
            conv_count = self.env['social.conversation'].search_count([
                ('account_id', '=', self.id)
            ])
            
            return {
                'type': 'ir.actions.client',
                'tag': 'display_notification',
                'params': {
                    'title': _('Success'),
                    'message': _('Synced conversations! Total: %d conversations') % conv_count,
                    'type': 'success',
                    'sticky': False,
                }
            }
            
        except Exception as e:
            _logger.error(f'Error syncing conversations for account {self.id}: {e}')
            raise UserError(_('Error syncing conversations: %s') % str(e))
    
    # âœ… THÃŠM: Action view conversations
    def action_view_conversations(self):
        """Xem táº¥t cáº£ conversations cá»§a account nÃ y"""
        self.ensure_one()
        return {
            'name': _('Conversations - %s') % self.name,
            'type': 'ir.actions.act_window',
            'res_model': 'social.conversation',
            'view_mode': 'list,form',
            'domain': [('account_id', '=', self.id)],
            'context': {'default_account_id': self.id},
        }
    
    @api.model
    def cron_refresh_facebook_tokens(self):
        accounts = self.search([('platform', '=', 'facebook'), ('state', '=', 'connected')])
        for account in accounts:
            try:
                _logger.info(f'Refreshing token for account {account.id}')
            except Exception as e:
                _logger.error(f'Error refreshing token: {e}')



################################################################################
## FILE 20: social_analytics.py
## ÄÆ°á»ng dáº«n: models/social_analytics.py
################################################################################

from odoo import models, fields, api, tools
import logging

_logger = logging.getLogger(__name__)


class SocialAnalytics(models.Model):
    """
    Model phÃ¢n tÃ­ch insights tá»« Facebook.
    """
    _name = 'social.analytics'
    _description = 'Facebook Analytics'
    _auto = False
    _rec_name = 'account_id'

    account_id = fields.Many2one('social.account', string='Page', readonly=True)
    date = fields.Date(string='Date', readonly=True)
    total_posts = fields.Integer(string='Total Posts', readonly=True)
    total_likes = fields.Integer(string='Total Likes', readonly=True)
    total_comments = fields.Integer(string='Total Comments', readonly=True)
    total_shares = fields.Integer(string='Total Shares', readonly=True)
    avg_engagement_rate = fields.Float(string='Avg Engagement Rate', readonly=True)
    company_id = fields.Many2one('res.company', string='Company', readonly=True)
    
    def init(self):
        """Táº¡o SQL view cho analytics"""
        tools.drop_view_if_exists(self._cr, self._table)
        self._cr.execute("""
            CREATE OR REPLACE VIEW %s AS (
                SELECT
                    ROW_NUMBER() OVER (ORDER BY sp.account_id, DATE(sp.published_date)) AS id,
                    sp.account_id AS account_id,
                    DATE(sp.published_date) AS date,
                    COUNT(sp.id) AS total_posts,
                    SUM(sp.likes_count) AS total_likes,
                    SUM(sp.comments_count) AS total_comments,
                    SUM(sp.shares_count) AS total_shares,
                    AVG(sp.engagement_rate) AS avg_engagement_rate,
                    sp.company_id AS company_id
                FROM
                    social_post sp
                WHERE
                    sp.state = 'published'
                    AND sp.published_date IS NOT NULL
                GROUP BY
                    sp.account_id, DATE(sp.published_date), sp.company_id
            )
        """ % self._table)
    
    @api.model
    def cron_update_facebook_insights(self):
        """Cron job Ä‘á»ƒ update insights"""
        _logger.info('Updating Facebook insights...')
        # Logic update insights



################################################################################
## FILE 21: social_comment.py
## ÄÆ°á»ng dáº«n: models/social_comment.py
################################################################################

from odoo import models, fields, api, _
from odoo.exceptions import UserError
import requests
import logging

_logger = logging.getLogger(__name__)


class SocialComment(models.Model):
    _name = 'social.comment'
    _description = 'Facebook Comment'
    _order = 'comment_date desc'

    display_name = fields.Char(string='Display Name', compute='_compute_display_name', store=True)
    post_id = fields.Many2one('social.post', string='Post', required=True, ondelete='cascade')
    facebook_comment_id = fields.Char(string='Facebook Comment ID', required=True)
    author_name = fields.Char(string='Author', required=True)
    author_facebook_id = fields.Char(string='Author FB ID')
    message = fields.Text(string='Message', required=True)
    comment_date = fields.Datetime(string='Date', required=True, default=fields.Datetime.now)
    parent_id = fields.Many2one('social.comment', string='Parent Comment')
    is_hidden = fields.Boolean(string='Hidden', default=False)
    is_spam = fields.Boolean(string='Spam', default=False)
    reply_text = fields.Text(string='Reply')
    replied = fields.Boolean(string='Replied', default=False)
    company_id = fields.Many2one('res.company', related='post_id.company_id', store=True)
    
    @api.depends('author_name', 'message')
    def _compute_display_name(self):
        for comment in self:
            preview = comment.message[:50] + '...' if len(comment.message or '') > 50 else comment.message
            comment.display_name = f"{comment.author_name}: {preview}"
    
    def action_reply(self):
        self.ensure_one()
        if not self.reply_text:
            raise UserError(_('Please enter a reply message!'))
        try:
            url = f'https://graph.facebook.com/v18.0/{self.facebook_comment_id}/comments'
            data = {'access_token': self.post_id.account_id.access_token, 'message': self.reply_text}
            response = requests.post(url, data=data, timeout=30)
            if response.status_code == 200:
                self.replied = True
                return {'type': 'ir.actions.client', 'tag': 'display_notification',
                        'params': {'title': _('Success'), 'message': _('Reply sent!'), 'type': 'success'}}
            else:
                raise UserError(_('Failed to reply: %s') % response.text)
        except Exception as e:
            raise UserError(_('Error: %s') % str(e))
    
    def action_hide(self):
        self.ensure_one()
        self.is_hidden = True
    
    def action_mark_spam(self):
        self.ensure_one()
        self.is_spam = True



################################################################################
## FILE 22: social_conversation.py
## ÄÆ°á»ng dáº«n: models/social_conversation.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import models, fields, api, _
from odoo.exceptions import UserError
import logging

_logger = logging.getLogger(__name__)


class SocialConversation(models.Model):
    """
    Model quáº£n lÃ½ Messenger Conversations - CRM Integration.
    
    Má»—i conversation Ä‘áº¡i diá»‡n cho má»™t cuá»™c há»™i thoáº¡i giá»¯a Facebook Page
    vÃ  má»™t khÃ¡ch hÃ ng cá»¥ thá»ƒ trÃªn Messenger.
    
    Use Cases:
    - Quáº£n lÃ½ há»™i thoáº¡i khÃ¡ch hÃ ng tá»« Facebook Messenger
    - Táº¡o CRM Lead tá»« conversation
    - Theo dÃµi tráº¡ng thÃ¡i chÄƒm sÃ³c khÃ¡ch hÃ ng
    - PhÃ¢n tÃ­ch hiá»‡u quáº£ tÆ°Æ¡ng tÃ¡c Messenger
    """
    _name = 'social.conversation'
    _description = 'Facebook Messenger Conversation'
    _order = 'last_message_date desc, id desc'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _rec_name = 'display_name'
    
    # =========================================================================
    # BASIC FIELDS
    # =========================================================================
    
    account_id = fields.Many2one(
        'social.account',
        string='Facebook Page',
        required=True,
        ondelete='cascade',
        tracking=True,
        help='Facebook Page mÃ  conversation nÃ y thuá»™c vá»'
    )
    
    conversation_id = fields.Char(
        string='Conversation ID',
        required=True,
        help='Facebook Conversation ID (format: t_xxxxxx)'
    )
    
    customer_name = fields.Char(
        string='Customer Name',
        required=True,
        tracking=True,
        help='TÃªn khÃ¡ch hÃ ng trÃªn Messenger'
    )
    
    customer_psid = fields.Char(
        string='Customer PSID',
        required=True,
        help='Page-Scoped ID - unique identifier cho user trÃªn page nÃ y'
    )
    
    customer_phone = fields.Char(
        string='Phone',
        tracking=True,
        help='Sá»‘ Ä‘iá»‡n thoáº¡i khÃ¡ch hÃ ng (náº¿u cÃ³)'
    )
    
    customer_email = fields.Char(
        string='Email',
        tracking=True,
        help='Email khÃ¡ch hÃ ng (náº¿u cÃ³)'
    )
    
    # =========================================================================
    # CRM INTEGRATION
    # =========================================================================
    
    lead_id = fields.Many2one(
        'crm.lead',
        string='CRM Lead',
        ondelete='set null',
        tracking=True,
        help='Lead Ä‘Æ°á»£c táº¡o tá»« conversation nÃ y'
    )
    
    state = fields.Selection([
        ('new', 'New'),
        ('ongoing', 'Ongoing'),
        ('resolved', 'Resolved'),
        ('closed', 'Closed')
    ], string='Status', default='new', required=True, tracking=True,
       help='Tráº¡ng thÃ¡i xá»­ lÃ½ conversation:\n'
            '- New: Má»›i, chÆ°a xá»­ lÃ½\n'
            '- Ongoing: Äang tÆ°Æ¡ng tÃ¡c\n'
            '- Resolved: ÄÃ£ xá»­ lÃ½ xong\n'
            '- Closed: ÄÃ£ Ä‘Ã³ng')
    
    # =========================================================================
    # TRACKING FIELDS
    # =========================================================================
    
    last_message_date = fields.Datetime(
        string='Last Message',
        help='Thá»i gian tin nháº¯n cuá»‘i cÃ¹ng trong conversation'
    )
    
    last_message_from = fields.Selection([
        ('customer', 'Customer'),
        ('page', 'Page')
    ], string='Last Message From',
       help='Tin nháº¯n cuá»‘i cÃ¹ng tá»« khÃ¡ch hÃ ng hay page')
    
    unread_count = fields.Integer(
        string='Unread Messages',
        default=0,
        help='Sá»‘ tin nháº¯n chÆ°a Ä‘á»c tá»« khÃ¡ch hÃ ng'
    )
    
    first_response_time = fields.Float(
        string='First Response Time (minutes)',
        help='Thá»i gian pháº£n há»“i láº§n Ä‘áº§u (phÃºt)',
        digits=(10, 2)
    )
    
    # =========================================================================
    # RELATIONS
    # =========================================================================
    
    message_ids = fields.One2many(
        'social.message',
        'conversation_id',
        string='Messages',
        help='Táº¥t cáº£ tin nháº¯n trong conversation nÃ y'
    )
    
    message_count = fields.Integer(
        string='Messages',
        compute='_compute_message_count',
        store=True,
        help='Tá»•ng sá»‘ tin nháº¯n trong conversation'
    )
    
    # =========================================================================
    # COMPUTED FIELDS
    # =========================================================================
    
    display_name = fields.Char(
        string='Display Name',
        compute='_compute_display_name',
        store=True,
        help='TÃªn hiá»ƒn thá»‹ cá»§a conversation'
    )
    
    # =========================================================================
    # SYSTEM FIELDS
    # =========================================================================
    
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        default=lambda self: self.env.company,
        required=True
    )
    
    active = fields.Boolean(
        string='Active',
        default=True,
        help='Uncheck to archive conversation'
    )
    
    # =========================================================================
    # SQL CONSTRAINTS
    # =========================================================================
    
    _sql_constraints = [
        ('conversation_id_account_uniq',
         'UNIQUE(conversation_id, account_id, company_id)',
         'Conversation ID must be unique per account and company!'),
        ('customer_psid_account_uniq',
         'UNIQUE(customer_psid, account_id, company_id)',
         'Customer PSID must be unique per account and company!'),
    ]
    
    # =========================================================================
    # COMPUTE METHODS
    # =========================================================================
    
    @api.depends('message_ids')
    def _compute_message_count(self):
        """TÃ­nh tá»•ng sá»‘ tin nháº¯n trong conversation"""
        for conversation in self:
            conversation.message_count = len(conversation.message_ids)
    
    @api.depends('customer_name', 'account_id.name')
    def _compute_display_name(self):
        """Táº¡o tÃªn hiá»ƒn thá»‹ cho conversation"""
        for conversation in self:
            if conversation.customer_name and conversation.account_id:
                conversation.display_name = f"{conversation.customer_name} - {conversation.account_id.name}"
            elif conversation.customer_name:
                conversation.display_name = conversation.customer_name
            else:
                conversation.display_name = f"Conversation {conversation.id or 'New'}"
    
    # =========================================================================
    # CRM ACTIONS
    # =========================================================================
    
    def action_create_lead(self):
        """
        Táº¡o CRM Lead tá»« conversation nÃ y.
        
        KÃ­ch hoáº¡t: Button "Create Lead" trÃªn conversation form
        Äiá»u kiá»‡n: ChÆ°a cÃ³ lead_id
        áº¢nh hÆ°á»Ÿng: Táº¡o record má»›i trong crm.lead vÃ  link vá»›i conversation
        """
        self.ensure_one()
        
        if self.lead_id:
            raise UserError(_('Lead already exists for this conversation!'))
        
        # Táº¡o lead description tá»« messages
        description = []
        for msg in self.message_ids.sorted('created_date')[:5]:  # 5 tin Ä‘áº§u
            prefix = "ğŸ‘¤ Customer:" if msg.is_from_customer else "ğŸ“˜ Page:"
            description.append(f"{prefix} {msg.message}")
        
        # Táº¡o lead
        lead_vals = {
            'name': f'FB Messenger: {self.customer_name}',
            'contact_name': self.customer_name,
            'phone': self.customer_phone,
            'email_from': self.customer_email,
            'type': 'lead',
            'source_id': self.env.ref('utm.utm_source_facebook', raise_if_not_found=False).id,
            'description': '\n'.join(description),
            'user_id': self.env.user.id,
            'team_id': self.env['crm.team'].search([], limit=1).id,
            'company_id': self.company_id.id,
            # Custom field tá»« crm_lead.py
            'messenger_conversation_id': self.id,
        }
        
        lead = self.env['crm.lead'].create(lead_vals)
        
        # Link lead vá»›i conversation
        self.write({
            'lead_id': lead.id,
            'state': 'ongoing',
        })
        
        # Log message
        self.message_post(
            body=_('CRM Lead created: <a href="#id=%s&model=crm.lead">%s</a>') % (lead.id, lead.name)
        )
        
        return {
            'type': 'ir.actions.act_window',
            'res_model': 'crm.lead',
            'res_id': lead.id,
            'view_mode': 'form',
            'target': 'current',
        }
    
    def action_mark_resolved(self):
        """
        ÄÃ¡nh dáº¥u conversation Ä‘Ã£ xá»­ lÃ½ xong.
        
        KÃ­ch hoáº¡t: Button "Mark Resolved"
        áº¢nh hÆ°á»Ÿng: state â†’ 'resolved', unread_count â†’ 0
        """
        for conversation in self:
            conversation.write({
                'state': 'resolved',
                'unread_count': 0,
            })
            conversation.message_post(body=_('Conversation marked as resolved'))
        
        return True
    
    def action_close(self):
        """
        ÄÃ³ng conversation.
        
        KÃ­ch hoáº¡t: Button "Close"
        áº¢nh hÆ°á»Ÿng: state â†’ 'closed'
        """
        for conversation in self:
            conversation.write({'state': 'closed'})
            conversation.message_post(body=_('Conversation closed'))
        
        return True
    
    def action_reopen(self):
        """
        Má»Ÿ láº¡i conversation Ä‘Ã£ Ä‘Ã³ng.
        
        KÃ­ch hoáº¡t: Button "Reopen"
        áº¢nh hÆ°á»Ÿng: state â†’ 'ongoing'
        """
        for conversation in self:
            conversation.write({'state': 'ongoing'})
            conversation.message_post(body=_('Conversation reopened'))
        
        return True
    
    def action_view_messages(self):
        """Xem táº¥t cáº£ messages trong conversation nÃ y"""
        self.ensure_one()
        return {
            'name': _('Messages - %s') % self.display_name,
            'type': 'ir.actions.act_window',
            'res_model': 'social.message',
            'view_mode': 'list,form',
            'domain': [('conversation_id', '=', self.id)],
            'context': {'default_conversation_id': self.id},
        }
    
    # =========================================================================
    # WEBHOOK PROCESSING
    # =========================================================================
    
    @api.model
    def process_messenger_webhook(self, account_id, sender_id, sender_name, message_data):
        """
        Xá»­ lÃ½ webhook tá»« Facebook Messenger.
        
        Args:
            account_id (int): ID cá»§a social.account
            sender_id (str): PSID cá»§a ngÆ°á»i gá»­i
            sender_name (str): TÃªn ngÆ°á»i gá»­i
            message_data (dict): Data tá»« webhook
        
        Returns:
            social.conversation: Conversation record
        """
        # TÃ¬m hoáº·c táº¡o conversation
        conversation = self.search([
            ('account_id', '=', account_id),
            ('customer_psid', '=', sender_id),
        ], limit=1)
        
        if not conversation:
            # Táº¡o conversation má»›i
            conversation = self.create({
                'account_id': account_id,
                'conversation_id': message_data.get('conversation_id', f"t_{sender_id}"),
                'customer_name': sender_name,
                'customer_psid': sender_id,
                'state': 'new',
                'last_message_date': fields.Datetime.now(),
                'last_message_from': 'customer',
                'unread_count': 1,
            })
            
            _logger.info(f'Created new conversation {conversation.id} for PSID {sender_id}')
        else:
            # Cáº­p nháº­t conversation
            conversation.write({
                'last_message_date': fields.Datetime.now(),
                'last_message_from': 'customer',
                'unread_count': conversation.unread_count + 1,
                'state': 'ongoing' if conversation.state == 'new' else conversation.state,
            })
        
        return conversation



################################################################################
## FILE 23: social_message.py
## ÄÆ°á»ng dáº«n: models/social_message.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _
from odoo.exceptions import UserError, ValidationError
import logging
import re

_logger = logging.getLogger(__name__)


class SocialMessage(models.Model):
    """
    Model quáº£n lÃ½ Facebook Messenger conversations vÃ  messages.
    
    Model nÃ y Ä‘áº¡i diá»‡n cho:
    1. Conversations: Cuá»™c há»™i thoáº¡i vá»›i má»™t user (identified by PSID)
    2. Messages: Tin nháº¯n riÃªng láº» trong conversation
    
    Chatbot Flow:
    - idle â†’ ask_name â†’ ask_phone â†’ show_products â†’ confirm_order â†’ completed
    
    Integration:
    - CRM: Auto-create crm.lead tá»« conversations
    - Sales: Create sale.order tá»« chatbot
    """
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # MODEL DEFINITION
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    _name = 'social.message'
    _description = 'Social Message / Conversation'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _order = 'create_date desc'
    _rec_name = 'facebook_user_id'
    
    # THÃŠM field nÃ y vÃ o pháº§n khai bÃ¡o fields:
    conversation_id = fields.Many2one(
        'social.conversation',
        string='Conversation',
        ondelete='cascade',
        help='Conversation mÃ  message nÃ y thuá»™c vá»'
    )
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # BASIC CONVERSATION FIELDS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    # Conversation Identification
    facebook_user_id = fields.Char(
        string='Facebook User ID (PSID)',
        required=True,
        index=True,
        help='Page-Scoped User ID from Facebook',
    )
    account_id = fields.Many2one(
        'social.account',
        string='Facebook Page',
        required=True,
        ondelete='cascade',
        index=True,
        help='Facebook Page nháº­n tin nháº¯n',
    )
    
    # Message Details
    message_id = fields.Char(
        string='Message ID',
        index=True,
        help='Facebook Message ID (unique cho má»—i message)',
    )
    message = fields.Text(
        string='Message Content',
        help='Ná»™i dung tin nháº¯n',
    )
    is_from_customer = fields.Boolean(
        string='From Customer',
        default=True,
        help='True = tá»« khÃ¡ch hÃ ng, False = tá»« Page',
    )
    attachments = fields.Text(
        string='Attachments',
        help='JSON data cá»§a file Ä‘Ã­nh kÃ¨m (images, files, etc.)',
    )
    
    # Timestamps
    created_date = fields.Datetime(
        string='Created Date',
        default=fields.Datetime.now,
        index=True,
    )
    last_message_date = fields.Datetime(
        string='Last Message',
        help='Thá»i Ä‘iá»ƒm tin nháº¯n cuá»‘i cÃ¹ng',
    )
    
    # Organization
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        default=lambda self: self.env.company,
        required=True,
        index=True,
    )
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CHATBOT FIELDS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    chatbot_state = fields.Selection([
        ('idle', 'Idle'),
        ('ask_name', 'Asking Name'),
        ('ask_phone', 'Asking Phone'),
        ('show_products', 'Showing Products'),
        ('confirm_order', 'Confirming Order'),
        ('completed', 'Completed'),
    ], string='Chatbot State', default='idle', tracking=True)
    
    customer_name = fields.Char(
        string='Customer Name',
        help='TÃªn khÃ¡ch hÃ ng trong cuá»™c há»™i thoáº¡i',
    )
    customer_phone = fields.Char(
        string='Customer Phone',
        help='Sá»‘ Ä‘iá»‡n thoáº¡i khÃ¡ch hÃ ng',
    )
    selected_product_ids = fields.Many2many(
        'social.messenger.product',
        string='Selected Products',
        help='Sáº£n pháº©m khÃ¡ch hÃ ng Ä‘Ã£ chá»n',
    )
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CRM & SALES INTEGRATION
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    lead_id = fields.Many2one(
        'crm.lead',
        string='Lead',
        ondelete='set null',
        help='Lead Ä‘Æ°á»£c táº¡o tá»« conversation nÃ y',
    )
    messenger_order_id = fields.Many2one(
        'social.messenger.order',
        string='Messenger Order',
        ondelete='set null',
        help='ÄÆ¡n hÃ ng Ä‘Æ°á»£c táº¡o tá»« conversation nÃ y',
    )
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CONSTRAINTS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    _sql_constraints = [
        ('facebook_user_account_uniq',
         'UNIQUE(facebook_user_id, account_id)',
         'Conversation already exists for this user and page!'),
    ]
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CHATBOT FLOW METHODS
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    def process_chatbot_flow(self, user_message):
        """
        Xá»­ lÃ½ luá»“ng há»™i thoáº¡i chatbot bÃ¡n hÃ ng.
        
        Flow:
        1. idle â†’ ask_name: ChÃ o há»i, xin tÃªn
        2. ask_name â†’ ask_phone: LÆ°u tÃªn, xin SÄT
        3. ask_phone â†’ show_products: LÆ°u SÄT, show danh sÃ¡ch SP
        4. show_products â†’ confirm_order: LÆ°u SP Ä‘Ã£ chá»n
        5. confirm_order â†’ completed: Táº¡o Ä‘Æ¡n hÃ ng
        
        Args:
            user_message (str): Tin nháº¯n cá»§a user
        
        Returns:
            dict: Response message to send
        """
        self.ensure_one()
        
        # Check if chatbot is enabled
        chatbot_enabled = self.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.chatbot_enabled', 'False'
        )
        if chatbot_enabled != 'True':
            return None
        
        current_state = self.chatbot_state
        
        if current_state == 'idle':
            return self._chatbot_ask_name()
        
        elif current_state == 'ask_name':
            return self._chatbot_save_name_ask_phone(user_message)
        
        elif current_state == 'ask_phone':
            return self._chatbot_save_phone_show_products(user_message)
        
        elif current_state == 'show_products':
            return self._chatbot_save_product_selection(user_message)
        
        elif current_state == 'confirm_order':
            return self._chatbot_create_order(user_message)
        
        return None
    
    def _chatbot_ask_name(self):
        """State 1: Há»i tÃªn khÃ¡ch hÃ ng"""
        self.chatbot_state = 'ask_name'
        
        welcome_msg = self.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.chatbot_welcome_message',
            'Xin chÃ o! TÃ´i lÃ  trá»£ lÃ½ bÃ¡n hÃ ng tá»± Ä‘á»™ng. ğŸ˜Š\nBáº¡n vui lÃ²ng cho tÃ´i biáº¿t tÃªn cá»§a báº¡n?'
        )
        
        return {
            'text': welcome_msg
        }
    
    def _chatbot_save_name_ask_phone(self, user_message):
        """State 2: LÆ°u tÃªn, há»i SÄT"""
        # Extract name from message
        name = user_message.strip()
        if len(name) < 2:
            return {
                'text': 'TÃªn báº¡n cÃ³ váº» hÆ¡i ngáº¯n. Báº¡n vui lÃ²ng nháº­p láº¡i tÃªn Ä‘áº§y Ä‘á»§ nhÃ©! ğŸ˜Š'
            }
        
        self.customer_name = name
        self.chatbot_state = 'ask_phone'
        
        return {
            'text': f'Ráº¥t vui Ä‘Æ°á»£c lÃ m quen vá»›i {name}! ğŸ‘‹\n\nÄá»ƒ chÃºng tÃ´i cÃ³ thá»ƒ liÃªn há»‡ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng, báº¡n vui lÃ²ng cung cáº¥p sá»‘ Ä‘iá»‡n thoáº¡i?'
        }
    
    def _chatbot_save_phone_show_products(self, user_message):
        """State 3: LÆ°u SÄT, hiá»ƒn thá»‹ sáº£n pháº©m"""
        # Validate phone number (simple regex)
        phone = user_message.strip()
        phone_pattern = r'^[0-9\s\+\-\(\)]{9,15}$'
        
        if not re.match(phone_pattern, phone):
            return {
                'text': 'Sá»‘ Ä‘iá»‡n thoáº¡i cÃ³ váº» khÃ´ng há»£p lá»‡. Vui lÃ²ng nháº­p láº¡i sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n (10-11 sá»‘).'
            }
        
        self.customer_phone = phone
        self.chatbot_state = 'show_products'
        
        # Get active products
        products = self.env['social.messenger.product'].get_active_products(
            company_id=self.company_id.id
        )
        
        if not products:
            return {
                'text': 'Xin lá»—i, hiá»‡n táº¡i chÃºng tÃ´i chÆ°a cÃ³ sáº£n pháº©m nÃ o. Vui lÃ²ng quay láº¡i sau! ğŸ˜Š'
            }
        
        # Create quick replies for products
        quick_replies = []
        product_list = "ğŸ“¦ Danh sÃ¡ch sáº£n pháº©m:\n\n"
        
        for idx, product in enumerate(products, 1):
            product_list += f"{idx}. {product.product_id.name}\n"
            product_list += f"   ğŸ’° {product.price:,.0f} {product.currency_id.symbol}\n"
            if product.description:
                product_list += f"   ğŸ“ {product.description[:50]}...\n"
            product_list += "\n"
            
            quick_replies.append(product.format_for_messenger())
        
        product_list += "Vui lÃ²ng chá»n sáº£n pháº©m báº¡n muá»‘n mua:"
        
        return {
            'text': product_list,
            'quick_replies': quick_replies
        }
    
    def _chatbot_save_product_selection(self, user_message):
        """State 4: LÆ°u sáº£n pháº©m Ä‘Ã£ chá»n, xÃ¡c nháº­n"""
        # Parse product ID from payload (format: PRODUCT_123)
        if user_message.startswith('PRODUCT_'):
            try:
                product_id = int(user_message.replace('PRODUCT_', ''))
                product = self.env['social.messenger.product'].browse(product_id)
                
                if not product.exists() or not product.active:
                    return {
                        'text': 'Sáº£n pháº©m khÃ´ng tá»“n táº¡i hoáº·c Ä‘Ã£ háº¿t hÃ ng. Vui lÃ²ng chá»n sáº£n pháº©m khÃ¡c.'
                    }
                
                # Add to selected products
                self.selected_product_ids = [(4, product.id)]
                self.chatbot_state = 'confirm_order'
                
                # Build confirmation message
                total = sum(self.selected_product_ids.mapped('price'))
                product_list = '\n'.join([
                    f"  â€¢ {p.product_id.name} - {p.price:,.0f} {p.currency_id.symbol}"
                    for p in self.selected_product_ids
                ])
                
                confirm_msg = f"""âœ… Báº¡n Ä‘Ã£ chá»n:

{product_list}

ğŸ’° Tá»•ng tiá»n: {total:,.0f} {self.selected_product_ids[0].currency_id.symbol}

ğŸ“‹ ThÃ´ng tin cá»§a báº¡n:
ğŸ‘¤ TÃªn: {self.customer_name}
ğŸ“ SÄT: {self.customer_phone}

Báº¡n cÃ³ muá»‘n xÃ¡c nháº­n Ä‘Æ¡n hÃ ng khÃ´ng?
Tráº£ lá»i "CÃ³" Ä‘á»ƒ xÃ¡c nháº­n, hoáº·c "KhÃ´ng" Ä‘á»ƒ há»§y."""
                
                return {
                    'text': confirm_msg,
                    'quick_replies': [
                        {'content_type': 'text', 'title': 'âœ… CÃ³', 'payload': 'CONFIRM_YES'},
                        {'content_type': 'text', 'title': 'âŒ KhÃ´ng', 'payload': 'CONFIRM_NO'},
                    ]
                }
                
            except ValueError:
                pass
        
        # If not valid product selection, ask again
        return {
            'text': 'Vui lÃ²ng chá»n má»™t sáº£n pháº©m tá»« danh sÃ¡ch bÃªn trÃªn.'
        }
    
    def _chatbot_create_order(self, user_message):
        """State 5: Táº¡o Ä‘Æ¡n hÃ ng hoáº·c há»§y"""
        if user_message == 'CONFIRM_YES' or user_message.lower() in ['cÃ³', 'yes', 'ok', 'Ä‘á»“ng Ã½']:
            # Create messenger order
            order_vals = {
                'conversation_id': self.id,
                'facebook_user_id': self.facebook_user_id,
                'customer_name': self.customer_name,
                'customer_phone': self.customer_phone,
                'product_ids': [(6, 0, self.selected_product_ids.ids)],
                'company_id': self.company_id.id,
                'state': 'confirmed',
            }
            
            order = self.env['social.messenger.order'].create(order_vals)
            self.messenger_order_id = order.id
            
            # Create sale.order
            try:
                sale_order = order.create_sale_order()
                
                self.chatbot_state = 'completed'
                
                return {
                    'text': f"""ğŸ‰ Äáº·t hÃ ng thÃ nh cÃ´ng!

MÃ£ Ä‘Æ¡n hÃ ng: {order.name}
MÃ£ Ä‘Æ¡n bÃ¡n hÃ ng: {sale_order.name}

ChÃºng tÃ´i sáº½ liÃªn há»‡ vá»›i báº¡n trong thá»i gian sá»›m nháº¥t Ä‘á»ƒ xÃ¡c nháº­n vÃ  giao hÃ ng.

Cáº£m Æ¡n báº¡n Ä‘Ã£ tin tÆ°á»Ÿng! ğŸ™"""
                }
            
            except Exception as e:
                _logger.error(f'Failed to create sale order: {e}')
                return {
                    'text': f'ÄÃ£ cÃ³ lá»—i xáº£y ra khi táº¡o Ä‘Æ¡n hÃ ng. Vui lÃ²ng liÃªn há»‡ vá»›i chÃºng tÃ´i qua hotline. Xin lá»—i vÃ¬ sá»± báº¥t tiá»‡n nÃ y! ğŸ˜”'
                }
        
        else:
            # Cancel order
            self.chatbot_state = 'idle'
            self.customer_name = False
            self.customer_phone = False
            self.selected_product_ids = [(5, 0, 0)]
            
            return {
                'text': 'ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c há»§y. Náº¿u báº¡n cáº§n há»— trá»£, vui lÃ²ng gá»­i tin nháº¯n báº¥t ká»³! ğŸ˜Š'
            }
    
    def send_chatbot_message(self, message_data):
        """
        Gá»­i tin nháº¯n chatbot qua Messenger.
        
        Args:
            message_data (dict): Message structure
                {
                    'text': 'Message text',
                    'quick_replies': [...]  (optional)
                }
        """
        self.ensure_one()
        
        if not message_data:
            return
        
        try:
            from odoo.addons.module_social_facebook.lib import facebook_api
            
            account = self.account_id
            if not account or not account.access_token:
                _logger.error(f'No access token for conversation {self.id}')
                return
            
            api = facebook_api.FacebookAPI(account.access_token)
            
            # Build message
            message = {'text': message_data['text']}
            
            if 'quick_replies' in message_data:
                message['quick_replies'] = message_data['quick_replies']
            
            # Send
            api.send_message(
                recipient_id=self.facebook_user_id,
                message=message
            )
            
            _logger.info(f'Sent chatbot message to {self.facebook_user_id}')
            
        except Exception as e:
            _logger.error(f'Failed to send chatbot message: {e}')
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # CRM LEAD CREATION
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    def create_lead_from_conversation(self):
        """
        Táº¡o crm.lead tá»« conversation.
        
        Returns:
            crm.lead: Lead record
        """
        self.ensure_one()
        
        if self.lead_id:
            _logger.warning(f'Lead already exists for conversation {self.id}')
            return self.lead_id
        
        # Check auto_create_lead setting
        auto_create = self.env['ir.config_parameter'].sudo().get_param(
            'module_social_facebook.auto_create_lead', 'False'
        )
        if auto_create != 'True':
            return None
        
        # Build lead vals
        lead_vals = {
            'name': f'Facebook Lead: {self.customer_name or self.facebook_user_id}',
            'type': 'lead',
            'source_id': self._get_facebook_source(),
            'description': self._build_lead_description(),
            'company_id': self.company_id.id,
        }
        
        # Add contact info if available
        if self.customer_name:
            lead_vals['contact_name'] = self.customer_name
        if self.customer_phone:
            lead_vals['phone'] = self.customer_phone
        
        # Create lead
        lead = self.env['crm.lead'].create(lead_vals)
        self.lead_id = lead.id
        
        _logger.info(f'Created lead {lead.id} from conversation {self.id}')
        
        # Log activity
        lead.message_post(
            body=_('Lead created from Facebook Messenger conversation'),
            subject=_('Facebook Lead'),
        )
        
        return lead
    
    def _get_facebook_source(self):
        """Get or create 'Facebook' source"""
        Source = self.env['utm.source']
        source = Source.search([('name', '=', 'Facebook')], limit=1)
        if not source:
            source = Source.create({'name': 'Facebook'})
        return source.id
    
    def _build_lead_description(self):
        """Build description from conversation messages"""
        messages = self.env['social.message'].search([
            ('conversation_id', '=', self.id)
        ], order='created_date asc', limit=10)
        
        desc = "Conversation from Facebook Messenger:\n\n"
        for msg in messages:
            sender = 'Customer' if msg.is_from_customer else 'Page'
            desc += f"[{sender}] {msg.message}\n"
        
        return desc



################################################################################
## FILE 24: social_messenger_order.py
## ÄÆ°á»ng dáº«n: models/social_messenger_order.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _
from odoo.exceptions import UserError, ValidationError
import logging

_logger = logging.getLogger(__name__)


class SocialMessengerOrder(models.Model):
    """
    ÄÆ¡n hÃ ng Ä‘Æ°á»£c táº¡o tá»« Facebook Messenger.
    Link vá»›i sale.order vÃ  social.conversation.
    """
    _name = 'social.messenger.order'
    _description = 'Messenger Sales Order'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _order = 'order_date desc, id desc'
    _rec_name = 'name'

    # Basic Info
    name = fields.Char(
        string='Order Reference',
        required=True,
        copy=False,
        readonly=True,
        default=lambda self: _('New'),
    )
    sale_order_id = fields.Many2one(
        'sale.order',
        string='Sale Order',
        ondelete='cascade',
        tracking=True,
    )
    conversation_id = fields.Many2one(
        'social.message',  # Link tá»›i conversation
        string='Conversation',
        ondelete='set null',
        help='Cuá»™c há»™i thoáº¡i Messenger táº¡o ra Ä‘Æ¡n hÃ ng nÃ y',
    )
    
    # Customer Info
    partner_id = fields.Many2one(
        'res.partner',
        string='Customer',
        related='sale_order_id.partner_id',
        store=True,
        readonly=True,
    )
    facebook_user_id = fields.Char(
        string='Facebook User ID',
        help='PSID cá»§a khÃ¡ch hÃ ng',
        tracking=True,
    )
    customer_name = fields.Char(
        string='Customer Name',
        required=True,
        tracking=True,
    )
    customer_phone = fields.Char(
        string='Phone',
        required=True,
        tracking=True,
    )
    customer_email = fields.Char(
        string='Email',
        tracking=True,
    )
    
    # Order Details
    state = fields.Selection([
        ('draft', 'Draft'),
        ('confirmed', 'Confirmed'),
        ('sale', 'Sale Order'),
        ('cancelled', 'Cancelled'),
    ], string='Status', default='draft', required=True, tracking=True)
    
    order_date = fields.Datetime(
        string='Order Date',
        default=fields.Datetime.now,
        required=True,
        tracking=True,
    )
    
    # Products
    product_ids = fields.Many2many(
        'social.messenger.product',
        string='Products',
        help='Sáº£n pháº©m khÃ¡ch hÃ ng Ä‘Ã£ chá»n',
    )
    
    # Pricing
    total_amount = fields.Monetary(
        string='Total',
        compute='_compute_total_amount',
        store=True,
        currency_field='currency_id',
    )
    currency_id = fields.Many2one(
        'res.currency',
        string='Currency',
        default=lambda self: self.env.company.currency_id,
    )
    
    # Organization
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        required=True,
        default=lambda self: self.env.company,
    )
    user_id = fields.Many2one(
        'res.users',
        string='Salesperson',
        default=lambda self: self.env.user,
        tracking=True,
    )
    
    # Notes
    notes = fields.Text(
        string='Internal Notes',
    )
    
    @api.model
    def create(self, vals):
        """Override create Ä‘á»ƒ táº¡o sequence"""
        if vals.get('name', _('New')) == _('New'):
            vals['name'] = self.env['ir.sequence'].next_by_code(
                'social.messenger.order'
            ) or _('New')
        return super().create(vals)
    
    @api.depends('sale_order_id', 'sale_order_id.amount_total')
    def _compute_total_amount(self):
        """TÃ­nh tá»•ng tiá»n tá»« sale.order hoáº·c products"""
        for record in self:
            if record.sale_order_id:
                record.total_amount = record.sale_order_id.amount_total
            else:
                # TÃ­nh tá»•ng tá»« products
                total = sum(record.product_ids.mapped('price'))
                record.total_amount = total
    
    # -------------------------------------------------------------------------
    # BUSINESS METHODS
    # -------------------------------------------------------------------------
    
    def create_sale_order(self):
        """
        Táº¡o sale.order tá»« messenger order.
        
        Flow:
        1. TÃ¬m hoáº·c táº¡o res.partner
        2. Táº¡o sale.order
        3. ThÃªm order lines tá»« products
        4. Link sale_order_id
        5. Chuyá»ƒn state â†’ 'sale'
        """
        self.ensure_one()
        
        if self.sale_order_id:
            raise UserError(_('Sale Order already exists for this Messenger Order!'))
        
        if not self.product_ids:
            raise UserError(_('Please select at least one product!'))
        
        # 1. Find or create partner
        partner = self._find_or_create_partner()
        
        # 2. Create sale.order
        sale_vals = {
            'partner_id': partner.id,
            'user_id': self.user_id.id,
            'company_id': self.company_id.id,
            'date_order': self.order_date,
            'origin': f'Messenger: {self.name}',
            'note': self.notes or f'Order from Facebook Messenger\nFacebook User: {self.facebook_user_id}',
        }
        
        sale_order = self.env['sale.order'].create(sale_vals)
        
        # 3. Add order lines
        for product in self.product_ids:
            line_vals = {
                'order_id': sale_order.id,
                'product_id': product.product_id.id,
                'product_uom_qty': 1,  # Default quantity
                'price_unit': product.price,
            }
            self.env['sale.order.line'].create(line_vals)
        
        # 4. Link sale order
        self.sale_order_id = sale_order.id
        self.state = 'sale'
        
        # 5. Send confirmation message
        self.send_order_confirmation()
        
        # 6. Log activity
        self.message_post(
            body=_('Sale Order %s created from Messenger') % sale_order.name,
            subject=_('Sale Order Created'),
        )
        
        return sale_order
    
    def _find_or_create_partner(self):
        """
        TÃ¬m hoáº·c táº¡o res.partner tá»« thÃ´ng tin khÃ¡ch hÃ ng.
        
        Logic:
        - TÃ¬m theo facebook_user_id (custom field)
        - Náº¿u khÃ´ng cÃ³, tÃ¬m theo phone
        - Náº¿u khÃ´ng cÃ³, táº¡o má»›i
        
        Returns:
            res.partner: Partner record
        """
        Partner = self.env['res.partner']
        
        # Check if partner has facebook_user_id field (custom field)
        if 'facebook_user_id' in Partner._fields:
            partner = Partner.search([
                ('facebook_user_id', '=', self.facebook_user_id),
                ('company_id', 'in', [False, self.company_id.id]),
            ], limit=1)
            if partner:
                return partner
        
        # Search by phone
        if self.customer_phone:
            partner = Partner.search([
                ('phone', '=', self.customer_phone),
                ('company_id', 'in', [False, self.company_id.id]),
            ], limit=1)
            if partner:
                # Update facebook_user_id if field exists
                if 'facebook_user_id' in Partner._fields and not partner.facebook_user_id:
                    partner.facebook_user_id = self.facebook_user_id
                return partner
        
        # Create new partner
        partner_vals = {
            'name': self.customer_name,
            'phone': self.customer_phone,
            'email': self.customer_email,
            'company_id': self.company_id.id,
            'comment': f'Created from Facebook Messenger Order: {self.name}',
        }
        
        # Add facebook_user_id if field exists
        if 'facebook_user_id' in Partner._fields:
            partner_vals['facebook_user_id'] = self.facebook_user_id
        
        partner = Partner.create(partner_vals)
        
        _logger.info(f'Created new partner {partner.id} for Messenger Order {self.name}')
        
        return partner
    
    def send_order_confirmation(self):
        """
        Gá»­i tin nháº¯n xÃ¡c nháº­n Ä‘Æ¡n hÃ ng qua Messenger.
        
        Message format:
        âœ… ÄÆ¡n hÃ ng #{name} Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n!
        ğŸ“¦ Sáº£n pháº©m: [Product List]
        ğŸ’° Tá»•ng tiá»n: {total}
        ğŸ“ ChÃºng tÃ´i sáº½ liÃªn há»‡ báº¡n sá»›m!
        """
        self.ensure_one()
        
        if not self.conversation_id:
            _logger.warning(f'No conversation found for order {self.name}')
            return
        
        # Build message
        product_list = '\n'.join([
            f"  â€¢ {p.product_id.name} - {p.price:,.0f} {p.currency_id.symbol}"
            for p in self.product_ids
        ])
        
        message = f"""âœ… ÄÆ¡n hÃ ng #{self.name} Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n!

ğŸ“¦ Sáº£n pháº©m:
{product_list}

ğŸ’° Tá»•ng tiá»n: {self.total_amount:,.0f} {self.currency_id.symbol}

ğŸ“ ChÃºng tÃ´i sáº½ liÃªn há»‡ vá»›i báº¡n trong thá»i gian sá»›m nháº¥t!
Cáº£m Æ¡n báº¡n Ä‘Ã£ mua hÃ ng."""
        
        # Send via Messenger API
        try:
            # Get Facebook API wrapper
            from odoo.addons.module_social_facebook.lib import facebook_api
            
            # Get page access token from conversation's account
            account = self.conversation_id.account_id
            if not account or not account.access_token:
                _logger.error(f'No access token found for conversation {self.conversation_id.id}')
                return
            
            api = facebook_api.FacebookAPI(account.access_token)
            
            # Send message
            api.send_message(
                recipient_id=self.facebook_user_id,
                message={'text': message}
            )
            
            _logger.info(f'Sent order confirmation for {self.name} to {self.facebook_user_id}')
            
            # Log to chatter
            self.message_post(
                body=_('Order confirmation sent via Messenger'),
                subject=_('Confirmation Sent'),
            )
            
        except Exception as e:
            _logger.error(f'Failed to send confirmation for order {self.name}: {e}')
            self.message_post(
                body=_('Failed to send confirmation: %s') % str(e),
                subject=_('Error'),
            )
    
    # -------------------------------------------------------------------------
    # ACTIONS
    # -------------------------------------------------------------------------
    
    def action_confirm(self):
        """XÃ¡c nháº­n Ä‘Æ¡n hÃ ng"""
        for record in self:
            if record.state != 'draft':
                raise UserError(_('Only draft orders can be confirmed!'))
            record.state = 'confirmed'
            record.message_post(body=_('Order confirmed'))
    
    def action_create_sale_order(self):
        """Button action: Táº¡o sale.order"""
        self.ensure_one()
        sale_order = self.create_sale_order()
        
        return {
            'type': 'ir.actions.act_window',
            'name': _('Sale Order'),
            'res_model': 'sale.order',
            'res_id': sale_order.id,
            'view_mode': 'form',
            'target': 'current',
        }
    
    def action_view_sale_order(self):
        """Xem sale.order"""
        self.ensure_one()
        if not self.sale_order_id:
            raise UserError(_('No Sale Order linked yet!'))
        
        return {
            'type': 'ir.actions.act_window',
            'name': _('Sale Order'),
            'res_model': 'sale.order',
            'res_id': self.sale_order_id.id,
            'view_mode': 'form',
            'target': 'current',
        }
    
    def action_cancel(self):
        """Há»§y Ä‘Æ¡n hÃ ng"""
        for record in self:
            record.state = 'cancelled'
            record.message_post(body=_('Order cancelled'))


# -------------------------------------------------------------------------
# EXTEND res.partner (OPTIONAL)
# -------------------------------------------------------------------------
# ThÃªm field facebook_user_id vÃ o res.partner Ä‘á»ƒ tracking

class ResPartner(models.Model):
    _inherit = 'res.partner'
    
    facebook_user_id = fields.Char(
        string='Facebook User ID (PSID)',
        help='Facebook Page-Scoped User ID',
    )
    messenger_order_count = fields.Integer(
        string='Messenger Orders',
        compute='_compute_messenger_order_count',
    )
    
    def _compute_messenger_order_count(self):
        """Äáº¿m sá»‘ Ä‘Æ¡n hÃ ng Messenger"""
        for partner in self:
            partner.messenger_order_count = self.env['social.messenger.order'].search_count([
                ('partner_id', '=', partner.id)
            ])
    
    def action_view_messenger_orders(self):
        """Xem Ä‘Æ¡n hÃ ng Messenger"""
        self.ensure_one()
        return {
            'name': _('Messenger Orders'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.messenger.order',
            'view_mode': 'tree,form',
            'domain': [('partner_id', '=', self.id)],
        }



################################################################################
## FILE 25: social_messenger_product.py
## ÄÆ°á»ng dáº«n: models/social_messenger_product.py
################################################################################

# -*- coding: utf-8 -*-

from odoo import api, fields, models, _
from odoo.exceptions import ValidationError
import logging

_logger = logging.getLogger(__name__)


class SocialMessengerProduct(models.Model):
    """
    Sáº£n pháº©m Ä‘Æ°á»£c bÃ¡n qua Facebook Messenger.
    Chá»‰ cÃ¡c sáº£n pháº©m Ä‘Æ°á»£c tick 'active' má»›i hiá»ƒn thá»‹ trong chatbot.
    """
    _name = 'social.messenger.product'
    _description = 'Messenger Product Catalog'
    _order = 'sequence, id'
    _rec_name = 'display_name'

    # Basic Info
    product_id = fields.Many2one(
        'product.product',
        string='Product',
        required=True,
        ondelete='cascade',
        domain=[('sale_ok', '=', True)],
    )
    display_name = fields.Char(
        string='Display Name',
        compute='_compute_display_name',
        store=True,
    )
    active = fields.Boolean(
        string='Sell on Messenger',
        default=True,
        help='Báº­t Ä‘á»ƒ sáº£n pháº©m xuáº¥t hiá»‡n trong chatbot Messenger'
    )
    
    # Messenger Customization
    quick_reply_title = fields.Char(
        string='Quick Reply Title',
        size=20,
        help='TiÃªu Ä‘á» hiá»ƒn thá»‹ trong quick reply button (max 20 kÃ½ tá»±)',
        compute='_compute_quick_reply_title',
        store=True,
        readonly=False,
    )
    description = fields.Text(
        string='Messenger Description',
        help='MÃ´ táº£ gá»­i cho khÃ¡ch hÃ ng qua Messenger',
        compute='_compute_description',
        store=True,
        readonly=False,
    )
    image_url = fields.Char(
        string='Image URL',
        compute='_compute_image_url',
        help='URL hÃ¬nh áº£nh gá»­i trong Messenger (tá»« product.image_1920)'
    )
    
    # Pricing
    price = fields.Float(
        string='Price',
        related='product_id.list_price',
        readonly=True,
    )
    currency_id = fields.Many2one(
        'res.currency',
        related='product_id.currency_id',
        readonly=True,
    )
    
    # Organization
    sequence = fields.Integer(
        string='Sequence',
        default=10,
        help='Thá»© tá»± hiá»ƒn thá»‹ trong danh sÃ¡ch sáº£n pháº©m'
    )
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        default=lambda self: self.env.company,
        required=True,
    )
    
    # Statistics
    order_count = fields.Integer(
        string='Orders',
        compute='_compute_order_count',
    )
    
    _sql_constraints = [
        ('product_company_uniq', 
         'UNIQUE(product_id, company_id)', 
         'Product already exists in Messenger catalog for this company!'),
    ]
    
    @api.depends('product_id', 'product_id.name')
    def _compute_display_name(self):
        """TÃªn hiá»ƒn thá»‹ = tÃªn sáº£n pháº©m"""
        for record in self:
            record.display_name = record.product_id.name if record.product_id else ''
    
    @api.depends('product_id', 'product_id.name')
    def _compute_quick_reply_title(self):
        """Auto-fill quick reply title tá»« tÃªn sáº£n pháº©m (max 20 chars)"""
        for record in self:
            if record.product_id and not record.quick_reply_title:
                name = record.product_id.name
                record.quick_reply_title = name[:20] if len(name) > 20 else name
    
    @api.depends('product_id', 'product_id.description_sale')
    def _compute_description(self):
        """Auto-fill description tá»« product"""
        for record in self:
            if record.product_id and not record.description:
                desc = record.product_id.description_sale or record.product_id.name
                record.description = desc
    
    @api.depends('product_id', 'product_id.image_1920')
    def _compute_image_url(self):
        """Generate public URL cho hÃ¬nh áº£nh"""
        for record in self:
            if record.product_id and record.product_id.image_1920:
                base_url = self.env['ir.config_parameter'].sudo().get_param('web.base.url')
                record.image_url = f"{base_url}/web/image/product.product/{record.product_id.id}/image_1920"
            else:
                record.image_url = False
    
    def _compute_order_count(self):
        """Äáº¿m sá»‘ Ä‘Æ¡n hÃ ng tá»« sáº£n pháº©m nÃ y"""
        for record in self:
            # Count sale.order.line cÃ³ product nÃ y tá»« messenger orders
            orders = self.env['social.messenger.order'].search([
                ('sale_order_id.order_line.product_id', '=', record.product_id.id),
                ('company_id', '=', record.company_id.id),
            ])
            record.order_count = len(orders)
    
    @api.constrains('quick_reply_title')
    def _check_quick_reply_title(self):
        """Validate quick reply title length"""
        for record in self:
            if record.quick_reply_title and len(record.quick_reply_title) > 20:
                raise ValidationError(
                    _('Quick Reply Title cannot exceed 20 characters!')
                )
    
    # -------------------------------------------------------------------------
    # BUSINESS METHODS
    # -------------------------------------------------------------------------
    
    @api.model
    def get_active_products(self, company_id=None):
        """
        Láº¥y danh sÃ¡ch sáº£n pháº©m Ä‘ang active cho Messenger.
        
        Returns:
            recordset: social.messenger.product records
        """
        domain = [('active', '=', True)]
        if company_id:
            domain.append(('company_id', '=', company_id))
        else:
            domain.append(('company_id', '=', self.env.company.id))
        
        return self.search(domain, order='sequence, id')
    
    def format_for_messenger(self):
        """
        Format sáº£n pháº©m thÃ nh quick reply buttons cho Messenger.
        
        Returns:
            list: Danh sÃ¡ch quick reply buttons
            [
                {
                    'content_type': 'text',
                    'title': 'Product Name',
                    'payload': 'PRODUCT_123',
                },
                ...
            ]
        """
        self.ensure_one()
        return {
            'content_type': 'text',
            'title': self.quick_reply_title or self.product_id.name[:20],
            'payload': f'PRODUCT_{self.id}',
        }
    
    def get_product_message(self):
        """
        Táº¡o tin nháº¯n giá»›i thiá»‡u sáº£n pháº©m.
        
        Returns:
            str: Message text
        """
        self.ensure_one()
        price_formatted = f"{self.price:,.0f} {self.currency_id.symbol}"
        message = f"ğŸ›ï¸ {self.product_id.name}\n"
        message += f"ğŸ’° GiÃ¡: {price_formatted}\n"
        if self.description:
            message += f"ğŸ“ {self.description}\n"
        return message
    
    # -------------------------------------------------------------------------
    # ACTIONS
    # -------------------------------------------------------------------------
    
    def action_view_orders(self):
        """Xem cÃ¡c Ä‘Æ¡n hÃ ng tá»« sáº£n pháº©m nÃ y"""
        self.ensure_one()
        return {
            'name': _('Messenger Orders'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.messenger.order',
            'view_mode': 'tree,form',
            'domain': [
                ('sale_order_id.order_line.product_id', '=', self.product_id.id),
                ('company_id', '=', self.company_id.id),
            ],
            'context': {'default_product_id': self.product_id.id},
        }
    
    def action_toggle_active(self):
        """Toggle active state"""
        for record in self:
            record.active = not record.active



################################################################################
## FILE 26: social_post.py
## ÄÆ°á»ng dáº«n: models/social_post.py
################################################################################

# FILE: social_post_fixed.py
# PhiÃªn báº£n sá»­a lá»—i khÃ´ng thá»ƒ Ä‘Äƒng áº£nh

from odoo import models, fields, api, _
from odoo.exceptions import UserError
import requests
import logging
from datetime import datetime
import base64  # âœ… THÃŠM IMPORT


_logger = logging.getLogger(__name__)


class SocialPost(models.Model):
    """
    Model quáº£n lÃ½ bÃ i Ä‘Äƒng Facebook.
    """
    _name = 'social.post'
    _description = 'Facebook Post'
    _order = 'create_date desc'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _rec_name = 'display_name'

    # -------------------------------------------------------------------------
    # BASIC INFO
    # -------------------------------------------------------------------------
    display_name = fields.Char(
        string='Display Name',
        compute='_compute_display_name',
        store=True,
    )
    
    account_id = fields.Many2one(
        'social.account',
        string='Facebook Page',
        required=True,
        domain=[('platform', '=', 'facebook')],
    )
    
    content = fields.Text(
        string='Content',
        required=True,
        tracking=True,
    )
    
    # -------------------------------------------------------------------------
    # MEDIA
    # -------------------------------------------------------------------------
    media_type = fields.Selection([
        ('text', 'Text Only'),
        ('photo', 'Photo'),
        ('video', 'Video'),
        ('link', 'Link'),
    ], string='Media Type', default='text')
    
    image = fields.Binary(string='Image', attachment=True)
    image_filename = fields.Char(string='Image Filename')
    video_url = fields.Char(string='Video URL')
    link_url = fields.Char(string='Link URL')
    
    # -------------------------------------------------------------------------
    # SCHEDULING
    # -------------------------------------------------------------------------
    post_type = fields.Selection([
        ('now', 'Publish Now'),
        ('scheduled', 'Scheduled'),
    ], string='Post Type', default='now', required=True)
    
    scheduled_date = fields.Datetime(
        string='Scheduled Date',
        tracking=True,
    )
    
    # -------------------------------------------------------------------------
    # FACEBOOK DATA
    # -------------------------------------------------------------------------
    facebook_post_id = fields.Char(
        string='Facebook Post ID',
        readonly=True,
        copy=False,
    )
    
    facebook_post_url = fields.Char(
        string='Facebook URL',
        compute='_compute_facebook_url',
        store=True,
    )
    
    published_date = fields.Datetime(
        string='Published Date',
        readonly=True,
        copy=False,
    )
    
    # -------------------------------------------------------------------------
    # STATUS
    # -------------------------------------------------------------------------
    state = fields.Selection([
        ('draft', 'Draft'),
        ('scheduled', 'Scheduled'),
        ('published', 'Published'),
        ('failed', 'Failed'),
    ], string='Status', default='draft', tracking=True)
    
    error_message = fields.Text(string='Error Message')
    
    # -------------------------------------------------------------------------
    # ENGAGEMENT STATS
    # -------------------------------------------------------------------------
    likes_count = fields.Integer(string='Likes', default=0)
    comments_count = fields.Integer(string='Comments', default=0)
    shares_count = fields.Integer(string='Shares', default=0)
    reach = fields.Integer(string='Reach', default=0)
    impressions = fields.Integer(string='Impressions', default=0)
    engagement_rate = fields.Float(
        string='Engagement Rate (%)',
        compute='_compute_engagement_rate',
        store=True,
    )
    
    # -------------------------------------------------------------------------
    # RELATIONS
    # -------------------------------------------------------------------------
    comment_ids = fields.One2many(
        'social.comment',
        'post_id',
        string='Comments',
    )
    
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        related='account_id.company_id',
        store=True,
    )
    
    user_id = fields.Many2one(
        'res.users',
        string='Created By',
        default=lambda self: self.env.user,
    )
    
    # -------------------------------------------------------------------------
    # COMPUTE METHODS
    # -------------------------------------------------------------------------
    @api.depends('content', 'account_id')
    def _compute_display_name(self):
        for post in self:
            if post.content:
                preview = post.content[:50] + '...' if len(post.content) > 50 else post.content
                post.display_name = f"{post.account_id.name}: {preview}"
            else:
                post.display_name = f"Post #{post.id}"
    
    @api.depends('facebook_post_id', 'account_id')
    def _compute_facebook_url(self):
        for post in self:
            if post.facebook_post_id and post.account_id:
                post.facebook_post_url = f"https://www.facebook.com/{post.facebook_post_id}"
            else:
                post.facebook_post_url = False
    
    @api.depends('likes_count', 'comments_count', 'shares_count', 'reach')
    def _compute_engagement_rate(self):
        for post in self:
            if post.reach > 0:
                total_engagement = post.likes_count + post.comments_count + post.shares_count
                post.engagement_rate = (total_engagement / post.reach) * 100
            else:
                post.engagement_rate = 0
    
    # -------------------------------------------------------------------------
    # BUSINESS METHODS
    # -------------------------------------------------------------------------
    
    def _prepare_facebook_post_data(self):
        """
        âœ… HÃ m má»›i: Chuáº©n bá»‹ dá»¯ liá»‡u post theo media_type
        
        Return: (url, data_dict, files_dict)
        """
        base_url = f'https://graph.facebook.com/v18.0/{self.account_id.facebook_page_id}'
        
        # Dá»¯ liá»‡u cÆ¡ báº£n
        data = {
            'access_token': self.account_id.access_token,
            'message': self.content,
        }
        
        files = None
        
        # Xá»­ lÃ½ dá»±a trÃªn media_type
        if self.media_type == 'photo':
            if not self.image:
                raise UserError(_('Please upload an image for photo post!'))
            
            # Decode base64 image
            image_binary = base64.b64decode(self.image)
            filename = self.image_filename or 'image.jpg'
            files = {'source': (filename, image_binary)}
            url = f'{base_url}/photos'
            
        elif self.media_type == 'video':
            if not self.video_url:
                raise UserError(_('Please provide a video URL!'))
            
            data['video_url'] = self.video_url
            url = f'{base_url}/feed'
            
        elif self.media_type == 'link':
            if not self.link_url:
                raise UserError(_('Please provide a link URL!'))
            
            data['link'] = self.link_url
            url = f'{base_url}/feed'
            
        else:  # text only
            url = f'{base_url}/feed'
        
        return url, data, files
    
    def action_publish_now(self):
        """âœ… Sá»¬A: ÄÄƒng bÃ i ngay láº­p tá»©c - Há»– TRá»¢ IMAGE"""
        self.ensure_one()
        
        if self.state != 'draft':
            raise UserError(_('Only draft posts can be published!'))
        
        try:
            # âœ… Cáº¦U DIá»†N Äáº¦U TIÃŠN: Chuáº©n bá»‹ dá»¯ liá»‡u
            url, data, files = self._prepare_facebook_post_data()
            
            # âœ… THAY Äá»”I: Gá»­i request vá»›i files náº¿u cÃ³ image
            if files:
                # Vá»›i image: dÃ¹ng multipart/form-data
                response = requests.post(url, data=data, files=files, timeout=30)
            else:
                # Chá»‰ text: dÃ¹ng form-urlencoded thÆ°á»ng
                response = requests.post(url, data=data, timeout=30)
            
            # Xá»­ lÃ½ response
            if response.status_code == 200:
                result = response.json()
                self.write({
                    'facebook_post_id': result.get('id'),
                    'published_date': fields.Datetime.now(),
                    'state': 'published',
                    'error_message': False,
                })
                
                self.message_post(body=_('Post published successfully!'))
                
                return {
                    'type': 'ir.actions.client',
                    'tag': 'display_notification',
                    'params': {
                        'title': _('Success'),
                        'message': _('Post published to Facebook!'),
                        'type': 'success',
                        'sticky': False,
                    }
                }
            else:
                # âœ… THÃŠM: Error handling tá»‘t hÆ¡n
                try:
                    error_detail = response.json().get('error', {})
                    error_msg = error_detail.get('message', response.text)
                except:
                    error_msg = response.text
                
                raise UserError(_('Failed to publish: %s') % error_msg)
                
        except Exception as e:
            error_str = str(e)
            self.write({
                'state': 'failed',
                'error_message': error_str,
            })
            _logger.error(f'Error publishing post {self.id}: {error_str}')
            raise UserError(_('Error publishing post: %s') % error_str)
    
    def action_schedule_post(self):
        """LÃªn lá»‹ch Ä‘Äƒng bÃ i"""
        self.ensure_one()
        
        if not self.scheduled_date:
            raise UserError(_('Please set a scheduled date!'))
        
        if self.scheduled_date <= fields.Datetime.now():
            raise UserError(_('Scheduled date must be in the future!'))
        
        self.state = 'scheduled'
        self.message_post(body=_('Post scheduled for %s') % self.scheduled_date)
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Success'),
                'message': _('Post scheduled successfully!'),
                'type': 'success',
                'sticky': False,
            }
        }
    
    def action_sync_stats(self):
        """Äá»“ng bá»™ thá»‘ng kÃª tá»« Facebook"""
        self.ensure_one()
        
        if not self.facebook_post_id:
            return False
        
        try:
            url = f'https://graph.facebook.com/v18.0/{self.facebook_post_id}'
            params = {
                'access_token': self.account_id.access_token,
                'fields': 'likes.summary(true),comments.summary(true),shares'
            }
            
            response = requests.get(url, params=params, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                self.write({
                    'likes_count': data.get('likes', {}).get('summary', {}).get('total_count', 0),
                    'comments_count': data.get('comments', {}).get('summary', {}).get('total_count', 0),
                    'shares_count': data.get('shares', {}).get('count', 0),
                })
                return True
            else:
                _logger.error(f'Failed to sync stats: {response.text}')
                return False
                
        except Exception as e:
            _logger.error(f'Error syncing stats: {e}')
            return False
    
    def action_view_comments(self):
        """Xem comments"""
        self.ensure_one()
        return {
            'name': _('Comments'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.comment',
            'view_mode': 'list,form',
            'domain': [('post_id', '=', self.id)],
            'context': {'default_post_id': self.id},
        }
    
    @api.model
    def cron_publish_scheduled_posts(self):
        """Cron job Ä‘á»ƒ publish scheduled posts"""
        now = fields.Datetime.now()
        posts = self.search([
            ('state', '=', 'scheduled'),
            ('scheduled_date', '<=', now),
        ])
        
        for post in posts:
            try:
                post.action_publish_now()
            except Exception as e:
                _logger.error(f'Error publishing scheduled post {post.id}: {e}')
    
    @api.model
    def cron_sync_facebook_comments(self):
        """Cron job Ä‘á»ƒ sync comments"""
        posts = self.search([
            ('state', '=', 'published'),
            ('facebook_post_id', '!=', False),
        ], limit=50)
        
        for post in posts:
            try:
                post.action_sync_stats()
            except Exception as e:
                _logger.error(f'Error syncing post {post.id}: {e}')
                
    def action_sync_comments(self):
        """Äá»“ng bá»™ chi tiáº¿t tá»«ng comment tá»« Facebook vá» Odoo"""
        self.ensure_one()
        if not self.facebook_post_id:
            raise UserError(_('Post not published yet!'))
        
        try:
            # Gá»i Graph API láº¥y comments
            url = f'https://graph.facebook.com/v18.0/{self.facebook_post_id}/comments'
            params = {
                'access_token': self.account_id.access_token,
                'fields': 'id,message,from,created_time,parent',
                'limit': 100
            }
            
            response = requests.get(url, params=params, timeout=30)
            if response.status_code == 200:
                data = response.json()
                
                # Loop qua tá»«ng comment
                for fb_comment in data.get('data', []):
                    # Kiá»ƒm tra xem comment Ä‘Ã£ cÃ³ chÆ°a
                    existing = self.env['social.comment'].search([
                        ('facebook_comment_id', '=', fb_comment['id']),
                        ('post_id', '=', self.id)
                    ], limit=1)
                    
                    if not existing:
                        # Táº¡o má»›i comment record
                        author = fb_comment.get('from', {})
                        self.env['social.comment'].create({
                            'post_id': self.id,
                            'facebook_comment_id': fb_comment['id'],
                            'author_name': author.get('name', 'Unknown'),
                            'author_facebook_id': author.get('id', ''),
                            'message': fb_comment.get('message', ''),
                            'comment_date': fb_comment.get('created_time'),
                            'company_id': self.company_id.id,
                        })
                
                self.message_post(body=_('Comments synced from Facebook!'))
                return True
            else:
                raise UserError(_('Failed to sync comments: %s') % response.text)
                
        except Exception as e:
            raise UserError(_('Error syncing comments: %s') % str(e))




################################################################################
## FILE 27: social_post_template.py
## ÄÆ°á»ng dáº«n: models/social_post_template.py
################################################################################

from odoo import models, fields, api, _


class SocialPostTemplate(models.Model):
    """
    Model quáº£n lÃ½ templates cho bÃ i Ä‘Äƒng.
    """
    _name = 'social.post.template'
    _description = 'Social Post Template'
    _order = 'name'

    name = fields.Char(
        string='Template Name',
        required=True,
    )
    
    template_type = fields.Selection([
        ('product_launch', 'Product Launch'),
        ('promotion', 'Promotion'),
        ('testimonial', 'Testimonial'),
        ('educational', 'Educational'),
        ('engagement', 'Engagement'),
        ('event', 'Event'),
        ('custom', 'Custom'),
    ], string='Type', default='custom')
    
    content = fields.Text(
        string='Content Template',
        required=True,
        help='Use {{variable_name}} for dynamic content'
    )
    
    description = fields.Text(string='Description')
    
    active = fields.Boolean(string='Active', default=True)
    
    company_id = fields.Many2one(
        'res.company',
        string='Company',
        default=lambda self: self.env.company,
    )
    
    def action_use_template(self):
        """Sá»­ dá»¥ng template Ä‘á»ƒ táº¡o post má»›i"""
        self.ensure_one()
        return {
            'name': _('New Post from Template'),
            'type': 'ir.actions.act_window',
            'res_model': 'social.post',
            'view_mode': 'form',
            'context': {
                'default_content': self.content,
            },
        }



################################################################################
## FILE 28: ir.model.access.csv
## ÄÆ°á»ng dáº«n: security/ir.model.access.csv
################################################################################

id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
access_social_account_user,social.account.user,model_social_account,base.group_user,1,1,1,1
access_social_post_user,social.post.user,model_social_post,base.group_user,1,1,1,1
access_social_comment_user,social.comment.user,model_social_comment,base.group_user,1,1,1,1
access_social_message_user,social.message.user,model_social_message,base.group_user,1,1,1,1
access_social_analytics_user,social.analytics.user,model_social_analytics,base.group_user,1,0,0,0
access_social_post_template_user,social.post.template.user,model_social_post_template,base.group_user,1,1,1,1
access_social_messenger_product_user,social.messenger.product.user,model_social_messenger_product,base.group_user,1,1,1,1
access_social_messenger_order_user,social.messenger.order.user,model_social_messenger_order,base.group_user,1,1,1,1
access_social_conversation_user,social.conversation.user,model_social_conversation,base.group_user,1,1,1,1



################################################################################
## FILE 29: social_security.xml
## ÄÆ°á»ng dáº«n: security/social_security.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- USER GROUPS -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    
    <record id="group_social_user" model="res.groups">
        <field name="name">Social Media User</field>
        <field name="implied_ids" eval="[(4, ref('base.group_user'))]"/>
        <field name="comment">CÃ³ thá»ƒ xem vÃ  táº¡o bÃ i Ä‘Äƒng trÃªn Facebook</field>
    </record>

    <record id="group_social_manager" model="res.groups">
        <field name="name">Social Media Manager</field>
        <field name="implied_ids" eval="[(4, ref('group_social_user'))]"/>
        <field name="comment">CÃ³ thá»ƒ quáº£n lÃ½ táº¥t cáº£ cáº¥u hÃ¬nh vÃ  tÃ i khoáº£n Facebook</field>
    </record>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- RECORD RULES - Multi-company Access Control -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    
    <!-- Social Account Rules -->
    <record id="social_account_rule_user" model="ir.rule">
        <field name="name">Social Account: User Access</field>
        <field name="model_id" ref="model_social_account"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>

    <!-- Social Post Rules -->
    <record id="social_post_rule_user" model="ir.rule">
        <field name="name">Social Post: User Access</field>
        <field name="model_id" ref="model_social_post"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>

    <!-- Social Post Template Rules -->
    <record id="social_post_template_rule_user" model="ir.rule">
        <field name="name">Social Post Template: User Access</field>
        <field name="model_id" ref="model_social_post_template"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>

    <!-- Social Comment Rules -->
    <record id="social_comment_rule_user" model="ir.rule">
        <field name="name">Social Comment: User Access</field>
        <field name="model_id" ref="model_social_comment"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>
    
    <!-- Social Message Rules -->
    <record id="social_message_rule_user" model="ir.rule">
        <field name="name">Social Message: User Access</field>
        <field name="model_id" ref="model_social_message"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>
    
    <!-- Social Analytics Rules -->
    <record id="social_analytics_rule_user" model="ir.rule">
        <field name="name">Social Analytics: User Access</field>
        <field name="model_id" ref="model_social_analytics"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>
    
    <!-- Social Messenger Product Rules -->
    <record id="social_messenger_product_rule_user" model="ir.rule">
        <field name="name">Messenger Product: User Access</field>
        <field name="model_id" ref="model_social_messenger_product"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>
    
    <!-- Social Messenger Order Rules -->
    <record id="social_messenger_order_rule_user" model="ir.rule">
        <field name="name">Messenger Order: User Access</field>
        <field name="model_id" ref="model_social_messenger_order"/>
        <field name="domain_force">[('company_id', 'in', company_ids)]</field>
        <field name="groups" eval="[(4, ref('group_social_user'))]"/>
    </record>

</odoo>



################################################################################
## FILE 30: icon.png
## ÄÆ°á»ng dáº«n: static/description/icon.png
################################################################################

[KhÃ´ng Ä‘á»c Ä‘Æ°á»£c file â€“ cÃ³ thá»ƒ lÃ  binary hoáº·c lá»—i mÃ£ hÃ³a]



################################################################################
## FILE 31: social_facebook.css
## ÄÆ°á»ng dáº«n: static/src/css/social_facebook.css
################################################################################

/*
 * CSS for Social Facebook Module
 */

.social_post_card {
    border-left: 4px solid #1877f2;
    transition: transform 0.2s;
}

.social_post_card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.facebook_badge {
    background-color: #1877f2;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

.engagement_stats {
    display: flex;
    gap: 1rem;
}

.engagement_stats .stat {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}



################################################################################
## FILE 32: social_conversation_list.js
## ÄÆ°á»ng dáº«n: static/src/js/social_conversation_list.js
################################################################################

/** @odoo-module **/

import { ListController } from "@web/views/list/list_controller";
import { listView } from "@web/views/list/list_view";
import { registry } from "@web/core/registry";
import { useService } from "@web/core/utils/hooks";

/**
 * Custom List Controller for Social Conversation
 * Adds "Sync All Conversations" button to the toolbar
 */
export class SocialConversationListController extends ListController {
    setup() {
        super.setup();
        this.orm = useService("orm");
        this.action = useService("action");
        this.notification = useService("notification");
    }

    /**
     * Handler for Sync All Conversations button
     */
    async onClickSyncConversations() {
        // Show loading notification
        this.notification.add("Äang Ä‘á»“ng bá»™ conversations tá»« Facebook...", {
            type: "info",
        });

        try {
            // Call the server method
            const result = await this.orm.call(
                "social.conversation",
                "action_sync_all_conversations",
                [[]]
            );

            // Reload the list view
            await this.model.load();

            // Show success notification
            if (result && result.params) {
                this.notification.add(result.params.message, {
                    type: result.params.type || "success",
                    sticky: result.params.sticky || false,
                });
            } else {
                this.notification.add("Äá»“ng bá»™ hoÃ n táº¥t!", {
                    type: "success",
                });
            }
        } catch (error) {
            console.error("Error syncing conversations:", error);
            this.notification.add("Lá»—i khi Ä‘á»“ng bá»™: " + (error.message || error), {
                type: "danger",
                sticky: true,
            });
        }
    }
}

// Define the template with the sync button
SocialConversationListController.template = "module_social_facebook.SocialConversationListView";

// Create custom list view for social.conversation
export const SocialConversationListView = {
    ...listView,
    Controller: SocialConversationListController,
    buttonTemplate: "module_social_facebook.SocialConversationListView.Buttons",
};

// Register the view
registry.category("views").add("social_conversation_list", SocialConversationListView);



################################################################################
## FILE 33: social_dashboard.js
## ÄÆ°á»ng dáº«n: static/src/js/social_dashboard.js
################################################################################

/** @odoo-module **/

console.log('Social Facebook Dashboard JS loaded');



################################################################################
## FILE 34: social_conversation_templates.xml
## ÄÆ°á»ng dáº«n: static/src/xml/social_conversation_templates.xml
################################################################################

<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <!-- Template for Sync button in list view toolbar -->
    <t t-name="module_social_facebook.SocialConversationListView.Buttons" t-inherit="web.ListView.Buttons">
        <xpath expr="//div[hasclass('o_list_buttons')]" position="inside">
            <button type="button" 
                    class="btn btn-primary o_sync_conversations_button ms-2"
                    t-on-click="() => this.onClickSyncConversations()">
                <i class="fa fa-refresh me-1"/>
                Sync Conversations
            </button>
        </xpath>
    </t>

    <!-- Alternative: Full button template -->
    <t t-name="module_social_facebook.SocialConversationListView">
        <t t-call="web.ListView"/>
    </t>

</templates>



################################################################################
## FILE 35: dashboard_views.xml
## ÄÆ°á»ng dáº«n: views/dashboard_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="action_social_dashboard" model="ir.actions.act_window">
        <field name="name">Social Media Dashboard</field>
        <field name="res_model">social.analytics</field>
        <field name="view_mode">pivot,graph,list</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">Welcome to Social Media Dashboard!</p>
        </field>
    </record>

</odoo>




################################################################################
## FILE 36: menu_views.xml
## ÄÆ°á»ng dáº«n: views/menu_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- ROOT MENU                                                             -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_marketing_root"
              name="Social"
              web_icon="module_social_facebook,static/description/icon.png"
              sequence="100"/>

    <!-- ===================================================================== -->
    <!-- DASHBOARD                                                             -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_dashboard"
              name="Dashboard"
              parent="menu_social_marketing_root"
              action="action_social_dashboard"
              sequence="1"/>

    <!-- ===================================================================== -->
    <!-- FACEBOOK PAGES                                                        -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_accounts"
              name="Facebook Pages"
              parent="menu_social_marketing_root"
              action="action_social_account"
              sequence="10"/>

    <!-- ===================================================================== -->
    <!-- POSTS                                                                 -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_posts"
              name="Posts"
              parent="menu_social_marketing_root"
              sequence="20"/>

    <menuitem id="menu_social_all_posts"
              name="All Posts"
              parent="menu_social_posts"
              action="action_social_post"
              sequence="10"/>

    <menuitem id="menu_social_post_calendar"
              name="Content Calendar"
              parent="menu_social_posts"
              action="action_social_post_calendar"
              sequence="15"/>

    <!-- ===================================================================== -->
    <!-- TEMPLATES                                                             -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_templates"
              name="Templates"
              parent="menu_social_marketing_root"
              action="action_social_post_template"
              sequence="30"/>

    <!-- ===================================================================== -->
    <!-- COMMENTS                                                              -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_comments"
              name="Comments"
              parent="menu_social_marketing_root"
              action="action_social_comment"
              sequence="40"/>

    <!-- ===================================================================== -->
    <!-- CONVERSATIONS - Sá»¬A ACTION Tá»ª social.message â†’ social.conversation -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_conversations"
              name="Messenger Conversations"
              parent="menu_social_marketing_root"
              action="action_social_conversation"
              sequence="50"/>

    <!-- ===================================================================== -->
    <!-- MESSENGER SALES                                                       -->
    <!-- ===================================================================== -->
    <menuitem id="menu_messenger_sales"
              name="Messenger Sales"
              parent="menu_social_marketing_root"
              sequence="60"/>

    <menuitem id="menu_messenger_products"
              name="Products"
              parent="menu_messenger_sales"
              action="action_social_messenger_product"
              sequence="10"/>

    <menuitem id="menu_messenger_orders"
              name="Orders"
              parent="menu_messenger_sales"
              action="action_social_messenger_order"
              sequence="20"/>

    <!-- ===================================================================== -->
    <!-- ANALYTICS                                                             -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_analytics"
              name="Analytics"
              parent="menu_social_marketing_root"
              action="action_social_analytics"
              sequence="70"/>

    <!-- ===================================================================== -->
    <!-- CONFIGURATION                                                         -->
    <!-- ===================================================================== -->
    <menuitem id="menu_social_configuration"
              name="Configuration"
              parent="menu_social_marketing_root"
              sequence="100"/>

</odoo>



################################################################################
## FILE 37: res_config_settings_views.md
## ÄÆ°á»ng dáº«n: views/res_config_settings_views.md
################################################################################

<odoo>

    <record id="res_config_settings_view_form_social_facebook" model="ir.ui.view">
        <field name="name">res.config.settings.view.form.inherit.social.facebook</field>
        <field name="model">res.config.settings</field>
        <field name="inherit_id" ref="base.res_config_settings_view_form"/>
        <field name="arch" type="xml">
            <!-- FIX: Target vÃ o sheet thay vÃ¬ div[class='settings'] -->
            <xpath expr="//sheet" position="inside">
                
                <div class="app_settings_block" data_key="module_social_facebook" 
                     string="Facebook Integration">
                    <h2>Facebook Integration</h2>
                    
                    <!-- Webhook Configuration -->
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane"></div>
                            <div class="o_setting_right_pane">
                                <span class="o_form_label">Webhook Configuration</span>
                                <div class="text-muted">
                                    Configure your Facebook webhook settings
                                </div>
                                <div class="content-group mt16">
                                    <div class="row">
                                        <label for="facebook_verify_token" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="facebook_verify_token" 
                                               placeholder="e.g., 16112005"/>
                                    </div>
                                    <div class="row mt8">
                                        <label string="Webhook URL" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="facebook_webhook_url" readonly="1"/>
                                        <button name="action_copy_webhook_url" 
                                                type="object" 
                                                string="Copy URL" 
                                                class="btn-link ml8"
                                                icon="fa-copy"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ngrok Integration -->
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane"></div>
                            <div class="o_setting_right_pane">
                                <span class="o_form_label">Ngrok Integration</span>
                                <div class="text-muted">
                                    Manage ngrok tunnel for localhost development
                                </div>
                                <div class="content-group mt16">
                                    <div class="row">
                                        <label for="ngrok_executable_path" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="ngrok_executable_path" 
                                               placeholder="C:/ngrok/ngrok.exe"/>
                                    </div>
                                    <div class="row mt8">
                                        <label string="Ngrok Status" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="ngrok_is_running" readonly="1" 
                                               widget="boolean"/>
                                        <span class="ml8" 
                                              invisible="not ngrok_is_running">
                                            âœ… Running
                                        </span>
                                        <span class="ml8 text-muted" 
                                              invisible="ngrok_is_running">
                                            â›” Not Running
                                        </span>
                                    </div>
                                    <div class="row mt8" 
                                         invisible="not ngrok_tunnel_url">
                                        <label string="Public URL" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="ngrok_tunnel_url" readonly="1" 
                                               class="text-primary font-weight-bold"/>
                                    </div>
                                    <div class="row mt16">
                                        <div class="col-lg-3"></div>
                                        <div>
                                            <button name="action_start_ngrok" 
                                                    type="object" 
                                                    string="Start Ngrok" 
                                                    class="btn-primary"
                                                    icon="fa-play"
                                                    invisible="ngrok_is_running"/>
                                            <button name="action_stop_ngrok" 
                                                    type="object" 
                                                    string="Stop Ngrok" 
                                                    class="btn-secondary ml8"
                                                    icon="fa-stop"
                                                    invisible="not ngrok_is_running"/>
                                            <button name="action_refresh_ngrok_url" 
                                                    type="object" 
                                                    string="Refresh" 
                                                    class="btn-link ml8"
                                                    icon="fa-refresh"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CRM Integration -->
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane">
                                <field name="auto_create_lead"/>
                            </div>
                            <div class="o_setting_right_pane">
                                <label for="auto_create_lead"/>
                                <div class="text-muted">
                                    Automatically create CRM leads from Messenger conversations
                                </div>
                                <div class="content-group mt16" 
                                     invisible="not auto_create_lead">
                                    <div class="row">
                                        <label for="lead_default_user_id" 
                                               string="Default Salesperson" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="lead_default_user_id"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chatbot Configuration -->
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane">
                                <field name="chatbot_enabled"/>
                            </div>
                            <div class="o_setting_right_pane">
                                <label for="chatbot_enabled"/>
                                <div class="text-muted">
                                    Enable automatic sales chatbot on Messenger
                                </div>
                                <div class="content-group mt16" 
                                     invisible="not chatbot_enabled">
                                    <div class="row">
                                        <label for="chatbot_welcome_message" 
                                               string="Welcome Message" 
                                               class="col-lg-3 o_light_label"/>
                                        <field name="chatbot_welcome_message" 
                                               widget="text"/>
                                    </div>
                                    <div class="alert alert-info mt16" role="alert">
                                        <strong>Chatbot Flow:</strong><br/>
                                        1. Ask customer name<br/>
                                        2. Ask phone number<br/>
                                        3. Show product catalog<br/>
                                        4. Confirm order<br/>
                                        5. Create sale order automatically
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
            </xpath>
        </field>
    </record>

</odoo>



################################################################################
## FILE 38: social_account_views.xml
## ÄÆ°á»ng dáº«n: views/social_account_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ============================================================
         SOCIAL ACCOUNT - LIST VIEW
         ============================================================ -->
    <record id="social_account_view_tree" model="ir.ui.view">
        <field name="name">social.account.list</field>
        <field name="model">social.account</field>
        <field name="arch" type="xml">
            <list string="Facebook Pages" decoration-muted="not active">
                <field name="name"/>
                <field name="facebook_page_id"/>
                <field name="state" widget="badge" decoration-success="state == 'connected'" decoration-danger="state == 'error'" decoration-info="state == 'draft'"/>
                <field name="followers_count"/>
                <field name="likes_count"/>
                <field name="post_count"/>
                <field name="conversation_count"/>
                <field name="last_sync_date"/>
                <field name="last_message_sync_date"/>
                <field name="active" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- ============================================================
         SOCIAL ACCOUNT - FORM VIEW (Cáº¬P NHáº¬T Vá»šI NÃšT SYNC CONVERSATIONS)
         ============================================================ -->
    <record id="social_account_view_form" model="ir.ui.view">
        <field name="name">social.account.form</field>
        <field name="model">social.account</field>
        <field name="arch" type="xml">
            <form string="Facebook Page">
                <header>
                    <button name="action_test_connection" type="object" string="Test Connection" class="btn-primary" invisible="state == 'connected'"/>
                    <button name="action_sync_page_info" type="object" string="Sync Page Info" class="btn-secondary" invisible="state != 'connected'"/>
                    <!-- âœ… THÃŠM: NÃšT SYNC CONVERSATIONS -->
                    <button name="action_sync_conversations" type="object" string="ğŸ”„ Sync Conversations" class="btn-primary" invisible="state != 'connected'"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,connected"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_posts" type="object" class="oe_stat_button" icon="fa-newspaper-o">
                            <field name="post_count" widget="statinfo" string="Posts"/>
                        </button>
                        <!-- âœ… THÃŠM: NÃšT XEM CONVERSATIONS -->
                        <button name="action_view_conversations" type="object" class="oe_stat_button" icon="fa-comments">
                            <field name="conversation_count" widget="statinfo" string="Conversations"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name" placeholder="Enter Facebook Page Name..."/>
                        </h1>
                    </div>
                    <group>
                        <group string="Facebook Information">
                            <field name="platform" readonly="1"/>
                            <field name="facebook_page_id" placeholder="Enter Page ID..."/>
                            <field name="facebook_page_url" widget="url" readonly="1"/>
                            <field name="page_category" readonly="1"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                            <field name="active" widget="boolean_toggle"/>
                        </group>
                        <group string="Statistics">
                            <field name="followers_count" readonly="1"/>
                            <field name="likes_count" readonly="1"/>
                            <field name="page_rating" readonly="1"/>
                            <field name="last_sync_date" readonly="1"/>
                            <field name="last_message_sync_date" readonly="1"/>
                        </group>
                    </group>
                    <group string="Authentication">
                        <group>
                            <field name="access_token" password="True"/>
                        </group>
                        <group>
                            <field name="token_expires_at"/>
                            <field name="is_token_valid"/>
                        </group>
                    </group>
                    <group string="Settings">
                        <group>
                            <field name="auto_sync_comments"/>
                        </group>
                        <group>
                            <field name="auto_sync_messages"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="About" name="about">
                            <field name="page_about" readonly="1"/>
                        </page>
                        <page string="Error Log" name="errors" invisible="not error_message">
                            <field name="error_message" readonly="1"/>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ============================================================
         SOCIAL ACCOUNT - KANBAN VIEW
         ============================================================ -->
    <record id="social_account_view_kanban" model="ir.ui.view">
        <field name="name">social.account.kanban</field>
        <field name="model">social.account</field>
        <field name="arch" type="xml">
            <kanban>
                <field name="name"/>
                <field name="state"/>
                <field name="followers_count"/>
                <field name="likes_count"/>
                <field name="post_count"/>
                <field name="conversation_count"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_content">
                            <div class="o_kanban_record_top">
                                <strong class="o_kanban_record_title">
                                    <field name="name"/>
                                </strong>
                            </div>
                            <div class="o_kanban_record_body">
                                <div>Status: <field name="state"/></div>
                                <div><field name="followers_count"/> followers</div>
                                <div><field name="likes_count"/> likes</div>
                                <div><field name="post_count"/> posts</div>
                                <div><field name="conversation_count"/> conversations</div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ============================================================
         SOCIAL ACCOUNT - SEARCH VIEW
         ============================================================ -->
    <record id="social_account_view_search" model="ir.ui.view">
        <field name="name">social.account.search</field>
        <field name="model">social.account</field>
        <field name="arch" type="xml">
            <search string="Search Facebook Pages">
                <field name="name"/>
                <field name="facebook_page_id"/>
                <field name="state"/>
                <field name="company_id" groups="base.group_multi_company"/>
                <filter string="Connected" name="filter_connected" domain="[('state', '=', 'connected')]"/>
                <filter string="Draft" name="filter_draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Error" name="filter_error" domain="[('state', '=', 'error')]"/>
                <filter string="Active" name="filter_active" domain="[('active', '=', True)]"/>
                <filter string="Group By Status" name="group_state" context="{'group_by': 'state'}"/>
                <filter string="Group By Company" name="group_company" context="{'group_by': 'company_id'}" groups="base.group_multi_company"/>
            </search>
        </field>
    </record>

    <!-- ============================================================
         SOCIAL ACCOUNT - ACTION
         ============================================================ -->
    <record id="action_social_account" model="ir.actions.act_window">
        <field name="name">Facebook Pages</field>
        <field name="res_model">social.account</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="search_view_id" ref="social_account_view_search"/>
        <field name="context">{'search_default_filter_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Connect your first Facebook Page!
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 39: social_analytics_views.xml
## ÄÆ°á»ng dáº«n: views/social_analytics_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="social_analytics_view_pivot" model="ir.ui.view">
        <field name="name">social.analytics.pivot</field>
        <field name="model">social.analytics</field>
        <field name="arch" type="xml">
            <pivot string="Facebook Analytics">
                <field name="account_id" type="row"/>
                <field name="date" interval="month" type="col"/>
                <field name="total_posts" type="measure"/>
                <field name="total_likes" type="measure"/>
                <field name="total_comments" type="measure"/>
            </pivot>
        </field>
    </record>

    <record id="social_analytics_view_graph" model="ir.ui.view">
        <field name="name">social.analytics.graph</field>
        <field name="model">social.analytics</field>
        <field name="arch" type="xml">
            <graph string="Facebook Analytics" type="line">
                <field name="date" interval="day"/>
                <field name="total_likes" type="measure"/>
                <field name="total_comments" type="measure"/>
            </graph>
        </field>
    </record>

    <record id="social_analytics_view_tree" model="ir.ui.view">
        <field name="name">social.analytics.list</field>
        <field name="model">social.analytics</field>
        <field name="arch" type="xml">
            <list string="Facebook Analytics" create="0" edit="0" delete="0">
                <field name="date"/>
                <field name="account_id"/>
                <field name="total_posts"/>
                <field name="total_likes"/>
                <field name="total_comments"/>
                <field name="total_shares"/>
                <field name="avg_engagement_rate"/>
            </list>
        </field>
    </record>

    <record id="action_social_analytics" model="ir.actions.act_window">
        <field name="name">Facebook Analytics</field>
        <field name="res_model">social.analytics</field>
        <field name="view_mode">pivot,graph,list</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">No analytics data yet!</p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 40: social_comment_views.xml
## ÄÆ°á»ng dáº«n: views/social_comment_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="social_comment_view_tree" model="ir.ui.view">
        <field name="name">social.comment.list</field>
        <field name="model">social.comment</field>
        <field name="arch" type="xml">
            <list string="Facebook Comments" 
                  decoration-muted="is_hidden"
                  decoration-danger="is_spam"
                  decoration-success="replied">
                <field name="comment_date"/>
                <field name="post_id"/>
                <field name="author_name"/>
                <field name="message"/>
                <field name="replied"/>
                <field name="is_hidden" optional="hide"/>
                <field name="is_spam" optional="hide"/>
            </list>
        </field>
    </record>

    <record id="social_comment_view_form" model="ir.ui.view">
        <field name="name">social.comment.form</field>
        <field name="model">social.comment</field>
        <field name="arch" type="xml">
            <form string="Facebook Comment">
                <header>
                    <button name="action_reply" type="object" string="Reply" class="btn-primary" invisible="replied"/>
                    <button name="action_hide" type="object" string="Hide" class="btn-secondary" invisible="is_hidden"/>
                    <button name="action_mark_spam" type="object" string="Mark Spam" class="btn-danger" invisible="is_spam"/>
                </header>
                <sheet>
                    <group>
                        <group string="Comment Info">
                            <field name="post_id"/>
                            <field name="comment_date"/>
                            <field name="facebook_comment_id"/>
                        </group>
                        <group string="Author">
                            <field name="author_name"/>
                            <field name="author_facebook_id"/>
                        </group>
                    </group>
                    <group string="Message">
                        <field name="message" nolabel="1" readonly="1"/>
                    </group>
                    <group string="Reply" invisible="replied">
                        <field name="reply_text" nolabel="1"/>
                    </group>
                    <group string="Status">
                        <field name="replied"/>
                        <field name="is_hidden"/>
                        <field name="is_spam"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_social_comment" model="ir.actions.act_window">
        <field name="name">Facebook Comments</field>
        <field name="res_model">social.comment</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">No comments yet!</p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 41: social_conversation_views.xml
## ÄÆ°á»ng dáº«n: views/social_conversation_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Form View -->
    <record id="social_conversation_view_form" model="ir.ui.view">
        <field name="name">social.conversation.form</field>
        <field name="model">social.conversation</field>
        <field name="arch" type="xml">
            <form string="Messenger Conversation">
                <header>
                    <button name="action_create_lead" type="object" string="Create Lead" class="btn-primary" invisible="lead_id"/>
                    <button name="action_mark_resolved" type="object" string="Mark Resolved" class="btn-success" invisible="state in ['resolved', 'closed']"/>
                    <button name="action_close" type="object" string="Close" class="btn-secondary" invisible="state == 'closed'"/>
                    <button name="action_reopen" type="object" string="Reopen" class="btn-warning" invisible="state != 'closed'"/>
                    <field name="state" widget="statusbar" statusbar_visible="new,ongoing,resolved"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_messages" type="object" class="oe_stat_button" icon="fa-comments">
                            <field name="message_count" widget="statinfo" string="Messages"/>
                        </button>
                    </div>
                    <group>
                        <group string="Customer Information">
                            <field name="customer_name"/>
                            <field name="customer_psid"/>
                            <field name="customer_phone"/>
                            <field name="customer_email"/>
                        </group>
                        <group string="Conversation Details">
                            <field name="account_id"/>
                            <field name="conversation_id"/>
                            <field name="lead_id"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                        </group>
                    </group>
                    <group>
                        <group string="Tracking">
                            <field name="last_message_date"/>
                            <field name="last_message_from"/>
                            <field name="unread_count"/>
                            <field name="first_response_time"/>
                        </group>
                        <group string="Status">
                            <field name="active"/>
                        </group>
                    </group>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- List View -->
    <record id="social_conversation_view_list" model="ir.ui.view">
        <field name="name">social.conversation.list</field>
        <field name="model">social.conversation</field>
        <field name="arch" type="xml">
            <list string="Messenger Conversations">
                <field name="customer_name"/>
                <field name="account_id"/>
                <field name="state"/>
                <field name="message_count"/>
                <field name="unread_count"/>
                <field name="last_message_date"/>
                <field name="lead_id"/>
            </list>
        </field>
    </record>

    <!-- Search View - SIMPLIFIED -->
    <record id="social_conversation_view_search" model="ir.ui.view">
        <field name="name">social.conversation.search</field>
        <field name="model">social.conversation</field>
        <field name="arch" type="xml">
            <search>
                <field name="customer_name"/>
                <field name="account_id"/>
                <field name="lead_id"/>
            </search>
        </field>
    </record>

    <!-- Action -->
    <record id="action_social_conversation" model="ir.actions.act_window">
        <field name="name">Messenger Conversations</field>
        <field name="res_model">social.conversation</field>
        <field name="view_mode">list,form</field>
    </record>

</odoo>



################################################################################
## FILE 42: social_message_views.xml
## ÄÆ°á»ng dáº«n: views/social_message_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- MESSAGE (CONVERSATION) - LIST VIEW                                    -->
    <!-- ===================================================================== -->
    <record id="social_message_view_tree" model="ir.ui.view">
        <field name="name">social.message.list</field>
        <field name="model">social.message</field>
        <field name="arch" type="xml">
            <list string="Facebook Conversations" 
                  decoration-info="is_from_customer == False"
                  decoration-muted="is_from_customer == True">
                <field name="account_id"/>
                <field name="facebook_user_id"/>
                <field name="customer_name"/>
                <field name="message"/>
                <field name="created_date"/>
                <field name="last_message_date"/>
                <field name="is_from_customer" widget="boolean"/>
                <field name="chatbot_state" widget="badge"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSAGE - FORM VIEW                                                   -->
    <!-- ===================================================================== -->
    <record id="social_message_view_form" model="ir.ui.view">
        <field name="name">social.message.form</field>
        <field name="model">social.message</field>
        <field name="arch" type="xml">
            <form string="Facebook Message / Conversation">
                <header>
                    <field name="chatbot_state" widget="statusbar" 
                           statusbar_visible="idle,ask_name,ask_phone,show_products,confirm_order,completed"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <label for="facebook_user_id" string="Conversation with"/>
                        <h1>
                            <field name="customer_name" placeholder="Customer Name"/>
                        </h1>
                        <h3>
                            <field name="facebook_user_id" readonly="1"/>
                        </h3>
                    </div>
                    
                    <group>
                        <group string="Conversation Info">
                            <field name="account_id" readonly="1"/>
                            <field name="message_id" readonly="1"/>
                            <field name="is_from_customer" widget="boolean"/>
                        </group>
                        <group string="Timestamps">
                            <field name="created_date" readonly="1"/>
                            <field name="last_message_date" readonly="1"/>
                        </group>
                    </group>
                    
                    <group string="Message Content">
                        <field name="message" nolabel="1" widget="text"/>
                    </group>
                    
                    <group string="Customer Info (Chatbot)">
                        <group>
                            <field name="customer_phone"/>
                        </group>
                        <group>
                            <field name="chatbot_state"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Products" name="products">
                            <field name="selected_product_ids" nolabel="1">
                                <list>
                                    <field name="display_name"/>
                                    <field name="price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                    <field name="currency_id" column_invisible="1"/>
                                    <field name="active" widget="boolean"/>
                                    <field name="sequence"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="Related Records" name="related">
                            <group>
                                <field name="lead_id"/>
                                <field name="messenger_order_id"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_ids" widget="mail_thread"/>
                    <field name="activity_ids" widget="mail_activity"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSAGE - SEARCH VIEW                                                 -->
    <!-- ===================================================================== -->
    <record id="social_message_view_search" model="ir.ui.view">
        <field name="name">social.message.search</field>
        <field name="model">social.message</field>
        <field name="arch" type="xml">
            <search string="Search Conversations">
                <field name="facebook_user_id"/>
                <field name="customer_name"/>
                <field name="message"/>
                <field name="account_id"/>
                
                <filter string="From Customer" name="filter_from_customer" 
                        domain="[('is_from_customer', '=', True)]"/>
                <filter string="From Page" name="filter_from_page" 
                        domain="[('is_from_customer', '=', False)]"/>
                <separator/>
                
                <filter string="Idle" name="filter_idle" 
                        domain="[('chatbot_state', '=', 'idle')]"/>
                <filter string="In Progress" name="filter_progress" 
                        domain="[('chatbot_state', 'in', ['ask_name', 'ask_phone', 'show_products', 'confirm_order'])]"/>
                <filter string="Completed" name="filter_completed" 
                        domain="[('chatbot_state', '=', 'completed')]"/>
                <separator/>
                
                <filter string="This Week" name="filter_week" 
                        domain="[('created_date', '&gt;=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                <filter string="This Month" name="filter_month" 
                        domain="[('created_date', '&gt;=', (context_today().replace(day=1)).strftime('%Y-%m-%d'))]"/>
                <separator/>
                
                <filter string="Has Lead" name="filter_has_lead" 
                        domain="[('lead_id', '!=', False)]"/>
                <filter string="Has Order" name="filter_has_order" 
                        domain="[('messenger_order_id', '!=', False)]"/>
                <separator/>
                
                <filter string="Group By Page" name="group_account" 
                        context="{'group_by': 'account_id'}"/>
                <filter string="Group By State" name="group_state" 
                        context="{'group_by': 'chatbot_state'}"/>
                <filter string="Group By Date" name="group_date" 
                        context="{'group_by': 'created_date:month'}"/>
            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSAGE - ACTION                                                      -->
    <!-- ===================================================================== -->
    <record id="action_social_message" model="ir.actions.act_window">
        <field name="name">Facebook Conversations</field>
        <field name="res_model">social.message</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="social_message_view_search"/>
        <field name="context">{'search_default_filter_from_customer': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No conversations yet!
            </p>
            <p>
                Conversations will appear here when customers message your Facebook page.
            </p>
            <p>
                <strong>Webhook must be configured to receive messages automatically.</strong>
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 43: social_messenger_order_views.xml
## ÄÆ°á»ng dáº«n: views/social_messenger_order_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- MESSENGER ORDER - LIST VIEW                                           -->
    <!-- ===================================================================== -->
    <record id="social_messenger_order_view_tree" model="ir.ui.view">
        <field name="name">social.messenger.order.list</field>
        <field name="model">social.messenger.order</field>
        <field name="arch" type="xml">
            <list string="Messenger Orders" 
                  decoration-success="state == 'sale'" 
                  decoration-info="state == 'confirmed'"
                  decoration-muted="state == 'cancelled'">
                <field name="name"/>
                <field name="order_date"/>
                <field name="customer_name"/>
                <field name="customer_phone"/>
                <field name="total_amount" widget="monetary" options="{'currency_field': 'currency_id'}" sum="Total"/>
                <field name="currency_id" column_invisible="1"/>
                <field name="state" widget="badge" 
                       decoration-success="state == 'sale'"
                       decoration-info="state == 'confirmed'"
                       decoration-muted="state == 'cancelled'"/>
                <field name="sale_order_id"/>
                <field name="user_id" widget="many2one_avatar_user"/>
                <field name="company_id" groups="base.group_multi_company" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER ORDER - FORM VIEW                                           -->
    <!-- ===================================================================== -->
    <record id="social_messenger_order_view_form" model="ir.ui.view">
        <field name="name">social.messenger.order.form</field>
        <field name="model">social.messenger.order</field>
        <field name="arch" type="xml">
            <form string="Messenger Order">
                <header>
                    <button name="action_confirm" type="object" 
                            string="Confirm" class="btn-primary"
                            invisible="state != 'draft'"/>
                    <button name="action_create_sale_order" type="object" 
                            string="Create Sale Order" class="btn-primary"
                            invisible="state != 'confirmed' or sale_order_id != False"/>
                    <button name="action_view_sale_order" type="object" 
                            string="View Sale Order" class="btn-info"
                            invisible="sale_order_id == False"/>
                    <button name="action_cancel" type="object" 
                            string="Cancel"
                            invisible="state in ['sale', 'cancelled']"/>
                    <field name="state" widget="statusbar" 
                           statusbar_visible="draft,confirmed,sale"/>
                </header>
                
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    
                    <group>
                        <group string="Customer Information">
                            <field name="customer_name"/>
                            <field name="customer_phone"/>
                            <field name="customer_email"/>
                            <field name="facebook_user_id"/>
                            <field name="partner_id" readonly="1"/>
                        </group>
                        <group string="Order Information">
                            <field name="order_date"/>
                            <field name="user_id"/>
                            <field name="total_amount" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                            <field name="currency_id" column_invisible="1"/>
                            <field name="sale_order_id" readonly="1"/>
                            <field name="conversation_id"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Products" name="products">
                            <field name="product_ids">
                                <list>
                                    <field name="product_id"/>
                                    <field name="quick_reply_title"/>
                                    <field name="price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                    <field name="currency_id" column_invisible="1"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="Internal Notes" name="notes">
                            <field name="notes" placeholder="Add internal notes..."/>
                        </page>
                    </notebook>
                </sheet>
                
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER ORDER - SEARCH VIEW                                         -->
    <!-- ===================================================================== -->
    <record id="social_messenger_order_view_search" model="ir.ui.view">
        <field name="name">social.messenger.order.search</field>
        <field name="model">social.messenger.order</field>
        <field name="arch" type="xml">
            <search string="Search Messenger Orders">
                <field name="name"/>
                <field name="customer_name"/>
                <field name="customer_phone"/>
                <field name="sale_order_id"/>
                
                <filter string="Draft" name="filter_draft" 
                        domain="[('state', '=', 'draft')]"/>
                <filter string="Confirmed" name="filter_confirmed" 
                        domain="[('state', '=', 'confirmed')]"/>
                <filter string="Sale Order Created" name="filter_sale" 
                        domain="[('state', '=', 'sale')]"/>
                <filter string="Cancelled" name="filter_cancelled" 
                        domain="[('state', '=', 'cancelled')]"/>
                <separator/>
                
                <filter string="My Orders" name="filter_my_orders" 
                        domain="[('user_id', '=', uid)]"/>
                <filter string="This Month" name="filter_this_month" 
                        domain="[('order_date', '&gt;=', (context_today() - datetime.timedelta(days=30)).strftime('%Y-%m-%d'))]"/>
                <separator/>
                
                <filter string="Group By Salesperson" name="group_user" 
                        context="{'group_by': 'user_id'}"/>
                <filter string="Group By Status" name="group_state" 
                        context="{'group_by': 'state'}"/>
                <filter string="Group By Order Date" name="group_date" 
                        context="{'group_by': 'order_date:month'}"/>
                <filter string="Group By Company" name="group_company" 
                        context="{'group_by': 'company_id'}" 
                        groups="base.group_multi_company"/>
            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER ORDER - ACTION                                              -->
    <!-- ===================================================================== -->
    <record id="action_social_messenger_order" model="ir.actions.act_window">
        <field name="name">Messenger Orders</field>
        <field name="res_model">social.messenger.order</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="social_messenger_order_view_search"/>
        <field name="context">{'search_default_filter_confirmed': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ğŸ“¦ No Messenger Orders Yet
            </p>
            <p>
                Orders created through the Facebook Messenger chatbot will appear here.<br/>
                Enable the chatbot in Settings to start receiving orders!
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 44: social_messenger_product_views.xml
## ÄÆ°á»ng dáº«n: views/social_messenger_product_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - LIST VIEW                                         -->
    <!-- ===================================================================== -->
    <record id="social_messenger_product_view_tree" model="ir.ui.view">
        <field name="name">social.messenger.product.list</field>
        <field name="model">social.messenger.product</field>
        <field name="arch" type="xml">
            <list string="Messenger Products" 
                  decoration-muted="active == False"
                  editable="bottom">
                <field name="sequence" widget="handle"/>
                <field name="product_id"/>
                <field name="quick_reply_title"/>
                <field name="price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                <field name="currency_id" column_invisible="1"/>
                <field name="active" widget="boolean_toggle"/>
                <field name="order_count"/>
                <field name="company_id" groups="base.group_multi_company" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - FORM VIEW                                         -->
    <!-- ===================================================================== -->
    <record id="social_messenger_product_view_form" model="ir.ui.view">
        <field name="name">social.messenger.product.form</field>
        <field name="model">social.messenger.product</field>
        <field name="arch" type="xml">
            <form string="Messenger Product">
                <header>
                    <button name="action_toggle_active" type="object" 
                            string="Enable" class="btn-primary"
                            invisible="active == True"/>
                    <button name="action_toggle_active" type="object" 
                            string="Disable" class="btn-secondary"
                            invisible="active == False"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_orders" type="object" 
                                class="oe_stat_button" icon="fa-shopping-cart"
                                invisible="order_count == 0">
                            <field name="order_count" widget="statinfo" 
                                   string="Orders"/>
                        </button>
                    </div>
                    
                    <field name="image_url" widget="image" class="oe_avatar"/>
                    
                    <div class="oe_title">
                        <h1>
                            <field name="product_id" 
                                   placeholder="Select Product..."
                                   options="{'no_create': True}"/>
                        </h1>
                    </div>
                    
                    <group>
                        <group string="Product Info">
                            <field name="display_name" invisible="1"/>
                            <field name="quick_reply_title" 
                                   placeholder="Max 20 characters"/>
                            <field name="price" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                            <field name="currency_id" column_invisible="1"/>
                            <field name="sequence"/>
                        </group>
                        <group string="Organization">
                            <field name="company_id" 
                                   groups="base.group_multi_company"/>
                        </group>
                    </group>
                    
                    <group string="Messenger Description">
                        <field name="description" nolabel="1" 
                               placeholder="Description sent to customers..."/>
                    </group>
                    
                    <notebook>
                        <page string="Preview" name="preview">
                            <group>
                                <group string="How it appears in Messenger">
                                    <div class="alert alert-info" role="alert">
                                        <h4>Quick Reply Button:</h4>
                                        <p>
                                            <strong>
                                                <field name="quick_reply_title" readonly="1"/>
                                            </strong>
                                        </p>
                                        
                                        <h4>Product Message:</h4>
                                        <p>
                                            ğŸ›ï¸ <field name="product_id" readonly="1"/><br/>
                                            ğŸ’° GiÃ¡: <field name="price" readonly="1"/> 
                                            <field name="currency_id" readonly="1"/><br/>
                                            ğŸ“ <field name="description" readonly="1"/>
                                        </p>
                                    </div>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - KANBAN VIEW                                       -->
    <!-- ===================================================================== -->
    <record id="social_messenger_product_view_kanban" model="ir.ui.view">
        <field name="name">social.messenger.product.kanban</field>
        <field name="model">social.messenger.product</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile">
                <field name="product_id"/>
                <field name="quick_reply_title"/>
                <field name="price"/>
                <field name="currency_id"/>
                <field name="active"/>
                <field name="order_count"/>
                
                <templates>
                    <t t-name="card" t-translation="off">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="product_id"/>
                                    </strong>
                                </div>
                                <span class="badge rounded-pill" 
                                      t-att-class="record.active.raw_value ? 'text-bg-success' : 'text-bg-secondary'">
                                    <t t-if="record.active.raw_value">Active</t>
                                    <t t-else="">Inactive</t>
                                </span>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="quick_reply_title"/>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <field name="price" widget="monetary"/>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <i class="fa fa-shopping-cart"/> 
                                    <field name="order_count"/> orders
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - SEARCH VIEW                                       -->
    <!-- ===================================================================== -->
    <record id="social_messenger_product_view_search" model="ir.ui.view">
        <field name="name">social.messenger.product.search</field>
        <field name="model">social.messenger.product</field>
        <field name="arch" type="xml">
            <search string="Search Products">
                <field name="product_id"/>
                <field name="quick_reply_title"/>
                
                <filter string="Active" name="filter_active" 
                        domain="[('active', '=', True)]"/>
                <filter string="Inactive" name="filter_inactive" 
                        domain="[('active', '=', False)]"/>
                <separator/>
                
                <!-- XÃ“A FILTER "Has Orders" VÃŒ order_count LÃ€ COMPUTED FIELD -->
                
                <filter string="Group By Product" name="group_product" 
                        context="{'group_by': 'product_id'}"/>
            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- MESSENGER PRODUCT - ACTION                                            -->
    <!-- ===================================================================== -->
    <record id="action_social_messenger_product" model="ir.actions.act_window">
        <field name="name">Messenger Products</field>
        <field name="res_model">social.messenger.product</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="search_view_id" ref="social_messenger_product_view_search"/>
        <field name="context">{'search_default_filter_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No products configured for Messenger!
            </p>
            <p>
                Add products to sell via Facebook Messenger chatbot.
            </p>
            <p>
                <strong>Only active products will appear in the chatbot.</strong>
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 45: social_post_calendar_views.xml
## ÄÆ°á»ng dáº«n: views/social_post_calendar_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="social_post_view_calendar" model="ir.ui.view">
        <field name="name">social.post.calendar</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <calendar
                string="Content Calendar"
                date_start="scheduled_date"
                mode="month"
                color="state"
                quick_create="0"
                event_open_popup="1">
                
                <!-- Required fields for calendar -->
                <field name="content"/>
                <field name="account_id"/>
                <field name="state"/>
                
            </calendar>
        </field>
    </record>

    <record id="action_social_post_calendar" model="ir.actions.act_window">
        <field name="name">Content Calendar</field>
        <field name="res_model">social.post</field>
        <field name="view_mode">calendar,tree,form</field>
        <field name="domain">[('scheduled_date', '!=', False)]</field>
        <field name="context">{'default_post_type': 'scheduled'}</field>
    </record>

</odoo>



################################################################################
## FILE 46: social_post_template_views.xml
## ÄÆ°á»ng dáº«n: views/social_post_template_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - LIST VIEW                                      -->
    <!-- ===================================================================== -->
    <record id="social_post_template_view_tree" model="ir.ui.view">
        <field name="name">social.post.template.list</field>
        <field name="model">social.post.template</field>
        <field name="arch" type="xml">
            <list string="Post Templates" decoration-muted="not active">
                <field name="name"/>
                <field name="template_type" widget="badge"/>
                <field name="description"/>
                <field name="active" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - FORM VIEW                                      -->
    <!-- ===================================================================== -->
    <record id="social_post_template_view_form" model="ir.ui.view">
        <field name="name">social.post.template.form</field>
        <field name="model">social.post.template</field>
        <field name="arch" type="xml">
            <form string="Post Template">
                <sheet>
                    <div class="oe_title">
                        <label for="name" string="Template Name"/>
                        <h1>
                            <field name="name" placeholder="Enter template name..."/>
                        </h1>
                    </div>
                    <group>
                        <group string="Template Info">
                            <field name="template_type"/>
                            <field name="active" widget="boolean_toggle"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                        </group>
                        <group string="Description">
                            <field name="description" nolabel="1" placeholder="Optional description..."/>
                        </group>
                    </group>
                    <group string="Content Template">
                        <field name="content" nolabel="1" placeholder="Enter your template content here. Use {{variable_name}} for dynamic content..."/>
                    </group>
                    <div class="mt-3">
                        <button name="action_use_template" type="object"
                                string="Use This Template" class="btn-primary"/>
                    </div>
                </sheet>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - KANBAN VIEW (FIXED FOR ODOO 19)                -->
    <!-- ===================================================================== -->
    <record id="social_post_template_view_kanban" model="ir.ui.view">
        <field name="name">social.post.template.kanban</field>
        <field name="model">social.post.template</field>
        <field name="arch" type="xml">
            <kanban>
                <field name="name"/>
                <field name="template_type"/>
                <field name="content"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_content">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <div>Type: <field name="template_type"/></div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - SEARCH VIEW                                    -->
    <!-- ===================================================================== -->
    <record id="social_post_template_view_search" model="ir.ui.view">
        <field name="name">social.post.template.search</field>
        <field name="model">social.post.template</field>
        <field name="arch" type="xml">
            <search string="Search Templates">
                <field name="name"/>
                <field name="content"/>
                <filter string="Active" name="filter_active" domain="[('active', '=', True)]"/>
<!-- Group By -->
                <filter string="Group By Type" name="group_type" context="{'group_by': 'template_type'}"/>
            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST TEMPLATE - ACTION                                         -->
    <!-- ===================================================================== -->
    <record id="action_social_post_template" model="ir.actions.act_window">
        <field name="name">Post Templates</field>
        <field name="res_model">social.post.template</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="search_view_id" ref="social_post_template_view_search"/>
        <field name="context">{'search_default_filter_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first post template!
            </p>
            <p>
                Templates help you quickly create consistent social media posts.
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 47: social_post_views.xml
## ÄÆ°á»ng dáº«n: views/social_post_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - LIST VIEW                                               -->
    <!-- ===================================================================== -->
    <record id="social_post_view_tree" model="ir.ui.view">
        <field name="name">social.post.list</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <list string="Facebook Posts" 
                  decoration-success="state == 'published'"
                  decoration-info="state == 'scheduled'"
                  decoration-danger="state == 'failed'">
                <field name="account_id"/>
                <field name="content"/>
                <field name="state" widget="badge"
                       decoration-success="state == 'published'"
                       decoration-info="state == 'scheduled'"
                       decoration-danger="state == 'failed'"
                       decoration-warning="state == 'draft'"/>
                <field name="scheduled_date" optional="show"/>
                <field name="published_date" optional="show"/>
                <field name="likes_count"/>
                <field name="comments_count"/>
                <field name="shares_count"/>
            </list>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - FORM VIEW (FIXED FOR ODOO 19)                           -->
    <!-- ===================================================================== -->
    <record id="social_post_view_form" model="ir.ui.view">
        <field name="name">social.post.form</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <form string="Facebook Post">
                <header>
                    <button name="action_publish_now" type="object"
                            string="Publish Now" class="btn-primary"
                            invisible="state != 'draft'"/>
                    <button name="action_schedule_post" type="object"
                            string="Schedule" class="btn-secondary"
                            invisible="state != 'draft'"/>
                    <button name="action_sync_stats" type="object"
                            string="Sync Stats" class="btn-secondary"
                            invisible="state != 'published'"/>
                                <!-- NÃšT Má»šI: SYNC COMMENTS -->
                    <button name="action_sync_comments" type="object"
                            string="Sync Comments" class="btn-secondary"
                            invisible="state != 'published'"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,scheduled,published"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_comments" type="object"
                                class="oe_stat_button" icon="fa-comments"
                                invisible="comments_count == 0">
                            <field name="comments_count" widget="statinfo" string="Comments"/>
                        </button>
                    </div>
                    
                    <group>
                        <group string="Post Information">
                            <field name="account_id" options="{'no_create': True}"/>
                            <field name="post_type" widget="radio"/>
                            <field name="scheduled_date" invisible="post_type != 'scheduled'"/>
                            <field name="user_id" readonly="1"/>
                        </group>
                        <group string="Engagement Stats" invisible="state != 'published'">
                            <field name="likes_count" readonly="1"/>
                            <field name="comments_count" readonly="1"/>
                            <field name="shares_count" readonly="1"/>
                            <field name="engagement_rate" readonly="1"/>
                        </group>
                    </group>
                    
                    <group string="Content">
                        <field name="content" nolabel="1" placeholder="What do you want to share?"/>
                    </group>
                    
                    <group string="Media">
                        <group>
                            <field name="media_type" widget="radio"/>
                        </group>
                        <group>
                            <field name="image" widget="image" invisible="media_type != 'photo'" class="oe_avatar"/>
                            <field name="link_url" invisible="media_type != 'link'" placeholder="https://..."/>
                            <field name="video_url" invisible="media_type != 'video'" placeholder="https://..."/>
                        </group>
                    </group>
                    
                    <notebook invisible="state == 'draft'">
                        <page string="Facebook Info" name="fb_info" invisible="not facebook_post_id">
                            <group>
                                <group>
                                    <field name="facebook_post_id" readonly="1"/>
                                    <field name="facebook_post_url" widget="url" readonly="1"/>
                                </group>
                                <group>
                                    <field name="published_date" readonly="1"/>
                                    <field name="reach" readonly="1"/>
                                    <field name="impressions" readonly="1"/>
                                </group>
                            </group>
                        </page>
                        <page string="Error Log" name="errors" invisible="not error_message">
                            <group>
                                <field name="error_message" nolabel="1" readonly="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - KANBAN VIEW (FIXED FOR ODOO 19)                         -->
    <!-- ===================================================================== -->
    <record id="social_post_view_kanban" model="ir.ui.view">
        <field name="name">social.post.kanban</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state">
                <field name="content"/>
                <field name="state"/>
                <field name="account_id"/>
                <field name="likes_count"/>
                <field name="comments_count"/>
                <templates>
                    <t t-name="card">
                        <div class="oe_kanban_content">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="account_id"/>
                                    </strong>
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="content"/>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <span><field name="likes_count"/> likes</span>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <span><field name="comments_count"/> comments</span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - SEARCH VIEW                                             -->
    <!-- ===================================================================== -->
    <record id="social_post_view_search" model="ir.ui.view">
        <field name="name">social.post.search</field>
        <field name="model">social.post</field>
        <field name="arch" type="xml">
            <search string="Search Posts">
                <field name="content"/>
                <field name="account_id"/>
                <filter string="Draft" name="filter_draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Scheduled" name="filter_scheduled" domain="[('state', '=', 'scheduled')]"/>
                <filter string="Published" name="filter_published" domain="[('state', '=', 'published')]"/>
                <filter string="Failed" name="filter_failed" domain="[('state', '=', 'failed')]"/>
                <filter string="Group By Status" name="group_state" context="{'group_by': 'state'}"/>
                <filter string="Group By Page" name="group_account" context="{'group_by': 'account_id'}"/>

            </search>
        </field>
    </record>

    <!-- ===================================================================== -->
    <!-- SOCIAL POST - ACTION                                                  -->
    <!-- ===================================================================== -->
    <record id="action_social_post" model="ir.actions.act_window">
        <field name="name">Facebook Posts</field>
        <field name="res_model">social.post</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="search_view_id" ref="social_post_view_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first Facebook post!
            </p>
            <p>
                Click the "New" button to create a new post.
            </p>
        </field>
    </record>

</odoo>



################################################################################
## FILE 48: __init__.py
## ÄÆ°á»ng dáº«n: wizard/__init__.py
################################################################################

from . import post_composer_wizard
from . import bulk_schedule_wizard



################################################################################
## FILE 49: bulk_schedule_wizard.py
## ÄÆ°á»ng dáº«n: wizard/bulk_schedule_wizard.py
################################################################################

from odoo import models, fields, api, _
from odoo.exceptions import UserError, ValidationError
from datetime import timedelta
import logging

_logger = logging.getLogger(__name__)


class BulkScheduleWizard(models.TransientModel):
    _name = 'social.bulk.schedule.wizard'
    _description = 'Bulk Post Scheduler Wizard'

    account_ids = fields.Many2many('social.account', string='Facebook Pages', required=True,
                                    domain=[('platform', '=', 'facebook'), ('state', '=', 'connected')])
    post_template_ids = fields.Many2many('social.post.template', string='Post Templates')
    
    schedule_type = fields.Selection([
        ('specific', 'Specific Dates'),
        ('recurring', 'Recurring Schedule'),
    ], string='Schedule Type', default='specific', required=True)
    
    start_date = fields.Datetime(string='Start Date', default=lambda self: fields.Datetime.now() + timedelta(hours=1))
    end_date = fields.Datetime(string='End Date')
    time_slots = fields.Text(string='Time Slots', default='09:00\n12:00\n15:00\n18:00')
    
    frequency = fields.Selection([
        ('daily', 'Daily'),
        ('weekly', 'Weekly'),
        ('monthly', 'Monthly'),
    ], string='Frequency', default='daily')
    
    interval = fields.Integer(string='Every', default=1)
    
    weekday_monday = fields.Boolean(string='Monday', default=True)
    weekday_tuesday = fields.Boolean(string='Tuesday', default=True)
    weekday_wednesday = fields.Boolean(string='Wednesday', default=True)
    weekday_thursday = fields.Boolean(string='Thursday', default=True)
    weekday_friday = fields.Boolean(string='Friday', default=True)
    weekday_saturday = fields.Boolean(string='Saturday', default=False)
    weekday_sunday = fields.Boolean(string='Sunday', default=False)
    
    day_of_month = fields.Integer(string='Day of Month', default=1)
    posting_times = fields.Text(string='Daily Posting Times', default='09:00\n15:00')
    duration_days = fields.Integer(string='Duration (Days)', default=30)
    
    content_rotation = fields.Selection([
        ('sequential', 'Sequential'),
        ('random', 'Random'),
    ], string='Content Rotation', default='sequential')
    
    preview_count = fields.Integer(string='Posts to Create', compute='_compute_preview_count')
    
    @api.depends('account_ids', 'post_template_ids', 'schedule_type', 'start_date', 'end_date', 'duration_days')
    def _compute_preview_count(self):
        for wizard in self:
            try:
                schedule = wizard._generate_schedule()
                wizard.preview_count = len(schedule) * len(wizard.account_ids)
            except:
                wizard.preview_count = 0
    
    def _get_selected_weekdays(self):
        self.ensure_one()
        weekdays = []
        if self.weekday_monday: weekdays.append(0)
        if self.weekday_tuesday: weekdays.append(1)
        if self.weekday_wednesday: weekdays.append(2)
        if self.weekday_thursday: weekdays.append(3)
        if self.weekday_friday: weekdays.append(4)
        if self.weekday_saturday: weekdays.append(5)
        if self.weekday_sunday: weekdays.append(6)
        return weekdays
    
    def _parse_time_slots(self, time_text):
        times = []
        for line in (time_text or '').split('\n'):
            line = line.strip()
            if not line:
                continue
            try:
                hour, minute = map(int, line.split(':'))
                if 0 <= hour <= 23 and 0 <= minute <= 59:
                    times.append((hour, minute))
            except:
                pass
        return times if times else [(9, 0)]
    
    def _generate_schedule(self):
        self.ensure_one()
        schedule = []
        
        if not self.start_date:
            return schedule
        
        if self.schedule_type == 'specific':
            current = self.start_date
            end = self.end_date or (self.start_date + timedelta(days=30))
            times = self._parse_time_slots(self.time_slots)
            
            while current <= end:
                for hour, minute in times:
                    scheduled_time = current.replace(hour=hour, minute=minute, second=0, microsecond=0)
                    if scheduled_time > fields.Datetime.now():
                        schedule.append(scheduled_time)
                current += timedelta(days=1)
        else:
            current = self.start_date
            end_date = current + timedelta(days=self.duration_days)
            times = self._parse_time_slots(self.posting_times)
            selected_weekdays = self._get_selected_weekdays()
            
            while current <= end_date:
                should_post = False
                if self.frequency == 'daily':
                    should_post = True
                elif self.frequency == 'weekly':
                    should_post = current.weekday() in selected_weekdays
                elif self.frequency == 'monthly':
                    should_post = current.day == self.day_of_month
                
                if should_post:
                    for hour, minute in times:
                        scheduled_time = current.replace(hour=hour, minute=minute, second=0, microsecond=0)
                        if scheduled_time > fields.Datetime.now():
                            schedule.append(scheduled_time)
                
                current += timedelta(days=1)
        
        return sorted(schedule)
    
    def action_schedule_posts(self):
        self.ensure_one()
        
        if not self.account_ids:
            raise UserError(_('Please select at least one Facebook Page!'))
        if not self.post_template_ids:
            raise UserError(_('Please select at least one post template!'))
        
        schedule = self._generate_schedule()
        if not schedule:
            raise UserError(_('No valid schedule dates found!'))
        
        created_posts = self.env['social.post']
        template_index = 0
        templates_list = list(self.post_template_ids)
        
        for scheduled_time in schedule:
            template = templates_list[template_index % len(templates_list)]
            template_index += 1
            
            for account in self.account_ids:
                post = self.env['social.post'].create({
                    'account_id': account.id,
                    'content': template.content,
                    'post_type': 'scheduled',
                    'scheduled_date': scheduled_time,
                    'state': 'scheduled',
                })
                created_posts |= post
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Success'),
                'message': _('Successfully scheduled %d posts!') % len(created_posts),
                'type': 'success',
                'sticky': False,
            }
        }




################################################################################
## FILE 50: post_composer_wizard.py
## ÄÆ°á»ng dáº«n: wizard/post_composer_wizard.py
################################################################################

from odoo import models, fields, api, _
from odoo.exceptions import UserError, ValidationError
import logging

_logger = logging.getLogger(__name__)


class PostComposerWizard(models.TransientModel):
    """
    Wizard Ä‘á»ƒ táº¡o vÃ  Ä‘Äƒng bÃ i nhanh lÃªn Facebook.
    Cho phÃ©p publish ngay hoáº·c lÃªn lá»‹ch.
    """
    _name = 'social.post.composer.wizard'
    _description = 'Quick Post Composer Wizard'

    # -------------------------------------------------------------------------
    # BASIC FIELDS
    # -------------------------------------------------------------------------
    account_ids = fields.Many2many(
        'social.account',
        string='Facebook Pages',
        required=True,
        domain=[('platform', '=', 'facebook'), ('state', '=', 'connected')],
        help='Select which pages to post to'
    )
    
    content = fields.Text(
        string='Post Content',
        required=True,
        help='What do you want to share?'
    )
    
    template_id = fields.Many2one(
        'social.post.template',
        string='Use Template',
        help='Select a template to start with'
    )
    
    # -------------------------------------------------------------------------
    # MEDIA
    # -------------------------------------------------------------------------
    media_type = fields.Selection([
        ('text', 'Text Only'),
        ('photo', 'Photo'),
        ('link', 'Link'),
    ], string='Post Type', default='text', required=True)
    
    image = fields.Binary(
        string='Image',
        attachment=True,
    )
    
    image_filename = fields.Char(string='Image Filename')
    
    link_url = fields.Char(
        string='Link URL',
        help='Share a link (optional)'
    )
    
    # -------------------------------------------------------------------------
    # SCHEDULING
    # -------------------------------------------------------------------------
    post_method = fields.Selection([
        ('now', 'Publish Now'),
        ('scheduled', 'Schedule for Later'),
    ], string='When to Post', default='now', required=True)
    
    scheduled_date = fields.Datetime(
        string='Schedule Date',
        help='When should this post be published?'
    )
    
    # -------------------------------------------------------------------------
    # PREVIEW
    # -------------------------------------------------------------------------
    preview_text = fields.Html(
        string='Preview',
        compute='_compute_preview_text',
        sanitize=False,
    )
    
    character_count = fields.Integer(
        string='Characters',
        compute='_compute_character_count',
    )
    
    # -------------------------------------------------------------------------
    # STATS
    # -------------------------------------------------------------------------
    page_count = fields.Integer(
        string='Number of Pages',
        compute='_compute_page_count',
    )
    
    # -------------------------------------------------------------------------
    # COMPUTE METHODS
    # -------------------------------------------------------------------------
    @api.onchange('template_id')
    def _onchange_template_id(self):
        """Load template content"""
        if self.template_id:
            self.content = self.template_id.content
    
    @api.depends('content')
    def _compute_character_count(self):
        """Count characters in content"""
        for wizard in self:
            wizard.character_count = len(wizard.content or '')
    
    @api.depends('account_ids')
    def _compute_page_count(self):
        """Count selected pages"""
        for wizard in self:
            wizard.page_count = len(wizard.account_ids)
    
    @api.depends('content', 'link_url', 'media_type')
    def _compute_preview_text(self):
        """Generate preview of the post"""
        for wizard in self:
            preview = '<div style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background-color: #f9f9f9;">'
            preview += '<div style="margin-bottom: 10px;">'
            preview += '<i class="fa fa-facebook-square" style="color: #1877f2; font-size: 20px;"></i> '
            preview += '<strong>Facebook Post Preview</strong>'
            preview += '</div>'
            
            if wizard.content:
                preview += f'<p style="white-space: pre-wrap; margin-bottom: 10px;">{wizard.content}</p>'
            
            if wizard.link_url:
                preview += f'<div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; background-color: #fff;">'
                preview += f'<i class="fa fa-link"></i> <a href="{wizard.link_url}" target="_blank">{wizard.link_url}</a>'
                preview += '</div>'
            
            if wizard.media_type == 'photo':
                preview += '<div style="margin-top: 10px;">'
                preview += '<i class="fa fa-camera"></i> <em>Image will be attached</em>'
                preview += '</div>'
            
            preview += '</div>'
            wizard.preview_text = preview
    
    # -------------------------------------------------------------------------
    # VALIDATION
    # -------------------------------------------------------------------------
    @api.constrains('scheduled_date', 'post_method')
    def _check_scheduled_date(self):
        """Validate scheduled date"""
        for wizard in self:
            if wizard.post_method == 'scheduled':
                if not wizard.scheduled_date:
                    raise ValidationError(_('Please set a scheduled date!'))
                if wizard.scheduled_date <= fields.Datetime.now():
                    raise ValidationError(_('Scheduled date must be in the future!'))
    
    @api.constrains('content')
    def _check_content_length(self):
        """Check content length"""
        for wizard in self:
            if wizard.content and len(wizard.content) > 63206:
                raise ValidationError(_('Facebook posts are limited to 63,206 characters!'))
    
    # -------------------------------------------------------------------------
    # ACTIONS
    # -------------------------------------------------------------------------
    def action_publish(self):
        """Create and publish/schedule posts"""
        self.ensure_one()
        
        if not self.account_ids:
            raise UserError(_('Please select at least one Facebook Page!'))
        
        created_posts = self.env['social.post']
        
        for account in self.account_ids:
            post_vals = {
                'account_id': account.id,
                'content': self.content,
                'media_type': self.media_type,
                'link_url': self.link_url,
                'post_type': self.post_method,
            }
            
            if self.media_type == 'photo' and self.image:
                post_vals.update({
                    'image': self.image,
                    'image_filename': self.image_filename,
                })
            
            if self.post_method == 'scheduled':
                post_vals['scheduled_date'] = self.scheduled_date
            
            post = self.env['social.post'].create(post_vals)
            created_posts |= post
            
            # If publish now, trigger publish action
            if self.post_method == 'now':
                try:
                    post.action_publish_now()
                except Exception as e:
                    _logger.error(f'Error publishing post {post.id}: {e}')
                    raise UserError(_('Error publishing to %s: %s') % (account.name, str(e)))
            else:
                post.state = 'scheduled'
        
        # Show success notification
        message = _('Successfully created %d post(s)!') % len(created_posts)
        if self.post_method == 'now':
            message = _('Successfully published to %d page(s)!') % len(self.account_ids)
        else:
            message = _('Successfully scheduled %d post(s) for %s') % (
                len(created_posts), 
                self.scheduled_date.strftime('%Y-%m-%d %H:%M')
            )
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Success'),
                'message': message,
                'type': 'success',
                'sticky': False,
                'next': {
                    'type': 'ir.actions.act_window',
                    'res_model': 'social.post',
                    'view_mode': 'list,form',
                    'domain': [('id', 'in', created_posts.ids)],
                }
            }
        }
    
    def action_preview(self):
        """Show preview of the post"""
        self.ensure_one()
        return {
            'type': 'ir.actions.act_window',
            'name': _('Post Preview'),
            'res_model': 'social.post.composer.wizard',
            'view_mode': 'form',
            'res_id': self.id,
            'target': 'new',
        }




################################################################################
## FILE 51: wizard_views.xml
## ÄÆ°á»ng dáº«n: wizard/wizard_views.xml
################################################################################

<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="post_composer_wizard_view_form" model="ir.ui.view">
        <field name="name">social.post.composer.wizard.form</field>
        <field name="model">social.post.composer.wizard</field>
        <field name="arch" type="xml">
            <form string="Quick Post Composer">
                <sheet>
                    <group>
                        <group string="Select Pages">
                            <field name="account_ids" widget="many2many_tags"/>
                        </group>
                        <group string="Options">
                            <field name="template_id"/>
                            <field name="post_method" widget="radio"/>
                        </group>
                    </group>
                    <group string="Content">
                        <field name="content" nolabel="1"/>
                    </group>
                    <group>
                        <group string="Media">
                            <field name="media_type" widget="radio"/>
                            <field name="image" widget="image" invisible="media_type != 'photo'"/>
                            <field name="link_url" invisible="media_type != 'link'"/>
                        </group>
                        <group string="Scheduling" invisible="post_method != 'scheduled'">
                            <field name="scheduled_date"/>
                        </group>
                    </group>
                </sheet>
                <footer>
                    <button name="action_publish" type="object" string="Publish/Schedule" class="btn-primary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <record id="action_post_composer_wizard" model="ir.actions.act_window">
        <field name="name">Create Post</field>
        <field name="res_model">social.post.composer.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

    <record id="bulk_schedule_wizard_view_form" model="ir.ui.view">
        <field name="name">social.bulk.schedule.wizard.form</field>
        <field name="model">social.bulk.schedule.wizard</field>
        <field name="arch" type="xml">
            <form string="Bulk Post Scheduler">
                <sheet>
                    <group>
                        <group string="Select Pages">
                            <field name="account_ids" widget="many2many_tags"/>
                        </group>
                        <group string="Select Templates">
                            <field name="post_template_ids" widget="many2many_tags"/>
                            <field name="content_rotation" widget="radio"/>
                        </group>
                    </group>
                    <group string="Schedule Type">
                        <field name="schedule_type" widget="radio"/>
                    </group>
                    <group invisible="schedule_type != 'specific'">
                        <group string="Date Range">
                            <field name="start_date"/>
                            <field name="end_date"/>
                        </group>
                        <group string="Time Slots">
                            <field name="time_slots" nolabel="1"/>
                        </group>
                    </group>
                    <group invisible="schedule_type != 'recurring'">
                        <group string="Frequency">
                            <field name="frequency" widget="radio"/>
                            <field name="interval"/>
                            <field name="duration_days"/>
                            <field name="day_of_month" invisible="frequency != 'monthly'"/>
                        </group>
                        <group string="Posting Times">
                            <field name="posting_times" nolabel="1"/>
                        </group>
                    </group>
                    <group string="Weekdays" invisible="schedule_type != 'recurring' or frequency != 'weekly'">
                        <group>
                            <field name="weekday_monday"/>
                            <field name="weekday_tuesday"/>
                            <field name="weekday_wednesday"/>
                            <field name="weekday_thursday"/>
                        </group>
                        <group>
                            <field name="weekday_friday"/>
                            <field name="weekday_saturday"/>
                            <field name="weekday_sunday"/>
                        </group>
                    </group>
                    <group string="Preview">
                        <field name="preview_count" readonly="1"/>
                    </group>
                </sheet>
                <footer>
                    <button name="action_schedule_posts" type="object" string="Schedule All Posts" class="btn-primary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <record id="action_bulk_schedule_wizard" model="ir.actions.act_window">
        <field name="name">Bulk Schedule Posts</field>
        <field name="res_model">social.bulk.schedule.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

</odoo>


